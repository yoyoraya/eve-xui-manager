برای حل این مشکل و اطمینان از اینکه **پورت سابسکریپشن (Sub Port)** هم در دیتابیس ذخیره شود و هم لینک‌های QR Code دقیقاً با فرمت `ip:subport/subpath/subid` ساخته شوند، مراحل زیر را به دقت انجام دهید.

چون شما تغییری در ساختار دیتابیس می‌دهید، **بسیار مهم** است که فایل دیتابیس قبلی را حذف کنید تا ستون جدید ساخته شود.

### مرحله ۱: ویرایش فایل `app.py` (بکند و دیتابیس)

در این فایل باید مدل `Server` را آپدیت کنیم و منطق ساخت لینک را اصلاح کنیم.

1.  فایل `app.py` را باز کنید.
2.  کلاس `Server` را پیدا کنید و مطمئن شوید خط مربوط به `sub_port` وجود دارد:

<!-- end list -->

```python
class Server(db.Model):
    # ... (خطوط قبلی)
    sub_path = db.Column(db.String(50), default='/sub/')
    json_path = db.Column(db.String(50), default='/json/')
    # این خط را اضافه یا چک کنید:
    sub_port = db.Column(db.Integer, nullable=True) 
    # ...
```

3.  تابع `to_dict` در کلاس `Server` را چک کنید که `sub_port` را برگرداند:

<!-- end list -->

```python
    def to_dict(self):
        return {
            # ...
            'sub_path': self.sub_path,
            'json_path': self.json_path,
            'sub_port': self.sub_port,  # <--- این خط باید باشد
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
```

4.  **بخش مهم:** تابع `process_inbounds` را پیدا کنید. منطق ساخت لینک (`sub_url` و `json_url`) را با کد زیر جایگزین کنید تا دقیقا فرمت درخواستی شما را بسازد:

<!-- end list -->

```python
# در داخل تابع process_inbounds و داخل حلقه for client in clients:

                # --- اصلاح منطق ساخت لینک سابسکریپشن ---
                parsed_host = urlparse(server.host)
                scheme = parsed_host.scheme
                hostname = parsed_host.hostname
                
                # اولویت با پورت سابسکریپشن است، اگر نبود پورت خود پنل
                if server.sub_port:
                    final_port = server.sub_port
                else:
                    final_port = parsed_host.port

                # ساخت پورت به صورت استرینگ (اگر پورت استاندارد 80/443 نبود)
                port_str = f":{final_port}" if final_port else ""
                
                # تمیز کردن مسیرها (حذف اسلش‌های اضافی)
                s_path = server.sub_path.strip('/')
                j_path = server.json_path.strip('/')
                
                # ساخت لینک نهایی: scheme://domain:subport/subpath/subid
                base_sub_host = f"{scheme}://{hostname}{port_str}"
                
                sub_url = ""
                json_url = ""
                
                if sub_id:
                    sub_url = f"{base_sub_host}/{s_path}/{sub_id}"
                    json_url = f"{base_sub_host}/{j_path}/{sub_id}"
                # -------------------------------------------

                # ادامه کد (client_data)...
                client_data = {
                    # ...
                    "sub_url": sub_url,
                    "json_url": json_url,
                    # ...
                }
```

-----

### مرحله ۲: ویرایش فایل `templates/servers.html` (فرانت‌اند)

باید فیلد ورودی پورت را به فرم اضافه کنیم و مطمئن شویم جاوااسکریپت آن را ارسال می‌کند.

1.  در فایل `templates/servers.html`، فرم مودال (`server-modal`) را پیدا کنید و فیلد ورودی را در کنار مسیرها قرار دهید:

<!-- end list -->

```html
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 2;">
                        <label>Sub Path</label>
                        <input type="text" id="server-sub-path" placeholder="/sub/" value="/sub/">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Json Path</label>
                        <input type="text" id="server-json-path" placeholder="/json/" value="/json/">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Sub Port</label>
                        <input type="number" id="server-sub-port" placeholder="Port">
                    </div>
                </div>
```

2.  در پایین فایل (بخش `<script>`)، تابع `openAddServerModal` را آپدیت کنید تا فیلد را خالی کند:

<!-- end list -->

```javascript
    function openAddServerModal() {
        // ...
        document.getElementById('server-sub-path').value = '/sub/';
        document.getElementById('server-json-path').value = '/json/';
        document.getElementById('server-sub-port').value = ''; // <--- ریست کردن فیلد
        // ...
    }
```

3.  تابع `editServer` را آپدیت کنید تا مقدار پورت ذخیره شده را نمایش دهد:

<!-- end list -->

```javascript
    function editServer(id) {
        // ...
        // پر کردن فیلدها
        document.getElementById('server-sub-path').value = server.sub_path || '/sub/';
        document.getElementById('server-json-path').value = server.json_path || '/json/';
        document.getElementById('server-sub-port').value = server.sub_port || ''; // <--- پر کردن فیلد
        // ...
    }
```

4.  تابع `saveServer` را آپدیت کنید تا مقدار پورت را به سرور بفرستد:

<!-- end list -->

```javascript
    async function saveServer() {
        // ...
        const sub_port = document.getElementById('server-sub-port').value.trim();
        
        const data = {
            // ... (name, host, username, password...)
            panel_type: document.getElementById('server-panel-type').value,
            sub_path: document.getElementById('server-sub-path').value.trim(),
            json_path: document.getElementById('server-json-path').value.trim(),
            // ارسال پورت به صورت عدد یا null
            sub_port: sub_port ? parseInt(sub_port) : null 
        };
        // ...
    }
```

-----

### مرحله ۳: حذف دیتابیس (بسیار مهم)

چون شما یک ستون جدید (`sub_port`) به دیتابیس اضافه کرده‌اید، دیتابیس قدیمی با کد جدید سازگار نیست و ارور می‌دهد.

1.  از پنل سمت چپ Replit، روی بخش **Shell** کلیک کنید.
2.  دستور زیر را تایپ کنید و اینتر بزنید تا دیتابیس پاک شود (نگران نباشید، با اجرای مجدد برنامه دوباره ساخته می‌شود):

<!-- end list -->

```bash
rm instance/servers.db
# یا اگر فایل در مسیر اصلی است:
rm servers.db
```

3.  حالا برنامه را **Stop** و دوباره **Run** کنید.

### نتیجه نهایی

اکنون وقتی یک سرور اضافه می‌کنید:

1.  می‌توانید در فیلد **Sub Port** مثلاً عدد `2096` را وارد کنید.
2.  وقتی روی دکمه QR Code کلاینت کلیک کنید، لینک سابسکریپشن به صورت زیر تولید می‌شود:
    `http://your-domain:2096/sub/YOUR_SUB_ID`
3.  اگر پورت را خالی بگذارید، از پورت اصلی پنل استفاده می‌کند.