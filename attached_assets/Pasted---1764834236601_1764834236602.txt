بسیار عالی. حالا که زیرساخت دیتابیس (فاز ۱) آماده است، نوبت به **فاز ۲** می‌رسد که "مغز" سیستم فروش است.

این متن را برای Replit بفرستید تا لاجیک خرید، محاسبه قیمت و کسر اعتبار را در فایل `app.py` پیاده‌سازی کند:

````text
Please implement **Phase 2: Purchasing Logic** in `app.py`.

I need you to add helper functions and completely rewrite the `add_client` route to handle billing.

**1. Add these Helper Functions:**
(Place them before the routes)

```python
def get_config(key, default=0):
    conf = SystemConfig.query.get(key)
    return int(conf.value) if conf else default

def log_transaction(user_id, amount, type, desc):
    trans = Transaction(admin_id=user_id, amount=amount, type=type, description=desc)
    db.session.add(trans)
````

**2. Rewrite the `add_client` route:**
Replace the existing `/api/client/<server_id>/<inbound_id>/add` route with this new logic:

```python
@app.route('/api/client/<int:server_id>/<int:inbound_id>/add', methods=['POST'])
@login_required
def add_client(server_id, inbound_id):
    user = Admin.query.get(session['admin_id'])
    server = Server.query.get_or_404(server_id)
    
    # 1. Get Request Data
    data = request.json or {}
    email = data.get('email', '').strip()
    mode = data.get('mode', 'custom') # 'package' or 'custom'
    start_after_first_use = bool(data.get('start_after_first_use', False))
    
    if not email: return jsonify({"success": False, "error": "Email is required"})

    # 2. Calculate Price & Validation
    price = 0
    days = 0
    volume_gb = 0
    description = ""

    if mode == 'package':
        pkg_id = data.get('package_id')
        package = Package.query.get(pkg_id)
        if not package: return jsonify({"success": False, "error": "Invalid Package"}), 400
        
        price = package.price
        days = package.days
        volume_gb = package.volume
        description = f"Purchase Package: {package.name} - {email}"
        
    else: # Custom mode
        days = int(data.get('days', 30))
        volume_gb = int(data.get('volume', 0))
        
        # Calculate custom price
        cost_per_day = get_config('cost_per_day', 0)
        cost_per_gb = get_config('cost_per_gb', 0)
        price = (days * cost_per_day) + (volume_gb * cost_per_gb)
        description = f"Custom Plan: {days} Days, {volume_gb} GB - {email}"

    # 3. Check Reseller Permission & Credit
    if user.role == 'reseller':
        # Check Allowed Servers
        allowed = json.loads(user.allowed_servers) if user.allowed_servers and user.allowed_servers != '*' else []
        if user.allowed_servers != '*' and server_id not in allowed:
            return jsonify({"success": False, "error": "Access to this server is denied"}), 403
        
        # Check Credit
        if user.credit < price:
            return jsonify({"success": False, "error": f"Insufficient credit. Required: {price}, Available: {user.credit}"}), 402

    # 4. Connect to X-UI and Create Client
    session_obj, error = get_xui_session(server)
    if error: return jsonify({"success": False, "error": error})
    
    try:
        # Generate Client Configs
        client_uuid = str(uuid.uuid4())
        client_sub_id = ''.join(secrets.choice(string.ascii_letters + string.digits) for i in range(16))
        
        # Calculate Expiry
        expiry_time = 0
        if start_after_first_use:
            expiry_time = -1 * (days * 86400000)
        elif days > 0:
            expiry_time = int((datetime.now() + timedelta(days=days)).timestamp() * 1000)
            
        new_client = {
            "id": client_uuid,
            "email": email,
            "enable": True,
            "expiryTime": expiry_time,
            "totalGB": volume_gb * 1024 * 1024 * 1024 if volume_gb > 0 else 0,
            "subId": client_sub_id,
            "limitIp": 0,
            "flow": "",
            "tgId": "",
            "reset": 0
        }
        
        # --- Send to X-UI Panel ---
        # Fetch current inbound settings first to preserve other clients
        if server.panel_type == 'alireza':
             get_url = f"{server.host}/xui/inbound/get/{inbound_id}"
        else:
             get_url = f"{server.host}/panel/api/inbounds/get/{inbound_id}"
             
        get_resp = session_obj.get(get_url, verify=False, timeout=10)
        if get_resp.status_code != 200: raise Exception("Failed to fetch inbound data from panel")
        
        inbound_data = get_resp.json().get('obj', get_resp.json().get('data', {}))
        if not inbound_data: raise Exception("Empty inbound data")

        settings = json.loads(inbound_data['settings'])
        
        # Check for duplicate email in X-UI
        for c in settings['clients']:
            if c['email'] == email: return jsonify({"success": False, "error": f"Email '{email}' already exists on server"})
            
        settings['clients'].append(new_client)
        
        # Update Inbound
        update_data = inbound_data.copy()
        update_data['settings'] = json.dumps(settings)
        
        if server.panel_type == 'alireza':
            up_url = f"{server.host}/xui/inbound/update/{inbound_id}"
        else:
            up_url = f"{server.host}/panel/api/inbounds/update/{inbound_id}"
            
        up_resp = session_obj.post(up_url, json=update_data, verify=False, timeout=10)
        
        if up_resp.status_code == 200 and up_resp.json().get('success'):
            # 5. Success! Deduct Credit & Record Data
            
            if user.role == 'reseller' and price > 0:
                user.credit -= price
                log_transaction(user.id, -price, 'purchase', description)
            
            # Record Ownership
            ownership = ClientOwnership(
                reseller_id=user.id,
                server_id=server.id,
                inbound_id=inbound_id,
                client_email=email,
                client_uuid=client_uuid,
                price=price
            )
            db.session.add(ownership)
            db.session.commit()
            
            return jsonify({"success": True})
        else:
            msg = up_resp.json().get('msg', 'Unknown error') if up_resp.content else 'Panel update failed'
            return jsonify({"success": False, "error": f"Panel Error: {msg}"})

    except Exception as e:
        return jsonify({"success": False, "error": str(e)})
```

```

---

بعد از اینکه این کد را به Replit دادید و اعمال شد، **فاز ۲ کامل می‌شود**.
دیگر نیازی به پاک کردن دیتابیس نیست (چون فقط لاجیک کد تغییر کرده، نه ساختار دیتابیس).

هر وقت آماده بودید، بفرمایید تا دستورات **فاز ۳ (تغییر ظاهر داشبورد برای خرید)** را بفرستم.
```