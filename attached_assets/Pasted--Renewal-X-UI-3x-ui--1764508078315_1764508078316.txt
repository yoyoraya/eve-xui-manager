برای پیاده‌سازی منطق «تمدید» (Renewal) در پنل‌های X-UI (مخصوصاً نسخه‌های توسعه‌یافته مثل 3x-ui یا نسخه Sanaei که در ایران محبوب هستند) به شکلی که تایمر پس از اولین اتصال شروع شود، باید از منطق اعداد منفی در زمان انقضا استفاده کنید.در اینجا منطق دقیق و نحوه ارسال آن به API را توضیح می‌دهم:منطق کلی (The Logic)در دیتابیس پنل‌های x-ui، فیلد expiryTime معمولاً یک عدد (Timestamp) است. اما توسعه‌دهندگان یک منطق هوشمندانه (تریک) برای حالت "Start after first use" پیاده‌سازی کرده‌اند:اعداد مثبت: نشان‌دهنده تاریخ دقیق انقضا (Unix Timestamp) هستند (مثلاً تاریخ ۲۰۲۴/۱۲/۰۱).عدد صفر: یعنی اکانت نامحدود است (هرگز منقضی نمی‌شود).اعداد منفی: نشان‌دهنده طول دوره (Duration) هستند که هنوز شروع نشده است.فرمول محاسبهاگر می‌خواهید اکانت را برای ۳۰ روز (از لحظه اولین اتصال) تمدید کنید، نباید تاریخ ۳۰ روز دیگر را بفرستید. بلکه باید تعداد میلی‌ثانیه‌های ۳۰ روز را به صورت منفی بفرستید.$$\text{New Expiry Time} = -1 \times (\text{Days} \times 24 \times 60 \times 60 \times 1000)$$مثال برای ۳۰ روز:۳۰ روز = ۲,۵۹۲,۰۰۰,۰۰۰ میلی‌ثانیه.عددی که باید به API بفرستید: 2592000000-مراحل پیاده‌سازی در APIوقتی کاربر درخواست تمدید می‌کند و تیک "Start after first use" را زده است، شما باید یک درخواست Update یا Reset به کلاینت بفرستید که شامل موارد زیر باشد:۱. ریست کردن ترافیک (الزامی)چون این یک "تمدید" است و تایمر قرار است از اول شروع شود، منطقی است که حجم مصرفی قبلی هم صفر شود تا با اتصال جدید، همه چیز (زمان و حجم) تازه باشد.۲. تنظیم ExpiryTime منفیمقدار محاسبه شده در بالا را جایگزین expiryTime فعلی کنید.۳. ساختار JSON ارسالی (Payload)فرض کنید می‌خواهیم کلاینت را برای ۳۰ روز شناور تمدید کنیم. درخواست API به اندپوینت /panel/api/inbounds/updateClient/{uuid} (یا اندپوینت مشابه بسته به نسخه پنل) باید شامل بادی زیر باشد:JSON{
  "id": 1,                // آی‌دی کلاینت در دیتابیس
  "settings": "{...}",    // تنظیمات دیگر که دست نمی‌خورند
  "expiryTime": -2592000000,  // نکته کلیدی اینجاست (۳۰ روز به میلی‌ثانیه اما منفی)
  "totalGB": 0,           // اگر می‌خواهید حجم هم نامحدود یا تغییر کند
  "email": "user@email.com",
  "enable": true,
  "tgId": "",
  "subId": "",
  "limitIp": 0,
  "reset": 0             // معمولاً برای ریست ترافیک از اندپوینت جداگانه استفاده می‌شود
}
نکته مهم در مورد ریست ترافیک:در اکثر پنل‌ها، صرفاً فرستادن بادی بالا ترافیک (up و down) را صفر نمی‌کند. شما باید حتماً اندپوینت resetClientTraffic را هم برای آن کاربر صدا بزنید یا اگر اندپوینت آپدیت شما فلگ reset: true دارد، آن را فعال کنید.خلاصه سناریو در کد (Pseudo-code)اگر دارید یک بات یا سایت می‌نویسید، منطق کد شما باید اینگونه باشد:Pythondef renew_user(uuid, days_to_add, is_floating_time=True):
    
    # 1. محاسبه زمان
    if is_floating_time:
        # حالت شناور: تبدیل روز به میلی‌ثانیه و منفی کردن آن
        ms_per_day = 86400000
        new_expiry = -1 * (days_to_add * ms_per_day)
    else:
        # حالت معمولی: زمان فعلی + روزهای اضافه
        import time
        current_timestamp = int(time.time() * 1000)
        new_expiry = current_timestamp + (days_to_add * 86400000)

    # 2. صدا زدن API برای آپدیت زمان
    api.update_client(uuid, expiry_time=new_expiry)

    # 3. صدا زدن API برای صفر کردن ترافیک (چون تمدید است)
    # اگر این کار را نکنید، ممکن است به محض اتصال به خاطر پر بودن حجم قبلی قطع شود
    api.reset_client_traffic(uuid)
    
    return "تمدید با موفقیت انجام شد"
چه اتفاقی در پنل می‌افتد؟پنل مقدار -2592000000 را در دیتابیس ذخیره می‌کند.در رابط کاربری پنل (Web UI)، جلوی تاریخ انقضا معمولاً می‌نویسد: "30 Days (Not Started)" یا مشابه آن.به محض اینکه کاربر اولین بایت را رد و بدل کند (Connect شود):پنل زمان فعلی (Now) را می‌گیرد.قدر مطلق عدد منفی (یعنی 2592000000) را به آن اضافه می‌کند.نتیجه را به عنوان expiryTime جدید (مثبت) در دیتابیس آپدیت می‌کند.تایمر شروع می‌شود.جمع‌بندیبرای تمدید شناور، ترافیک را صفر کنید و expiryTime را برابر با منفیِ طول دوره (به میلی‌ثانیه) قرار دهید.