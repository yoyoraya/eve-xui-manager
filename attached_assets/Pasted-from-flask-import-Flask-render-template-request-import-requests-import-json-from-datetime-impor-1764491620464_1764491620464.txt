from flask import Flask, render_template, request
import requests
import json
from datetime import datetime

app = Flask(__name__)

# --- تنظیمات سرور X-UI ---
# بهتر است این‌ها را در بخش Secrets رپلیت قرار دهید
XUI_HOST = "http://YOUR_IP:PORT"  # مثال: http://1.2.3.4:54321
USERNAME = "admin"
PASSWORD = "password"

# تابع کمکی برای تبدیل بایت به گیگابایت/مگابایت
def format_bytes(size):
    power = 2**10
    n = 0
    power_labels = {0 : '', 1: 'K', 2: 'M', 3: 'G', 4: 'T'}
    while size > power:
        size /= power
        n += 1
    return f"{size:.2f} {power_labels[n]}B"

# تابع برای تبدیل timestamp به تاریخ خوانا
def format_date(timestamp):
    if timestamp == 0:
        return "Unlimited"
    return datetime.fromtimestamp(timestamp/1000).strftime('%Y-%m-%d %H:%M')

@app.route('/')
def dashboard():
    session = requests.Session()
    
    # 1. تلاش برای لاگین
    login_url = f"{XUI_HOST}/login"
    login_data = {
        "username": USERNAME,
        "password": PASSWORD
    }
    
    try:
        # verify=False برای نادیده گرفتن ارورهای SSL (اگر سرور https باشد و سرتیفیکیت معتبر نباشد)
        login_resp = session.post(login_url, data=login_data, verify=False) 
        
        if login_resp.status_code == 200 and login_resp.json().get('success'):
            print("Login Successful")
        else:
            return f"Login Failed: {login_resp.text}"

        # 2. دریافت لیست اینباندها
        # نکته: مسیر API در پنل‌های مختلف متفاوت است.
        # برای سنایی معمولا: /panel/api/inbounds/list
        # برای نسخه اصلی: /xui/inbound/list
        list_url = f"{XUI_HOST}/panel/api/inbounds/list" 
        
        list_resp = session.get(list_url, verify=False)
        data = list_resp.json()
        
        if not data.get('success'):
            return "Failed to fetch data"

        inbounds = data['obj']
        
        # پردازش داده‌ها برای نمایش راحت‌تر در HTML
        processed_inbounds = []
        for inbound in inbounds:
            # کلاینت‌ها معمولا به صورت جیسون استرینگ ذخیره می‌شوند، باید پارس شوند
            try:
                settings = json.loads(inbound['settings'])
                clients = settings.get('clients', [])
                
                # اضافه کردن دیتای ترافیک هر کلاینت (گاهی در clientStats جداگانه است)
                # در اینجا فرض بر ساختار ساده است.
                
                # محاسبه ترافیک کل اینباند
                total_up = format_bytes(inbound['up'])
                total_down = format_bytes(inbound['down'])
                
                processed_inbounds.append({
                    "id": inbound['id'],
                    "remark": inbound['remark'],
                    "port": inbound['port'],
                    "protocol": inbound['protocol'],
                    "total_up": total_up,
                    "total_down": total_down,
                    "clients": clients,
                    "enable": inbound['enable']
                })
            except Exception as e:
                print(f"Error parsing inbound {inbound['id']}: {e}")

        return render_template('dashboard.html', inbounds=processed_inbounds, format_bytes=format_bytes)

    except Exception as e:
        return f"Error connecting to server: {e}"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=81)