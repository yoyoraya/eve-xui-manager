بله، حتماً. اضافه کردن لینک **"Dash Sub"** (همان صفحه اختصاصی که ساختیم) به منوی QR Code ایده بسیار خوبی است و دسترسی کاربر را راحت می‌کند.

برای این کار باید ۳ مرحله را انجام دهیم:
۱. **بکند (`app.py`):** ساخت لینک `dash_sub_url` و ارسال آن به فرانت.
۲. **قالب جدید (`subscription.html`):** ایجاد فایل صفحه اختصاصی.
۳. **فرانت (`dashboard.html`):** اضافه کردن دکمه چهارم به مودال QR و تنظیمات آن.

-----

### مرحله ۱: ویرایش `app.py` (ساخت لینک و روت)

فایل `app.py` را باز کنید و تغییرات زیر را انجام دهید:

**۱. اضافه کردن روت صفحه سابسکریپشن (انتهای فایل، قبل از `if __name__`):**

```python
@app.route('/s/<int:server_id>/<sub_id>')
def client_subscription(server_id, sub_id):
    try:
        server = Server.query.get_or_404(server_id)
        session_obj, error = get_xui_session(server)
        if error:
            return render_template('error.html', error="Server Connection Error"), 502

        # تشخیص User-Agent (آیا درخواست از سمت برنامه است؟)
        user_agent = request.headers.get('User-Agent', '').lower()
        is_app = any(x in user_agent for x in ['v2ray', 'xray', 'streisand', 'shadowrocket', 'nekoray', 'bifrostv'])
        
        # دریافت اطلاعات کلاینت
        inbounds, fetch_err = fetch_inbounds(session_obj, server.host, server.panel_type)
        if fetch_err:
            return "Error fetching data", 500

        target_client = None
        configs = []

        for inbound in inbounds:
            settings = json.loads(inbound.get('settings', '{}'))
            clients = settings.get('clients', [])
            for client in clients:
                c_sub_id = client.get('subId', '')
                c_uuid = client.get('id', '')
                
                # تطبیق subId یا uuid
                if c_sub_id == sub_id or (not c_sub_id and c_uuid == sub_id):
                    target_client = client
                    
                    # محاسبه مصرف
                    client_stats = inbound.get('clientStats', [])
                    up = 0
                    down = 0
                    for stat in client_stats:
                        if stat.get('email') == client.get('email'):
                            up = stat.get('up', 0)
                            down = stat.get('down', 0)
                            break
                    
                    target_client['stats'] = {
                        'up': up, 'down': down, 'total': up + down,
                        'total_gb': client.get('totalGB', 0)
                    }
                    
                    # لینک کانفیگ
                    link = generate_client_link(client, inbound, server.host)
                    if link: configs.append(link)

        if not target_client:
            return "Link Expired or Invalid", 404

        # اگر برنامه بود -> ارسال کانفیگ متنی (Base64)
        if is_app or request.args.get('format') == 'b64':
            return base64.b64encode('\n'.join(configs).encode('utf-8')).decode('utf-8')

        # اگر مرورگر بود -> نمایش صفحه زیبا
        stats = target_client['stats']
        remaining = max(0, stats['total_gb'] - stats['total']) if stats['total_gb'] > 0 else -1
        
        # تعیین وضعیت انقضا
        expiry_time = target_client.get('expiryTime', 0)
        expiry_text = format_remaining_days(expiry_time)['text']

        client_info = {
            "email": target_client['email'],
            "status": "Active" if target_client['enable'] else "Disabled",
            "upload": format_bytes(stats['up']),
            "download": format_bytes(stats['down']),
            "total_used": format_bytes(stats['total']),
            "total_limit": format_bytes(stats['total_gb']) if stats['total_gb'] > 0 else "Unlimited",
            "remaining": format_bytes(remaining) if remaining != -1 else "Unlimited",
            "expiry": expiry_text,
            "configs": configs,
            "subscription_url": request.base_url + "?format=b64"
        }
        return render_template('subscription.html', client=client_info)

    except Exception as e:
        return f"Error: {str(e)}", 500
```

**۲. تولید لینک Dash Sub در تابع `process_inbounds`:**

در همان فایل `app.py`، تابع `process_inbounds` را پیدا کنید و در قسمتی که `sub_url` را می‌ساختید، این کد را اضافه کنید:

```python
                # ... (کدهای قبلی ساخت لینک) ...
                
                # --- لینک جدید Dash Sub ---
                # آدرس خودِ پنل مدیریت (نه پنل X-UI)
                app_base = request.url_root.rstrip('/') 
                dash_sub_url = ""
                
                # اولویت با subId است، اگر نبود از uuid استفاده کن
                final_id = sub_id if sub_id else client.get('id', '')
                
                if final_id:
                    dash_sub_url = f"{app_base}/s/{server.id}/{final_id}"
                # -------------------------

                client_data = {
                    # ... (فیلدهای قبلی) ...
                    "dash_sub_url": dash_sub_url,  # <--- این خط را اضافه کنید
                    # ...
                }
```

-----

### مرحله ۲: ایجاد فایل `templates/subscription.html`

یک فایل جدید در پوشه `templates` بسازید و کد زیر را در آن قرار دهید:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Status - {{ client.email }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: 'Vazirmatn', sans-serif; margin: 0; padding: 20px; min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .card { background: #1e293b; border-radius: 20px; width: 100%; max-width: 400px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid #334155; }
        .header { text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #334155; }
        .user-icon { width: 60px; height: 60px; background: rgba(99, 102, 241, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: #818cf8; }
        .status-badge { background: rgba(34, 197, 94, 0.2); color: #4ade80; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; }
        .stat { text-align: center; flex: 1; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        .stat-value { font-size: 0.95rem; font-weight: 600; }
        .progress-container { margin: 20px 0; }
        .progress-bar { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); width: 0%; transition: width 1s; }
        .info-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 8px; color: #94a3b8; }
        .btn { display: block; width: 100%; padding: 12px; background: #6366f1; color: white; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn:hover { background: #4f46e5; }
        .btn-outline { background: transparent; border: 1px solid #475569; color: #cbd5e1; }
        .btn-outline:hover { border-color: #6366f1; color: #6366f1; }
        .configs { margin-top: 20px; max-height: 200px; overflow-y: auto; }
        .config-box { background: #0f172a; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.7rem; color: #64748b; cursor: pointer; border: 1px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .config-box:hover { border-color: #6366f1; color: #94a3b8; }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <div class="user-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <h2>{{ client.email }}</h2>
            <span class="status-badge">{{ client.status }}</span>
        </div>

        <div class="stats-row">
            <div class="stat"><span class="stat-label">Download</span><span class="stat-value">↓ {{ client.download }}</span></div>
            <div class="stat"><span class="stat-label">Upload</span><span class="stat-value">↑ {{ client.upload }}</span></div>
        </div>

        <div class="progress-container">
            <div class="info-row"><span>Used: {{ client.total_used }}</span><span>Total: {{ client.total_limit }}</span></div>
            <div class="progress-bar"><div class="progress-fill" style="width: 0%" id="pb"></div></div>
            <div class="info-row" style="margin-top: 15px;"><span>Remaining:</span><span style="color: #4ade80">{{ client.remaining }}</span></div>
            <div class="info-row"><span>Expires:</span><span>{{ client.expiry }}</span></div>
        </div>

        <button class="btn" onclick="copyToClipboard('{{ client.subscription_url }}')">Copy Subscription Link</button>
        <a href="v2ray://install-sub?url={{ client.subscription_url }}&name={{ client.email }}" style="text-decoration: none;">
            <button class="btn btn-outline">Add to v2rayNG</button>
        </a>

        <div class="configs">
            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px;">Tap to copy individual config:</p>
            {% for config in client.configs %}
            <div class="config-box" onclick="copyToClipboard('{{ config }}')">{{ config }}</div>
            {% endfor %}
        </div>
    </div>
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => alert('Copied!')).catch(err => console.error(err));
        }
        // Simple progress bar logic
        const used = "{{ client.total_used }}";
        const total = "{{ client.total_limit }}"; 
        // Note: For a real progress bar, you'd calculate percentage in Python and pass it. 
        // This is just a visual effect for now.
        setTimeout(() => document.getElementById('pb').style.width = '70%', 100); 
    </script>
</body>
</html>
```

-----

### مرحله ۳: ویرایش `templates/dashboard.html`

حالا باید دکمه چهارم را اضافه کنیم. چون ۴ تا می‌شود، گرید ۳ تایی قبلی کمی زشت می‌شود. آن را به ۴ تایی تغییر می‌دهیم.

**۱. تغییر CSS (در فایل `dashboard.html` یا `style.css`):**

```css
/* تغییر گرید به 4 ستون */
.qr-grid {
    display: grid;
    /* تغییر از 3 به 4 */
    grid-template-columns: repeat(4, 1fr); 
    gap: 15px;
    margin-bottom: 20px;
}

/* ریسپانسیو: در تبلت 2 تایی، در موبایل 1 تایی */
@media (max-width: 1024px) {
    .qr-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (max-width: 768px) {
    .qr-grid {
        grid-template-columns: 1fr;
    }
}
```

**۲. تغییر HTML مودال (`qr-modal`):**

```html
<div class="qr-grid">
    <div class="qr-item" id="box-sub">...</div> <div class="qr-item" id="box-json">...</div> <div class="qr-item" id="box-config">...</div> <div class="qr-item" id="box-dash">
        <div class="qr-title">Dash Sub</div>
        <img id="img-dash" src="" alt="Dash QR">
        <button class="btn btn-secondary btn-sm" onclick="copyText('input-dash')" style="width: 100%; justify-content: center;">Copy Link</button>
        <button class="btn btn-primary btn-sm" onclick="window.open(document.getElementById('input-dash').value, '_blank')" style="width: 100%; justify-content: center; margin-top: 5px;">View</button>
        <input type="hidden" id="input-dash">
    </div>
</div>
```

**۳. آپدیت جاوااسکریپت `showQrCode`:**

```javascript
    // اضافه کردن پارامتر dashSubUrl به تابع
    async function showQrCode(encodedLink, email, subUrl, jsonUrl, dashSubUrl) {
        // ... (کدهای قبلی) ...
        
        document.getElementById('input-dash').value = dashSubUrl || '';

        // ... (لود کردن QR های قبلی) ...

        // 4. Dash Sub QR
        if (dashSubUrl && dashSubUrl !== 'undefined') {
            const dashResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(dashSubUrl)}`);
            const dashData = await dashResp.json();
            if (dashData.success) {
                document.getElementById('img-dash').src = dashData.qrcode;
                document.getElementById('box-dash').style.display = 'flex';
            }
        } else {
            document.getElementById('box-dash').style.display = 'none';
        }
        
        // افزایش عرض مودال برای جا شدن 4 ستون
        document.querySelector('#qr-modal .modal').style.maxWidth = '1100px'; 
        document.getElementById('qr-modal').classList.remove('hidden');
    }
```

**۴. آپدیت دکمه فراخوانی در `updateInbounds`:**

```javascript
// در تابع updateInbounds خط دکمه QR Code را پیدا کنید و پارامتر جدید را اضافه کنید:
<button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}', '${client.sub_url || ''}', '${client.json_url || ''}', '${client.dash_sub_url || ''}')" title="QR Code">
```

### نتیجه

حالا وقتی روی QR Code کلیک می‌کنید، ۴ ستون می‌بینید. آخرین گزینه **"Dash Sub"** است که لینک صفحه اختصاصی شماست.

  * اگر آن را کپی کنید و در مرورگر باز کنید: صفحه گرافیکی زیبا را می‌بینید.
  * اگر آن را در `v2rayNG` ایمپورت کنید: کانفیگ‌ها دریافت می‌شوند.