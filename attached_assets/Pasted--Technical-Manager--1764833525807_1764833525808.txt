Ø­Ù‚ Ø¨Ø§ Ø´Ù…Ø§Ø³Øª. Ù…Ù† Ø¹Ø°Ø±Ø®ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ù…Ø§ ØªØ§ Ø§Ù„Ø§Ù† ÙÙ‚Ø· ÛŒÚ© **"Ù…Ø¯ÛŒØ±ÛŒØª ÙÙ†ÛŒ"** (Technical Manager) Ø³Ø§Ø®ØªÙ‡ Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø§Ù…Ø§ Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø´Ù…Ø§ Ø§Ù„Ø§Ù† ØªÙˆØµÛŒÙ Ú©Ø±Ø¯ÛŒØ¯ ÛŒÚ© **"Ø³ÛŒØ³ØªÙ… ÙØ±ÙˆØ´ Ùˆ Ø§Ú©Ø§Ù†ØªÛŒÙ†Ú¯"** (Billing & Accounting System) Ú©Ø§Ù…Ù„ Ø§Ø³Øª.

Ø§ÛŒÙ† ÛŒÚ© ØªØºÛŒÛŒØ± Ø¨Ø²Ø±Ú¯ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ØŒ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Û´ Ù…Ø§Ú˜ÙˆÙ„ Ø­ÛŒØ§ØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯:

1.  **Ù…Ø§Ú˜ÙˆÙ„ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§:** ØªØ¹Ø±ÛŒÙ Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ (Ù…Ø«Ù„Ø§Ù‹: Û± Ù…Ø§Ù‡Ù‡ Û³Û° Ú¯ÛŒÚ¯ = ÛµÛ° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†).
2.  **Ù…Ø§Ú˜ÙˆÙ„ ØªØ¹Ø±ÙÙ‡ Ù¾Ø§ÛŒÙ‡:** ØªØ¹ÛŒÛŒÙ† Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ (Ù…Ø«Ù„Ø§Ù‹: Ù‡Ø± Ø±ÙˆØ² = ÛµÛ°Û° ØªÙˆÙ…Ø§Ù†ØŒ Ù‡Ø± Ú¯ÛŒÚ¯ = Û²,Û°Û°Û° ØªÙˆÙ…Ø§Ù†) Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø§Ú©Ø§Ù†Øª Ø¯Ù„Ø®ÙˆØ§Ù‡.
3.  **Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø§Ù„ÛŒ (Wallet & Transactions):** Ø«Ø¨Øª ØªÙ…Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨ØŒ Ú©Ø³Ø± Ø¨Ø§Ø¨Øª Ø®Ø±ÛŒØ¯ØŒ Ø¨Ø±Ú¯Ø´Øª ÙˆØ¬Ù‡).
4.  **Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯:** ØªØºÛŒÛŒØ± Ú©Ø§Ù…Ù„ Ù…ÙˆØ¯Ø§Ù„ "Add Client" Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ú©ÛŒØ¬ ÛŒØ§ Ø­Ø§Ù„Øª Ø¯Ù„Ø®ÙˆØ§Ù‡.

Ø¨ÛŒØ§ÛŒÛŒØ¯ Ø§ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒÙ…. Ø§ÛŒÙ† Ú©Ø§Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¹Ù…Ø¯Ù‡ Ø¯Ø± `app.py` Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø§Ø±Ø¯.

-----

### Ú¯Ø§Ù… Ø§ÙˆÙ„: Ø¢Ù¾Ø¯ÛŒØª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ùˆ Ù…Ø¯Ù„â€ŒÙ‡Ø§ (`app.py`)

ÙØ§ÛŒÙ„ `app.py` Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ú©Ù„ Ù…Ø­ØªÙˆØ§ Ø±Ø§ Ø¨Ø§ Ú©Ø¯ Ø²ÛŒØ± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯.
**ØªØºÛŒÛŒØ±Ø§Øª Ø¬Ø¯ÛŒØ¯:**

  * Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¬Ø¯ÙˆÙ„ `Package` (Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡).
  * Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¬Ø¯ÙˆÙ„ `Transaction` (Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§).
  * Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¬Ø¯ÙˆÙ„ `SystemConfig` (Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯ÛŒÚ¯ Ùˆ Ù‡Ø± Ø±ÙˆØ²).
  * ØªØºÛŒÛŒØ± Ú©Ø§Ù…Ù„ Ù„Ø§Ø¬ÛŒÚ© `add_client` Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ùˆ Ú©Ø³Ø± Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„.

<!-- end list -->

```python
import os
import json
import requests
import uuid
import secrets
import string
from datetime import datetime, timedelta
from functools import wraps
from flask import Flask, render_template, jsonify, request, redirect, url_for, session
from flask_sqlalchemy import SQLAlchemy
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from werkzeug.security import generate_password_hash, check_password_hash
from urllib.parse import urlparse

app = Flask(__name__)
app.secret_key = os.environ.get("SESSION_SECRET", "dev-secret-key")
app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get("DATABASE_URL", "sqlite:///servers.db")
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=7)

limiter = Limiter(app=app, key_func=get_remote_address, default_limits=["2000 per day"])
db = SQLAlchemy(app)

# --- MODELS ---

class Admin(db.Model):
    __tablename__ = 'admins'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(100), unique=True, nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    role = db.Column(db.String(20), default='reseller') 
    is_superadmin = db.Column(db.Boolean, default=False)
    credit = db.Column(db.Integer, default=0) # Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„
    allowed_servers = db.Column(db.Text, default='[]')
    enabled = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    last_login = db.Column(db.DateTime)
    
    # Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
    transactions = db.relationship('Transaction', backref='admin', lazy=True)

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)
    def check_password(self, password):
        return check_password_hash(self.password_hash, password)
    def to_dict(self):
        return {
            'id': self.id, 'username': self.username, 'role': self.role,
            'credit': self.credit, 'enabled': self.enabled
        }

class Server(db.Model):
    __tablename__ = 'servers'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100))
    host = db.Column(db.String(255))
    username = db.Column(db.String(100))
    password = db.Column(db.String(255))
    enabled = db.Column(db.Boolean, default=True)
    panel_type = db.Column(db.String(50), default='auto')
    sub_path = db.Column(db.String(50), default='/sub/')
    json_path = db.Column(db.String(50), default='/json/')
    sub_port = db.Column(db.Integer, nullable=True)
    
    def to_dict(self):
        return {'id': self.id, 'name': self.name, 'host': self.host, 'enabled': self.enabled}

# Ù…Ø¯Ù„ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡
class Package(db.Model):
    __tablename__ = 'packages'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False) # Ù…Ø«Ù„Ø§: 1 Ù…Ø§Ù‡Ù‡ 30 Ú¯ÛŒÚ¯
    days = db.Column(db.Integer, nullable=False)
    volume = db.Column(db.Integer, nullable=False) # Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª
    price = db.Column(db.Integer, nullable=False) # Ù‚ÛŒÙ…Øª ØªÙˆÙ…Ø§Ù†
    enabled = db.Column(db.Boolean, default=True)
    
    def to_dict(self):
        return {'id': self.id, 'name': self.name, 'days': self.days, 'volume': self.volume, 'price': self.price}

# Ù…Ø¯Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ… (Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡)
class SystemConfig(db.Model):
    __tablename__ = 'system_configs'
    key = db.Column(db.String(50), primary_key=True)
    value = db.Column(db.String(200))

# Ù…Ø¯Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ú©ÛŒÙ Ù¾ÙˆÙ„)
class Transaction(db.Model):
    __tablename__ = 'transactions'
    id = db.Column(db.Integer, primary_key=True)
    admin_id = db.Column(db.Integer, db.ForeignKey('admins.id'), nullable=False)
    amount = db.Column(db.Integer, nullable=False) # Ù…Ø«Ø¨Øª Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜ØŒ Ù…Ù†ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯
    type = db.Column(db.String(20)) # 'deposit', 'purchase', 'refund'
    description = db.Column(db.String(255))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    def to_dict(self):
        return {
            'id': self.id, 'amount': self.amount, 'type': self.type,
            'description': self.description, 'date': self.created_at.isoformat()
        }

class ClientOwnership(db.Model):
    __tablename__ = 'client_ownerships'
    id = db.Column(db.Integer, primary_key=True)
    reseller_id = db.Column(db.Integer, db.ForeignKey('admins.id'))
    server_id = db.Column(db.Integer, db.ForeignKey('servers.id'))
    client_email = db.Column(db.String(100))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    price = db.Column(db.Integer, default=0)

# --- INIT ---
with app.app_context():
    db.create_all()
    if not Admin.query.filter_by(username='admin').first():
        admin = Admin(username='admin', role='superadmin', is_superadmin=True, credit=99999999)
        admin.set_password(os.environ.get("INITIAL_ADMIN_PASSWORD", "admin"))
        db.session.add(admin)
        
        # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡
        db.session.add(SystemConfig(key='cost_per_gb', value='2000')) # Ù‡Ø± Ú¯ÛŒÚ¯ 2000 ØªÙˆÙ…Ø§Ù†
        db.session.add(SystemConfig(key='cost_per_day', value='500')) # Ù‡Ø± Ø±ÙˆØ² 500 ØªÙˆÙ…Ø§Ù†
        db.session.commit()

# --- HELPERS ---
def get_config(key, default=0):
    conf = SystemConfig.query.get(key)
    return int(conf.value) if conf else default

def log_transaction(user_id, amount, type, desc):
    trans = Transaction(admin_id=user_id, amount=amount, type=type, description=desc)
    db.session.add(trans)

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'admin_id' not in session: return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def superadmin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'admin_id' not in session: return jsonify({"error": "Auth required"}), 401
        user = Admin.query.get(session['admin_id'])
        if user.role != 'superadmin': return jsonify({"error": "Access denied"}), 403
        return f(*args, **kwargs)
    return decorated_function

def get_xui_session(server):
    s = requests.Session()
    try:
        r = s.post(f"{server.host}/login", data={"username": server.username, "password": server.password}, verify=False, timeout=5)
        if r.status_code == 200 and r.json().get('success'): return s, None
        return None, "Login failed"
    except: return None, "Connection failed"

# --- ROUTES ---

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        data = request.json or request.form
        user = Admin.query.filter_by(username=data.get('username')).first()
        if user and user.check_password(data.get('password')):
            session['admin_id'] = user.id
            session['role'] = user.role
            return jsonify({"success": True})
        return jsonify({"success": False, "error": "Invalid"})
    return render_template('login.html')

@app.route('/')
@login_required
def dashboard():
    user = Admin.query.get(session['admin_id'])
    servers = Server.query.filter_by(enabled=True).all()
    # Ø§Ø±Ø³Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø± ÙØ±Ø§Ù†Øª
    base_cost_gb = get_config('cost_per_gb')
    base_cost_day = get_config('cost_per_day')
    return render_template('dashboard.html', 
                         user=user, 
                         servers=servers, 
                         base_cost_gb=base_cost_gb, 
                         base_cost_day=base_cost_day)

@app.route('/api/packages', methods=['GET'])
@login_required
def get_packages():
    pkgs = Package.query.filter_by(enabled=True).all()
    return jsonify([p.to_dict() for p in pkgs])

# --- ADD CLIENT LOGIC (UPDATED FOR BILLING) ---
@app.route('/api/client/add', methods=['POST'])
@login_required
def add_client():
    user = Admin.query.get(session['admin_id'])
    data = request.json
    
    server_id = data.get('server_id')
    inbound_id = data.get('inbound_id')
    email = data.get('email')
    
    # ØªØ´Ø®ÛŒØµ Ø­Ø§Ù„Øª Ø®Ø±ÛŒØ¯: Ù¾Ú©ÛŒØ¬ ÛŒØ§ Ø¯Ø³ØªÛŒ
    mode = data.get('mode') # 'package' or 'custom'
    price = 0
    days = 0
    volume = 0
    
    if mode == 'package':
        pkg_id = data.get('package_id')
        package = Package.query.get(pkg_id)
        if not package: return jsonify({"success": False, "error": "Invalid Package"}), 400
        price = package.price
        days = package.days
        volume = package.volume
        desc = f"Purchase Package: {package.name} for {email}"
        
    elif mode == 'custom':
        days = int(data.get('days', 30))
        volume = int(data.get('volume', 0))
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª
        cost_per_day = get_config('cost_per_day')
        cost_per_gb = get_config('cost_per_gb')
        price = (days * cost_per_day) + (volume * cost_per_gb)
        desc = f"Custom Plan: {days} Days, {volume} GB for {email}"
        
    else:
        return jsonify({"success": False, "error": "Invalid mode"}), 400

    # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
    if user.role == 'reseller' and user.credit < price:
        return jsonify({"success": False, "error": f"Ú©Ù…Ø¨ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ! Ù‡Ø²ÛŒÙ†Ù‡: {price}ØŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: {user.credit}"}), 402

    # --- Ø§ØªØµØ§Ù„ Ø¨Ù‡ X-UI ---
    server = Server.query.get(server_id)
    session_obj, err = get_xui_session(server)
    if err: return jsonify({"success": False, "error": err}), 500
    
    try:
        # 1. Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª Ø¯Ø± X-UI
        client_uuid = str(uuid.uuid4())
        # (Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª Ú©Ù‡ Ù‚Ø¨Ù„Ø§ Ø¯Ø§Ø´ØªÛŒÙ… Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ - Ø®Ù„Ø§ØµÙ‡ Ø´Ø¯Ù‡)
        # ÙØ±Ø¶ Ø¨Ø± Ù…ÙˆÙÙ‚ÛŒØª:
        
        # ... X-UI Logic Here ...
        # Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ù„ÙˆØºÛŒ Ú©Ø¯ØŒ ÙØ±Ø¶ Ù…ÛŒÚ©Ù†ÛŒÙ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ X-UI Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù‡
        
        # 2. Ú©Ø³Ø± Ø§Ø² Ø­Ø³Ø§Ø¨ Ùˆ Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
        if user.role == 'reseller':
            user.credit -= price
            log_transaction(user.id, -price, 'purchase', desc)
        
        # 3. Ø«Ø¨Øª Ù…Ø§Ù„Ú©ÛŒØª
        ownership = ClientOwnership(
            reseller_id=user.id, server_id=server.id, client_email=email, price=price
        )
        db.session.add(ownership)
        db.session.commit()
        
        return jsonify({"success": True})
        
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

# --- SUPERADMIN ROUTES (PACKAGES & CONFIG) ---

@app.route('/admin/packages', methods=['POST'])
@superadmin_required
def create_package():
    data = request.json
    pkg = Package(
        name=data['name'], days=int(data['days']), 
        volume=int(data['volume']), price=int(data['price'])
    )
    db.session.add(pkg)
    db.session.commit()
    return jsonify({"success": True})

@app.route('/admin/config', methods=['POST'])
@superadmin_required
def update_config():
    data = request.json
    for key, val in data.items():
        conf = SystemConfig.query.get(key)
        if conf: conf.value = str(val)
        else: db.session.add(SystemConfig(key=key, value=str(val)))
    db.session.commit()
    return jsonify({"success": True})

@app.route('/admin/charge', methods=['POST'])
@superadmin_required
def charge_reseller():
    data = request.json
    reseller = Admin.query.get(data['admin_id'])
    amount = int(data['amount'])
    
    reseller.credit += amount
    log_transaction(reseller.id, amount, 'deposit', data.get('description', 'Manual Charge'))
    db.session.commit()
    return jsonify({"success": True})

@app.route('/api/transactions')
@login_required
def get_transactions():
    user = Admin.query.get(session['admin_id'])
    # Ø±ÛŒØ³Ù„Ø± ÙÙ‚Ø· Ù…Ø§Ù„ Ø®ÙˆØ¯Ø´ØŒ Ø³ÙˆÙ¾Ø±Ø§Ø¯Ù…ÛŒÙ† Ù‡Ù…Ù‡ (ÛŒØ§ Ù…Ø§Ù„ ÛŒÚ© Ù†ÙØ± Ø®Ø§Øµ)
    if user.role == 'reseller':
        trans = Transaction.query.filter_by(admin_id=user.id).order_by(Transaction.created_at.desc()).all()
    else:
        target_id = request.args.get('user_id')
        if target_id:
            trans = Transaction.query.filter_by(admin_id=target_id).order_by(Transaction.created_at.desc()).all()
        else:
            trans = Transaction.query.order_by(Transaction.created_at.desc()).limit(100).all()
            
    return jsonify([t.to_dict() for t in trans])

# ... (Ø³Ø§ÛŒØ± Ø±ÙˆØªâ€ŒÙ‡Ø§ Ù…Ø«Ù„ before) ...

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

-----

### Ú¯Ø§Ù… Ø¯ÙˆÙ…: Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (Frontend)

Ø­Ø§Ù„Ø§ Ø¨Ø§ÛŒØ¯ Ù…ÙˆØ¯Ø§Ù„ `Add Client` Ø¯Ø± `dashboard.html` Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒÙ… ØªØ§ Ø¯Ùˆ ØªØ¨ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯: **"Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§"** Ùˆ **"Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÛŒ"**.

ÙØ§ÛŒÙ„ `templates/dashboard.html` Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ø®Ø´ `add-client-modal` Ø±Ø§ Ø¨Ø§ Ú©Ø¯ Ø²ÛŒØ± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯:

```html
<div class="modal-overlay hidden" id="add-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ø¬Ø¯ÛŒØ¯</h2>
            <button class="modal-close" onclick="closeAddClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            
            <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                <button class="tab-btn active" onclick="switchAddMode('package')" id="btn-mode-package" style="padding: 10px; border-bottom: 2px solid var(--primary); color: white;">ğŸ“¦ Ø®Ø±ÛŒØ¯ Ø¨Ø³ØªÙ‡</button>
                <button class="tab-btn" onclick="switchAddMode('custom')" id="btn-mode-custom" style="padding: 10px; color: var(--text-secondary);">âš™ï¸ Ù¾Ù„Ù† Ø¯Ù„Ø®ÙˆØ§Ù‡</button>
            </div>

            <div class="form-group">
                <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ / Ø§ÛŒÙ…ÛŒÙ„</label>
                <input type="text" id="add-client-email" class="form-input" placeholder="user1">
            </div>
            
            <div class="form-group">
                <label>Ø³Ø±ÙˆØ± Ùˆ Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯</label>
                <select id="add-client-server-select" class="form-select" onchange="onServerSelected()"></select>
                <select id="add-client-inbound-select" class="form-select" style="margin-top: 5px;"></select>
            </div>

            <div id="section-package">
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø³ØªÙ‡</label>
                    <div id="packages-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="pkg-loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§...</div>
                    </div>
                </div>
            </div>

            <div id="section-custom" class="hidden">
                <div class="form-row" style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex:1">
                        <label>Ù…Ø¯Øª (Ø±ÙˆØ²)</label>
                        <input type="number" id="custom-days" class="form-input" value="30" oninput="calculateCustomPrice()">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Ø­Ø¬Ù… (Ú¯ÛŒÚ¯)</label>
                        <input type="number" id="custom-volume" class="form-input" value="10" oninput="calculateCustomPrice()">
                    </div>
                </div>
                <div class="cost-preview" style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center;">
                    Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡: <strong id="custom-price-display" style="color: #fbbf24;">0</strong> ØªÙˆÙ…Ø§Ù†
                </div>
            </div>

            <div class="form-footer" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div class="wallet-info">
                    Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§: <span style="color: #4ade80;">{{ user.credit }} ØªÙˆÙ…Ø§Ù†</span>
                </div>
                <button class="btn btn-primary" onclick="submitAddClient()">
                    Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ø³Ø§Ø®Øª
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    let currentMode = 'package';
    let selectedPackageId = null;
    // Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø§Ø² Ø¨Ú©Ù†Ø¯ Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯
    const BASE_COST_DAY = {{ base_cost_day }};
    const BASE_COST_GB = {{ base_cost_gb }};

    function switchAddMode(mode) {
        currentMode = mode;
        document.getElementById('section-package').classList.toggle('hidden', mode !== 'package');
        document.getElementById('section-custom').classList.toggle('hidden', mode !== 'custom');
        
        // Ø¢Ù¾Ø¯ÛŒØª ØªØ¨â€ŒÙ‡Ø§ (Ø§Ø³ØªØ§ÛŒÙ„ Ø³Ø§Ø¯Ù‡)
        document.getElementById('btn-mode-package').style.borderBottom = mode === 'package' ? '2px solid var(--primary)' : 'none';
        document.getElementById('btn-mode-custom').style.borderBottom = mode === 'custom' ? '2px solid var(--primary)' : 'none';
        
        if (mode === 'package') loadPackages();
        if (mode === 'custom') calculateCustomPrice();
    }

    async function loadPackages() {
        const container = document.getElementById('packages-list');
        try {
            const res = await fetch('/api/packages');
            const pkgs = await res.json();
            
            container.innerHTML = pkgs.map(p => `
                <div class="pkg-card" onclick="selectPackage(this, ${p.id}, ${p.price})" 
                     style="border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s;">
                    <div style="font-weight: bold;">${p.name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${p.days} Ø±ÙˆØ²Ù‡ / ${p.volume} Ú¯ÛŒÚ¯</div>
                    <div style="color: #4ade80; margin-top: 5px;">${p.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                </div>
            `).join('');
        } catch (e) { container.innerHTML = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª'; }
    }

    function selectPackage(el, id, price) {
        // Ø­Ø°Ù Ø§Ø³ØªØ§ÛŒÙ„ Ù‚Ø¨Ù„ÛŒ
        document.querySelectorAll('.pkg-card').forEach(d => d.style.borderColor = 'var(--border-color)');
        // Ø§Ø¹Ù…Ø§Ù„ Ø§Ø³ØªØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯
        el.style.borderColor = 'var(--primary)';
        el.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
        selectedPackageId = id;
    }

    function calculateCustomPrice() {
        const days = parseInt(document.getElementById('custom-days').value) || 0;
        const vol = parseInt(document.getElementById('custom-volume').value) || 0;
        const total = (days * BASE_COST_DAY) + (vol * BASE_COST_GB);
        document.getElementById('custom-price-display').innerText = total.toLocaleString();
    }

    async function submitAddClient() {
        // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯ÛŒØªØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ currentMode
        const email = document.getElementById('add-client-email').value;
        const inboundData = JSON.parse(document.getElementById('add-client-inbound-select').value || '{}');
        
        const payload = {
            email: email,
            server_id: inboundData.server_id,
            inbound_id: inboundData.inbound_id,
            mode: currentMode
        };

        if (currentMode === 'package') {
            if (!selectedPackageId) return showToast('Ù„Ø·ÙØ§ ÛŒÚ© Ø¨Ø³ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
            payload.package_id = selectedPackageId;
        } else {
            payload.days = document.getElementById('custom-days').value;
            payload.volume = document.getElementById('custom-volume').value;
        }

        // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
        // ... (Ú©Ø¯ ÙÚ†) ...
    }
</script>
```

### Ú¯Ø§Ù… Ø³ÙˆÙ…: Ø³Ø§Ø®Øª Ù¾Ù†Ù„ "ØªØ¹Ø±ÛŒÙ Ù¾Ú©ÛŒØ¬" (Ù…Ø®ØµÙˆØµ Ø³ÙˆÙ¾Ø±Ø§Ø¯Ù…ÛŒÙ†)

Ø´Ù…Ø§ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ Ø¬Ø§ÛŒÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ú©Ù†ÛŒØ¯.
ÛŒÚ© ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù†Ø§Ù… `templates/packages.html` Ø¨Ø³Ø§Ø²ÛŒØ¯ (ÛŒØ§ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† `admins.html` Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯) Ú©Ù‡ ÙØ±Ù… Ø³Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:

  * Ù†Ø§Ù… Ø¨Ø³ØªÙ‡
  * ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²
  * Ø­Ø¬Ù… (GB)
  * Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)
  * Ø¯Ú©Ù…Ù‡ "Ø§ÙØ²ÙˆØ¯Ù†" Ú©Ù‡ Ø¨Ù‡ `/admin/packages` Ù¾Ø³Øª Ú©Ù†Ø¯.

Ùˆ Ù‡Ù…Ú†Ù†ÛŒÙ† ÛŒÚ© ÙØ±Ù… Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ (Ù‡Ø± Ú¯ÛŒÚ¯ Ú†Ù†Ø¯ØŸ Ù‡Ø± Ø±ÙˆØ² Ú†Ù†Ø¯ØŸ) Ú©Ù‡ Ø¨Ù‡ `/admin/config` Ù¾Ø³Øª Ú©Ù†Ø¯.

-----

### Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡

Ø¨Ø§ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª:

1.  **Ø±ÛŒØ³Ù„Ø± Ø´Ù…Ø§ ÛŒÚ© Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¯Ø§Ø±Ø¯.**
2.  Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ÛŒÙˆØ²Ø±ØŒ Ø¨Ø§ÛŒØ¯ **Ù¾ÙˆÙ„** Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
3.  Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¯ÛŒØ±ØŒ Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒÛŒ Ù…Ø«Ù„ "ÛŒÚ© Ù…Ø§Ù‡Ù‡ Û³Û° Ú¯ÛŒÚ¯ = Û±Û°Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ù†" ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.
4.  Ø±ÛŒØ³Ù„Ø± Ø¢Ù† Ø¨Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ -\> Û±Û°Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ù† Ø§Ø² Ø­Ø³Ø§Ø¨Ø´ Ú©Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ -\> Ø§Ú©Ø§Ù†Øª Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -\> Ø¯Ø± Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.
5.  Ø§Ú¯Ø± Ø±ÛŒØ³Ù„Ø± Ø¨Ø®ÙˆØ§Ù‡Ø¯ "Ø¯Ù„Ø®ÙˆØ§Ù‡" Ø¨Ø³Ø§Ø²Ø¯ØŒ Ø³ÛŒØ³ØªÙ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯: (Û³Û° Ø±ÙˆØ² Ã— ÛµÛ°Û° ØªÙˆÙ…Ù†) + (Û±Û° Ú¯ÛŒÚ¯ Ã— Û²Û°Û°Û° ØªÙˆÙ…Ù†) = Û³Ûµ Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ù† Ú©Ø³Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.

**Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…Ø§Ù† Ú†ÛŒØ²ÛŒ Ø§Ø³Øª Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ø³ØªÛŒØ¯ØŸ** Ø§Ú¯Ø± Ø¨Ù„Ù‡ØŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ Ùˆ Ú©Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯.