{% extends "base.html" %}

{% block title %}Settings - Eve Manager{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="settings-layout">
    <div class="settings-sidebar">
        <button class="settings-tab" onclick="switchTab('general')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            General
        </button>
        <button class="settings-tab active" onclick="switchTab('templates')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            Notification Templates
        </button>
        <button class="settings-tab" onclick="switchTab('renew_template')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-2.64-6.36"></path><polyline points="21 3 21 9 15 9"></polyline><path d="M12 7v5l4 2"></path></svg>
            Renew Template
        </button>
        <button class="settings-tab" onclick="switchTab('backups')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Backup & Restore
        </button>
        <button class="settings-tab" onclick="switchTab('telegram_backup')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2L15 22l-4-9-9-4 20-7z"></path></svg>
            Telegram Backup
        </button>
        <button class="settings-tab" onclick="switchTab('whatsapp')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.5 8.5 0 0 1-12.38 7.55L3 21l1.98-5.44A8.5 8.5 0 1 1 21 11.5z"></path></svg>
            WhatsApp
        </button>
        <button class="settings-tab" onclick="switchTab('ssl')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            SSL Settings
        </button>
        <button class="settings-tab" onclick="switchTab('session')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            Session Settings
        </button>
        <button class="settings-tab" onclick="switchTab('health_logs')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="9 15 12 12 15 15"></polyline></svg>
            System Logs
        </button>
        <!-- Add more tabs here later -->
    </div>

    <div class="settings-content">
        <div id="tab-general" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>General</h2>
                        <p class="text-secondary">General application preferences.</p>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Theme</label>
                    <div class="refresh-toggle" style="gap: 10px;">
                        <label class="toggle-switch" style="margin: 0;">
                            <input type="checkbox" id="theme-toggle" onchange="handleThemeToggleChange(this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label" id="theme-toggle-text">Light</span>
                    </div>
                    <small class="text-secondary">Switch between Dark and Light mode.</small>
                </div>

                <div class="form-group" style="margin-top: 18px; margin-bottom: 0;">
                    <label>Panel Language</label>
                    <select id="general-panel-lang" class="form-select">
                        <option value="en">English</option>
                        <option value="fa">فارسی (Persian)</option>
                    </select>
                    <small class="text-secondary">Controls dashboard status language in the admin panel.</small>
                </div>

                <div class="form-group" style="margin-top: 18px; margin-bottom: 0;">
                    <label>Subscription Page Language</label>
                    <select id="subscription-page-lang" class="form-select" onchange="saveSubscriptionPageSettings()">
                        <option value="en">English</option>
                        <option value="fa">Persian (فارسی)</option>
                    </select>
                    <small class="text-secondary">Controls the public subscription page language shown to clients.</small>
                </div>

                <div class="form-group" style="margin-top: 18px; margin-bottom: 0;">
                    <label>TimeZone</label>
                    <select id="general-timezone" class="form-select"></select>
                    <small class="text-secondary">IANA timezone. Example: Asia/Tehran, Europe/Berlin, UTC</small>
                </div>

                <div class="form-group" style="margin-top: 18px; margin-bottom: 0;">
                    <label>Near Expiry Threshold</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <input type="number" id="general-near-expiry-days" class="form-input" min="0" max="365" value="3" placeholder="Days">
                            <small class="text-secondary">Days</small>
                        </div>
                        <div>
                            <input type="number" id="general-near-expiry-hours" class="form-input" min="0" max="23" value="0" placeholder="Hours">
                            <small class="text-secondary">Hours</small>
                        </div>
                    </div>
                    <small class="text-secondary">Clients with remaining time less than this are marked as: انقضا نزدیکه</small>
                </div>

                <div class="form-group" style="margin-top: 18px; margin-bottom: 0;">
                    <label>Low Volume Threshold (GB)</label>
                    <input type="number" id="general-low-volume-gb" class="form-input" min="0.1" max="1024" step="0.1" value="1">
                    <small class="text-secondary">Clients with remaining volume less than this are marked as: حجم رو به اتمامه</small>
                </div>

                <div class="form-group" style="margin-top: 16px; margin-bottom: 0;">
                    <button class="btn btn-primary" onclick="saveGeneralSettings()">Save</button>
                </div>
            </div>
        </div>

        <div id="tab-templates" class="tab-pane active">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Client Created Notification</h2>
                        <p class="text-secondary">Customize the message sent to clients when a new account is created.</p>
                    </div>
                    <button class="btn btn-primary" onclick="openTemplateModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Template
                    </button>
                </div>
                <div class="templates-grid" id="templates-container">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>

        <div id="tab-renew_template" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Renew Template</h2>
                        <p class="text-secondary">Customize the copy text shown after a successful renew. Supports variables like {email}, {days_label}, {volume_label}, {date}.</p>
                    </div>
                    <button class="btn btn-primary" onclick="openRenewTemplateModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Template
                    </button>
                </div>
                <div class="templates-grid" id="renew-templates-container">
                    <!-- Renew Templates will be loaded here -->
                </div>
            </div>
        </div>

        <div id="tab-backups" class="tab-pane">
            <!-- Auto Backup Settings -->
            <div class="panel-card" style="margin-bottom: 24px;">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Automatic Backup</h2>
                        <p class="text-secondary">Configure scheduled backups for your database.</p>
                    </div>
                </div>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <div class="form-group" style="margin-bottom: 0; flex: 1; max-width: 300px;">
                        <label>Backup Frequency</label>
                        <select id="backup-frequency" class="form-select" onchange="saveBackupSettings()">
                            <option value="disabled">Disabled</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Backup List -->
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Database Backups</h2>
                        <p class="text-secondary">Manage your system and uploaded backups.</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div class="file-upload-wrapper" id="backup-upload-container" style="width: 280px;">
                            <div class="file-upload-btn" id="backup-upload-btn">
                                <span class="btn-text">Choose File</span>
                                <span class="btn-loading hidden">
                                    <svg class="animate-spin" width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Uploading...
                                </span>
                            </div>
                            <div class="file-upload-text" id="backup-file-name">No file chosen</div>
                            <input type="file" id="upload-backup-input" class="file-upload-input" accept=".db,.dump,.sql" onchange="handleUpload(this)">
                        </div>
                        <button class="btn btn-primary" onclick="createBackup()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Create Backup
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backups-table-body">
                            <!-- Backups will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-telegram_backup" class="tab-pane">
            <div class="panel-card" style="margin-bottom: 24px;">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Telegram Backup</h2>
                        <p class="text-secondary">Send X-UI panel backups to Telegram on a schedule.</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-secondary" onclick="testTelegramBackupSettings(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
                            Test Connection
                        </button>
                        <button class="btn btn-primary" onclick="triggerTelegramBackupNow(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2L15 22l-4-9-9-4 20-7z"></path></svg>
                            Backup Now
                        </button>
                    </div>
                </div>

                <div id="telegram-backup-progress" style="display:none; margin-top: 10px;">
                    <div style="width: 100%; background: var(--panel-bg); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; overflow: hidden;">
                        <div id="telegram-backup-progress-bar" style="height: 8px; width: 0%; background: var(--primary);"></div>
                    </div>
                    <div id="telegram-backup-progress-text" style="margin-top: 6px; font-size: 0.85rem; color: var(--text-secondary);">Waiting...</div>
                </div>

                <div class="form-group">
                    <label>Enable Telegram Backup</label>
                    <div class="refresh-toggle" style="gap: 10px;">
                        <label class="toggle-switch" style="margin: 0;">
                            <input type="checkbox" id="telegram-backup-enabled">
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">Enabled</span>
                    </div>
                    <small class="text-secondary">When enabled, backups are pulled from each X-UI panel.</small>
                </div>

                <div class="form-group">
                    <label>Interval (Minutes)</label>
                    <input type="number" id="telegram-backup-interval" class="form-control" min="1" max="1440" value="60">
                    <small class="text-secondary">How often to run the scheduled backup.</small>
                </div>

                <div class="form-group">
                    <label>Bot Token</label>
                    <input type="text" id="telegram-backup-token" class="form-control" placeholder="123456:ABC-DEF" spellcheck="false" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>Chat ID</label>
                    <input type="text" id="telegram-backup-chat-id" class="form-control" placeholder="-1001234567890" spellcheck="false" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>Use SOCKS Proxy</label>
                    <div class="refresh-toggle" style="gap: 10px;">
                        <label class="toggle-switch" style="margin: 0;">
                            <input type="checkbox" id="telegram-backup-use-proxy">
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">SOCKS</span>
                    </div>
                    <small class="text-secondary">Use a SOCKS proxy for Telegram requests.</small>
                </div>

                <div class="form-group">
                    <label>SOCKS Proxy Mode</label>
                    <select id="telegram-backup-proxy-mode" class="form-select" onchange="updateTelegramProxyModeUI()">
                        <option value="url">URL</option>
                        <option value="hostport">Host &amp; Port</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>SOCKS Proxy URL</label>
                    <input type="text" id="telegram-backup-proxy" class="form-control" placeholder="socks5h://127.0.0.1:1080" spellcheck="false" autocomplete="off" oninput="updateTelegramProxyModeUI()">
                </div>

                <div class="form-group">
                    <label>SOCKS Host</label>
                    <input type="text" id="telegram-backup-proxy-host" class="form-control" placeholder="127.0.0.1" spellcheck="false" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>SOCKS Port</label>
                    <input type="number" id="telegram-backup-proxy-port" class="form-control" placeholder="1080" min="1" max="65535">
                </div>

                <div class="form-group">
                    <label>SOCKS Username</label>
                    <input type="text" id="telegram-backup-proxy-username" class="form-control" placeholder="username" spellcheck="false" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>SOCKS Password</label>
                    <input type="password" id="telegram-backup-proxy-password" class="form-control" placeholder="password" spellcheck="false" autocomplete="off">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label>Last Run (Jalali)</label>
                    <div id="telegram-backup-last-run" class="text-secondary">Never</div>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveTelegramBackupSettings()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Save Settings
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-whatsapp" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>WhatsApp Automation</h2>
                        <p class="text-secondary">Configure gateway, authentication flow, triggers, and safety limits.</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="wa-auto-setup" class="btn btn-secondary" onclick="autoConfigureWhatsAppGatewaySettings()">
                            Auto Setup
                        </button>
                        <button id="wa-test-connection" class="btn btn-secondary" onclick="testWhatsAppConnectionSettings()">
                            Test Connection
                        </button>
                        <button id="wa-open-auth" class="btn btn-primary" onclick="openWhatsAppAuthWizard()">
                            Open Auth Wizard
                        </button>
                    </div>
                </div>

                <div id="wa-region-warning" class="form-group" style="display:none; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px;">
                    <strong>Unavailable on Iran deployment:</strong>
                    <div style="margin-top: 4px;">If the panel is deployed in Iran, WhatsApp automation cannot be used.</div>
                </div>

                <div class="form-group">
                    <label>Deployment Region</label>
                    <select id="wa-deployment-region" class="form-select" onchange="applyWhatsAppRegionStateSettings()">
                        <option value="outside" {% if whatsapp_deployment_region != 'iran' %}selected{% endif %}>Outside Iran</option>
                        <option value="iran" {% if whatsapp_deployment_region == 'iran' %}selected{% endif %}>Iran</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Provider</label>
                    <select id="wa-provider" class="form-select">
                        <option value="baileys" {% if whatsapp_provider == 'baileys' %}selected{% endif %}>Baileys</option>
                        <option value="cloud" {% if whatsapp_provider == 'cloud' %}selected{% endif %}>WhatsApp Cloud API</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Gateway URL</label>
                    <input type="text" id="wa-gateway-url" class="form-control" value="{{ whatsapp_gateway_url }}" placeholder="https://wa-gateway.example.com">
                    <small class="text-secondary">If you do not know this value, click <strong>Auto Setup</strong>. Manual value is optional.</small>
                </div>

                <div class="form-group">
                    <label>Gateway API Key (optional)</label>
                    <input type="text" id="wa-gateway-api-key" class="form-control" value="{{ whatsapp_gateway_api_key }}" placeholder="Bearer token">
                </div>

                <div class="form-group">
                    <label>Gateway Timeout (seconds)</label>
                    <input type="number" id="wa-gateway-timeout" class="form-control" min="3" max="60" value="{{ whatsapp_gateway_timeout_seconds }}">
                </div>

                <div class="form-group">
                    <label>Enable WhatsApp Automation</label>
                    <div class="refresh-toggle" style="gap: 10px;">
                        <label class="toggle-switch" style="margin: 0;">
                            <input type="checkbox" id="wa-enabled" {% if whatsapp_enabled %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">Enabled</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Triggers</label>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <label class="checkbox-label" onclick="event.stopPropagation()">
                            <input type="checkbox" id="wa-trigger-renew" {% if whatsapp_trigger_renew_success %}checked{% endif %}>
                            <span class="checkmark"></span>
                            <span>After successful renewal</span>
                        </label>
                        <label class="checkbox-label" onclick="event.stopPropagation()">
                            <input type="checkbox" id="wa-trigger-welcome" {% if whatsapp_trigger_welcome %}checked{% endif %}>
                            <span class="checkmark"></span>
                            <span>Welcome message</span>
                        </label>
                        <label class="checkbox-label" onclick="event.stopPropagation()">
                            <input type="checkbox" id="wa-trigger-pre-expiry" {% if whatsapp_trigger_pre_expiry %}checked{% endif %}>
                            <span class="checkmark"></span>
                            <span>Pre-expiry reminder</span>
                        </label>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <div class="form-group">
                        <label>Min Interval (seconds)</label>
                        <input type="number" id="wa-min-interval" class="form-control" min="45" max="3600" value="{{ whatsapp_min_interval_seconds }}">
                    </div>
                    <div class="form-group">
                        <label>Daily Limit</label>
                        <input type="number" id="wa-daily-limit" class="form-control" min="1" max="50000" value="{{ whatsapp_daily_limit }}">
                    </div>
                    <div class="form-group">
                        <label>Pre-expiry (hours)</label>
                        <input type="number" id="wa-pre-expiry-hours" class="form-control" min="1" max="720" value="{{ whatsapp_pre_expiry_hours }}">
                    </div>
                    <div class="form-group">
                        <label>Retry Count</label>
                        <input type="number" id="wa-retry-count" class="form-control" min="0" max="10" value="{{ whatsapp_retry_count }}">
                    </div>
                    <div class="form-group">
                        <label>Backoff (seconds)</label>
                        <input type="number" id="wa-backoff-seconds" class="form-control" min="5" max="3600" value="{{ whatsapp_backoff_seconds }}">
                    </div>
                </div>

                <div class="form-group">
                    <label>Circuit Breaker</label>
                    <div class="refresh-toggle" style="gap: 10px;">
                        <label class="toggle-switch" style="margin: 0;">
                            <input type="checkbox" id="wa-circuit-breaker" {% if whatsapp_circuit_breaker %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">Enabled</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Renew Template</label>
                    <textarea id="wa-template-renew" class="form-input" rows="2">{{ whatsapp_template_renew }}</textarea>
                </div>
                <div class="form-group">
                    <label>Welcome Template</label>
                    <textarea id="wa-template-welcome" class="form-input" rows="2">{{ whatsapp_template_welcome }}</textarea>
                </div>
                <div class="form-group">
                    <label>Pre-expiry Template</label>
                    <textarea id="wa-template-pre-expiry" class="form-input" rows="2">{{ whatsapp_template_pre_expiry }}</textarea>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveWhatsAppSettings()">Save WhatsApp Settings</button>
                </div>
            </div>
        </div>

        <div id="tab-ssl" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>SSL Configuration</h2>
                        <p class="text-secondary">Configure SSL certificate paths for HTTPS.</p>
                    </div>
                    <button class="btn btn-primary" onclick="saveSSLSettings()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Save Settings
                    </button>
                </div>
                <div class="form-group">
                    <label>Public Key Path (Certificate)</label>
                    <input type="text" id="ssl-cert-path" class="form-control" placeholder="/etc/ssl/certs/your_cert.crt">
                    <small class="text-secondary">Absolute path to your .crt or .pem file</small>
                </div>
                <div class="form-group">
                    <label>Private Key Path</label>
                    <input type="text" id="ssl-key-path" class="form-control" placeholder="/etc/ssl/private/your_key.key">
                    <small class="text-secondary">Absolute path to your .key file</small>
                </div>
            </div>
        </div>

        <div id="tab-session" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Session Timeout</h2>
                        <p class="text-secondary">Configure how long a user stays logged in.</p>
                    </div>
                    <button class="btn btn-primary" onclick="saveSessionSettings()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Save Settings
                    </button>
                </div>
                <div class="form-group">
                    <label>Session Timeout (Hours)</label>
                    <input type="number" id="session-timeout" class="form-control" min="1" value="168">
                    <small class="text-secondary">Default is 168 hours (7 days). Set to a higher value to keep users logged in longer.</small>
                </div>
            </div>
        </div>

        <!-- System Logs / Health Check tab -->
        <div id="tab-health_logs" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>System Health Logs</h2>
                        <p class="text-secondary">Self-healing watchdog monitors DB, servers, disk &amp; static files every 60 s.</p>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="runHealthCheckNow()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                            Run Check Now
                        </button>
                        <button class="btn btn-secondary" onclick="loadHealthLogs()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.12-9.36L1 10"></path></svg>
                            Refresh
                        </button>
                        <button class="btn btn-danger" onclick="clearHealthLogs()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-2 14H7L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path></svg>
                            Clear Logs
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center;">
                    <select id="hl-filter-level" class="form-control" style="width:auto;min-width:120px;" onchange="loadHealthLogs()">
                        <option value="">All Levels</option>
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                        <option value="critical">Critical</option>
                    </select>
                    <select id="hl-filter-category" class="form-control" style="width:auto;min-width:140px;" onchange="loadHealthLogs()">
                        <option value="">All Categories</option>
                        <option value="general">General</option>
                        <option value="db">Database</option>
                        <option value="server">Server</option>
                        <option value="static">Static Files</option>
                        <option value="disk">Disk</option>
                    </select>
                    <span id="hl-total-badge" class="text-secondary" style="font-size:0.85rem;"></span>
                </div>

                <!-- Last manual check results -->
                <div id="hl-check-result" class="hidden" style="margin-bottom:14px;padding:12px 16px;border-radius:8px;font-size:0.9rem;"></div>

                <!-- Logs table -->
                <div style="overflow-x:auto;">
                    <table class="data-table" id="health-logs-table">
                        <thead>
                            <tr>
                                <th style="width:170px;">Time</th>
                                <th style="width:90px;">Level</th>
                                <th style="width:100px;">Category</th>
                                <th>Message</th>
                                <th style="width:220px;">Action Taken</th>
                            </tr>
                        </thead>
                        <tbody id="hl-tbody">
                            <tr><td colspan="5" class="text-secondary" style="text-align:center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="hl-pagination" style="display:flex;justify-content:center;gap:8px;margin-top:14px;flex-wrap:wrap;"></div>
            </div>
        </div>

    </div>
</div>

<div class="modal-overlay hidden" id="template-modal">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 id="template-modal-title">Add Template</h2>
            <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-template-id">
            <div class="form-group">
                <label>Template Name</label>
                <input type="text" id="template-name" class="form-input" placeholder="e.g. Persian Default">
            </div>
            <div class="form-group">
                <label>Content</label>
                <div class="variables-chips">
                    <span class="var-chip" onclick="insertVar('{protocol}')">{protocol}</span>
                    <span class="var-chip" onclick="insertVar('{service_name}')">{service_name}</span>
                    <span class="var-chip" onclick="insertVar('{volume}')">{volume}</span>
                    <span class="var-chip" onclick="insertVar('{days}')">{days}</span>
                    <span class="var-chip" onclick="insertVar('{sub_link}')">{sub_link}</span>
                    <span class="var-chip" onclick="insertVar('{dashboard_link}')">{dashboard_link}</span>
                </div>
                <textarea id="template-content" class="form-input" rows="15" style="font-family: 'Vazirmatn', sans-serif; direction: rtl;"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeTemplateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="renew-template-modal">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 id="renew-template-modal-title">Add Renew Template</h2>
            <button class="modal-close" onclick="closeRenewTemplateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-renew-template-id">
            <div class="form-group">
                <label>Template Name</label>
                <input type="text" id="renew-template-name" class="form-input" placeholder="e.g. Persian Renew">
            </div>
            <div class="form-group">
                <label>Content</label>
                <div class="variables-chips" id="renew-modal-vars">
                    <span class="var-chip" onclick="insertRenewVar('{email}')">{email}</span>
                    <span class="var-chip" onclick="insertRenewVar('{days_label}')">{days_label}</span>
                    <span class="var-chip" onclick="insertRenewVar('{volume_label}')">{volume_label}</span>
                    <span class="var-chip" onclick="insertRenewVar('{date}')">{date}</span>
                    <span class="var-chip" onclick="insertRenewVar('{dashboard_link}')">{dashboard_link}</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <textarea id="renew-template-content" class="form-input" rows="15" style="font-family: 'Vazirmatn', sans-serif; direction: rtl;" oninput="updateRenewModalPreview(this.value)"></textarea>
                    <div class="renew-template-preview" id="renew-modal-preview" style="height: 100%; margin-top: 0;">
                        <span class="renew-preview-hint">Preview appears here...</span>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeRenewTemplateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRenewTemplate()">Save Template</button>
            </div>
        </div>
    </div>
</div>

<style nonce="{{ csp_nonce }}">
    .settings-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 24px;
        align-items: start;
    }
    
    @media (max-width: 768px) {
        .settings-layout {
            grid-template-columns: 1fr;
        }
    }

    .settings-sidebar {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--border-color);
    }

    .settings-tab {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 12px 16px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        font-size: 0.9rem;
        margin-bottom: 8px;
    }

    .settings-tab:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
    }

    .settings-tab.active {
        background: rgba(99, 102, 241, 0.15);
        color: var(--primary);
        font-weight: 500;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    /* Header Styles */
    .panel-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .header-content h2 {
        margin: 0 0 4px 0;
        font-size: 1.5rem;
    }

    .header-content p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Grid Layout */
    .templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    /* Bank Card Style */
    .template-card {
        background: linear-gradient(145deg, var(--bg-card), rgba(30, 41, 59, 0.8));
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        position: relative;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    html[data-theme="light"] .template-card {
        background: var(--bg-card);
        box-shadow: var(--shadow);
    }

    .template-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-color: var(--primary);
    }

    html[data-theme="light"] .template-card:hover {
        box-shadow: var(--shadow-lg);
    }

    .template-card.active {
        border-color: var(--success);
        box-shadow: 0 0 0 1px var(--success), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    html[data-theme="light"] .template-card.active {
        box-shadow: 0 0 0 1px var(--success), var(--shadow-lg);
    }

    /* Decorative top bar */
    .template-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--border-color);
        transition: background 0.3s;
    }

    .template-card.active::before {
        background: var(--success);
    }

    .template-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .template-title {
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .active-badge {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 12px;
        width: fit-content;
        display: inline-block;
    }

    html[data-theme="light"] .active-badge {
        background: rgba(34, 197, 94, 0.12);
        box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.25);
    }

    .template-preview {
        background: rgba(0, 0, 0, 0.2);
        padding: 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        white-space: pre-wrap;
        max-height: 120px;
        overflow: hidden;
        margin-bottom: 16px;
        font-family: 'Vazirmatn', sans-serif;
        direction: rtl;
        flex-grow: 1;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    html[data-theme="light"] .template-preview {
        background: var(--bg-dark);
        border-color: var(--border-color);
        color: var(--text-secondary);
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        transition: opacity 0.2s;
    }

    .template-card:hover .action-buttons {
        opacity: 1;
    }

    .variables-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
    }

    .var-chip {
        background: var(--bg-dark);
        border: 1px solid var(--border-color);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        color: var(--primary);
        cursor: pointer;
        transition: all 0.2s;
    }

    html[data-theme="light"] .var-chip {
        background: var(--bg-card);
    }

    .var-chip:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Badge Styles */
    .badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .badge-info { background: rgba(56, 189, 248, 0.15); color: #38bdf8; }
    .badge-success { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .badge-warning { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .badge-secondary { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }

    /* Vazirmatn font for forms */
    .form-input, .form-select, .form-control, label, .modal-body {
        font-family: 'Vazirmatn', sans-serif !important;
    }
    
    /* Spinner animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Custom File Upload Style - Redesigned */
    .file-upload-wrapper {
        position: relative;
        display: flex;
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        background-color: var(--bg-dark);
        transition: all 0.2s;
        height: 46px;
    }
    .file-upload-wrapper:hover {
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary);
    }
    .file-upload-wrapper.uploading {
        pointer-events: none;
        opacity: 0.8;
    }
    .file-upload-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 0 20px;
        background-color: var(--bg-card-hover);
        color: var(--text-primary);
        font-size: 0.9rem;
        font-weight: 500;
        border-right: 1px solid var(--border-color);
        white-space: nowrap;
        transition: background-color 0.2s;
        flex-shrink: 0;
        min-width: 130px;
    }
    .file-upload-btn.loading {
        background-color: rgba(99, 102, 241, 0.15);
        color: var(--primary);
        pointer-events: none;
    }
    .file-upload-btn .btn-text,
    .file-upload-btn .btn-loading {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .file-upload-btn .btn-loading.hidden,
    .file-upload-btn.loading .btn-text {
        display: none;
    }
    .file-upload-btn.loading .btn-loading {
        display: flex;
    }
    .file-upload-wrapper:hover .file-upload-btn {
        background-color: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }
    .file-upload-text {
        flex-grow: 1;
        display: flex;
        align-items: center;
        padding: 0 16px;
        color: var(--text-secondary);
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }
    .file-upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 10;
    }
    .upload-spinner-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        backdrop-filter: blur(2px);
        gap: 10px;
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    .upload-spinner-overlay svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
    }

    /* Table Styles */
    .table-responsive {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .table th {
        text-align: left;
        padding: 12px 16px;
        color: var(--text-secondary);
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
    }

    .table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .table tr:last-child td {
        border-bottom: none;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
    }

    .action-btn {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        opacity: 0.9;
    }

    .action-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        opacity: 1;
    }

    .action-btn.warning:hover {
        background: var(--warning);
        border-color: var(--warning);
        color: white;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .action-btn.danger:hover {
        background: var(--danger);
        border-color: var(--danger);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .renew-card {
        background: linear-gradient(140deg, var(--bg-card), rgba(15, 23, 42, 0.85));
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
        transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
    }

    .renew-card:hover {
        border-color: var(--primary);
        transform: translateY(-4px);
        box-shadow: 0 25px 55px rgba(15, 23, 42, 0.35);
    }

    .renew-card-header {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        align-items: flex-start;
        flex-wrap: wrap;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding-bottom: 18px;
        margin-bottom: 20px;
    }

    .renew-card-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .renew-status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--success);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.25);
    }

    .renew-status-subtext {
        margin: 0;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .renew-card-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .renew-card-actions .btn {
        min-width: 120px;
    }

    .renew-card-body {
        margin-bottom: 20px;
    }

    .renew-label {
        display: block;
        margin-bottom: 10px;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
    }

    html[data-theme="light"] .renew-label {
        color: var(--text-secondary);
    }

    .renew-template-preview {
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 16px;
        min-height: 140px;
        color: var(--text-primary);
        font-size: 0.95rem;
        line-height: 1.7;
        white-space: pre-wrap;
        font-family: 'Vazirmatn', sans-serif;
        position: relative;
        overflow: auto;
    }

    html[data-theme="light"] .renew-template-preview {
        background: var(--bg-dark);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .renew-preview-hint {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    .renew-card-footer {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .renew-vars-label {
        font-size: 0.82rem;
        color: var(--text-secondary);
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }

    .renew-vars-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .renew-vars-chips button {
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 6px 14px;
        background: rgba(99, 102, 241, 0.12);
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: 'Vazirmatn', sans-serif;
    }

    .renew-vars-chips button:hover {
        background: rgba(99, 102, 241, 0.22);
        border-color: rgba(99, 102, 241, 0.5);
        color: var(--primary);
    }

    @media (max-width: 640px) {
        .renew-card {
            padding: 18px;
        }

        .renew-card-header {
            flex-direction: column;
        }

        .renew-card-actions {
            width: 100%;
            justify-content: flex-end;
        }

        .renew-card-actions .btn {
            flex: 1;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
        syncThemeToggleUI();

        const activeTab = document.querySelector('.settings-tab.active');
        if (activeTab) {
            const onclick = activeTab.getAttribute('onclick');
            if (onclick.includes("'general'")) syncThemeToggleUI();
            else if (onclick.includes("'templates'")) loadTemplates();
            else if (onclick.includes("'renew_template'")) loadRenewTemplates();
            else if (onclick.includes("'backups'")) { loadBackups(); loadBackupSettings(); }
            else if (onclick.includes("'telegram_backup'")) loadTelegramBackupSettings();
            else if (onclick.includes("'whatsapp'")) loadWhatsAppSettings();
            else if (onclick.includes("'ssl'")) loadSSLSettings();
            else if (onclick.includes("'session'")) loadSessionSettings();
            else if (onclick.includes("'health_logs'")) loadHealthLogs();
        }
    });

    function getSavedTheme() {
        try {
            const t = localStorage.getItem('eve_theme');
            return (t === 'light' || t === 'dark') ? t : 'dark';
        } catch (e) {
            return 'dark';
        }
    }

    function applyTheme(theme) {
        const t = (theme === 'light' || theme === 'dark') ? theme : 'dark';
        document.documentElement.dataset.theme = t;
        try {
            localStorage.setItem('eve_theme', t);
        } catch (e) {
            // Ignore storage errors
        }
    }

    function syncThemeToggleUI() {
        const theme = getSavedTheme();
        const toggle = document.getElementById('theme-toggle');
        const label = document.getElementById('theme-toggle-text');
        if (toggle) toggle.checked = theme === 'light';
        if (label) label.textContent = theme === 'light' ? 'Light' : 'Dark';
    }

    function handleThemeToggleChange(isLight) {
        applyTheme(isLight ? 'light' : 'dark');
        syncThemeToggleUI();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        
        event.currentTarget.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');

        if (tabName === 'general') {
            loadGeneralSettings();
        } else if (tabName === 'backups') {
            loadBackups();
            loadBackupSettings();
        } else if (tabName === 'telegram_backup') {
            loadTelegramBackupSettings();
        } else if (tabName === 'whatsapp') {
            loadWhatsAppSettings();
        } else if (tabName === 'ssl') {
            loadSSLSettings();
        } else if (tabName === 'session') {
            loadSessionSettings();
        } else if (tabName === 'renew_template') {
            loadRenewTemplates();
        } else if (tabName === 'templates') {
            loadTemplates();
        } else if (tabName === 'health_logs') {
            loadHealthLogs();
        }
    }

    function loadWhatsAppSettings() {
        applyWhatsAppRegionStateSettings();
        const region = (document.getElementById('wa-deployment-region') || {}).value || 'outside';
        const gateway = ((document.getElementById('wa-gateway-url') || {}).value || '').trim();
        if (region !== 'iran' && !gateway) {
            autoConfigureWhatsAppGatewaySettings({ silent: true }).catch(() => {});
        }
    }

    function applyWhatsAppRegionStateSettings() {
        const regionSelect = document.getElementById('wa-deployment-region');
        const warningBox = document.getElementById('wa-region-warning');
        if (!regionSelect || !warningBox) return;

        const isIran = regionSelect.value === 'iran';
        warningBox.style.display = isIran ? '' : 'none';

        const guardedIds = [
            'wa-provider',
            'wa-gateway-url',
            'wa-gateway-api-key',
            'wa-gateway-timeout',
            'wa-enabled',
            'wa-trigger-renew',
            'wa-trigger-welcome',
            'wa-trigger-pre-expiry',
            'wa-min-interval',
            'wa-daily-limit',
            'wa-pre-expiry-hours',
            'wa-retry-count',
            'wa-backoff-seconds',
            'wa-circuit-breaker',
            'wa-template-renew',
            'wa-template-welcome',
            'wa-template-pre-expiry',
            'wa-auto-setup',
            'wa-test-connection',
            'wa-open-auth'
        ];

        guardedIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.disabled = isIran;
        });

        if (isIran) {
            const enabled = document.getElementById('wa-enabled');
            if (enabled) enabled.checked = false;
        }
    }

    async function saveWhatsAppSettings() {
        const region = (document.getElementById('wa-deployment-region') || {}).value || 'outside';
        const isIran = region === 'iran';

        if (!isIran) {
            const gateway = ((document.getElementById('wa-gateway-url') || {}).value || '').trim();
            if (!gateway) {
                const setup = await autoConfigureWhatsAppGatewaySettings({ silent: true });
                if (!setup.success) {
                    showToast('WhatsApp gateway آماده نیست. لطفاً چند دقیقه بعد دوباره تلاش کنید.', 'error');
                    return;
                }
            }
        }

        const payload = {
            whatsapp_deployment_region: region,
            whatsapp_provider: (document.getElementById('wa-provider') || {}).value || 'baileys',
            whatsapp_gateway_url: (document.getElementById('wa-gateway-url') || {}).value || '',
            whatsapp_gateway_api_key: (document.getElementById('wa-gateway-api-key') || {}).value || '',
            whatsapp_gateway_timeout_seconds: Number((document.getElementById('wa-gateway-timeout') || {}).value || 10),
            whatsapp_enabled: isIran ? false : !!(document.getElementById('wa-enabled') || {}).checked,
            whatsapp_trigger_renew_success: !!(document.getElementById('wa-trigger-renew') || {}).checked,
            whatsapp_trigger_welcome: !!(document.getElementById('wa-trigger-welcome') || {}).checked,
            whatsapp_trigger_pre_expiry: !!(document.getElementById('wa-trigger-pre-expiry') || {}).checked,
            whatsapp_min_interval_seconds: Number((document.getElementById('wa-min-interval') || {}).value || 45),
            whatsapp_daily_limit: Number((document.getElementById('wa-daily-limit') || {}).value || 100),
            whatsapp_pre_expiry_hours: Number((document.getElementById('wa-pre-expiry-hours') || {}).value || 24),
            whatsapp_retry_count: Number((document.getElementById('wa-retry-count') || {}).value || 3),
            whatsapp_backoff_seconds: Number((document.getElementById('wa-backoff-seconds') || {}).value || 30),
            whatsapp_circuit_breaker: !!(document.getElementById('wa-circuit-breaker') || {}).checked,
            whatsapp_template_renew: (document.getElementById('wa-template-renew') || {}).value || '',
            whatsapp_template_welcome: (document.getElementById('wa-template-welcome') || {}).value || '',
            whatsapp_template_pre_expiry: (document.getElementById('wa-template-pre-expiry') || {}).value || '',
        };

        try {
            const res = await fetch('/api/system-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data && data.success) {
                if (data.warning) showToast(data.warning, 'warning');
                else showToast('WhatsApp settings saved');
                applyWhatsAppRegionStateSettings();
            } else {
                showToast((data && data.error) ? data.error : 'Error saving settings', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function testWhatsAppConnectionSettings() {
        const region = (document.getElementById('wa-deployment-region') || {}).value || 'outside';
        if (region === 'iran') {
            showToast('Server region is Iran. WhatsApp automation is unavailable.', 'warning');
            return;
        }

        const gateway = ((document.getElementById('wa-gateway-url') || {}).value || '').trim();
        if (!gateway) {
            const setup = await autoConfigureWhatsAppGatewaySettings({ silent: true });
            if (!setup.success) {
                showToast('اتصال خودکار به WhatsApp gateway انجام نشد. لطفاً بعداً دوباره تست بزنید.', 'error');
                return;
            }
        }

        try {
            const res = await fetch('/api/whatsapp/test-connection', { method: 'POST' });
            const data = await res.json();
            if (data && data.success) {
                showToast('WhatsApp gateway is reachable');
            } else {
                showToast((data && (data.error || data.message)) ? (data.error || data.message) : 'Gateway test failed', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function autoConfigureWhatsAppGatewaySettings(options = {}) {
        const region = (document.getElementById('wa-deployment-region') || {}).value || 'outside';
        if (region === 'iran') {
            showToast('Server region is Iran. WhatsApp automation is unavailable.', 'warning');
            return { success: false };
        }

        const autoBtn = document.getElementById('wa-auto-setup');
        const silent = !!(options && options.silent);
        const originalText = autoBtn ? autoBtn.textContent : '';

        try {
            if (autoBtn) {
                autoBtn.disabled = true;
                autoBtn.textContent = 'Detecting...';
            }

            const res = await fetch('/api/whatsapp/auto-configure', { method: 'POST' });
            const data = await res.json();

            if (data && data.success && data.gateway_url) {
                const gatewayInput = document.getElementById('wa-gateway-url');
                if (gatewayInput) gatewayInput.value = data.gateway_url;
                if (!silent) showToast('Gateway configured automatically');
                return { success: true, gateway_url: data.gateway_url, auth_url: data.auth_url || '' };
            }

            if (!silent) {
                const message = (data && data.error)
                    ? String(data.error)
                    : 'تنظیم خودکار WhatsApp gateway انجام نشد. لطفاً کمی بعد دوباره تلاش کنید.';
                showToast(message, 'error');
            }
            return { success: false };
        } catch (e) {
            if (!silent) showToast('Network error during auto setup', 'error');
            return { success: false };
        } finally {
            if (autoBtn) {
                autoBtn.disabled = false;
                autoBtn.textContent = originalText || 'Auto Setup';
            }
        }
    }

    async function openWhatsAppAuthWizard() {
        const region = (document.getElementById('wa-deployment-region') || {}).value || 'outside';
        if (region === 'iran') {
            showToast('Server region is Iran. WhatsApp automation is unavailable.', 'warning');
            return;
        }

        let raw = ((document.getElementById('wa-gateway-url') || {}).value || '').trim();
        if (!raw) {
            const setup = await autoConfigureWhatsAppGatewaySettings({ silent: true });
            if (!setup.success) {
                showToast('Gateway URL not found automatically. Please run Auto Setup or set it manually.', 'error');
                return;
            }
            raw = (setup.gateway_url || '').trim();
        }

        const base = raw.endsWith('/') ? raw.slice(0, -1) : raw;
        const authUrl = `${base}/auth`;
        window.open(authUrl, '_blank', 'noopener,noreferrer');
        showToast('Auth wizard opened in a new tab');
    }

    function loadGeneralSettings() {
        syncThemeToggleUI();
        loadAppGeneralSettings();
        loadSubscriptionPageSettings();
    }

    async function loadAppGeneralSettings() {
        try {
            const res = await fetch('/api/settings/general');
            const data = await res.json();
            if (data && data.success) {
                applyTimezoneOptions('general-timezone', Array.isArray(data.timezone_options) ? data.timezone_options : []);
                const input = document.getElementById('general-timezone');
                if (input) input.value = data.timezone || 'Asia/Tehran';

                const panelLangSel = document.getElementById('general-panel-lang');
                if (panelLangSel) panelLangSel.value = (data.panel_lang === 'fa') ? 'fa' : 'en';

                const nearDaysInput = document.getElementById('general-near-expiry-days');
                if (nearDaysInput) nearDaysInput.value = Number(data.near_expiry_days ?? 3);

                const nearHoursInput = document.getElementById('general-near-expiry-hours');
                if (nearHoursInput) nearHoursInput.value = Number(data.near_expiry_hours ?? 0);

                const lowVolumeInput = document.getElementById('general-low-volume-gb');
                if (lowVolumeInput) lowVolumeInput.value = Number(data.low_volume_gb ?? 1);
            }
        } catch (e) {
            console.error('Error loading general settings', e);
        }
    }

    async function saveGeneralSettings() {
        const input = document.getElementById('general-timezone');
        const timezone = ((input ? input.value : '') || 'Asia/Tehran').trim().replace(/\\/g, '/').replace(/\s+/g, '');
        const panelLang = (document.getElementById('general-panel-lang') || {}).value || 'en';
        const nearDays = parseInt((document.getElementById('general-near-expiry-days') || {}).value || '3', 10);
        const nearHours = parseInt((document.getElementById('general-near-expiry-hours') || {}).value || '0', 10);
        const lowVolumeGb = parseFloat((document.getElementById('general-low-volume-gb') || {}).value || '1');

        try {
            const res = await fetch('/api/settings/general', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    timezone,
                    panel_lang: (panelLang === 'fa') ? 'fa' : 'en',
                    near_expiry_days: Number.isFinite(nearDays) ? nearDays : 3,
                    near_expiry_hours: Number.isFinite(nearHours) ? nearHours : 0,
                    low_volume_gb: Number.isFinite(lowVolumeGb) ? lowVolumeGb : 1,
                })
            });
            const data = await res.json();
            if (data && data.success) {
                applyTimezoneOptions('general-timezone', Array.isArray(data.timezone_options) ? data.timezone_options : []);
                if (input) input.value = data.timezone || timezone;
                const panelLangSel = document.getElementById('general-panel-lang');
                if (panelLangSel) panelLangSel.value = (data.panel_lang === 'fa') ? 'fa' : 'en';
                const nearDaysInput = document.getElementById('general-near-expiry-days');
                if (nearDaysInput) nearDaysInput.value = Number(data.near_expiry_days ?? 3);

                const nearHoursInput = document.getElementById('general-near-expiry-hours');
                if (nearHoursInput) nearHoursInput.value = Number(data.near_expiry_hours ?? 0);

                const lowVolumeInput = document.getElementById('general-low-volume-gb');
                if (lowVolumeInput) lowVolumeInput.value = Number(data.low_volume_gb ?? 1);
                showToast('Settings saved');
            } else {
                showToast((data && data.error) ? data.error : 'Error saving settings', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    function applyTimezoneOptions(selectId, options) {
        const list = document.getElementById(selectId);
        if (!list) return;

        const current = String(list.value || '').trim();

        const unique = [];
        const seen = new Set();
        (Array.isArray(options) ? options : []).forEach((raw) => {
            const val = String(raw || '').trim();
            if (!val) return;
            const lower = val.toLowerCase();
            if (seen.has(lower)) return;
            seen.add(lower);
            unique.push(val);
        });

        list.innerHTML = unique.map((tz) => `<option value="${tz}">${tz}</option>`).join('');

        if (current && unique.includes(current)) {
            list.value = current;
        }
    }

    async function loadSubscriptionPageSettings() {
        try {
            const res = await fetch('/api/settings/subscription-page');
            const data = await res.json();
            if (data && data.success) {
                const sel = document.getElementById('subscription-page-lang');
                if (sel) sel.value = (data.lang === 'fa') ? 'fa' : 'en';
            }
        } catch (e) {
            console.error('Error loading subscription page settings', e);
        }
    }

    async function saveSubscriptionPageSettings() {
        const sel = document.getElementById('subscription-page-lang');
        const lang = sel ? sel.value : 'en';

        try {
            const res = await fetch('/api/settings/subscription-page', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ lang })
            });
            const data = await res.json();
            if (data && data.success) {
                showToast('Settings saved');
            } else {
                showToast((data && data.error) ? data.error : 'Error saving settings', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function loadSSLSettings() {
        try {
            const res = await fetch('/api/settings/ssl');
            const data = await res.json();
            if (data.success) {
                document.getElementById('ssl-cert-path').value = data.cert_path || '';
                document.getElementById('ssl-key-path').value = data.key_path || '';
            }
        } catch (e) {
            console.error('Error loading SSL settings', e);
        }
    }

    async function saveSSLSettings() {
        const certPath = document.getElementById('ssl-cert-path').value;
        const keyPath = document.getElementById('ssl-key-path').value;

        try {
            const res = await fetch('/api/settings/ssl', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    cert_path: certPath,
                    key_path: keyPath
                })
            });
            const data = await res.json();
            if (data.success) {
                showToast('SSL settings saved');
            } else {
                showToast(data.error || 'Error saving settings', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function loadBackupSettings() {
        try {
            const res = await fetch('/api/settings/backup');
            const data = await res.json();
            if (data.success) {
                document.getElementById('backup-frequency').value = data.frequency;
            }
        } catch (e) {
            console.error('Error loading settings', e);
        }
    }

    async function saveBackupSettings() {
        const freq = document.getElementById('backup-frequency').value;
        try {
            const res = await fetch('/api/settings/backup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ frequency: freq })
            });
            const data = await res.json();
            if (data.success) {
                showToast('Settings saved');
            } else {
                showToast('Error saving settings', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function loadTelegramBackupSettings() {
        try {
            const res = await fetch('/api/settings/telegram-backup');
            const data = await res.json();
            if (!data.success) return;

            const enabled = document.getElementById('telegram-backup-enabled');
            const interval = document.getElementById('telegram-backup-interval');
            const token = document.getElementById('telegram-backup-token');
            const chatId = document.getElementById('telegram-backup-chat-id');
            const useProxy = document.getElementById('telegram-backup-use-proxy');
            const proxyMode = document.getElementById('telegram-backup-proxy-mode');
            const proxy = document.getElementById('telegram-backup-proxy');
            const proxyHost = document.getElementById('telegram-backup-proxy-host');
            const proxyPort = document.getElementById('telegram-backup-proxy-port');
            const proxyUser = document.getElementById('telegram-backup-proxy-username');
            const proxyPass = document.getElementById('telegram-backup-proxy-password');
            const lastRun = document.getElementById('telegram-backup-last-run');

            if (enabled) enabled.checked = !!data.enabled;
            if (interval) interval.value = data.interval_minutes || 60;
            if (token) token.value = data.bot_token || '';
            if (chatId) chatId.value = data.chat_id || '';
            if (useProxy) useProxy.checked = !!data.use_proxy;
            if (proxyMode) proxyMode.value = data.proxy_mode || 'url';
            if (proxy) proxy.value = data.proxy_url || '';
            if (proxyHost) proxyHost.value = data.proxy_host || '';
            if (proxyPort) proxyPort.value = data.proxy_port || '';
            if (proxyUser) proxyUser.value = data.proxy_username || '';
            if (proxyPass) proxyPass.value = data.proxy_password || '';
            if (lastRun) lastRun.textContent = data.last_run_jalali || 'Never';

            updateTelegramProxyModeUI();
        } catch (e) {
            console.error('Error loading telegram backup settings', e);
        }
    }

    function updateTelegramProxyModeUI() {
        const mode = (document.getElementById('telegram-backup-proxy-mode') || {}).value || 'url';
        const urlGroup = document.getElementById('telegram-backup-proxy').closest('.form-group');
        const hostGroup = document.getElementById('telegram-backup-proxy-host').closest('.form-group');
        const portGroup = document.getElementById('telegram-backup-proxy-port').closest('.form-group');
        const usernameGroup = document.getElementById('telegram-backup-proxy-username').closest('.form-group');
        const passwordGroup = document.getElementById('telegram-backup-proxy-password').closest('.form-group');

        if (mode === 'hostport') {
            if (urlGroup) urlGroup.style.display = 'none';
            if (hostGroup) hostGroup.style.display = '';
            if (portGroup) portGroup.style.display = '';
            // Always show username/password in hostport mode
            if (usernameGroup) usernameGroup.style.display = '';
            if (passwordGroup) passwordGroup.style.display = '';
        } else {
            if (urlGroup) urlGroup.style.display = '';
            if (hostGroup) hostGroup.style.display = 'none';
            if (portGroup) portGroup.style.display = 'none';
            
            // In URL mode, check if URL already has credentials
            const proxyUrl = document.getElementById('telegram-backup-proxy').value || '';
            const hasCredentials = proxyUrl.includes('@');
            
            if (hasCredentials) {
                // URL has credentials, disable username/password fields
                if (usernameGroup) {
                    usernameGroup.style.display = '';
                    const input = document.getElementById('telegram-backup-proxy-username');
                    if (input) {
                        input.disabled = true;
                        input.placeholder = 'Credentials already in URL';
                        input.title = 'Username is already included in the proxy URL';
                    }
                }
                if (passwordGroup) {
                    passwordGroup.style.display = '';
                    const input = document.getElementById('telegram-backup-proxy-password');
                    if (input) {
                        input.disabled = true;
                        input.placeholder = 'Credentials already in URL';
                        input.title = 'Password is already included in the proxy URL';
                    }
                }
            } else {
                // URL doesn't have credentials, enable username/password fields
                if (usernameGroup) usernameGroup.style.display = '';
                if (passwordGroup) passwordGroup.style.display = '';
                const usernameInput = document.getElementById('telegram-backup-proxy-username');
                const passwordInput = document.getElementById('telegram-backup-proxy-password');
                if (usernameInput) {
                    usernameInput.disabled = false;
                    usernameInput.placeholder = 'Username (optional)';
                    usernameInput.title = '';
                }
                if (passwordInput) {
                    passwordInput.disabled = false;
                    passwordInput.placeholder = 'Password (optional)';
                    passwordInput.title = '';
                }
            }
        }
    }

    async function saveTelegramBackupSettings() {
        const enabled = document.getElementById('telegram-backup-enabled').checked;
        const interval = parseInt(document.getElementById('telegram-backup-interval').value, 10);
        const token = document.getElementById('telegram-backup-token').value.trim();
        const chatId = document.getElementById('telegram-backup-chat-id').value.trim();
        const useProxy = document.getElementById('telegram-backup-use-proxy').checked;
        const proxyMode = document.getElementById('telegram-backup-proxy-mode').value;
        const proxyUrl = document.getElementById('telegram-backup-proxy').value.trim();
        const proxyHost = document.getElementById('telegram-backup-proxy-host').value.trim();
        const proxyPort = parseInt(document.getElementById('telegram-backup-proxy-port').value, 10);
        const proxyUser = document.getElementById('telegram-backup-proxy-username').value.trim();
        const proxyPass = document.getElementById('telegram-backup-proxy-password').value.trim();

        if (!interval || interval < 1) {
            showToast('Interval must be at least 1 minute', 'error');
            return;
        }

        try {
            const res = await fetch('/api/settings/telegram-backup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    enabled,
                    interval_minutes: interval,
                    bot_token: token,
                    chat_id: chatId,
                    use_proxy: useProxy,
                    proxy_mode: proxyMode,
                    proxy_url: proxyUrl,
                    proxy_host: proxyHost,
                    proxy_port: proxyPort,
                    proxy_username: proxyUser,
                    proxy_password: proxyPass
                })
            });
            const data = await res.json();
            if (data.success) {
                showToast('Telegram backup settings saved');
                loadTelegramBackupSettings();
            } else {
                showToast(data.error || 'Error saving settings', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function testTelegramBackupSettings(btnEl) {
        const btn = btnEl || (typeof event !== 'undefined' ? event.currentTarget : null);
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Testing...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/settings/telegram-backup/test', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                showToast('Telegram connection successful');
            } else {
                showToast(data.error || 'Telegram test failed', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function triggerTelegramBackupNow(btnEl) {
        const btn = btnEl || (typeof event !== 'undefined' ? event.currentTarget : null);
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Running...';
        btn.disabled = true;

        const wrap = document.getElementById('telegram-backup-progress');
        const bar = document.getElementById('telegram-backup-progress-bar');
        const text = document.getElementById('telegram-backup-progress-text');

        function setProgress(visible, processed = 0, total = 0, stageText = '') {
            if (wrap) wrap.style.display = visible ? '' : 'none';
            const pct = total > 0 ? Math.min(100, Math.round((processed / total) * 100)) : (visible ? 10 : 0);
            if (bar) bar.style.width = `${pct}%`;
            if (text) {
                const t = total > 0 ? `${processed}/${total}` : '';
                text.textContent = stageText ? (t ? `${stageText} (${t})` : stageText) : (t || '');
            }
        }

        function stageToHuman(stage) {
            const s = (stage || '').toString();
            if (!s) return '🚀 Starting...';
            if (s === 'queued') return '⏳ Queued...';
            if (s === 'starting') return '🚀 Starting operation...';
            if (s === 'loading_settings') return '⚙️ Loading settings...';
            if (s === 'building_proxy') return '🔗 Connecting to Telegram...';
            if (s === 'fetching_servers') return '📡 Fetching server list...';
            if (s.startsWith('xui_login:')) return `🔐 Logging into: ${s.split(':').slice(1).join(':')}`;
            if (s.startsWith('xui_download_backup:')) return `⬇️ Downloading backup from: ${s.split(':').slice(1).join(':')}`;
            if (s.startsWith('telegram_upload:')) return `⬆️ Uploading to Telegram: ${s.split(':').slice(1).join(':')}`;
            if (s.startsWith('server_done:')) return `✅ Finished: ${s.split(':').slice(1).join(':')}`;
            if (s.startsWith('xui_failed:')) return `❌ Server error: ${s.split(':').slice(1).join(':')}`;
            if (s.startsWith('telegram_failed:')) return `❌ Telegram error: ${s.split(':').slice(1).join(':')}`;
            if (s === 'done') return '✅ Completed';
            if (s === 'error') return '❌ Failed';
            return s;
        }

        let pollTimer = null;
        let jobId = null;

        try {
            setProgress(true, 0, 0, '🚀 Starting backup...');
            const startRes = await fetch('/api/telegram-backup/now', { method: 'POST' });
            const startData = await startRes.json();
            if (!startData.success || !startData.job_id) {
                showToast(startData.error || 'Backup failed to start', 'error');
                return;
            }

            jobId = startData.job_id;

            async function poll() {
                try {
                    const res = await fetch(`/api/telegram-backup/job/${jobId}`, { method: 'GET' });
                    const data = await res.json();
                    if (!data.success || !data.job) {
                        setProgress(true, 0, 0, '⏳ Waiting for status...');
                        return;
                    }

                    const job = data.job;
                    const progress = job.progress || {};
                    const total = progress.total || job.total || 0;
                    const processed = progress.processed || 0;
                    const stageText = stageToHuman(job.stage);
                    setProgress(true, processed, total, stageText);

                    if (job.state === 'done') {
                        clearInterval(pollTimer);
                        pollTimer = null;
                        setProgress(false);
                        const done = job.success_count || 0;
                        const all = job.total || total || 0;
                        showToast(`Backup sent (${done}/${all})`);
                        loadTelegramBackupSettings();
                    }
                    if (job.state === 'error') {
                        clearInterval(pollTimer);
                        pollTimer = null;
                        let message = job.error || 'Backup failed';
                        if (Array.isArray(job.results) && job.results.length) {
                            const details = job.results
                                .filter(item => !item.success && item.error)
                                .map(item => `${item.server_name || 'Server'}: ${item.error}`)
                                .slice(0, 6)
                                .join('\n');
                            if (details) message = `${message}\n${details}`;
                        }
                        setProgress(false);
                        showToast(message, 'error');
                    }
                } catch (e) {
                    // keep polling; transient error
                    setProgress(true, 0, 0, '🔄 Checking status...');
                }
            }

            pollTimer = setInterval(poll, 1000);
            await poll();
        } catch (e) {
            showToast('Network error', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function handleUpload(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        document.getElementById('backup-file-name').textContent = file.name;
        
        // Show loading state on button
        const wrapper = document.getElementById('backup-upload-container');
        const btn = document.getElementById('backup-upload-btn');
        wrapper.classList.add('uploading');
        btn.classList.add('loading');

        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch('/api/backups/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.success) {
                showToast('Backup uploaded successfully');
                loadBackups();
            } else {
                showToast(data.error || 'Error uploading backup', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        } finally {
            wrapper.classList.remove('uploading');
            btn.classList.remove('loading');
        }
    }

    async function loadBackups() {
        try {
            const res = await fetch('/api/backups');
            const data = await res.json();
            renderBackups(data.backups);
        } catch (e) {
            showToast('Error loading backups', 'error');
        }
    }

    function renderBackups(backups) {
        const tbody = document.getElementById('backups-table-body');
        if (backups.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary">No backups found</td></tr>';
            return;
        }

        tbody.innerHTML = backups.map(b => `
            <tr>
                <td>${b.name}</td>
                <td>
                    <span class="badge ${getBadgeClass(b.type)}">${b.type}</span>
                </td>
                <td>${b.date}</td>
                <td>${formatBytes(b.size)}</td>
                <td>
                    <div class="action-buttons">
                        <a href="/api/backups/${b.name}/download" class="action-btn" title="Download">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </a>
                        <button class="action-btn warning" onclick="${b.restore_supported ? `restoreBackup('${b.name}')` : ''}" title="${b.restore_supported ? 'Restore' : 'Restore not available'}" ${b.restore_supported ? '' : 'disabled style="opacity:0.5;cursor:not-allowed"'}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
                        </button>
                        <button class="action-btn danger" onclick="deleteBackup('${b.name}')" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function getBadgeClass(type) {
        switch(type) {
            case 'Uploaded': return 'badge-info';
            case 'Automatic': return 'badge-success';
            case 'Safety': return 'badge-warning';
            default: return 'badge-secondary';
        }
    }

    async function createBackup() {
        try {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Creating...';
            btn.disabled = true;

            const res = await fetch('/api/backups', { method: 'POST' });
            const data = await res.json();
            
            if (data.success) {
                showToast('Backup created successfully');
                loadBackups();
            } else {
                showToast(data.error || 'Error creating backup', 'error');
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function restoreBackup(filename) {
        if (!confirm('Are you sure you want to restore this backup? Current data will be overwritten and you will be logged out!')) return;
        
        try {
            const res = await fetch(`/api/backups/${filename}/restore`, { method: 'POST' });
            const data = await res.json();
            
            if (data.success) {
                showToast(data.message || 'Database restored successfully');
                // Redirect to login page if provided, otherwise reload
                if (data.redirect) {
                    setTimeout(() => window.location.href = data.redirect, 1500);
                } else {
                    setTimeout(() => window.location.reload(), 1500);
                }
            } else {
                showToast(data.error || 'Error restoring backup', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function deleteBackup(filename) {
        if (!confirm('Delete this backup?')) return;
        
        try {
            const res = await fetch(`/api/backups/${filename}`, { method: 'DELETE' });
            const data = await res.json();
            
            if (data.success) {
                showToast('Backup deleted');
                loadBackups();
            } else {
                showToast(data.error || 'Error deleting backup', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    async function loadTemplates() {
        try {
            const res = await fetch('/api/templates');
            const data = await res.json();
            renderTemplates(data.templates);
        } catch (e) {
            showToast('Error loading templates', 'error');
        }
    }

    function renderTemplates(templates) {
        const container = document.getElementById('templates-container');
        if (templates.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No templates found. Create one!</p></div>';
            return;
        }

        container.innerHTML = templates.map(t => `
            <div class="template-card ${t.is_active ? 'active' : ''}">
                <div class="template-header">
                    <div class="template-title">
                        ${t.name}
                        ${t.is_active ? '<span class="active-badge">Active</span>' : ''}
                    </div>
                    <div class="action-buttons">
                        ${!t.is_active ? `
                        <button class="action-btn success" onclick="activateTemplate(${t.id})" title="Set Active">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>` : ''}
                        <button class="action-btn" onclick="editTemplate(${t.id})" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-btn danger" onclick="deleteTemplate(${t.id})" title="Delete" ${t.is_active ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="template-preview">${escapeHtml(t.content)}</div>
            </div>
        `).join('');
    }

    let templatesCache = []; // To store loaded templates for editing

    // Override fetch to cache templates
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
        const response = await originalFetch(...args);
        const clone = response.clone();
        if (args[0] === '/api/templates' && args[1] === undefined) {
            try {
                const data = await clone.json();
                templatesCache = data.templates;
            } catch(e) {}
        }
        return response;
    };

    function openTemplateModal() {
        document.getElementById('template-modal-title').textContent = 'Add Template';
        document.getElementById('edit-template-id').value = '';
        document.getElementById('template-name').value = '';
        document.getElementById('template-content').value = '';
        document.getElementById('template-modal').classList.remove('hidden');
    }

    function editTemplate(id) {
        const t = templatesCache.find(x => x.id === id);
        if (!t) return;
        
        document.getElementById('template-modal-title').textContent = 'Edit Template';
        document.getElementById('edit-template-id').value = t.id;
        document.getElementById('template-name').value = t.name;
        document.getElementById('template-content').value = t.content;
        document.getElementById('template-modal').classList.remove('hidden');
    }

    function closeTemplateModal() {
        document.getElementById('template-modal').classList.add('hidden');
    }

    function insertVar(variable) {
        const textarea = document.getElementById('template-content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const before = text.substring(0, start);
        const after = text.substring(end, text.length);
        textarea.value = before + variable + after;
        textarea.selectionStart = textarea.selectionEnd = start + variable.length;
        textarea.focus();
    }

    async function saveTemplate() {
        const id = document.getElementById('edit-template-id').value;
        const name = document.getElementById('template-name').value;
        const content = document.getElementById('template-content').value;

        if (!name || !content) {
            showToast('Name and content are required', 'error');
            return;
        }

        try {
            const url = id ? `/api/templates/${id}` : '/api/templates';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, content })
            });
            
            const data = await res.json();
            if (data.success) {
                showToast('Template saved');
                closeTemplateModal();
                loadTemplates();
            } else {
                showToast(data.error || 'Error saving template', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function activateTemplate(id) {
        try {
            const res = await fetch(`/api/templates/${id}/activate`, { method: 'POST' });
            if (res.ok) {
                showToast('Template activated');
                loadTemplates();
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function deleteTemplate(id) {
        if (!confirm('Delete this template?')) return;
        try {
            const res = await fetch(`/api/templates/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
                showToast('Template deleted');
                loadTemplates();
            } else {
                showToast(data.error || 'Error deleting', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    // Session Settings
    async function loadSessionSettings() {
        try {
            const res = await fetch('/api/settings/session');
            const data = await res.json();
            if (data.success) {
                document.getElementById('session-timeout').value = data.timeout_hours;
            }
        } catch (e) {
            console.error('Error loading session settings:', e);
        }
    }

    async function saveSessionSettings() {
        const hours = document.getElementById('session-timeout').value;
        try {
            const res = await fetch('/api/settings/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ timeout_hours: hours })
            });
            const data = await res.json();
            if (data.success) {
                showToast('Session settings saved');
            } else {
                showToast(data.message || 'Error saving settings', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    let renewTemplateDefault = '';
    const renewPreviewSample = {
        email: 'client@example.com',
        days: '30',
        days_label: '30 Days',
        volume: '10',
        volume_label: '10GB',
        date: '1404/10/06',
        server_name: 'Main Server',
        mode: 'custom',
        dashboard_link: 'https://example.com/s/1/uuid'
    };

    let renewTemplatesCache = [];
    let renewAvailableVars = [];

    function updateRenewModalPreview(value) {
        const preview = document.getElementById('renew-modal-preview');
        if (!preview) return;

        const template = (value || '').trim();
        if (!template) {
            preview.innerHTML = '<span class="renew-preview-hint">Preview appears here...</span>';
            return;
        }

        const rendered = template.replace(/\{(.*?)\}/g, (match, key) => {
            const tmp = renewPreviewSample[key.trim()];
            return typeof tmp !== 'undefined' ? tmp : match;
        });

        const sanitized = escapeHtml(rendered);
        preview.innerHTML = sanitized.replace(/\n/g, '<br>');
    }

    async function loadRenewTemplates() {
        try {
            const res = await fetch('/api/renew-templates');
            const data = await res.json();
            if (data.success) {
                renewTemplatesCache = data.templates;
                renewAvailableVars = data.available_vars || [];
                renderRenewTemplates(data.templates);
                
                // Update modal vars
                const modalVarsContainer = document.getElementById('renew-modal-vars');
                if (modalVarsContainer) {
                    modalVarsContainer.innerHTML = renewAvailableVars.map(v => `
                        <span class="var-chip" onclick="insertRenewVar('${v.replace(/'/g, "\\'")}')">${escapeHtml(v)}</span>
                    `).join('');
                }
            }
        } catch (e) {
            showToast('Error loading renew templates', 'error');
        }
    }

    function renderRenewTemplates(templates) {
        const container = document.getElementById('renew-templates-container');
        if (!container) return;
        
        if (templates.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No renew templates found. Create one!</p></div>';
            return;
        }

        container.innerHTML = templates.map(t => `
            <div class="template-card ${t.is_active ? 'active' : ''}">
                <div class="template-header">
                    <div class="template-title">
                        ${t.name}
                        ${t.is_active ? '<span class="active-badge">Active</span>' : ''}
                    </div>
                    <div class="action-buttons">
                        ${!t.is_active ? `
                        <button class="action-btn success" onclick="activateRenewTemplate(${t.id})" title="Set Active">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>` : ''}
                        <button class="action-btn" onclick="editRenewTemplate(${t.id})" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-btn danger" onclick="deleteRenewTemplate(${t.id})" title="Delete" ${t.is_active ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="template-preview">${escapeHtml(t.content).replace(/\n/g, '<br>')}</div>
            </div>
        `).join('');
    }

    function openRenewTemplateModal() {
        document.getElementById('renew-template-modal-title').textContent = 'Add Renew Template';
        document.getElementById('edit-renew-template-id').value = '';
        document.getElementById('renew-template-name').value = '';
        document.getElementById('renew-template-content').value = '';
        document.getElementById('renew-modal-preview').innerHTML = '<span class="renew-preview-hint">Preview appears here...</span>';
        document.getElementById('renew-template-modal').classList.remove('hidden');
    }

    function editRenewTemplate(id) {
        const t = renewTemplatesCache.find(x => x.id === id);
        if (!t) return;
        
        document.getElementById('renew-template-modal-title').textContent = 'Edit Renew Template';
        document.getElementById('edit-renew-template-id').value = t.id;
        document.getElementById('renew-template-name').value = t.name;
        document.getElementById('renew-template-content').value = t.content;
        updateRenewModalPreview(t.content);
        document.getElementById('renew-template-modal').classList.remove('hidden');
    }

    function closeRenewTemplateModal() {
        document.getElementById('renew-template-modal').classList.add('hidden');
    }

    function insertRenewVar(variable) {
        const textarea = document.getElementById('renew-template-content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const before = text.substring(0, start);
        const after = text.substring(end, text.length);
        textarea.value = before + variable + after;
        textarea.selectionStart = textarea.selectionEnd = start + variable.length;
        textarea.focus();
        updateRenewModalPreview(textarea.value);
    }

    async function saveRenewTemplate() {
        const id = document.getElementById('edit-renew-template-id').value;
        const name = document.getElementById('renew-template-name').value;
        const content = document.getElementById('renew-template-content').value;

        if (!name || !content) {
            showToast('Name and content are required', 'error');
            return;
        }

        try {
            const url = id ? `/api/renew-templates/${id}` : '/api/renew-templates';
            const method = id ? 'PUT' : 'POST';
            
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, content })
            });
            
            const data = await res.json();
            if (data.success) {
                showToast('Renew template saved');
                closeRenewTemplateModal();
                loadRenewTemplates();
            } else {
                showToast(data.error || 'Error saving template', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function activateRenewTemplate(id) {
        try {
            const res = await fetch(`/api/renew-templates/${id}/activate`, { method: 'POST' });
            if (res.ok) {
                showToast('Renew template activated');
                loadRenewTemplates();
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function deleteRenewTemplate(id) {
        if (!confirm('Delete this renew template?')) return;
        try {
            const res = await fetch(`/api/renew-templates/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
                showToast('Renew template deleted');
                loadRenewTemplates();
            } else {
                showToast(data.error || 'Error deleting', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    // -----------------------------------------------------------------------
    // Health Logs (System Logs tab)
    // -----------------------------------------------------------------------
    let _hlCurrentPage = 1;

    function _hlLevelBadge(level) {
        const colors = {
            info: 'background:var(--accent);color:#fff;',
            warning: 'background:#f59e0b;color:#000;',
            error: 'background:#ef4444;color:#fff;',
            critical: 'background:#dc2626;color:#fff;font-weight:700;',
        };
        const style = colors[level] || 'background:var(--card-bg);color:var(--text);';
        return `<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.78rem;${style}">${(level||'').toUpperCase()}</span>`;
    }

    function _hlCategoryLabel(cat) {
        const labels = { db: 'Database', server: 'Server', static: 'Static Files', disk: 'Disk', general: 'General' };
        return labels[cat] || cat || '-';
    }

    function _hlFormatTime(iso) {
        if (!iso) return '-';
        try {
            const d = new Date(iso);
            return d.toLocaleString();
        } catch { return iso; }
    }

    async function loadHealthLogs(page) {
        if (page) _hlCurrentPage = page;
        const level = (document.getElementById('hl-filter-level') || {}).value || '';
        const category = (document.getElementById('hl-filter-category') || {}).value || '';
        const tbody = document.getElementById('hl-tbody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-secondary" style="text-align:center;">Loading...</td></tr>';

        try {
            const params = new URLSearchParams({ page: _hlCurrentPage, per_page: 50 });
            if (level) params.set('level', level);
            if (category) params.set('category', category);

            const resp = await fetch(`/api/settings/health-logs?${params}`);
            const data = await resp.json();
            if (!data.success) { tbody.innerHTML = `<tr><td colspan="5" class="text-secondary" style="text-align:center;">${data.message||'Error'}</td></tr>`; return; }

            const badge = document.getElementById('hl-total-badge');
            if (badge) badge.textContent = `${data.total} log${data.total !== 1 ? 's' : ''}`;

            if (!data.logs || data.logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-secondary" style="text-align:center;">No logs found. The watchdog is running – logs will appear when issues are detected.</td></tr>';
                document.getElementById('hl-pagination').innerHTML = '';
                return;
            }

            tbody.innerHTML = data.logs.map(l => `
                <tr>
                    <td style="white-space:nowrap;font-size:0.85rem;">${_hlFormatTime(l.timestamp)}</td>
                    <td>${_hlLevelBadge(l.level)}</td>
                    <td style="font-size:0.85rem;">${_hlCategoryLabel(l.category)}</td>
                    <td style="font-size:0.85rem;">${escapeHtml(l.message || '')}</td>
                    <td style="font-size:0.85rem;color:var(--text-secondary);">${l.action_taken ? escapeHtml(l.action_taken) : '-'}</td>
                </tr>
            `).join('');

            // Pagination
            const pagDiv = document.getElementById('hl-pagination');
            if (data.pages > 1) {
                let btns = '';
                for (let p = 1; p <= data.pages; p++) {
                    const active = p === data.page ? 'btn-primary' : 'btn-secondary';
                    btns += `<button class="btn ${active}" style="min-width:36px;padding:4px 10px;" onclick="loadHealthLogs(${p})">${p}</button>`;
                }
                pagDiv.innerHTML = btns;
            } else {
                pagDiv.innerHTML = '';
            }
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-secondary" style="text-align:center;">Network error</td></tr>`;
        }
    }

    async function runHealthCheckNow() {
        const resultDiv = document.getElementById('hl-check-result');
        resultDiv.classList.remove('hidden');
        resultDiv.style.background = 'var(--card-bg)';
        resultDiv.style.border = '1px solid var(--border)';
        resultDiv.innerHTML = 'Running health check...';

        try {
            const resp = await fetch('/api/settings/health-logs/run-check', { method: 'POST' });
            const data = await resp.json();
            if (!data.success) {
                resultDiv.style.background = '#fef2f2';
                resultDiv.style.border = '1px solid #fca5a5';
                resultDiv.innerHTML = `<strong>Error:</strong> ${escapeHtml(data.message || 'Unknown error')}`;
                return;
            }
            const r = data.results || {};
            const allOk = Object.values(r).every(v => v.ok);
            if (allOk) {
                resultDiv.style.background = 'var(--card-bg)';
                resultDiv.style.border = '1px solid var(--accent)';
                resultDiv.innerHTML = '✅ <strong>All checks passed</strong> — DB, servers, disk &amp; static files are healthy.';
            } else {
                const issues = Object.entries(r).filter(([,v]) => !v.ok).map(([k,v]) => `<strong>${k}:</strong> ${escapeHtml(v.detail || 'issue detected')}`);
                resultDiv.style.background = '#fef2f2';
                resultDiv.style.border = '1px solid #fca5a5';
                resultDiv.innerHTML = '⚠️ <strong>Issues detected:</strong><br>' + issues.join('<br>');
            }
            loadHealthLogs();
        } catch (e) {
            resultDiv.style.background = '#fef2f2';
            resultDiv.style.border = '1px solid #fca5a5';
            resultDiv.innerHTML = 'Network error running health check.';
        }
    }

    async function clearHealthLogs() {
        if (!confirm('Clear all health logs?')) return;
        try {
            const resp = await fetch('/api/settings/health-logs/clear', { method: 'POST' });
            const data = await resp.json();
            if (data.success) {
                showToast(data.message || 'Logs cleared');
                loadHealthLogs();
            } else {
                showToast(data.message || 'Error', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
</script>
{% endblock %}
