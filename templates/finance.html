{% extends "base.html" %}

{% block title %}Finance Overview - Eve X-UI Manager{% endblock %}
{% block page_title %}Financial Overview{% endblock %}

{% block content %}
<div class="page-header"></div>

<!-- Stats Cards -->
<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: var(--text-secondary); font-size: 0.875rem;">Today</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        </div>
        <div id="stat-today" style="font-size: 1.75rem; font-weight: 700; color: #4ade80;">0 T</div>
    </div>
    
    
    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span id="stat-month-label" style="color: var(--text-secondary); font-size: 0.875rem;">This Month</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
        </div>
        <div id="stat-month" style="font-size: 1.75rem; font-weight: 700; color: #a78bfa;">0 T</div>
    </div>

    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span id="stat-month-expense-label" style="color: var(--text-secondary); font-size: 0.875rem;">Month Cost</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="4"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="12" y1="8" x2="12" y2="16"/></svg>
        </div>
        <div id="stat-month-expense" style="font-size: 1.75rem; font-weight: 700; color: #ef4444;">0 T</div>
    </div>

    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span id="stat-total-label" style="color: var(--text-secondary); font-size: 0.875rem;">Total Income</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        </div>
        <div id="stat-total" style="font-size: 1.75rem; font-weight: 700; color: #fbbf24;">0 T</div>
    </div>
</div>

<!-- Filters -->
<style>
    .filters-card {
        background: rgba(13, 17, 23, 0.85);
        border: 1px solid var(--border-color);
        border-radius: 18px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 20px 45px rgba(0,0,0,0.35);
    }
    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }
    .filters-header h3 {
        margin: 0;
    }
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }
    .filter-field label {
        display: block;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }
    .filter-field input,
    .filter-field select {
        width: 100%;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        padding: 10px 12px;
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    .filter-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .filter-actions button {
        border: none;
        border-radius: 999px;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.4px;
    }
    .btn-apply {
        background: linear-gradient(120deg, #22d3ee, #6366f1);
        color: #fff;
    }
    .btn-reset {
        background: rgba(255,255,255,0.05);
        color: var(--text-secondary);
    }
    .range-chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .range-chips button {
        border: 1px solid rgba(255,255,255,0.1);
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.8rem;
        padding: 6px 14px;
        border-radius: 999px;
        cursor: pointer;
        transition: color 0.2s ease, border-color 0.2s ease;
    }
    .range-chips button:hover {
        border-color: #22d3ee;
        color: #22d3ee;
    }
    .muted-note {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: -4px;
    }
    @media (max-width: 600px) {
        .filters-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .filter-actions {
            justify-content: stretch;
        }
        .filter-actions button {
            width: 100%;
            text-align: center;
        }
    }
</style>

<div class="filters-card">
    <div class="filters-header">
        <div>
            <h3>Smart Filters</h3>
            <p class="muted-note">Enter Jalali dates such as 1403/01/01 for precise reporting.</p>
        </div>
        <div class="range-chips">
            <button type="button" data-range="today">Today</button>
            <button type="button" data-range="7d">Last 7 Days</button>
            <button type="button" data-range="30d">Last 30 Days</button>
            <button type="button" data-range="clear">Clear Dates</button>
        </div>
    </div>
    <form id="payment-filters">
        <div class="filters-grid">
            <div class="filter-field" style="grid-column: span 2;">
                <label>Search</label>
                <input type="text" id="payment-search" placeholder="Email, description, or sender">
            </div>
            <div class="filter-field">
                <label>Direction</label>
                <select id="direction-filter" class="form-select filter-select">
                    <option value="">All</option>
                    <option value="income">Income (+)</option>
                    <option value="expense">Expense (-)</option>
                </select>
            </div>
            <div class="filter-field">
                <label>Type</label>
                <select id="type-filter" class="form-select filter-select">
                    <option value="">All types</option>
                    <option value="payment">PAYMENT</option>
                    <option value="receipt">RECEIPT</option>
                    <option value="renew">RENEW</option>
                    <option value="reset_traffic">RESET_TRAFFIC</option>
                    <option value="add_client">ADD_CLIENT</option>
                    <option value="server_renewal">SERVER_RENEWAL</option>
                    <option value="server_traffic">SERVER_TRAFFIC</option>
                    <option value="server_cost">SERVER_COST</option>
                    <option value="deposit">DEPOSIT</option>
                    <option value="manual_debit">MANUAL_DEBIT</option>
                </select>
            </div>
            <div class="filter-field">
                <label>Start Date (Jalali)</label>
                <input type="text" id="start-date" dir="ltr" placeholder="1403/01/01">
            </div>
            <div class="filter-field">
                <label>End Date (Jalali)</label>
                <input type="text" id="end-date" dir="ltr" placeholder="1403/01/30">
            </div>
            <div class="filter-field">
                <label>Card</label>
                <select id="card-filter" class="form-select filter-select">
                    <option value="">All cards</option>
                    {% for card in cards %}
                    <option value="{{ card.id }}">{{ card.label }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if is_superadmin %}
            <div class="filter-field">
                <label>User</label>
                <select id="user-filter" class="form-select filter-select">
                    <option value="">All users</option>
                    {% for admin in admin_options %}
                    <option value="{{ admin.id }}">{{ admin.username }} ({{ admin.role }})</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>
        <div class="filter-actions">
            <button type="button" class="btn-reset" id="reset-filters">Reset</button>
            <button type="submit" class="btn-apply">Apply Filters</button>
        </div>
    </form>
</div>

<!-- Payments Table -->
<div class="server-card">
    <div class="server-header">
        <div class="server-title">
            <h3>Payment History</h3>
            <p class="muted-note" id="payments-count">Loading...</p>
        </div>
        <div class="server-actions">
            <button id="add-payment-btn" class="btn btn-primary" title="Add Payment">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Payment
            </button>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="clients-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 15px; text-align: left;">Date</th>
                    {% if is_superadmin %}
                    <th style="padding: 15px; text-align: left;">User</th>
                    {% endif %}
                    <th style="padding: 15px; text-align: left;">Type</th>
                    <th style="padding: 15px; text-align: left;">Sender</th>
                    <th style="padding: 15px; text-align: left;">Card</th>
                    <th style="padding: 15px; text-align: left;">Amount</th>
                    <th style="padding: 15px; text-align: left;">Client</th>
                    <th style="padding: 15px; text-align: left;">Status</th>
                    <th style="padding: 15px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody id="payments-list">
                <tr><td colspan="8" style="text-align: center; padding: 20px;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 16px 20px; border-top: 1px solid var(--border-color); flex-wrap: wrap;">
        <span id="page-info" style="color: var(--text-secondary); font-size: 0.875rem;">Showing 0 to 0 of 0 results</span>
        <div id="pagination-buttons" style="display: flex; align-items: center; gap: 4px;"></div>
    </div>

<!-- add payment button removed from bottom, placed in server-header -->
</div>

<!-- Add/Edit Payment Modal -->
<div id="payment-modal" class="modal-overlay hidden">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h3 id="modal-title">Edit Payment</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="payment-form">
            <input type="hidden" id="payment-id">
            <div id="payment-error" class="muted-note" style="color:#ef4444; display:none; margin-bottom:8px;"> </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Entry Type</label>
                    <select id="payment-kind" class="form-select">
                        <option value="income" selected>Income (payment)</option>
                        <option value="expense">Expense (server cost)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount (Toman) *</label>
                    <input type="text" id="payment-amount" class="form-input" required inputmode="numeric" placeholder="e.g. 150,000">
                </div>
                <div class="form-group">
                    <label>Payment Date (Jalali)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="payment-date" class="form-input" style="width: 60%;" placeholder="1403/09/18">
                        <input type="text" id="payment-time" class="form-input" style="width: 38%;" placeholder="00:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Destination Card (Your Card)</label>
                    <select id="payment-card" class="form-select">
                        <option value="">-- Select Card --</option>
                        {% for card in cards %}
                        <option value="{{ card.id }}">{{ card.label }} ({{ card.bank_name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group expense-only" style="display:none;">
                    <label>Server (for expense)</label>
                    <select id="payment-server" class="form-select">
                        <option value="">-- Select Server --</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}">{{ server.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group expense-only" style="display:none;">
                    <label>Cost Type</label>
                    <select id="payment-cost-type" class="form-select">
                        <option value="server_renewal">Server renewal</option>
                        <option value="server_traffic">Server traffic</option>
                        <option value="server_cost">Other server cost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sender Name</label>
                    <input type="text" id="payment-sender-name" class="form-input" placeholder="Customer name">
                </div>
                <div class="form-group">
                    <label>Sender Card Number</label>
                    <input type="text" id="payment-sender-card" class="form-input" placeholder="6037xxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Client Email</label>
                    <input type="text" id="payment-client" class="form-input" placeholder="client@example.com">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="payment-description" class="form-input" rows="2" placeholder="Notes..."></textarea>
                    <div id="tx-audit-note" class="muted-note" style="display:none; margin-top: 6px;">
                        For transaction edits, changes are automatically written into the description (who/when/what changed).
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="save-payment-btn">Save Payment</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h3 style="color: #ef4444; display: flex; align-items: center; gap: 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Delete Payment
            </h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <p style="color: #991b1b; margin: 0; font-weight: 600;">⚠️ Warning: This action cannot be undone!</p>
                <p style="color: #991b1b; margin: 8px 0 0 0; font-size: 0.9rem;">This will remove the record from the Finance overview.</p>
                <p style="color: #991b1b; margin: 6px 0 0 0; font-size: 0.9rem;">A log entry will remain in Transactions showing who deleted it.</p>
            </div>
            <p style="color: var(--text-primary); margin-bottom: 12px;">You are about to delete this payment transaction:</p>
            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <div style="display: grid; gap: 8px; font-size: 0.875rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Amount:</span>
                        <span style="color: var(--text-primary); font-weight: 600;" id="delete-amount">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Date:</span>
                        <span style="color: var(--text-primary);" id="delete-date">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Sender:</span>
                        <span style="color: var(--text-primary);" id="delete-sender">-</span>
                    </div>
                </div>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Deleting this payment will:</p>
            <ul style="color: var(--text-secondary); font-size: 0.875rem; margin: 8px 0 0 20px; padding: 0;">
                <li>Permanently remove it from the database</li>
                <li>Update your income statistics</li>
                <li>This cannot be reversed</li>
            </ul>
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button type="button" class="btn" style="background: #ef4444; color: white;" id="confirm-delete-btn" onclick="confirmDelete()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Delete Payment
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const isSuperadmin = {{ 'true' if is_superadmin else 'false' }};
    const columnSpan = isSuperadmin ? 9 : 8;

    const tbody = document.getElementById('payments-list');
    const kindSelect = document.getElementById('payment-kind');
    const expenseFields = document.querySelectorAll('.expense-only');
    const txAuditNote = document.getElementById('tx-audit-note');
    const countLabel = document.getElementById('payments-count');
    const pageInfo = document.getElementById('page-info');
    const paginationButtons = document.getElementById('pagination-buttons');

    const filtersForm = document.getElementById('payment-filters');
    const searchInput = document.getElementById('payment-search');
    const startInput = document.getElementById('start-date');
    const endInput = document.getElementById('end-date');
    const cardSelect = document.getElementById('card-filter');
    const userSelect = document.getElementById('user-filter');
    const directionSelect = document.getElementById('direction-filter');
    const typeSelect = document.getElementById('type-filter');
    const resetButton = document.getElementById('reset-filters');
    const rangeButtons = document.querySelectorAll('[data-range]');
    const addPaymentBtn = document.getElementById('add-payment-btn');

    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    const perPage = 20;

    let lastLoadedEntries = [];

    let formatter;
    try {
        formatter = new Intl.DateTimeFormat('en-u-ca-persian', { year: 'numeric', month: '2-digit', day: '2-digit' });
    } catch (err) {
        console.warn('Persian calendar is not supported in this browser', err);
    }

    const filters = {
        search: '',
        direction: '',
        type: '',
        start_date: '',
        end_date: '',
        card_id: '',
        user_id: ''
    };

    const debounce = (fn, delay = 400) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
        };
    };

    const escapeAttr = (value) => {
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    };

    const normalizeDigits = (value) => {
        if (value == null) return '';
        let s = String(value);
        const map = {
            '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4', '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
            '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4', '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
        };
        s = s.replace(/[۰-۹٠-٩]/g, (ch) => map[ch] || ch);
        return s;
    };

    const toCleanNumberString = (value) => {
        // keep digits only (after normalizing), strip commas/spaces
        const s = normalizeDigits(value);
        const digitsOnly = s.replace(/[^0-9]/g, '');
        return digitsOnly;
    };

    const formatWithCommas = (digitsOnly) => {
        const s = String(digitsOnly || '').replace(/^0+(\d)/, '$1');
        if (!s) return '';
        return s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };

    const setupAmountFormatting = () => {
        const amountInput = document.getElementById('payment-amount');
        if (!amountInput) return;

        amountInput.addEventListener('input', () => {
            const cleaned = toCleanNumberString(amountInput.value);
            amountInput.value = formatWithCommas(cleaned);
        });

        amountInput.addEventListener('blur', () => {
            const cleaned = toCleanNumberString(amountInput.value);
            amountInput.value = formatWithCommas(cleaned);
        });
    };

    const updateKindUI = () => {
        const isExpense = kindSelect.value === 'expense';
        expenseFields.forEach(el => {
            el.style.display = isExpense ? 'block' : 'none';
        });
    };

    const formatJalali = (dateObj) => {
        if (!formatter || !(dateObj instanceof Date)) return '';
        const parts = formatter.formatToParts(dateObj).reduce((acc, part) => {
            if (part.type !== 'literal') acc[part.type] = part.value;
            return acc;
        }, {});
        if (!parts.year || !parts.month || !parts.day) return '';
        return `${parts.year}/${parts.month}/${parts.day}`;
    };

    const updateFiltersFromInputs = () => {
        filters.search = searchInput.value.trim();
        filters.direction = directionSelect ? directionSelect.value : '';
        filters.type = typeSelect ? typeSelect.value : '';
        filters.start_date = startInput.value.trim();
        filters.end_date = endInput.value.trim();
        filters.card_id = cardSelect.value;
        if (userSelect) {
            filters.user_id = userSelect.value;
        }
    };

    const buildQueryString = () => {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
            if (value) params.append(key, value);
        });
        params.append('page', currentPage);
        params.append('limit', perPage);
        return params.toString();
    };

    const setLoadingState = (message = 'Loading...') => {
        countLabel.textContent = 'Loading...';
        tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align:center; padding:20px; color:var(--text-secondary);">${message}</td></tr>`;
    };

    const getPageNumbers = (current, total) => {
        if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
        const pages = [];
        pages.push(1);
        if (current > 3) pages.push('...');
        const start = Math.max(2, current - 1);
        const end = Math.min(total - 1, current + 1);
        for (let i = start; i <= end; i++) if (!pages.includes(i)) pages.push(i);
        if (current < total - 2) pages.push('...');
        if (!pages.includes(total)) pages.push(total);
        return pages;
    };

    const updatePaginationUI = () => {
        const start = totalItems === 0 ? 0 : ((currentPage - 1) * perPage) + 1;
        const end = Math.min(currentPage * perPage, totalItems);
        pageInfo.textContent = `Showing ${start} to ${end} of ${totalItems} results`;

        let html = '';

        html += `<button class="page-btn ${currentPage <= 1 ? 'disabled' : ''}" data-page="prev" ${currentPage <= 1 ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'}; opacity: ${currentPage <= 1 ? '0.5' : '1'};">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>`;

        const pages = getPageNumbers(currentPage, totalPages);
        pages.forEach(p => {
            if (p === '...') {
                html += `<span style="padding: 8px 4px; color: var(--text-secondary);">...</span>`;
            } else {
                const isActive = p === currentPage;
                html += `<button class="page-btn ${isActive ? 'active' : ''}" data-page="${p}" style="min-width: 36px; padding: 8px 12px; border: 1px solid ${isActive ? '#6366f1' : 'var(--border-color)'}; background: ${isActive ? '#6366f1' : 'var(--bg-secondary)'}; color: ${isActive ? '#fff' : 'var(--text-secondary)'}; border-radius: 6px; cursor: pointer; font-weight: ${isActive ? '600' : '400'};">${p}</button>`;
            }
        });

        html += `<button class="page-btn ${currentPage >= totalPages ? 'disabled' : ''}" data-page="next" ${currentPage >= totalPages ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'}; opacity: ${currentPage >= totalPages ? '0.5' : '1'};">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>`;

        paginationButtons.innerHTML = html;

        paginationButtons.querySelectorAll('.page-btn:not(.disabled)').forEach(btn => {
            btn.addEventListener('click', () => {
                const page = btn.dataset.page;
                if (page === 'prev') {
                    currentPage = Math.max(1, currentPage - 1);
                } else if (page === 'next') {
                    currentPage = Math.min(totalPages, currentPage + 1);
                } else {
                    currentPage = parseInt(page);
                }
                loadPayments();
            });
        });
    };

    const renderPayments = (payments) => {
        if (!payments.length) {
            tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align: center; padding: 20px; color: var(--text-secondary);">No payments found.</td></tr>`;
            return;
        }

        // مرتب‌سازی جدیدترین به قدیمی‌ترین
        payments.sort((a, b) => {
            const da = new Date(a.payment_date || a.created_at);
            const db = new Date(b.payment_date || b.created_at);
            return db - da;
        });
        tbody.innerHTML = payments.map(p => {
            const userCell = isSuperadmin ? `
                <td style="padding: 15px; color: var(--text-secondary);">
                    ${p.admin ? `<span style="font-weight: 600; color: var(--text-primary);">${p.admin.username}</span>` : '-'}
                </td>` : '';

            // نوع تراکنش (type)
            let typeLabel = '-';
            if (p.type) {
                let color = '#6366f1';
                let text = p.type;
                if (p.type === 'payment') color = '#4ade80';
                else if (p.type === 'receipt') color = '#fbbf24';
                else if (p.type === 'renew') color = '#60a5fa';
                else if (p.type === 'reset_traffic') color = '#a78bfa';
                else if (p.type === 'add_client') color = '#f472b6';
                else if (p.type === 'server_renewal') color = '#f97316';
                else if (p.type === 'server_traffic') color = '#fb7185';
                else if (p.type === 'server_cost') color = '#f87171';
                typeLabel = `<span class="badge" style="background:${color}; color:#fff; font-size:0.7rem; font-weight:600;">${text.toUpperCase()}</span>`;
            }

            let cardLabel = '-';
            if (p.card) {
                cardLabel = `<span style="color: var(--text-primary); font-weight: 500;">${p.card.label}</span><br><span style="font-size: 0.7rem; color: var(--text-secondary);">${p.card.bank_name || ''}</span>`;
            } else if (p.type === 'receipt' && p.card) {
                cardLabel = p.card.label ? `<span style="color: var(--text-primary); font-weight: 500;">${p.card.label}</span>` : '-';
            }

            let statusBadge = '';
            const isEdited = String(p.description || '').toLowerCase().includes('edited by');
            if (isEdited) {
                statusBadge = '<span class="badge" style="font-size: 0.7rem; background: #6366f1;">EDITED</span>';
            } else if (p.type === 'payment') {
                statusBadge = '<span class="badge active" style="font-size: 0.7rem;">VERIFIED</span>';
            } else {
                statusBadge = p.verified
                    ? '<span class="badge active" style="font-size: 0.7rem;">VERIFIED</span>'
                    : '<span class="badge" style="font-size: 0.7rem; background: #374151;">PENDING</span>';
            }

            const entryId = String(p.id);
            const isTx = entryId.startsWith('tx-');
            const canEdit = (p.type === 'payment') || (isSuperadmin && isTx);
            const canDelete = (p.type === 'payment') || (isSuperadmin && isTx);

            const editBtnHtml = canEdit
                ? `<button class="action-btn" title="Edit" data-action="edit" data-entry-id="${escapeAttr(entryId)}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>`
                : `<button class="action-btn" title="Edit" disabled style="opacity:0.5;cursor:not-allowed;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>`;

            const deleteBtnHtml = canDelete
                ? `<button class="action-btn danger" title="Delete" data-action="delete" data-entry-id="${escapeAttr(entryId)}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>`
                : `<button class="action-btn danger" title="Delete" disabled style="opacity:0.5;cursor:not-allowed;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>`;

            // Determine amount color and sign: positive = green with +, negative = red (minus is automatic)
            const amountValue = Number(p.amount);
            const amountColor = amountValue >= 0 ? '#4ade80' : '#ef4444'; // Green if positive, Red if negative
            const amountSign = amountValue >= 0 ? '+' : ''; // Add + only for positive amounts

            return `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 15px; color: var(--text-primary);">${p.payment_date_jalali || '-'}</td>
                    ${userCell}
                    <td style="padding: 15px;">${typeLabel}</td>
                    <td style="padding: 15px;">
                        <div style="font-weight: 600; color: var(--text-primary);">${p.sender_name || '-'}</div>
                        ${p.sender_card ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${p.sender_card}</div>` : ''}
                    </td>
                    <td style="padding: 15px; color: var(--text-secondary);">${cardLabel}</td>
                    <td style="padding: 15px; color: ${amountColor}; font-weight: bold; direction: ltr;">${amountSign}${amountValue.toLocaleString()} T</td>
                    <td style="padding: 15px; color: var(--text-secondary);">${p.client_email || '-'}</td>
                    <td style="padding: 15px;">${statusBadge}</td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            ${editBtnHtml}
                            ${deleteBtnHtml}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    };

    // Delegate clicks for dynamically rendered action buttons (avoids inline onclick quoting issues)
    tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action');
        const entryId = btn.getAttribute('data-entry-id');
        if (!entryId) return;
        if (action === 'edit') window.editEntry(entryId);
        if (action === 'delete') window.deleteEntry(entryId);
    });

    const loadStats = async () => {
        try {
            const params = new URLSearchParams();
            Object.entries(filters).forEach(([key, value]) => { if (value) params.append(key, value); });
            const response = await fetch(`/api/finance/stats?${params}`);
            const data = await response.json();

            if (data.success || data.stats) {
                const stats = data.stats || {};
                document.getElementById('stat-today').textContent = Number(stats.today || 0).toLocaleString() + ' T';
                document.getElementById('stat-month').textContent = Number(stats.month || 0).toLocaleString() + ' T';
                    document.getElementById('stat-month-expense').textContent = Number(stats.month_expense || 0).toLocaleString() + ' T';
                document.getElementById('stat-total').textContent = Number(stats.total || 0).toLocaleString() + ' T';
            }
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    };

    const loadPayments = async () => {
        try {
            setLoadingState();
            const query = buildQueryString();
            const response = await fetch(`/api/payments?${query}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Failed to load');

            totalPages = data.pages || 1;
            currentPage = data.current_page || 1;
            totalItems = data.total || 0;

            lastLoadedEntries = data.payments || [];

            renderPayments(data.payments || []);
            updatePaginationUI();

            countLabel.textContent = `${totalItems} payments found.`;
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align: center; color: #ef4444; padding: 20px;">${error.message}</td></tr>`;
            countLabel.textContent = 'Unable to load payments';
        }
    };

    const clearFilters = () => {
        // Reset all filter fields to their initial state
        if (filtersForm) filtersForm.reset();
        if (cardSelect) cardSelect.value = '';
        if (userSelect) userSelect.value = '';
        if (directionSelect) directionSelect.value = '';
        if (typeSelect) typeSelect.value = '';
        if (searchInput) searchInput.value = '';
        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        rangeButtons.forEach(btn => btn.classList.remove('active'));
        updateFiltersFromInputs();
        currentPage = 1;
    };

    rangeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const range = btn.dataset.range;
            if (range === 'clear') {
                startInput.value = '';
                endInput.value = '';
            } else {
                const end = new Date();
                const start = new Date();
                if (range === 'today') {
                    // keep start as today
                } else if (range === '7d') {
                    start.setDate(start.getDate() - 6);
                } else if (range === '30d') {
                    start.setDate(start.getDate() - 29);
                }
                startInput.value = formatJalali(start);
                endInput.value = formatJalali(end);
            }
            // Removed immediate update to allow "Apply Filters" to handle it
        });
    });

    filtersForm.addEventListener('submit', (event) => {
        event.preventDefault();
        updateFiltersFromInputs();
        currentPage = 1;
        loadPayments();
        loadStats();
    });

    resetButton.addEventListener('click', (event) => {
        event.preventDefault();
        clearFilters();
        loadPayments();
        loadStats();
    });

    // Removed immediate change listeners to support "Apply Filters" button workflow
    /*
    cardSelect.addEventListener('change', () => { ... });
    if (directionSelect) { ... }
    if (typeSelect) { ... }
    if (userSelect) { ... }
    searchInput.addEventListener('input', ...);
    */

    kindSelect.addEventListener('change', () => {
        updateKindUI();
    });

    const openModal = () => {
        document.getElementById('payment-modal').classList.remove('hidden');
        updateKindUI();
    };

    const closeModal = () => {
        document.getElementById('payment-modal').classList.add('hidden');
        document.getElementById('payment-form').reset();
        document.getElementById('payment-id').value = '';
        document.getElementById('modal-title').textContent = 'Add Payment';
        kindSelect.value = 'income';
        updateKindUI();
    };

    addPaymentBtn.addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'Add Payment';
        // اتوفیل تاریخ امروز به جلالی (کاربر می‌تواند دستی تغییر دهد)
        const today = new Date();
        const todayJalali = formatJalali(today);
        const dateInput = document.getElementById('payment-date');
        if (dateInput && !dateInput.value) {
            dateInput.value = todayJalali;
        }
        // مقدار ساعت و دقیقه فعلی را اتوفیل کن
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('payment-time').value = `${hh}:${mm}`;
        kindSelect.value = 'income';
        updateKindUI();
        openModal();
    });

    setupAmountFormatting();

    document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorBox = document.getElementById('payment-error');
        const saveBtn = document.getElementById('save-payment-btn');
        errorBox.style.display = 'none';
        errorBox.textContent = '';

        // Simple client-side validation
        const amountValRaw = document.getElementById('payment-amount').value;
        const amountDigits = toCleanNumberString(amountValRaw);
        if (!amountDigits || Number(amountDigits) <= 0) {
            errorBox.textContent = 'Amount is required and must be greater than 0';
            errorBox.style.display = 'block';
            return;
        }

        saveBtn.disabled = true;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';

        const paymentId = document.getElementById('payment-id').value;
        let paymentDate = document.getElementById('payment-date').value;
        let paymentTime = document.getElementById('payment-time').value;
        // اگر ساعت وارد نشده بود، ساعت و دقیقه لحظه ثبت را بردار
        if (!paymentTime) {
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            paymentTime = `${hh}:${mm}`;
        }
        const data = {
            amount: amountDigits,
            payment_date: paymentDate,
            payment_time: paymentTime,
            card_id: document.getElementById('payment-card').value || null,
            sender_name: document.getElementById('payment-sender-name').value,
            sender_card: document.getElementById('payment-sender-card').value,
            client_email: document.getElementById('payment-client').value,
            description: document.getElementById('payment-description').value,
            is_expense: kindSelect.value === 'expense'
        };

        if (data.is_expense) {
            data.server_id = document.getElementById('payment-server').value || null;
            data.cost_type = document.getElementById('payment-cost-type').value || 'server_cost';
            if (!data.server_id) {
                errorBox.textContent = 'Please select a server for this expense.';
                errorBox.style.display = 'block';
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
        }

        try {
            let url = paymentId ? `/api/payments/${paymentId}` : '/api/payments';
            let method = paymentId ? 'PUT' : 'POST';

            if (paymentId && String(paymentId).startsWith('tx-')) {
                url = `/api/transactions/${String(paymentId).slice(3)}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                const errMsg = result && result.error ? result.error : 'Failed to save';
                throw new Error(errMsg);
            }

            closeModal();
            // show a success toast
            try {
                if (result && result.converted) {
                    showToast('Converted to expense successfully');
                } else if (method === 'POST') {
                    showToast('Payment saved successfully');
                } else {
                    showToast('Payment updated successfully');
                }
            } catch (e) { /* ignore if showToast not available */ }
            loadPayments();
            loadStats();
        } catch (error) {
            errorBox.textContent = error.message || 'An error occurred';
            errorBox.style.display = 'block';
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    });

    window.editEntry = async (id) => {
        try {
            const entryId = String(id);
            let entry = (lastLoadedEntries || []).find(p => String(p.id) === entryId);
            if (!entry) {
                const response = await fetch(`/api/payments?limit=1000`);
                const data = await response.json();
                entry = (data.payments || []).find(p => String(p.id) === entryId);
            }

            if (!entry) {
                alert('Payment not found');
                return;
            }

            const isTx = String(entry.id).startsWith('tx-');
            if (isTx && !isSuperadmin) {
                alert('Access denied');
                return;
            }

            if (txAuditNote) {
                txAuditNote.style.display = isTx ? 'block' : 'none';
            }

            document.getElementById('payment-id').value = entry.id;
            document.getElementById('payment-amount').value = formatWithCommas(String(entry.amount || '').replace(/[^0-9]/g, ''));
            // payment_date_jalali is like "YYYY/MM/DD HH:MM"; split into date/time inputs
            const jalaliDt = (entry.payment_date_jalali || '').trim();
            let datePart = '';
            let timePart = '';
            if (jalaliDt) {
                const parts = jalaliDt.split(' ');
                datePart = parts[0] || '';
                timePart = parts[1] || '';
            }
            document.getElementById('payment-date').value = datePart;
            document.getElementById('payment-time').value = timePart;
            document.getElementById('payment-card').value = entry.card_id || '';
            document.getElementById('payment-sender-name').value = entry.sender_name || '';
            document.getElementById('payment-sender-card').value = entry.sender_card || '';
            document.getElementById('payment-client').value = entry.client_email || '';
            document.getElementById('payment-description').value = entry.description || '';

            if (isTx) {
                const isExpense = Number(entry.amount) < 0;
                kindSelect.value = isExpense ? 'expense' : 'income';
                updateKindUI();
                // expense-only fields (server/type)
                try {
                    document.getElementById('payment-server').value = (entry.server && entry.server.id) ? entry.server.id : '';
                } catch (e) {}
                try {
                    document.getElementById('payment-cost-type').value = entry.type || 'server_cost';
                } catch (e) {}
            } else {
                kindSelect.value = 'income';
                updateKindUI();
            }

            document.getElementById('modal-title').textContent = 'Edit Payment';
            openModal();
        } catch (error) {
            alert('Error loading payment');
        }
    };

    let paymentToDelete = null;

    window.deleteEntry = async (id) => {
        try {
            const entryId = String(id);
            let entry = (lastLoadedEntries || []).find(p => String(p.id) === entryId);
            if (!entry) {
                const response = await fetch(`/api/payments?limit=1000`);
                const data = await response.json();
                entry = (data.payments || []).find(p => String(p.id) === entryId);
            }

            if (!entry) {
                alert('Payment not found');
                return;
            }

            const isTx = String(entry.id).startsWith('tx-');
            if (isTx && !isSuperadmin) {
                alert('Access denied');
                return;
            }

            // Store payment ID for deletion
            paymentToDelete = entry.id;

            // Populate modal with payment details
            document.getElementById('delete-amount').textContent = `${Number(entry.amount || 0).toLocaleString()} T`;
            document.getElementById('delete-date').textContent = entry.payment_date_jalali || '-';
            document.getElementById('delete-sender').textContent = entry.sender_name || entry.sender_card || '-';

            // Show delete modal
            document.getElementById('delete-modal').classList.remove('hidden');
        } catch (error) {
            alert('Error loading payment details');
        }
    };

    window.closeDeleteModal = () => {
        document.getElementById('delete-modal').classList.add('hidden');
        paymentToDelete = null;
    };

    window.confirmDelete = async () => {
        if (!paymentToDelete) return;

        const confirmBtn = document.getElementById('confirm-delete-btn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span style="opacity: 0.7;">Deleting...</span>';

        try {
            let url = `/api/payments/${paymentToDelete}`;
            if (String(paymentToDelete).startsWith('tx-')) {
                url = `/api/transactions/${String(paymentToDelete).slice(3)}`;
            }
            const response = await fetch(url, { method: 'DELETE' });
            const result = await response.json();

            if (!response.ok) throw new Error(result.error || 'Failed to delete');

            closeDeleteModal();
            
            // Show success message
            try {
                showToast('Payment deleted successfully');
            } catch (e) { /* ignore */ }

            loadPayments();
            loadStats();
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
        }
    };

    // Close delete modal when clicking outside
    document.getElementById('delete-modal').addEventListener('click', (e) => {
        if (e.target.id === 'delete-modal') closeDeleteModal();
    });

    document.getElementById('payment-modal').addEventListener('click', (e) => {
        if (e.target.id === 'payment-modal') closeModal();
    });

    updateFiltersFromInputs();
    loadStats();
    loadPayments();

    // Change stat card labels for reseller
    if (!isSuperadmin) {
        const monthLabel = document.getElementById('stat-month-label');
        if (monthLabel) monthLabel.textContent = 'Charge';
        
        const expenseLabel = document.getElementById('stat-month-expense-label');
        if (expenseLabel) expenseLabel.textContent = 'Month Cost';
        
        const totalLabel = document.getElementById('stat-total-label');
        if (totalLabel) totalLabel.textContent = 'Total';
    }
</script>
{% endblock %}
