{% extends "base.html" %}

{% block title %}Finance Overview - Eve X-UI Manager{% endblock %}
{% block page_title %}Financial Overview{% endblock %}

{% block content %}
<div class="page-header"></div>


<style>
    /* ===== Finance page: responsive helpers ===== */
    html, body { overflow-x: hidden; }
    .stats-grid { min-width: 0; max-width: 100%; }
    .stat-card { min-width: 0; }
    .server-card { min-width: 0; max-width: 100%; }
    .filters-card { min-width: 0; max-width: 100%; }

    /* Overview (feed-style) */
    .overview-feed {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0 20px 14px 20px;
    }

    .overview-item {
        display: flex;
        gap: 12px;
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 14px;
        background: var(--bg-dark);
        min-width: 0;
    }

    .overview-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--primary);
        flex: 0 0 auto;
        margin-top: 6px;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
    }

    .overview-content {
        flex: 1;
        min-width: 0;
    }

    .overview-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
        align-items: start;
        min-width: 0;
    }

    .overview-cell {
        min-width: 0;
    }

    .overview-label {
        display: block;
        font-size: 0.72rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 4px;
        white-space: nowrap;
    }

    .overview-value {
        display: inline-block;
        max-width: 100%;
        font-weight: 700;
        color: var(--text-primary);
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Mid screens (sidebar visible): allow wrapping to avoid ellipsis dots */
    @media (max-width: 1100px) {
        .overview-value {
            display: block;
            font-size: 0.88rem;
            white-space: normal;
            word-break: break-word;
            overflow: visible;
            text-overflow: unset;
            line-height: 1.25;
        }
    }

    .overview-value.success, .summary-value.success { color: var(--success); }
    .overview-value.danger, .summary-value.danger { color: var(--danger); }
    .overview-value.profit, .summary-value.profit { color: var(--warning); }

    /* Collapsible Summary */
    .overview-details { width: 100%; }
    .overview-summary {
        cursor: pointer;
        user-select: none;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        border-bottom: 1px solid var(--border-color);
        position: relative;
        padding-right: 54px;
    }
    .overview-summary::-webkit-details-marker { display: none; }
    .overview-summary-title { flex: 1; min-width: 0; }
    .overview-summary-row {
        display: flex;
        align-items: baseline;
        gap: 10px;
        min-width: 0;
    }
    .overview-summary-title h3 { margin: 0; }
    .overview-summary-hint {
        color: var(--text-secondary);
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .overview-picker {
        padding: 14px 20px 10px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        min-width: 0;
        max-width: 100%;
    }
    .overview-picker label {
        font-size: 0.8rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin: 0;
        white-space: nowrap;
    }
    .overview-picker select {
        min-width: 0;
        width: 100%;
        max-width: 240px;
    }

    .overview-summary::after {
        content: '▾';
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1;
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
    }
    details[open] > .overview-summary::after { content: '▴'; }
    .overview-body { padding-bottom: 6px; }

    /* Prevent any horizontal overflow */
    #finance-overview-card,
    .overview-details,
    .overview-body,
    .overview-feed {
        overflow-x: hidden;
        max-width: 100%;
    }

    .overview-date-footer {
        display: none;
        padding: 10px 12px;
        border-top: 1px solid var(--border-color);
        color: var(--text-secondary);
        font-size: 0.86rem;
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        line-height: 1.4;
    }

    /* Payment History Type badges */
    .badge.type-badge {
        background: rgba(148, 163, 184, 0.14) !important;
        border: 1px solid rgba(148, 163, 184, 0.32) !important;
        color: var(--text-primary) !important;
        font-size: 0.72rem !important;
        font-weight: 700 !important;
        letter-spacing: 0.02em;
    }
    .badge.type-badge.type-SERVER_RENEWAL { background: rgba(249, 115, 22, 0.14) !important; border-color: rgba(249, 115, 22, 0.32) !important; color: #f97316 !important; }
    .badge.type-badge.type-RENEW { background: rgba(96, 165, 250, 0.14) !important; border-color: rgba(96, 165, 250, 0.32) !important; color: #60a5fa !important; }
    .badge.type-badge.type-PURCHASE { background: rgba(99, 102, 241, 0.14) !important; border-color: rgba(99, 102, 241, 0.32) !important; color: #6366f1 !important; }
    .badge.type-badge.type-SERVER_TRRAFIC { background: rgba(251, 113, 133, 0.14) !important; border-color: rgba(251, 113, 133, 0.32) !important; color: #fb7185 !important; }
    .badge.type-badge.type-SERVER_TRAFFIC { background: rgba(251, 113, 133, 0.14) !important; border-color: rgba(251, 113, 133, 0.32) !important; color: #fb7185 !important; }
    .badge.type-badge.type-SERVER_COST { background: rgba(248, 113, 113, 0.14) !important; border-color: rgba(248, 113, 113, 0.32) !important; color: #f87171 !important; }
    .badge.type-badge.type-PAYMENT { background: rgba(74, 222, 128, 0.14) !important; border-color: rgba(74, 222, 128, 0.32) !important; color: #4ade80 !important; }

    .overview-empty {
        padding: 16px 20px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .finance-table-wrap {
        overflow-x: auto;
        min-width: 0;
        max-width: 100%;
    }



    /* Payment table -> cards on <=1024px (uses td[data-label]) */
    @media (max-width: 1024px) {
        .finance-table thead { display: none; }
        .finance-table,
        .finance-table tbody { display: block; width: 100%; }

        /* No horizontal scrolling on mobile card-view */
        .finance-table-wrap { overflow-x: hidden; }

        /* Keep Amount value aligned (avoid dropping low on very small screens) */
        .finance-table td[data-label="Amount"] {
            align-items: center;
        }
        .finance-table td[data-label="Amount"] .finance-amount {
            margin-left: auto;
            white-space: nowrap;
            line-height: 1.2;
        }

        .finance-table tbody tr {
            display: block;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 12px;
            background: var(--bg-secondary);
        }

        .finance-table tbody tr > td[colspan] {
            display: block !important;
            text-align: center !important;
            padding: 16px !important;
        }

        .finance-table td[data-label] {
            display: flex !important;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 14px !important;
            text-align: left !important;
            border-bottom: 1px solid var(--border-color);
        }
        .finance-table td[data-label]:last-child { border-bottom: none; }

        .finance-table td[data-label]::before {
            content: attr(data-label);
            flex: 0 0 92px;
            font-size: 0.72rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding-top: 2px;
        }

        .finance-table td[data-label="Actions"] > div {
            justify-content: flex-end;
            width: 100%;
        }
    }

    /* Ensure stats never disappear and wrap cleanly */
    .stats-grid {
        display: grid;
        width: 100%;
        gap: 16px;
    }

    /* Tablet & small screens */
    @media (max-width: 1024px) {
        .stats-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            gap: 16px !important;
            margin-bottom: 16px !important;
        }

        .filters-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }
    }

    /* Prevent overview columns from being too tight on tablets */
    @media (max-width: 900px) {
        .overview-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }
    }

    @media (max-width: 820px) {
        .stats-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            gap: 12px !important;
            margin-bottom: 14px !important;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            gap: 12px !important;
        }
        .stat-card { padding: 16px !important; }
        
        .filters-grid {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
        }
        .filters-grid .filter-field {
            grid-column: auto !important;
        }
    }

    @media (max-width: 640px) {
        /* Modal & header tweaks */
        .server-header {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 12px !important;
        }
        .server-actions { width: 100%; }
        .server-actions button,
        .server-actions select {
            width: 100%;
            justify-content: center;
        }

        #page-info {
            flex: 1 1 100%;
        }

        #pagination-buttons {
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .modal {
            width: calc(100% - 24px) !important;
            max-width: calc(100% - 24px) !important;
            margin: 12px !important;
        }
        .modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            gap: 10px !important;
        }
        .stat-card {
            padding: 14px !important;
        }
    }

    @media (max-width: 420px) {
        .stats-grid {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
        }
    }

    @media (max-width: 640px) {
        .overview-feed {
            padding: 0 14px 10px 14px;
        }
        .overview-item {
            padding: 10px;
        }
        .overview-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        /* Mobile: smaller values as requested */
        .overview-cell[data-kind="income"] .overview-value,
        .overview-cell[data-kind="costs"] .overview-value,
        .overview-cell[data-kind="profit"] .overview-value {
            font-size: 0.7rem;
        }

        .overview-summary { padding: 14px; }
        .overview-summary { padding-right: 44px; }
        .overview-summary::after { right: 14px; font-size: 0.85rem; }

        .overview-summary { flex-wrap: wrap; row-gap: 10px; }
        .overview-summary-row { flex-wrap: wrap; }
        .overview-summary-hint { white-space: normal; }

        .overview-picker {
            padding: 10px 14px 8px 14px;
        }
        .overview-picker select {
            max-width: 100%;
        }
    }

    @media (max-width: 420px) {
        .overview-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Desktop/tablet: 2-column items to reduce height */
    @media (min-width: 768px) {
        .overview-feed {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
    }

    /* <=425px: match sketch layout (date rail + stacked metrics) */
    @media (max-width: 425px) {
        .overview-dot { display: none; }

        .overview-item {
            padding: 0;
            gap: 0;
            overflow: hidden;
        }

        .overview-content { width: 100%; }

        .overview-grid {
            grid-template-columns: 68px 1fr;
            grid-template-rows: repeat(3, auto);
            grid-template-areas:
                "date income"
                "date costs"
                "date profit";
            gap: 0;
            align-items: stretch;
            align-content: start;
        }

        .overview-cell {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .overview-cell[data-kind="date"] {
            grid-area: date;
            border-right: 1px solid var(--border-color);
            border-bottom: none;
            background: rgba(13, 17, 23, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 4px;
            align-self: stretch;
        }

        .overview-cell[data-kind="income"] { grid-area: income; }
        .overview-cell[data-kind="costs"] { grid-area: costs; }
        .overview-cell[data-kind="profit"] { grid-area: profit; border-bottom: none; }

        .overview-cell[data-kind="income"],
        .overview-cell[data-kind="costs"],
        .overview-cell[data-kind="profit"] {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .overview-cell[data-kind="date"] .overview-label { display: none; }
        .overview-cell[data-kind="date"] .overview-value {
            display: block;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            margin: 0;
            font-size: 0.74rem;
            line-height: 1;
            font-weight: 400;
            color: var(--text-secondary);
            white-space: nowrap;
            text-align: center;
        }

        .overview-cell[data-kind="income"] .overview-label,
        .overview-cell[data-kind="costs"] .overview-label,
        .overview-cell[data-kind="profit"] .overview-label {
            font-size: 0.7rem;
            line-height: 1.1;
        }

        .overview-cell[data-kind="income"] .overview-value,
        .overview-cell[data-kind="costs"] .overview-value,
        .overview-cell[data-kind="profit"] .overview-value {
            font-weight: 400;
        }

        .overview-cell[data-kind="income"] .overview-value,
        .overview-cell[data-kind="costs"] .overview-value,
        .overview-cell[data-kind="profit"] .overview-value {
            line-height: 1.1;
        }

        /* No footer on sketch layout */
        .overview-date-footer { display: none; }

        .overview-label { margin-bottom: 0; white-space: nowrap; }
        .overview-value { font-size: 0.98rem; }
    }

    /* Monthly Summary Block */
    .overview-monthly-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 0 20px 16px 20px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 16px;
    }

    .monthly-summary-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        background: rgba(255, 255, 255, 0.03);
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .summary-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
    }

    .summary-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    @media (max-width: 640px) {
        .overview-monthly-summary {
            grid-template-columns: 1fr;
            padding: 0 14px 12px 14px;
            gap: 8px;
        }
        .monthly-summary-item {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
        }
        .summary-value {
            font-size: 1rem;
        }
    }
</style>


<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon green">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Today</span>
            <span class="stat-value" id="stat-today">0 T</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon purple">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label" id="stat-month-label">This Month</span>
            <span class="stat-value" id="stat-month">0 T</span>
            <span class="stat-sub" id="stat-month-delta">vs last month: —</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon orange">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="4"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
                <line x1="12" y1="8" x2="12" y2="16"/>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label" id="stat-month-expense-label">Month Cost</span>
            <span class="stat-value" id="stat-month-expense">0 T</span>
            <span class="stat-sub" id="stat-month-expense-delta">vs last month: —</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon blue">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label" id="stat-total-label">Total Profit</span>
            <span class="stat-value profit" id="stat-total">0 T</span>
            <span class="stat-sub" id="stat-net-delta">Profit vs last month: —</span>
        </div>
    </div>
</div>

<!-- Overview (Feed-style) -->
<div class="server-card" id="finance-overview-card" style="margin-bottom: 24px;">
    <details class="overview-details">
        <summary class="overview-summary">
            <div class="overview-summary-title">
                <div class="overview-summary-row">
                    <h3>Summary</h3>
                    <span class="overview-summary-hint">Daily income, costs, and profit for the selected Jalali month.</span>
                </div>
            </div>
        </summary>

        <div class="overview-body">
            <div class="overview-picker" id="overview-picker" aria-label="Jalali month picker">
                <label for="overview-month-select">Month</label>
                <select id="overview-month-select" class="form-select interval-select" aria-label="Select month">
                    <option value="" selected>Open Summary to load…</option>
                </select>
            </div>

            <!-- Monthly Summary Totals -->
            <div class="overview-monthly-summary" id="overview-monthly-summary" style="display: none;">
                <div class="monthly-summary-item">
                    <span class="summary-label">Total Income</span>
                    <span class="summary-value success" id="monthly-total-income">0 T</span>
                </div>
                <div class="monthly-summary-item">
                    <span class="summary-label">Total Costs</span>
                    <span class="summary-value danger" id="monthly-total-costs">0 T</span>
                </div>
                <div class="monthly-summary-item">
                    <span class="summary-label">Total Profit</span>
                    <span class="summary-value profit" id="monthly-total-profit">0 T</span>
                </div>
            </div>

            <div class="overview-feed" id="overview-feed">
                <div class="overview-empty" id="overview-empty">Open Summary to load overview…</div>
            </div>
        </div>
    </details>
</div>







<!-- Filters -->
<style>
    .filters-card {
        background: rgba(13, 17, 23, 0.85);
        border: 1px solid var(--border-color);
        border-radius: 18px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 20px 45px rgba(0,0,0,0.35);
    }
    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }
    .filters-header h3 {
        margin: 0;
    }
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr));
        gap: 16px;
        margin-bottom: 16px;
        min-width: 0;
    }
    .filter-field label {
        display: block;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }
    .filter-field input,
    .filter-field select {
        width: 100%;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        padding: 10px 12px;
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    .filter-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .filter-actions button {
        border: none;
        border-radius: 999px;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.4px;
    }
    .btn-apply {
        background: linear-gradient(120deg, #22d3ee, #6366f1);
        color: #fff;
    }
    .btn-reset {
        background: rgba(255,255,255,0.05);
        color: var(--text-secondary);
    }
    .range-chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .range-chips button {
        border: 1px solid rgba(255,255,255,0.1);
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.8rem;
        padding: 6px 14px;
        border-radius: 999px;
        cursor: pointer;
        transition: color 0.2s ease, border-color 0.2s ease;
    }
    .range-chips button:hover {
        border-color: #22d3ee;
        color: #22d3ee;
    }
    .muted-note {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: -4px;
    }
    @media (max-width: 768px) {
        .filters-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .range-chips {
            width: 100%;
        }
        .filter-actions {
            width: 100%;
            justify-content: stretch;
        }
        .filter-actions button {
            flex: 1;
            text-align: center;
        }
    }
</style>

<div class="filters-card">
    <div class="filters-header">
        <div>
            <h3>Smart Filters</h3>
            <p class="muted-note">Enter Jalali dates such as 1403/01/01 for precise reporting.</p>
        </div>
        <div class="range-chips">
            <button type="button" data-range="today">Today</button>
            <button type="button" data-range="7d">Last 7 Days</button>
            <button type="button" data-range="30d">Last 30 Days</button>
            <button type="button" data-range="clear">Clear Dates</button>
        </div>
    </div>
    <form id="payment-filters">
        <div class="filters-grid">
            <div class="filter-field" style="grid-column: span 2;">
                <label>Search</label>
                <input type="text" id="payment-search" placeholder="Email, description, or sender">
            </div>
            <div class="filter-field">
                <label>Direction</label>
                <select id="direction-filter" class="form-select filter-select">
                    <option value="">All</option>
                    <option value="income">Income (+)</option>
                    <option value="expense">Expense (-)</option>
                </select>
            </div>
            <div class="filter-field">
                <label>Type</label>
                <select id="type-filter" class="form-select filter-select">
                    <option value="">All types</option>
                    <option value="payment">PAYMENT</option>
                    <option value="receipt">RECEIPT</option>
                    <option value="renew">RENEW</option>
                    <option value="reset_traffic">RESET_TRAFFIC</option>
                    <option value="add_client">ADD_CLIENT</option>
                    <option value="server_renewal">SERVER_RENEWAL</option>
                    <option value="server_traffic">SERVER_TRAFFIC</option>
                    <option value="server_cost">SERVER_COST</option>
                    <option value="deposit">DEPOSIT</option>
                    <option value="manual_debit">MANUAL_DEBIT</option>
                </select>
            </div>
            <div class="filter-field">
                <label>Start Date (Jalali)</label>
                <input type="text" id="start-date" dir="ltr" placeholder="1403/01/01">
            </div>
            <div class="filter-field">
                <label>End Date (Jalali)</label>
                <input type="text" id="end-date" dir="ltr" placeholder="1403/01/30">
            </div>
            <div class="filter-field">
                <label>Card</label>
                <select id="card-filter" class="form-select filter-select">
                    <option value="">All cards</option>
                    {% for card in cards %}
                    <option value="{{ card.id }}">{{ card.label }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if is_superadmin %}
            <div class="filter-field">
                <label>User</label>
                <select id="user-filter" class="form-select filter-select">
                    <option value="">All users</option>
                    {% for admin in admin_options %}
                    <option value="{{ admin.id }}">{{ admin.username }} ({{ admin.role }})</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>
        <div class="filter-actions">
            <button type="button" class="btn-reset" id="reset-filters">Reset</button>
            <button type="submit" class="btn-apply">Apply Filters</button>
        </div>
    </form>
</div>

<!-- Payments Table -->
<div class="server-card">
    <div class="server-header">
        <div class="server-title">
            <h3>Payment History</h3>
            <p class="muted-note" id="payments-count">Loading...</p>
        </div>
        <div class="server-actions">
            <button id="add-payment-btn" class="btn btn-primary" title="Add Payment">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Payment
            </button>
        </div>
    </div>
    
    <div class="finance-table-wrap">
        <table class="clients-table finance-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 15px; text-align: left;">Date</th>
                    {% if is_superadmin %}
                    <th style="padding: 15px; text-align: left;">User</th>
                    {% endif %}
                    <th style="padding: 15px; text-align: left;">Type</th>
                    <th style="padding: 15px; text-align: left;">Sender</th>
                    <th style="padding: 15px; text-align: left;">Card</th>
                    <th style="padding: 15px; text-align: left;">Amount</th>
                    <th style="padding: 15px; text-align: left;">Client</th>
                    <th style="padding: 15px; text-align: left;">Status</th>
                    <th style="padding: 15px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody id="payments-list">
                <tr><td colspan="8" style="text-align: center; padding: 20px;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 16px 20px; border-top: 1px solid var(--border-color); flex-wrap: wrap;">
        <span id="page-info" style="color: var(--text-secondary); font-size: 0.875rem;">Showing 0 to 0 of 0 results</span>
        <div id="pagination-buttons" style="display: flex; align-items: center; gap: 4px;"></div>
    </div>

<!-- add payment button removed from bottom, placed in server-header -->
</div>

<!-- Add/Edit Payment Modal -->
<div id="payment-modal" class="modal-overlay hidden">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h3 id="modal-title">Edit Payment</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="payment-form">
            <input type="hidden" id="payment-id">
            <div id="payment-error" class="muted-note" style="color:#ef4444; display:none; margin-bottom:8px;"> </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Entry Type</label>
                    <select id="payment-kind" class="form-select">
                        <option value="income" selected>Income (payment)</option>
                        <option value="expense">Expense (server cost)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount (Toman) *</label>
                    <input type="text" id="payment-amount" class="form-input" required inputmode="numeric" placeholder="e.g. 150,000">
                </div>
                <div class="form-group">
                    <label>Payment Date (Jalali)</label>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="payment-date" class="form-input" style="flex: 2 1 160px; min-width: 0;" placeholder="1403/09/18">
                        <input type="text" id="payment-time" class="form-input" style="flex: 1 1 120px; min-width: 0;" placeholder="00:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Destination Card (Your Card)</label>
                    <select id="payment-card" class="form-select">
                        <option value="">-- Select Card --</option>
                        {% for card in cards %}
                        <option value="{{ card.id }}">{{ card.label }} ({{ card.bank_name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group expense-only" style="display:none;">
                    <label>Server (for expense)</label>
                    <select id="payment-server" class="form-select">
                        <option value="">-- Select Server --</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}">{{ server.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group expense-only" style="display:none;">
                    <label>Cost Type</label>
                    <select id="payment-cost-type" class="form-select">
                        <option value="server_renewal">Server renewal</option>
                        <option value="server_traffic">Server traffic</option>
                        <option value="server_cost">Other server cost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sender Name</label>
                    <input type="text" id="payment-sender-name" class="form-input" placeholder="Customer name">
                </div>
                <div class="form-group">
                    <label>Sender Card Number</label>
                    <input type="text" id="payment-sender-card" class="form-input" placeholder="6037xxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Client Email</label>
                    <input type="text" id="payment-client" class="form-input" placeholder="client@example.com">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="payment-description" class="form-input" rows="2" placeholder="Notes..."></textarea>
                    <div id="tx-audit-note" class="muted-note" style="display:none; margin-top: 6px;">
                        For transaction edits, changes are automatically written into the description (who/when/what changed).
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="save-payment-btn">Save Payment</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h3 style="color: #ef4444; display: flex; align-items: center; gap: 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Delete Payment
            </h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <p style="color: #991b1b; margin: 0; font-weight: 600;">⚠️ Warning: This action cannot be undone!</p>
                <p style="color: #991b1b; margin: 8px 0 0 0; font-size: 0.9rem;">This will remove the record from the Finance overview.</p>
                <p style="color: #991b1b; margin: 6px 0 0 0; font-size: 0.9rem;">A log entry will remain in Transactions showing who deleted it.</p>
            </div>
            <p style="color: var(--text-primary); margin-bottom: 12px;">You are about to delete this payment transaction:</p>
            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <div style="display: grid; gap: 8px; font-size: 0.875rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Amount:</span>
                        <span style="color: var(--text-primary); font-weight: 600;" id="delete-amount">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Date:</span>
                        <span style="color: var(--text-primary);" id="delete-date">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Sender:</span>
                        <span style="color: var(--text-primary);" id="delete-sender">-</span>
                    </div>
                </div>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Deleting this payment will:</p>
            <ul style="color: var(--text-secondary); font-size: 0.875rem; margin: 8px 0 0 20px; padding: 0;">
                <li>Permanently remove it from the database</li>
                <li>Update your income statistics</li>
                <li>This cannot be reversed</li>
            </ul>
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button type="button" class="btn" style="background: #ef4444; color: white;" id="confirm-delete-btn" onclick="confirmDelete()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Delete Payment
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
    const isSuperadmin = {{ 'true' if is_superadmin else 'false' }};
    const columnSpan = isSuperadmin ? 9 : 8;

    const tbody = document.getElementById('payments-list');
    const kindSelect = document.getElementById('payment-kind');
    const expenseFields = document.querySelectorAll('.expense-only');
    const txAuditNote = document.getElementById('tx-audit-note');
    const countLabel = document.getElementById('payments-count');
    const pageInfo = document.getElementById('page-info');
    const paginationButtons = document.getElementById('pagination-buttons');

    const filtersForm = document.getElementById('payment-filters');
    const searchInput = document.getElementById('payment-search');
    const startInput = document.getElementById('start-date');
    const endInput = document.getElementById('end-date');
    const cardSelect = document.getElementById('card-filter');
    const userSelect = document.getElementById('user-filter');
    const directionSelect = document.getElementById('direction-filter');
    const typeSelect = document.getElementById('type-filter');
    const resetButton = document.getElementById('reset-filters');
    const rangeButtons = document.querySelectorAll('[data-range]');
    const addPaymentBtn = document.getElementById('add-payment-btn');

    const overviewMonthSelect = document.getElementById('overview-month-select');
    const overviewFeed = document.getElementById('overview-feed');
    const overviewEmpty = document.getElementById('overview-empty');
    const overviewDetails = document.querySelector('.overview-details');

    let overviewMonthsLoadedForKey = null;
    let overviewIsLoading = false;

    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    const perPage = 20;

    let lastLoadedEntries = [];

    let formatter;
    try {
        formatter = new Intl.DateTimeFormat('en-u-ca-persian', { year: 'numeric', month: '2-digit', day: '2-digit' });
    } catch (err) {
        console.warn('Persian calendar is not supported in this browser', err);
    }

    const filters = {
        search: '',
        direction: '',
        type: '',
        start_date: '',
        end_date: '',
        card_id: '',
        user_id: ''
    };

    const escapeAttr = (value) => {
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    };

    const normalizeDigits = (value) => {
        if (value == null) return '';
        let s = String(value);
        const map = {
            '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4', '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
            '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4', '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
        };
        s = s.replace(/[۰-۹٠-٩]/g, (ch) => map[ch] || ch);
        return s;
    };

    const toCleanNumberString = (value) => {
        const s = normalizeDigits(value);
        return s.replace(/[^0-9]/g, '');
    };

    const formatWithCommas = (digitsOnly) => {
        const s = String(digitsOnly || '').replace(/^0+(\d)/, '$1');
        if (!s) return '';
        return s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };

    const setupAmountFormatting = () => {
        const amountInput = document.getElementById('payment-amount');
        if (!amountInput) return;

        amountInput.addEventListener('input', () => {
            const cleaned = toCleanNumberString(amountInput.value);
            amountInput.value = formatWithCommas(cleaned);
        });

        amountInput.addEventListener('blur', () => {
            const cleaned = toCleanNumberString(amountInput.value);
            amountInput.value = formatWithCommas(cleaned);
        });
    };

    const updateKindUI = () => {
        const isExpense = kindSelect && kindSelect.value === 'expense';
        expenseFields.forEach(el => {
            el.style.display = isExpense ? 'block' : 'none';
        });
    };

    const formatJalali = (dateObj) => {
        if (!formatter || !(dateObj instanceof Date)) return '';
        const parts = formatter.formatToParts(dateObj).reduce((acc, part) => {
            if (part.type !== 'literal') acc[part.type] = part.value;
            return acc;
        }, {});
        if (!parts.year || !parts.month || !parts.day) return '';
        return `${parts.year}/${parts.month}/${parts.day}`;
    };

    const getTodayJalaliParts = () => {
        if (!formatter) return null;
        try {
            const parts = formatter.formatToParts(new Date()).reduce((acc, part) => {
                if (part.type !== 'literal') acc[part.type] = part.value;
                return acc;
            }, {});
            if (!parts.year || !parts.month || !parts.day) return null;
            return {
                year: parseInt(normalizeDigits(parts.year), 10),
                month: parseInt(normalizeDigits(parts.month), 10),
                day: parseInt(normalizeDigits(parts.day), 10)
            };
        } catch (_) {
            return null;
        }
    };

    const updateFiltersFromInputs = () => {
        filters.search = (searchInput ? searchInput.value : '').trim();
        filters.direction = directionSelect ? directionSelect.value : '';
        filters.type = typeSelect ? typeSelect.value : '';
        filters.start_date = (startInput ? startInput.value : '').trim();
        filters.end_date = (endInput ? endInput.value : '').trim();
        filters.card_id = cardSelect ? cardSelect.value : '';
        if (userSelect) filters.user_id = userSelect.value;
    };

    const buildQueryString = () => {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
            if (value) params.append(key, value);
        });
        params.append('page', currentPage);
        params.append('limit', perPage);
        return params.toString();
    };

    const buildOverviewQuery = (extraParams = {}) => {
        const params = new URLSearchParams();
        // Reuse a subset of filters (month overview should follow card/user selections)
        if (filters.card_id) params.append('card_id', filters.card_id);
        if (filters.user_id) params.append('user_id', filters.user_id);
        Object.entries(extraParams).forEach(([k, v]) => {
            if (v !== null && v !== undefined && v !== '') params.append(k, String(v));
        });
        return params.toString();
    };

    const getOverviewKey = () => `${filters.card_id || ''}|${filters.user_id || ''}`;

    const isOverviewOpen = () => !!(overviewDetails && overviewDetails.open);

    const ensureOverviewLoaded = async ({ forceMonthsReload = false } = {}) => {
        if (!overviewMonthSelect || !overviewFeed) return;
        if (!isOverviewOpen()) return;
        if (overviewIsLoading) return;

        overviewIsLoading = true;
        try {
            updateFiltersFromInputs();
            const key = getOverviewKey();
            const shouldReloadMonths = forceMonthsReload || (overviewMonthsLoadedForKey !== key);
            if (shouldReloadMonths) {
                await loadOverviewMonths();
                overviewMonthsLoadedForKey = key;
            } else {
                const ym = parseYM(overviewMonthSelect.value);
                if (ym) await loadOverviewMonth(ym.year, ym.month);
            }
        } finally {
            overviewIsLoading = false;
        }
    };

    const formatYMOption = (ym) => {
        // ym is YYYY/MM
        return ym;
    };

    const parseYM = (value) => {
        const m = String(value || '').trim().match(/^(\d{4})\/(\d{2})$/);
        if (!m) return null;
        return { year: parseInt(m[1], 10), month: parseInt(m[2], 10) };
    };

    const renderOverview = ({ year, month, labels, series }) => {
        if (!overviewFeed) return;
        const income = (series && series.income) || [];
        const expense = (series && series.expense) || [];
        const profit = (series && series.profit) || [];

        // Calculate Monthly Totals
        const totalInc = income.reduce((a, b) => a + Number(b || 0), 0);
        const totalExp = expense.reduce((a, b) => a + Number(b || 0), 0);
        const totalProf = profit.reduce((a, b) => a + Number(b || 0), 0);

        const summaryBlock = document.getElementById('overview-monthly-summary');
        const incEl = document.getElementById('monthly-total-income');
        const expEl = document.getElementById('monthly-total-costs');
        const profEl = document.getElementById('monthly-total-profit');

        if (summaryBlock) {
            summaryBlock.style.display = (labels && labels.length) ? 'grid' : 'none';
            if (incEl) incEl.textContent = totalInc.toLocaleString() + ' T';
            if (expEl) expEl.textContent = '-' + Math.abs(totalExp).toLocaleString() + ' T';
            if (profEl) profEl.textContent = totalProf.toLocaleString() + ' T';
        }

        const today = getTodayJalaliParts();
        const isCurrentMonth = !!(today && year === today.year && month === today.month);
        const maxDay = isCurrentMonth ? today.day : Infinity;

        const ordered = (labels || []).map((label, idx) => {
            const dayInt = parseInt(normalizeDigits(String(label)), 10);
            return { idx, label: String(label), dayInt: Number.isFinite(dayInt) ? dayInt : 0 };
        }).filter(x => x.dayInt > 0 && x.dayInt <= maxDay)
          .sort((a, b) => b.dayInt - a.dayInt);

        const rows = ordered.map(({ idx, label, dayInt }) => {
            const day = String(label);
            const fullDateStr = (year && month && day)
                ? `${String(year).padStart(4, '0')}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`
                : day;
            const dayLabel = String(dayInt).padStart(2, '0');

            const inc = Number(income[idx] || 0);
            const exp = Number(expense[idx] || 0);
            const prof = Number(profit[idx] || (inc - exp));

            return `
                <div class="overview-item">
                    <div class="overview-dot"></div>
                    <div class="overview-content">
                        <div class="overview-grid">
                            <div class="overview-cell" data-kind="date">
                                <span class="overview-label">Date</span>
                                <span class="overview-value" title="${escapeAttr(fullDateStr)}">${escapeAttr(dayLabel)}</span>
                            </div>
                            <div class="overview-cell" data-kind="income">
                                <span class="overview-label">Income</span>
                                <span class="overview-value success">${inc.toLocaleString()} T</span>
                            </div>
                            <div class="overview-cell" data-kind="costs">
                                <span class="overview-label">Costs</span>
                                <span class="overview-value danger">-${Math.abs(exp).toLocaleString()} T</span>
                            </div>
                            <div class="overview-cell" data-kind="profit">
                                <span class="overview-label">Profit</span>
                                <span class="overview-value profit">${prof.toLocaleString()} T</span>
                            </div>
                        </div>
                        <div class="overview-date-footer">${escapeAttr(fullDateStr)}</div>
                    </div>
                </div>
            `;
        });

        if (!rows.length) {
            overviewFeed.innerHTML = `<div class="overview-empty">No overview data.</div>`;
            return;
        }

        overviewFeed.innerHTML = rows.join('');
    };

    const loadOverviewMonth = async (year, month) => {
        if (!overviewFeed) return;
        overviewFeed.innerHTML = `<div class="overview-empty">Loading overview…</div>`;

        const summaryBlock = document.getElementById('overview-monthly-summary');
        if (summaryBlock) summaryBlock.style.display = 'none';

        const query = buildOverviewQuery({ range: 'month', year, month });
        const response = await fetch(`/api/finance/overview?${query}`);
        const data = await response.json();
        if (!response.ok || !data.success) {
            overviewFeed.innerHTML = `<div class="overview-empty">Failed to load overview.</div>`;
            return;
        }
        renderOverview({ year, month, labels: data.labels, series: data.series });
    };

    const loadOverviewMonths = async () => {
        if (!overviewMonthSelect) return;
        const previousValue = overviewMonthSelect.value;
        overviewMonthSelect.innerHTML = '<option value="" selected>Loading…</option>';

        const query = buildOverviewQuery({ range: '12m' });
        const response = await fetch(`/api/finance/overview?${query}`);
        const data = await response.json();
        if (!response.ok || !data.success) {
            overviewMonthSelect.innerHTML = '<option value="" selected>Failed to load months</option>';
            return;
        }

        const labels = data.labels || [];
        const currentValue = previousValue;

        overviewMonthSelect.innerHTML = labels.map(label => {
            const safe = formatYMOption(label);
            return `<option value="${escapeAttr(safe)}">${escapeAttr(safe)}</option>`;
        }).join('');

        // Default to latest month
        const defaultLabel = labels.length ? labels[labels.length - 1] : '';
        const nextValue = currentValue && labels.includes(currentValue) ? currentValue : defaultLabel;
        if (nextValue) overviewMonthSelect.value = nextValue;

        const ym = parseYM(overviewMonthSelect.value);
        if (ym) await loadOverviewMonth(ym.year, ym.month);
    };

    const setLoadingState = (message = 'Loading...') => {
        if (countLabel) countLabel.textContent = 'Loading...';
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align:center; padding:20px; color:var(--text-secondary);">${message}</td></tr>`;
        }
    };

    const getPageNumbers = (current, total) => {
        if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
        const pages = [];
        pages.push(1);
        if (current > 3) pages.push('...');
        const start = Math.max(2, current - 1);
        const end = Math.min(total - 1, current + 1);
        for (let i = start; i <= end; i++) pages.push(i);
        if (current < total - 2) pages.push('...');
        pages.push(total);
        return pages;
    };

    const updatePaginationUI = () => {
        const start = totalItems === 0 ? 0 : ((currentPage - 1) * perPage) + 1;
        const end = Math.min(currentPage * perPage, totalItems);
        if (pageInfo) pageInfo.textContent = `Showing ${start} to ${end} of ${totalItems} results`;

        const pages = getPageNumbers(currentPage, totalPages);
        let html = '';

        html += `<button class="page-btn ${currentPage <= 1 ? 'disabled' : ''}" data-page="prev" ${currentPage <= 1 ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'}; opacity: ${currentPage <= 1 ? '0.5' : '1'};">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>`;

        pages.forEach(p => {
            if (p === '...') {
                html += `<span style="padding: 8px 4px; color: var(--text-secondary);">...</span>`;
            } else {
                const isActive = p === currentPage;
                html += `<button class="page-btn ${isActive ? 'active' : ''}" data-page="${p}" style="min-width: 36px; padding: 8px 12px; border: 1px solid ${isActive ? 'var(--primary)' : 'var(--border-color)'}; background: ${isActive ? 'var(--primary)' : 'var(--bg-secondary)'}; color: ${isActive ? '#fff' : 'var(--text-secondary)'}; border-radius: 6px; cursor: pointer; font-weight: ${isActive ? '600' : '400'};">${p}</button>`;
            }
        });

        html += `<button class="page-btn ${currentPage >= totalPages ? 'disabled' : ''}" data-page="next" ${currentPage >= totalPages ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'}; opacity: ${currentPage >= totalPages ? '0.5' : '1'};">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>`;

        if (paginationButtons) {
            paginationButtons.innerHTML = html;
            paginationButtons.querySelectorAll('.page-btn:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    if (page === 'prev') currentPage = Math.max(1, currentPage - 1);
                    else if (page === 'next') currentPage = Math.min(totalPages, currentPage + 1);
                    else currentPage = parseInt(page, 10);
                    loadPayments();
                });
            });
        }
    };

    const renderPayments = (payments) => {
        if (!tbody) return;
        if (!payments || !payments.length) {
            tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align: center; padding: 20px; color: var(--text-secondary);">No payments found.</td></tr>`;
            return;
        }

        payments.sort((a, b) => {
            const da = new Date(a.payment_date || a.created_at);
            const db = new Date(b.payment_date || b.created_at);
            return db - da;
        });

        tbody.innerHTML = payments.map(p => {
            const entryId = String(p.id);
            const isTx = entryId.startsWith('tx-');
            const canEdit = (p.type === 'payment') || (isSuperadmin && isTx);
            const canDelete = (p.type === 'payment') || (isSuperadmin && isTx);

            const userCell = isSuperadmin ? `
                <td data-label="User" style="padding: 15px; color: var(--text-secondary);">
                    ${p.admin ? `<span style="font-weight: 600; color: var(--text-primary);">${p.admin.username}</span>` : '-'}
                </td>` : '';

            let typeLabel = '-';
            if (p.type) {
                const typeText = String(p.type).toUpperCase();
                const typeCss = typeText.replace(/[^A-Z0-9_]/g, '_');
                typeLabel = `<span class="badge type-badge type-${escapeAttr(typeCss)}">${escapeAttr(typeText)}</span>`;
            }

            let cardLabel = '-';
            if (p.card) {
                const bank = (p.card.bank_name || '').trim();
                cardLabel = bank
                    ? `<span style="color: var(--text-primary); font-weight: 500; min-width:0; overflow:hidden; text-overflow:ellipsis;">${p.card.label}</span><span style="font-size: 0.7rem; color: var(--text-secondary); margin-left: 8px;">${bank}</span>`
                    : `<span style="color: var(--text-primary); font-weight: 500; min-width:0; overflow:hidden; text-overflow:ellipsis;">${p.card.label}</span>`;
            }

            const isEdited = String(p.description || '').toLowerCase().includes('edited by');
            const statusBadge = isEdited
                ? '<span class="badge" style="font-size: 0.7rem; background: var(--primary);">EDITED</span>'
                : (p.verified ? '<span class="badge active" style="font-size: 0.7rem;">VERIFIED</span>' : '<span class="badge" style="font-size: 0.7rem; background: #374151;">PENDING</span>');

            const editBtnHtml = canEdit
                ? `<button class="action-btn" title="Edit" data-action="edit" data-entry-id="${escapeAttr(entryId)}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>`
                : `<button class="action-btn" title="Edit" disabled style="opacity:0.5;cursor:not-allowed;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>`;

            const deleteBtnHtml = canDelete
                ? `<button class="action-btn danger" title="Delete" data-action="delete" data-entry-id="${escapeAttr(entryId)}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>`
                : `<button class="action-btn danger" title="Delete" disabled style="opacity:0.5;cursor:not-allowed;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>`;

            const amountValue = Number(p.amount || 0);
            const amountColor = amountValue >= 0 ? 'var(--success)' : 'var(--danger)';
            const amountSign = amountValue >= 0 ? '+' : '';

            return `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td data-label="Date" style="padding: 15px; color: var(--text-primary);">${p.payment_date_jalali || '-'}</td>
                    ${userCell}
                    <td data-label="Type" style="padding: 15px;">${typeLabel}</td>
                    <td data-label="Sender" style="padding: 15px;">
                        <div style="display:flex; flex-direction:row; align-items:center; justify-content:flex-end; text-align:right; gap:8px; width:100%; flex-wrap:wrap; min-width:0;">
                            <div style="font-weight: 600; color: var(--text-primary); min-width:0; overflow:hidden; text-overflow:ellipsis;">${p.sender_name || '-'}</div>
                            ${p.sender_card ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${p.sender_card}</div>` : ''}
                        </div>
                    </td>
                    <td data-label="Card" style="padding: 15px; color: var(--text-secondary);">
                        <div style="display:flex; flex-direction:row; align-items:center; justify-content:flex-end; text-align:right; gap:6px; width:100%; flex-wrap:wrap; min-width:0;">${cardLabel}</div>
                    </td>
                    <td data-label="Amount" style="padding: 15px; color: ${amountColor}; font-weight: bold; direction: ltr;"><span class="finance-amount">${amountSign}${amountValue.toLocaleString()} T</span></td>
                    <td data-label="Client" style="padding: 15px; color: var(--text-secondary);">${p.client_email || '-'}</td>
                    <td data-label="Status" style="padding: 15px;">${statusBadge}</td>
                    <td data-label="Actions" style="padding: 15px; text-align: right;">
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            ${editBtnHtml}
                            ${deleteBtnHtml}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    };

    tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action');
        const entryId = btn.getAttribute('data-entry-id');
        if (!entryId) return;
        if (action === 'edit') window.editEntry(entryId);
        if (action === 'delete') window.deleteEntry(entryId);
    });

    const loadStats = async () => {
        try {
            const params = new URLSearchParams();
            Object.entries(filters).forEach(([key, value]) => { if (value) params.append(key, value); });
            const response = await fetch(`/api/finance/stats?${params}`);
            const data = await response.json();
            const stats = data.stats || {};

            const todayEl = document.getElementById('stat-today');
            const monthEl = document.getElementById('stat-month');
            const monthExpenseEl = document.getElementById('stat-month-expense');
            const totalEl = document.getElementById('stat-total');
            if (todayEl) todayEl.textContent = Number(stats.today || 0).toLocaleString() + ' T';
            if (monthEl) monthEl.textContent = Number(stats.month || 0).toLocaleString() + ' T';
            if (monthExpenseEl) monthExpenseEl.textContent = Number(stats.month_expense || 0).toLocaleString() + ' T';
            if (totalEl) totalEl.textContent = Number(stats.month_net ?? 0).toLocaleString() + ' T';

            const fmtPct = (v) => {
                if (v === null || v === undefined || Number.isNaN(Number(v))) return null;
                const num = Number(v);
                if (!Number.isFinite(num)) return null;
                const sign = num > 0 ? '+' : '';
                return `${sign}${num.toFixed(0)}%`;
            };

            const applyDelta = (elId, pct, goodIsPositive = true, emptyText = 'vs last month: —') => {
                const el = document.getElementById(elId);
                if (!el) return;
                const p = fmtPct(pct);
                if (!p) {
                    el.textContent = emptyText;
                    el.style.color = 'var(--text-secondary)';
                    return;
                }
                el.textContent = emptyText.replace('—', p);
                const isUp = Number(pct) >= 0;
                const good = goodIsPositive ? isUp : !isUp;
                el.style.color = good ? 'var(--success)' : 'var(--danger)';
            };

            applyDelta('stat-month-delta', stats.month_change_pct, true, 'vs last month: —');
            applyDelta('stat-month-expense-delta', stats.month_expense_change_pct, false, 'vs last month: —');
            applyDelta('stat-net-delta', stats.month_net_change_pct, true, 'Profit vs last month: —');
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    };

    const loadPayments = async () => {
        try {
            setLoadingState();
            const query = buildQueryString();
            const response = await fetch(`/api/payments?${query}`);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Failed to load');

            totalPages = data.pages || 1;
            currentPage = data.current_page || 1;
            totalItems = data.total || 0;
            lastLoadedEntries = data.payments || [];

            renderPayments(data.payments || []);
            updatePaginationUI();
            if (countLabel) countLabel.textContent = `${totalItems} payments found.`;
        } catch (error) {
            console.error(error);
            if (tbody) tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align: center; color: #ef4444; padding: 20px;">${error.message}</td></tr>`;
            if (countLabel) countLabel.textContent = 'Unable to load payments';
        }
    };

    const clearFilters = () => {
        if (filtersForm) filtersForm.reset();
        if (cardSelect) cardSelect.value = '';
        if (userSelect) userSelect.value = '';
        if (directionSelect) directionSelect.value = '';
        if (typeSelect) typeSelect.value = '';
        if (searchInput) searchInput.value = '';
        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        rangeButtons.forEach(btn => btn.classList.remove('active'));
        updateFiltersFromInputs();
        currentPage = 1;
    };

    rangeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            rangeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const range = btn.dataset.range;
            if (range === 'clear') {
                startInput.value = '';
                endInput.value = '';
                return;
            }

            const end = new Date();
            const start = new Date();
            if (range === 'today') {
                // keep start as today
            } else if (range === '7d') {
                start.setDate(start.getDate() - 6);
            } else if (range === '30d') {
                start.setDate(start.getDate() - 29);
            }
            startInput.value = formatJalali(start);
            endInput.value = formatJalali(end);
        });
    });

    filtersForm.addEventListener('submit', (event) => {
        event.preventDefault();
        updateFiltersFromInputs();
        currentPage = 1;
        loadPayments();
        loadStats();
        if (isOverviewOpen()) ensureOverviewLoaded({ forceMonthsReload: true });
    });

    resetButton.addEventListener('click', (event) => {
        event.preventDefault();
        clearFilters();
        loadPayments();
        loadStats();
        if (isOverviewOpen()) ensureOverviewLoaded({ forceMonthsReload: true });
    });

    if (overviewMonthSelect) {
        overviewMonthSelect.addEventListener('change', () => {
            updateFiltersFromInputs();
            const ym = parseYM(overviewMonthSelect.value);
            if (!ym) return;
            loadOverviewMonth(ym.year, ym.month);
        });
    }

    if (overviewDetails) {
        overviewDetails.addEventListener('toggle', () => {
            if (overviewDetails.open) {
                if (overviewEmpty) overviewEmpty.textContent = 'Loading overview…';
                ensureOverviewLoaded({ forceMonthsReload: false });
            }
        });
    }

    kindSelect.addEventListener('change', () => updateKindUI());

    function openModal() {
        document.getElementById('payment-modal').classList.remove('hidden');
        updateKindUI();
    }

    function closeModal() {
        document.getElementById('payment-modal').classList.add('hidden');
        document.getElementById('payment-form').reset();
        document.getElementById('payment-id').value = '';
        document.getElementById('modal-title').textContent = 'Add Payment';
        const err = document.getElementById('payment-error');
        if (err) { err.style.display = 'none'; err.textContent = ''; }
        if (txAuditNote) txAuditNote.style.display = 'none';
        kindSelect.value = 'income';
        updateKindUI();
    }

    window.openModal = openModal;
    window.closeModal = closeModal;

    addPaymentBtn.addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'Add Payment';
        const today = new Date();
        const todayJalali = formatJalali(today);
        const dateInput = document.getElementById('payment-date');
        if (dateInput && !dateInput.value) dateInput.value = todayJalali;

        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const timeInput = document.getElementById('payment-time');
        if (timeInput && !timeInput.value) timeInput.value = `${hh}:${mm}`;

        kindSelect.value = 'income';
        if (txAuditNote) txAuditNote.style.display = 'none';
        updateKindUI();
        window.openModal();
    });

    setupAmountFormatting();

    document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorBox = document.getElementById('payment-error');
        const saveBtn = document.getElementById('save-payment-btn');
        if (errorBox) { errorBox.style.display = 'none'; errorBox.textContent = ''; }

        const amountValRaw = document.getElementById('payment-amount').value;
        const amountDigits = toCleanNumberString(amountValRaw);
        if (!amountDigits || Number(amountDigits) <= 0) {
            if (errorBox) {
                errorBox.textContent = 'Amount is required and must be greater than 0';
                errorBox.style.display = 'block';
            }
            return;
        }

        saveBtn.disabled = true;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';

        const paymentId = document.getElementById('payment-id').value;
        const paymentDate = document.getElementById('payment-date').value;
        let paymentTime = document.getElementById('payment-time').value;
        if (!paymentTime) {
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            paymentTime = `${hh}:${mm}`;
        }

        const data = {
            amount: amountDigits,
            payment_date: paymentDate,
            payment_time: paymentTime,
            card_id: document.getElementById('payment-card').value || null,
            sender_name: document.getElementById('payment-sender-name').value,
            sender_card: document.getElementById('payment-sender-card').value,
            client_email: document.getElementById('payment-client').value,
            description: document.getElementById('payment-description').value,
            is_expense: kindSelect.value === 'expense'
        };

        if (data.is_expense) {
            data.server_id = document.getElementById('payment-server').value || null;
            data.cost_type = document.getElementById('payment-cost-type').value || 'server_cost';
            if (!data.server_id) {
                if (errorBox) {
                    errorBox.textContent = 'Please select a server for this expense.';
                    errorBox.style.display = 'block';
                }
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
        }

        try {
            let url = paymentId ? `/api/payments/${paymentId}` : '/api/payments';
            let method = paymentId ? 'PUT' : 'POST';

            if (paymentId && String(paymentId).startsWith('tx-')) {
                url = `/api/transactions/${String(paymentId).slice(3)}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (!response.ok) throw new Error((result && result.error) ? result.error : 'Failed to save');

            window.closeModal();
            try {
                if (result && result.converted) showToast('Converted to expense successfully');
                else if (method === 'POST') showToast('Payment saved successfully');
                else showToast('Payment updated successfully');
            } catch (e) {}

            loadPayments();
            loadStats();
        } catch (error) {
            if (errorBox) {
                errorBox.textContent = error.message || 'An error occurred';
                errorBox.style.display = 'block';
            }
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    });

    window.editEntry = async (id) => {
        try {
            const entryId = String(id);
            let entry = (lastLoadedEntries || []).find(p => String(p.id) === entryId);
            if (!entry) {
                const response = await fetch(`/api/payments?limit=1000`);
                const data = await response.json();
                entry = (data.payments || []).find(p => String(p.id) === entryId);
            }

            if (!entry) {
                alert('Payment not found');
                return;
            }

            const isTx = String(entry.id).startsWith('tx-');
            if (isTx && !isSuperadmin) {
                alert('Access denied');
                return;
            }

            if (txAuditNote) {
                txAuditNote.style.display = isTx ? 'block' : 'none';
            }

            document.getElementById('payment-id').value = entry.id;
            document.getElementById('payment-amount').value = formatWithCommas(String(entry.amount || '').replace(/[^0-9]/g, ''));
            // payment_date_jalali is like "YYYY/MM/DD HH:MM"; split into date/time inputs
            const jalaliDt = (entry.payment_date_jalali || '').trim();
            let datePart = '';
            let timePart = '';
            if (jalaliDt) {
                const parts = jalaliDt.split(' ');
                datePart = parts[0] || '';
                timePart = parts[1] || '';
            }
            document.getElementById('payment-date').value = datePart;
            document.getElementById('payment-time').value = timePart;
            document.getElementById('payment-card').value = entry.card_id || '';
            document.getElementById('payment-sender-name').value = entry.sender_name || '';
            document.getElementById('payment-sender-card').value = entry.sender_card || '';
            document.getElementById('payment-client').value = entry.client_email || '';
            document.getElementById('payment-description').value = entry.description || '';

            if (isTx) {
                const isExpense = Number(entry.amount) < 0;
                kindSelect.value = isExpense ? 'expense' : 'income';
                updateKindUI();
                // expense-only fields (server/type)
                try {
                    document.getElementById('payment-server').value = (entry.server && entry.server.id) ? entry.server.id : '';
                } catch (e) {}
                try {
                    document.getElementById('payment-cost-type').value = entry.type || 'server_cost';
                } catch (e) {}
            } else {
                kindSelect.value = 'income';
                updateKindUI();
            }

            document.getElementById('modal-title').textContent = 'Edit Payment';
            openModal();
        } catch (error) {
            alert('Error loading payment');
        }
    };

    let paymentToDelete = null;

    window.deleteEntry = async (id) => {
        try {
            const entryId = String(id);
            let entry = (lastLoadedEntries || []).find(p => String(p.id) === entryId);
            if (!entry) {
                const response = await fetch(`/api/payments?limit=1000`);
                const data = await response.json();
                entry = (data.payments || []).find(p => String(p.id) === entryId);
            }

            if (!entry) {
                alert('Payment not found');
                return;
            }

            const isTx = String(entry.id).startsWith('tx-');
            if (isTx && !isSuperadmin) {
                alert('Access denied');
                return;
            }

            // Store payment ID for deletion
            paymentToDelete = entry.id;

            // Populate modal with payment details
            document.getElementById('delete-amount').textContent = `${Number(entry.amount || 0).toLocaleString()} T`;
            document.getElementById('delete-date').textContent = entry.payment_date_jalali || '-';
            document.getElementById('delete-sender').textContent = entry.sender_name || entry.sender_card || '-';

            // Show delete modal
            document.getElementById('delete-modal').classList.remove('hidden');
        } catch (error) {
            alert('Error loading payment details');
        }
    };

    window.closeDeleteModal = () => {
        document.getElementById('delete-modal').classList.add('hidden');
        paymentToDelete = null;
    };

    window.confirmDelete = async () => {
        if (!paymentToDelete) return;

        const confirmBtn = document.getElementById('confirm-delete-btn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span style="opacity: 0.7;">Deleting...</span>';

        try {
            let url = `/api/payments/${paymentToDelete}`;
            if (String(paymentToDelete).startsWith('tx-')) {
                url = `/api/transactions/${String(paymentToDelete).slice(3)}`;
            }
            const response = await fetch(url, { method: 'DELETE' });
            const result = await response.json();

            if (!response.ok) throw new Error(result.error || 'Failed to delete');

            closeDeleteModal();
            
            // Show success message
            try {
                showToast('Payment deleted successfully');
            } catch (e) { /* ignore */ }

            loadPayments();
            loadStats();
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
        }
    };

    // Close delete modal when clicking outside
    document.getElementById('delete-modal').addEventListener('click', (e) => {
        if (e.target.id === 'delete-modal') closeDeleteModal();
    });

    document.getElementById('payment-modal').addEventListener('click', (e) => {
        if (e.target.id === 'payment-modal') closeModal();
    });

    updateFiltersFromInputs();
    loadStats();
    loadPayments();
    // Overview is lazy-loaded when Summary is opened

    if (!isSuperadmin) {
        const monthLabel = document.getElementById('stat-month-label');
        if (monthLabel) monthLabel.textContent = 'Charge';
        const expenseLabel = document.getElementById('stat-month-expense-label');
        if (expenseLabel) expenseLabel.textContent = 'Month Cost';
        const totalLabel = document.getElementById('stat-total-label');
        if (totalLabel) totalLabel.textContent = 'Total';
    }
</script>
{% endblock %}
