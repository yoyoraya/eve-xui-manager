{% extends "base.html" %}

{% block title %}Finance Overview - Eve X-UI Manager{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1 class="page-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            Finance Overview
        </h1>
        <p class="page-subtitle">Track your income and payments</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: var(--text-secondary); font-size: 0.875rem;">Today</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        </div>
        <div id="stat-today" style="font-size: 1.75rem; font-weight: 700; color: #4ade80;">0 T</div>
    </div>
    
    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: var(--text-secondary); font-size: 0.875rem;">This Week</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        </div>
        <div id="stat-week" style="font-size: 1.75rem; font-weight: 700; color: #60a5fa;">0 T</div>
    </div>
    
    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: var(--text-secondary); font-size: 0.875rem;">This Month</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
        </div>
        <div id="stat-month" style="font-size: 1.75rem; font-weight: 700; color: #a78bfa;">0 T</div>
    </div>
    
    <div class="stat-card" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="color: var(--text-secondary); font-size: 0.875rem;">Total Income</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        </div>
        <div id="stat-total" style="font-size: 1.75rem; font-weight: 700; color: #fbbf24;">0 T</div>
    </div>
</div>

<!-- Add Payment Button & Filters -->
<div class="server-card" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; padding: 20px;">
        <button id="add-payment-btn" class="btn-apply" style="display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Payment
        </button>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <select id="card-filter" class="form-select" style="min-width: 150px;">
                <option value="">All Cards</option>
                {% for card in cards %}
                <option value="{{ card.id }}">{{ card.label }}</option>
                {% endfor %}
            </select>
            
            {% if is_superadmin %}
            <select id="user-filter" class="form-select" style="min-width: 150px;">
                <option value="">All Users</option>
                {% for admin in admin_options %}
                <option value="{{ admin.id }}">{{ admin.username }}</option>
                {% endfor %}
            </select>
            {% endif %}
            
            <input type="text" id="search-input" class="form-input" placeholder="Search..." style="min-width: 200px;">
        </div>
    </div>
</div>

<!-- Payments Table -->
<div class="server-card">
    <div class="server-header">
        <div class="server-title">
            <h3>Payment History</h3>
            <p class="muted-note" id="payments-count">Loading...</p>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="clients-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 15px; text-align: left;">Date</th>
                    {% if is_superadmin %}
                    <th style="padding: 15px; text-align: left;">User</th>
                    {% endif %}
                    <th style="padding: 15px; text-align: left;">Sender</th>
                    <th style="padding: 15px; text-align: left;">Card</th>
                    <th style="padding: 15px; text-align: left;">Amount</th>
                    <th style="padding: 15px; text-align: left;">Client</th>
                    <th style="padding: 15px; text-align: left;">Status</th>
                    <th style="padding: 15px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody id="payments-list">
                <tr><td colspan="8" style="text-align: center; padding: 20px;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-top: 1px solid var(--border-color);">
        <span id="page-info" style="color: var(--text-secondary); font-size: 0.875rem;">Showing 0 to 0 of 0 results</span>
        <div id="pagination-buttons" style="display: flex; align-items: center; gap: 4px;"></div>
    </div>
</div>

<!-- Add/Edit Payment Modal -->
<div id="payment-modal" class="modal-overlay hidden">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h3 id="modal-title">Edit Payment</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="payment-form">
            <input type="hidden" id="payment-id">
            <div class="modal-body">
                <div class="form-group">
                    <label>Amount (Toman) *</label>
                    <input type="number" id="payment-amount" class="form-input" required min="1" placeholder="e.g. 150000">
                </div>
                <div class="form-group">
                    <label>Payment Date (Jalali)</label>
                    <input type="text" id="payment-date" class="form-input" placeholder="1403/09/18">
                </div>
                <div class="form-group">
                    <label>Destination Card (Your Card)</label>
                    <select id="payment-card" class="form-select">
                        <option value="">-- Select Card --</option>
                        {% for card in cards %}
                        <option value="{{ card.id }}">{{ card.label }} ({{ card.bank_name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Sender Name</label>
                    <input type="text" id="payment-sender-name" class="form-input" placeholder="Customer name">
                </div>
                <div class="form-group">
                    <label>Sender Card Number</label>
                    <input type="text" id="payment-sender-card" class="form-input" placeholder="6037xxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Client Email</label>
                    <input type="text" id="payment-client" class="form-input" placeholder="client@example.com">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="payment-description" class="form-input" rows="2" placeholder="Notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn-reset" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn-apply">Save Payment</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const isSuperadmin = {{ 'true' if is_superadmin else 'false' }};
    const columnSpan = isSuperadmin ? 8 : 7;
    
    const tbody = document.getElementById('payments-list');
    const countLabel = document.getElementById('payments-count');
    const pageInfo = document.getElementById('page-info');
    const paginationButtons = document.getElementById('pagination-buttons');
    
    const cardFilter = document.getElementById('card-filter');
    const userFilter = document.getElementById('user-filter');
    const searchInput = document.getElementById('search-input');
    
    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    const perPage = 20;
    
    // Load stats
    const loadStats = async () => {
        try {
            const params = new URLSearchParams();
            if (cardFilter.value) params.append('card_id', cardFilter.value);
            if (userFilter && userFilter.value) params.append('user_id', userFilter.value);
            
            const response = await fetch(`/api/finance/stats?${params}`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('stat-today').textContent = Number(data.stats.today).toLocaleString() + ' T';
                document.getElementById('stat-week').textContent = Number(data.stats.week).toLocaleString() + ' T';
                document.getElementById('stat-month').textContent = Number(data.stats.month).toLocaleString() + ' T';
                document.getElementById('stat-total').textContent = Number(data.stats.total).toLocaleString() + ' T';
            }
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    };
    
    // Load payments
    const loadPayments = async () => {
        try {
            tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align: center; padding: 20px;">Loading...</td></tr>`;
            
            const params = new URLSearchParams();
            params.append('page', currentPage);
            params.append('limit', perPage);
            
            if (cardFilter.value) params.append('card_id', cardFilter.value);
            if (userFilter && userFilter.value) params.append('user_id', userFilter.value);
            if (searchInput.value.trim()) params.append('search', searchInput.value.trim());
            
            const response = await fetch(`/api/payments?${params}`);
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error || 'Failed to load');
            
            totalPages = data.pages || 1;
            currentPage = data.current_page || 1;
            totalItems = data.total || 0;
            
            renderPayments(data.payments || []);
            updatePaginationUI();
            
            countLabel.textContent = `${totalItems} payments found.`;
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align: center; color: #ef4444; padding: 20px;">${error.message}</td></tr>`;
        }
    };
    
    const renderPayments = (payments) => {
        if (!payments.length) {
            tbody.innerHTML = `<tr><td colspan="${columnSpan}" style="text-align: center; padding: 20px; color: var(--text-secondary);">No payments found.</td></tr>`;
            return;
        }
        
        tbody.innerHTML = payments.map(p => {
            const userCell = isSuperadmin ? `
                <td style="padding: 15px; color: var(--text-secondary);">
                    ${p.admin ? `<span style="font-weight: 600; color: var(--text-primary);">${p.admin.username}</span>` : '-'}
                </td>` : '';
            
            const cardLabel = p.card ? `<span style="color: var(--text-primary); font-weight: 500;">${p.card.label}</span><br><span style="font-size: 0.7rem; color: var(--text-secondary);">${p.card.bank_name || ''}</span>` : '-';
            const statusBadge = p.verified 
                ? '<span class="badge active" style="font-size: 0.7rem;">VERIFIED</span>'
                : '<span class="badge" style="font-size: 0.7rem; background: #374151;">PENDING</span>';
            
            return `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 15px; color: var(--text-primary);">${p.payment_date_jalali || '-'}</td>
                    ${userCell}
                    <td style="padding: 15px;">
                        <div style="font-weight: 600; color: var(--text-primary);">${p.sender_name || '-'}</div>
                        ${p.sender_card ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${p.sender_card}</div>` : ''}
                    </td>
                    <td style="padding: 15px; color: var(--text-secondary);">${cardLabel}</td>
                    <td style="padding: 15px; color: #4ade80; font-weight: bold; direction: ltr;">+${Number(p.amount).toLocaleString()} T</td>
                    <td style="padding: 15px; color: var(--text-secondary);">${p.client_email || '-'}</td>
                    <td style="padding: 15px;">${statusBadge}</td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button onclick="editPayment(${p.id})" class="action-icon" title="Edit" style="width: 40px; height: 40px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.35); background: transparent; display: flex; align-items: center; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button onclick="deletePayment(${p.id})" class="action-icon" title="Delete" style="width: 40px; height: 40px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.35); background: transparent; display: flex; align-items: center; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    };
    
    const updatePaginationUI = () => {
        const start = totalItems === 0 ? 0 : ((currentPage - 1) * perPage) + 1;
        const end = Math.min(currentPage * perPage, totalItems);
        pageInfo.textContent = `Showing ${start} to ${end} of ${totalItems} results`;
        
        let html = '';
        
        html += `<button class="page-btn ${currentPage <= 1 ? 'disabled' : ''}" data-page="prev" ${currentPage <= 1 ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: ${currentPage <= 1 ? 'not-allowed' : 'pointer'}; opacity: ${currentPage <= 1 ? '0.5' : '1'};">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>`;
        
        const pages = getPageNumbers(currentPage, totalPages);
        pages.forEach(p => {
            if (p === '...') {
                html += `<span style="padding: 8px 4px; color: var(--text-secondary);">...</span>`;
            } else {
                const isActive = p === currentPage;
                html += `<button class="page-btn ${isActive ? 'active' : ''}" data-page="${p}" style="min-width: 36px; padding: 8px 12px; border: 1px solid ${isActive ? '#6366f1' : 'var(--border-color)'}; background: ${isActive ? '#6366f1' : 'var(--bg-secondary)'}; color: ${isActive ? '#fff' : 'var(--text-secondary)'}; border-radius: 6px; cursor: pointer;">${p}</button>`;
            }
        });
        
        html += `<button class="page-btn ${currentPage >= totalPages ? 'disabled' : ''}" data-page="next" ${currentPage >= totalPages ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'}; opacity: ${currentPage >= totalPages ? '0.5' : '1'};">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>`;
        
        paginationButtons.innerHTML = html;
        
        paginationButtons.querySelectorAll('.page-btn:not(.disabled)').forEach(btn => {
            btn.addEventListener('click', () => {
                const page = btn.dataset.page;
                if (page === 'prev') currentPage = Math.max(1, currentPage - 1);
                else if (page === 'next') currentPage = Math.min(totalPages, currentPage + 1);
                else currentPage = parseInt(page);
                loadPayments();
            });
        });
    };
    
    const getPageNumbers = (current, total) => {
        if (total <= 7) return Array.from({length: total}, (_, i) => i + 1);
        const pages = [1];
        if (current > 3) pages.push('...');
        const start = Math.max(2, current - 1);
        const end = Math.min(total - 1, current + 1);
        for (let i = start; i <= end; i++) if (!pages.includes(i)) pages.push(i);
        if (current < total - 2) pages.push('...');
        if (!pages.includes(total)) pages.push(total);
        return pages;
    };
    
    // Modal functions
    const openModal = () => {
        document.getElementById('payment-modal').classList.remove('hidden');
    };
    
    const closeModal = () => {
        document.getElementById('payment-modal').classList.add('hidden');
        document.getElementById('payment-form').reset();
        document.getElementById('payment-id').value = '';
        document.getElementById('modal-title').textContent = 'Add Payment';
    };
    
    document.getElementById('add-payment-btn').addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'Add Payment';
        openModal();
    });
    
    // Save payment
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const paymentId = document.getElementById('payment-id').value;
        const data = {
            amount: document.getElementById('payment-amount').value,
            payment_date: document.getElementById('payment-date').value,
            card_id: document.getElementById('payment-card').value || null,
            sender_name: document.getElementById('payment-sender-name').value,
            sender_card: document.getElementById('payment-sender-card').value,
            client_email: document.getElementById('payment-client').value,
            description: document.getElementById('payment-description').value
        };
        
        try {
            const url = paymentId ? `/api/payments/${paymentId}` : '/api/payments';
            const method = paymentId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (!response.ok) throw new Error(result.error || 'Failed to save');
            
            closeModal();
            loadPayments();
            loadStats();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
    
    // Edit payment
    window.editPayment = async (id) => {
        try {
            const response = await fetch(`/api/payments?limit=1000`);
            const data = await response.json();
            const payment = data.payments.find(p => p.id === id);
            
            if (!payment) {
                alert('Payment not found');
                return;
            }
            
            document.getElementById('payment-id').value = payment.id;
            document.getElementById('payment-amount').value = payment.amount;
            document.getElementById('payment-date').value = payment.payment_date_jalali || '';
            document.getElementById('payment-card').value = payment.card_id || '';
            document.getElementById('payment-sender-name').value = payment.sender_name || '';
            document.getElementById('payment-sender-card').value = payment.sender_card || '';
            document.getElementById('payment-client').value = payment.client_email || '';
            document.getElementById('payment-description').value = payment.description || '';
            
            document.getElementById('modal-title').textContent = 'Edit Payment';
            openModal();
        } catch (error) {
            alert('Error loading payment');
        }
    };
    
    // Delete payment
    window.deletePayment = async (id) => {
        if (!confirm('Are you sure you want to delete this payment?')) return;
        
        try {
            const response = await fetch(`/api/payments/${id}`, { method: 'DELETE' });
            const result = await response.json();
            
            if (!response.ok) throw new Error(result.error || 'Failed to delete');
            
            loadPayments();
            loadStats();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    };
    
    // Filters
    cardFilter.addEventListener('change', () => { currentPage = 1; loadPayments(); loadStats(); });
    if (userFilter) userFilter.addEventListener('change', () => { currentPage = 1; loadPayments(); loadStats(); });
    
    let debounceTimer;
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => { currentPage = 1; loadPayments(); }, 400);
    });
    
    // Click outside modal to close
    document.getElementById('payment-modal').addEventListener('click', (e) => {
        if (e.target.id === 'payment-modal') closeModal();
    });
    
    // Initial load
    loadStats();
    loadPayments();
</script>
{% endblock %}
