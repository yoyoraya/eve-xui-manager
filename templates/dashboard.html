{% extends "base.html" %}

{% block title %}Dashboard - X-UI{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header_actions %}
<div class="header-controls">
    <label class="toggle-switch" title="Auto Refresh">
        <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
        <span class="slider"></span>
    </label>
    <select id="refresh-interval" class="interval-select" onchange="updateRefreshInterval()">
        <option value="10">10s</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
        <option value="120">2 min</option>
        <option value="300">5 min</option>
    </select>
    <button class="btn btn-primary" onclick="refreshData()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        <span class="btn-label">Refresh</span>
    </button>
    <button class="btn btn-success" onclick="openAddClientModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"></path>
        </svg>
        <span class="btn-label">Add Client</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="overview-wrapper">
    <div class="overview-toggle" onclick="toggleOverview()">
        <h3>Overview</h3>
        <svg id="overview-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </div>
    <div class="stats-grid" id="overview-stats">
        <div class="stat-card">
            <div class="stat-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                    <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Servers</span>
                <span class="stat-value" id="stat-servers">{{ server_count }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                    <line x1="8" y1="21" x2="16" y2="21"></line>
                    <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Inbounds</span>
                <span class="stat-value" id="stat-inbounds">0</span>
                <span class="stat-sub" id="stat-active">0 Active</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Clients</span>
                <span class="stat-value" id="stat-total-clients">0</span>
                <div class="client-breakdown">
                    <span class="client-count active-count"><span id="stat-active-clients">0</span></span>
                    <span class="client-count inactive-count"><span id="stat-inactive-clients">0</span></span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Total Traffic</span>
                <span class="stat-value" id="stat-traffic">0 B</span>
                <span class="stat-sub"><span id="stat-upload">↑ 0 B</span> / <span id="stat-download">↓ 0 B</span></span>
            </div>
        </div>
    </div>
</div>

<div class="inbounds-section">
    <div class="section-header">
        <h2>Inbounds</h2>
        <span class="badge" id="inbounds-count">0 total</span>
    </div>
    <div class="filter-bar">
        <div class="search-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="global-search-input" placeholder="Search clients..." class="search-input">
            <button class="search-clear hidden" onclick="clearSearch()" id="clear-search-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="filters-group">
            <!-- Server Filter -->
            <div class="filter-dropdown-wrapper">
                <button class="filter-btn" onclick="toggleServerFilter()" id="server-filter-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="filter-icon"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>
                    <span>Servers</span>
                    <span class="badge-count hidden" id="server-filter-count">0</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="server-filter-dropdown" class="filter-dropdown hidden">
                    <div class="filter-header">
                        <span>Select Servers</span>
                        <button class="text-btn" onclick="selectAllServers()">All</button>
                    </div>
                    <div id="server-filter-list" class="filter-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Hide Disabled Filter -->
            <label class="filter-toggle" title="Hide Disabled Clients">
                <input type="checkbox" id="hide-disabled-filter" onchange="applyFilters()">
                <span class="toggle-track"></span>
                <span class="toggle-text">Hide Disabled</span>
            </label>
        </div>
    </div>
    
    <div id="search-results" style="display: none; margin-bottom: 20px; padding: 12px 16px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px; font-size: 0.9rem; color: #e0e7ff;">
        <span id="search-results-text"></span>
    </div>
    <div class="inbounds-list" id="inbounds-container">
        <div class="empty-state" id="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
            </svg>
            <h3>No servers added</h3>
            <p>Add your X-UI server to see statistics.</p>
            <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="server-modal-title">Servers</h2>
            <button class="modal-close" onclick="closeServerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="server-form">
                <h3 id="form-title">Add Server</h3>
                <input type="hidden" id="edit-server-id">
                <div class="form-group">
                    <label>Server Name</label>
                    <input type="text" id="server-name" placeholder="Server 1">
                </div>
                <div class="form-group">
                    <label>Panel URL</label>
                    <input type="text" id="server-host" placeholder="http://1.2.3.4:54321">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="server-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="server-password" placeholder="password">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 2;">
                        <label>Sub Path</label>
                        <input type="text" id="server-sub-path" placeholder="/sub/" value="/sub/">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Json Path</label>
                        <input type="text" id="server-json-path" placeholder="/json/" value="/json/">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Sub Port</label>
                        <input type="number" id="server-sub-port" placeholder="Default">
                    </div>
                </div>
                <div class="form-group">
                    <label>Panel Type</label>
                    <select id="server-panel-type" class="form-select">
                        <option value="auto">Auto Detect</option>
                        <option value="sanaei">3X-UI (Sanaei)</option>
                        <option value="alireza">X-UI (Alireza)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="testServerConnection()">Test Connection</button>
                    <button class="btn btn-primary" onclick="saveServer()">Save</button>
                </div>
            </div>
            
            <div class="server-list-section">
                <h3>Servers</h3>
                <div class="server-list" id="server-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="qr-modal">
    <div class="modal modal-xl">
        <div class="modal-header">
            <h2>QR Codes - <span id="qr-email" class="qr-email"></span></h2>
            <button class="modal-close" onclick="closeQrModal()">&times;</button>
        </div>
        <div class="modal-body qr-body" style="padding: 15px;">
            <div class="qr-grid">
                
                <div class="qr-item ripple" id="box-sub" onclick="copyText('input-sub', 'img-sub', 'Subscription')">
                    <div class="qr-title">Subscription</div>
                    <img id="img-sub" src="" alt="Sub QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-sub">
                </div>

                <div class="qr-item ripple" id="box-json" onclick="copyText('input-json', 'img-json', 'Subscription JSON')">
                    <div class="qr-title">Subscription JSON</div>
                    <img id="img-json" src="" alt="Json QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-json">
                </div>

                <div class="qr-item ripple" id="box-config" onclick="copyText('input-config', 'img-config', 'Direct Link')">
                    <div class="qr-title" id="title-config">Direct Link</div>
                    <img id="img-config" src="" alt="Config QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-config">
                </div>

                <div class="qr-item ripple" id="box-dash" onclick="copyText('input-dash', 'img-dash', 'Dash Sub')">
                    <div class="qr-title">Dash Sub</div>
                    <img id="img-dash" src="" alt="Dash QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-dash">
                </div>
                
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="expanded-qr-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2 id="expanded-qr-title">QR Code</h2>
            <button class="modal-close" onclick="closeExpandedQr()">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center; padding: 20px;">
            <img id="expanded-qr-img" src="" alt="QR" style="max-width: 300px; width: 100%; height: auto; background: white; padding: 10px; border-radius: 8px;">
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="renew-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Renew Client</h2>
            <button class="modal-close" onclick="closeRenewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="renew-server-id">
            <input type="hidden" id="renew-inbound-id">
            <input type="hidden" id="renew-email">
            
            <p class="renew-info">Renew Client: <strong id="renew-client-email"></strong></p>

            <div class="form-group">
                <label>Packages (Optional)</label>
                <div id="renew-packages-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading packages...</div>
                </div>
                <small style="color: var(--text-secondary); display: block; margin-top: 6px;">Click again to unselect a package. No selection = custom pricing.</small>
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Duration (Days)</label>
                    <input type="number" id="renew-custom-days" class="form-input" value="30" min="1" max="365" oninput="calculateRenewCustomPrice()">
                </div>
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Volume (GB)</label>
                    <input type="number" id="renew-custom-volume" class="form-input" value="10" min="0" max="10000" oninput="calculateRenewCustomPrice()">
                </div>
                <div style="flex: 1.5; background: rgba(255,255,255,0.05); padding: 0 12px; border-radius: 8px; height: 42px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color);">
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">Cost: <strong id="renew-price-display" style="color: #fbbf24; margin-left: 4px;">0</strong> <span style="font-size: 0.75rem;">T</span></span>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); padding: 8px 12px; border-radius: 8px; margin-bottom: 5px;">
                <span style="font-size: 0.9rem; color: #4ade80;">Payable Amount</span>
                <div style="color: #4ade80;">
                    <strong id="renew-payable-display" style="font-size: 1.1rem;">0</strong>
                    <span class="wallet-currency" style="font-size: 0.8rem;">T</span>
                </div>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 15px; text-align: right; opacity: 0.8;">
                Packages override the custom price. Without a package the amount is based on days & volume.
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <label class="form-group form-toggle-item" style="cursor: pointer; margin: 0;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="renew-reset-traffic">
                        <span class="slider"></span>
                    </div>
                    <span>Reset Traffic</span>
                </label>
                
                <label class="form-group form-toggle-item" style="cursor: pointer; margin: 0;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="renew-start-after-first-use">
                        <span class="slider"></span>
                    </div>
                    <span>Start after first use</span>
                </label>
            </div>
            
            <div class="form-footer" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div style="font-size: 0.9rem; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; color: #4ade80;">
                        <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path>
                        <path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path>
                        <path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path>
                    </svg>
                    <span style="color: #4ade80;">{{ "{:,}".format(credit if credit else 0) }} T</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeRenewModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitRenewal()">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>

        <div class="modal-overlay hidden" id="reset-modal">
            <div class="modal modal-sm">
                <div class="modal-header">
                    <h2>Reset Traffic</h2>
                    <button class="modal-close" onclick="closeResetModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reset-server-id">
                    <input type="hidden" id="reset-inbound-id">
                    <input type="hidden" id="reset-email">

                    <p class="renew-info">User: <strong id="reset-client-email"></strong></p>
                    <p class="reset-summary">Current plan volume: <strong id="reset-current-volume"></strong></p>

                    <div class="form-group">
                        <label>Billable Volume (GB)</label>
                        <input type="number" id="reset-volume" class="form-input" min="1" max="10000" value="50" oninput="updateResetCost()">
                        <small style="color: var(--text-secondary);">Adjust to charge the correct amount for this reset.</small>
                    </div>

                    <div class="reset-cost-box">
                        <span>Wallet Deduction</span>
                        <div>
                            <strong id="reset-cost">0</strong>
                            <span class="wallet-currency">T</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitResetTraffic()">Confirm Reset</button>
                    </div>
                </div>
            </div>
        </div>

<div class="modal-overlay hidden" id="add-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Purchase New Service</h2>
            <button class="modal-close" onclick="closeAddClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Username / Email</label>
                <input type="text" id="add-client-email" class="form-input" placeholder="user1">
            </div>
            
            <div class="form-group">
                <label>Server & Inbound</label>
                <div style="display: flex; gap: 10px;">
                    <select id="add-client-server-select" class="form-select" onchange="onServerSelected()" style="flex: 1;"></select>
                    <select id="add-client-inbound-select" class="form-select" style="flex: 1;"></select>
                </div>
            </div>

            <div class="form-group">
                <label>Packages (Optional)</label>
                <div id="packages-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading packages...</div>
                </div>
                <small style="color: var(--text-secondary); display: block; margin-top: 6px;">Click a package to use its pricing. Click again to remove selection.</small>
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Duration (Days)</label>
                    <input type="number" id="custom-days" class="form-input" value="30" min="1" max="365" oninput="calculateCustomPrice()">
                </div>
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Volume (GB)</label>
                    <input type="number" id="custom-volume" class="form-input" value="10" min="0" max="10000" oninput="calculateCustomPrice()">
                </div>
                <div style="flex: 1.5; background: rgba(255,255,255,0.05); padding: 0 12px; border-radius: 8px; height: 42px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color);">
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">Cost: <strong id="custom-price-display" style="color: #fbbf24; margin-left: 4px;">0</strong> <span style="font-size: 0.75rem;">T</span></span>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); padding: 8px 12px; border-radius: 8px; margin-bottom: 5px;">
                <span style="font-size: 0.9rem; color: #4ade80;">Payable Amount</span>
                <div style="color: #4ade80;">
                    <strong id="add-price-display" style="font-size: 1.1rem;">0</strong>
                    <span class="wallet-currency" style="font-size: 0.8rem;">T</span>
                </div>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 15px; text-align: right; opacity: 0.8;">
                Package price takes priority. Otherwise, days × cost/day + GB × cost/GB.
            </div>
            
            <label class="form-group form-toggle-item" style="cursor: pointer;">
                <div class="toggle-switch">
                    <input type="checkbox" id="add-client-start-after-first-use">
                    <span class="slider"></span>
                </div>
                <span>Start after first use</span>
            </label>

            <div class="form-footer" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div style="font-size: 0.9rem; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; color: #4ade80;">
                        <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path>
                        <path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path>
                        <path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path>
                    </svg>
                    <span style="color: #4ade80;">{{ "{:,}".format(credit if credit else 0) }} T</span>
                </div>
                <button class="btn btn-primary" onclick="submitAddClient()">
                    Pay & Create
                </button>
            </div>

        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="assign-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Assign to Reseller</h2>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Client: <strong id="assign-client-email" style="color: var(--text-primary);"></strong></p>
            <input type="hidden" id="assign-server-id">
            <input type="hidden" id="assign-client-email-hidden">
            
            <div class="form-group">
                <label>Select Reseller</label>
                <div class="filter-dropdown-wrapper" style="width: 100%;">
                    <button class="filter-btn" onclick="toggleResellerDropdown()" id="assign-reseller-btn" style="width: 100%; justify-content: space-between;">
                        <span id="assign-reseller-label">Select Reseller</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div id="assign-reseller-dropdown" class="filter-dropdown hidden" style="width: 100%;">
                        <div id="assign-reseller-list" class="filter-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <input type="hidden" id="assign-reseller-select">
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAssignment()">Assign</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="edit-client-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Edit Client</h2>
            <button class="modal-close" onclick="closeEditClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-client-server-id">
            <input type="hidden" id="edit-client-inbound-id">
            <input type="hidden" id="edit-client-old-email">
            
            <div class="form-group">
                <label>Email</label>
                <input type="text" id="edit-client-new-email" class="form-input" placeholder="New Email">
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeEditClientModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitEditClient()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="new-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Client Created Successfully</h2>
            <button class="modal-close" onclick="closeNewClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Client Details</label>
                <textarea id="new-client-details" class="form-input" rows="12" readonly style="font-family: 'Vazirmatn', sans-serif; direction: rtl; white-space: pre; line-height: 1.7;"></textarea>
                <button class="btn btn-secondary btn-block" style="margin-top: 8px;" onclick="copyNewClientDetails()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    Copy Details
                </button>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">QR Codes</h3>
                <div class="qr-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="qr-item ripple" id="new-client-qr-sub" onclick="copyText('new-client-sub-link', 'new-client-img-sub', 'Subscription')">
                        <div class="qr-title">Subscription</div>
                        <img id="new-client-img-sub" src="" alt="Sub QR">
                        <div class="click-hint">Tap to Copy</div>
                        <input type="hidden" id="new-client-sub-link">
                    </div>
                    <div class="qr-item ripple" id="new-client-qr-dash" onclick="copyText('new-client-dash-link', 'new-client-img-dash', 'Dashboard')">
                        <div class="qr-title">Dashboard</div>
                        <img id="new-client-img-dash" src="" alt="Dash QR">
                        <div class="click-hint">Tap to Copy</div>
                        <input type="hidden" id="new-client-dash-link">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<div class="modal-overlay hidden" id="delete-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Delete Client</h2>
            <button class="modal-close" onclick="closeDeleteClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="delete-client-server-id">
            <input type="hidden" id="delete-client-inbound-id">
            <input type="hidden" id="delete-client-email-hidden">
            
            <div class="alert alert-danger" style="margin-bottom: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 15px; border-radius: 8px;">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <strong>Warning: This action cannot be undone!</strong>
                </div>
                <p>You are about to delete the following client:</p>
            </div>

            <div class="client-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                <div style="grid-column: span 2;">
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Email / Subscription</label>
                    <div id="delete-client-email" style="font-weight: bold; font-size: 1.1rem; color: var(--text-primary);"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Status</label>
                    <div id="delete-client-status"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Expiry</label>
                    <div id="delete-client-expiry"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Traffic (Up/Down)</label>
                    <div id="delete-client-traffic"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Volume (Used/Total)</label>
                    <div id="delete-client-volume"></div>
                </div>
                
                <div style="grid-column: span 2;">
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Client ID (UUID)</label>
                    <div id="delete-client-uuid" style="font-family: monospace; font-size: 0.9rem; word-break: break-all;"></div>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeDeleteClientModal()">Cancel</button>
                <button class="btn btn-danger" onclick="submitDeleteClient()">Delete Client</button>
            </div>
        </div>
    </div>
</div>

<script>
    let autoRefreshInterval = null;
    let currentLink = '';
    let inboundsData = [];
    let allInboundsData = [];
    let refreshController = null;

    const IS_SUPERADMIN = {{ 'true' if is_superadmin else 'false' }};
    const USER_ROLE = "{{ role }}";
    let selectedPackageId = null;
    let selectedRenewPackageId = null;
    const BASE_COST_DAY = {{ base_cost_day|default(0) }};
    const BASE_COST_GB = {{ base_cost_gb|default(0) }};

    document.addEventListener('DOMContentLoaded', function() {
        showLoading();
        // Load servers first to know if we have any
        loadServers().then(() => {
            refreshData(true).then(() => hideLoading());
        });
        document.getElementById('global-search-input').addEventListener('input', performGlobalSearch);
        if (IS_SUPERADMIN) loadResellersForModal();
    });

    function toggleAutoRefresh() {
        const toggle = document.getElementById('auto-refresh-toggle');
        
        if (toggle.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    }

    function updateRefreshInterval() {
        if (document.getElementById('auto-refresh-toggle').checked) {
            startAutoRefresh();
        }
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        const interval = parseInt(document.getElementById('refresh-interval').value) * 1000;
        autoRefreshInterval = setInterval(() => refreshData(true), interval);
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    async function refreshData(isSilent = false) {
        const refreshBtn = document.querySelector('.header-controls .btn-primary');
        
        // Cancel previous request if it exists
        if (refreshController) {
            refreshController.abort();
        }
        refreshController = new AbortController();
        const signal = refreshController.signal;

        if (!isSilent) {
            if (refreshBtn) {
                if (!refreshBtn.dataset.originalContent) {
                    refreshBtn.dataset.originalContent = refreshBtn.innerHTML;
                }
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; border-color: rgba(255,255,255,0.2); border-top-color: white;"></div> Refreshing';
            } else {
                showLoading();
            }
        }
        
        try {
            const response = await fetch('/api/refresh', { signal });
            const data = await response.json();
            
            if (data.success) {
                updateStats(data.stats, data.server_count);
                
                // Store all data
                allInboundsData = data.inbounds;
                inboundsData = data.inbounds; // Keep for compatibility if used elsewhere
                
                // Apply filters to update view
                applyFilters();
                
                const failedServers = data.servers?.filter(s => !s.success) || [];
                if (failedServers.length > 0) {
                    const errors = failedServers.map(s => `${s.server_name}: ${s.error}`).join(', ');
                    showToast('Server errors: ' + errors, 'error');
                }
                if (!isSilent) showToast('Data updated successfully');

                // If there is an active search, re-run it to update the results view
                const searchInput = document.getElementById('global-search-input');
                if (searchInput && searchInput.value.trim().length > 0) {
                    performGlobalSearch();
                }
            } else {
                if (!isSilent) showToast('Error loading data', 'error');
                handleRefreshError();
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Refresh aborted');
                return;
            }
            console.error('Refresh error:', error);
            if (!isSilent) showToast('Error updating: ' + error.message, 'error');
            handleRefreshError();
        } finally {
            if (!isSilent) {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = refreshBtn.dataset.originalContent;
                } else {
                    hideLoading();
                }
            }
            hideLoading();
            refreshController = null;
        }
    }

    function handleRefreshError() {
        // If we have servers but failed to load data, show error state instead of "No servers added"
        if (allServers && allServers.length > 0) {
            const container = document.getElementById('inbounds-container');
            // Only replace if it's currently showing the empty state or nothing
            if (container.querySelector('.empty-state') || container.innerHTML.trim() === '') {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <h3>Connection Error</h3>
                        <p>Failed to load data from servers. Please check your connection and try again.</p>
                        <button class="btn btn-primary" onclick="refreshData()">Try Again</button>
                    </div>`;
            }
        }
    }

    function updateStats(stats, serverCount) {
        document.getElementById('stat-servers').textContent = serverCount || 0;
        document.getElementById('stat-inbounds').textContent = stats?.total_inbounds || 0;
        document.getElementById('stat-active').textContent = `${stats?.active_inbounds || 0} Active`;
        document.getElementById('stat-total-clients').textContent = stats?.total_clients || 0;
        document.getElementById('stat-active-clients').textContent = stats?.active_clients || 0;
        document.getElementById('stat-inactive-clients').textContent = stats?.inactive_clients || 0;
        document.getElementById('stat-traffic').textContent = stats?.total_traffic || '0 B';
        document.getElementById('stat-upload').textContent = `↑ ${stats?.total_upload || '0 B'}`;
        document.getElementById('stat-download').textContent = `↓ ${stats?.total_download || '0 B'}`;
    }

    function getExpiryClass(type) {
        switch(type) {
            case 'expired': return 'expiry-expired';
            case 'today': return 'expiry-today';
            case 'soon': return 'expiry-soon';
            case 'start_after_use': return 'expiry-start-after';
            default: return '';
        }
    }

    function updateInbounds(inbounds) {
        const container = document.getElementById('inbounds-container');
        document.getElementById('inbounds-count').textContent = `${inbounds.length} total`;
        
        if (inbounds.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                    </svg>
                    <h3>No servers added</h3>
                    <p>Add your X-UI server to see statistics.</p>
                    <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
                </div>`;
            return;
        }
        
        container.innerHTML = inbounds.map(inbound => `
            <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                <div class="inbound-header">
                    <div class="inbound-title">
                        <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                        <h3>${inbound.remark}</h3>
                        <span class="port-badge">:${inbound.port}</span>
                        <span class="server-badge">${inbound.server_name}</span>
                    </div>
                    <div class="inbound-status">
                        ${inbound.enable 
                            ? `<span class="status-pill active">Active</span>` 
                            : `<span class="status-pill inactive">Inactive</span>`}
                    </div>
                </div>
                
                <div class="inbound-meta-compact">
                    <span class="meta-tag"><span class="label">Network:</span> <span class="value">${inbound.network}</span></span>
                    <span class="meta-tag"><span class="label">Security:</span> <span class="value">${inbound.security}</span></span>
                    <span class="meta-tag"><span class="label">Clients:</span> <span class="value">${inbound.client_count}</span></span>
                    <span class="meta-tag traffic"><span class="label">Traffic:</span> <span class="up">↑${inbound.total_up}</span> <span class="down">↓${inbound.total_down}</span></span>
                </div>

                ${inbound.clients.length > 0 ? `
                <div class="clients-section">
                    <button class="toggle-clients" onclick="toggleClients(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        Show Clients (${inbound.clients.length})
                    </button>
                    <div class="clients-list hidden">
                        <div class="clients-table-wrapper">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Traffic</th>
                                        <th>Volume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td class="email-cell">${client.email}</td>
                                        <td>
                                            ${client.enable 
                                                ? `<span class="client-status active">Enabled</span>` 
                                                : `<span class="client-status inactive">Disabled</span>`}
                                        </td>
                                        <td>
                                            <span class="expiry-badge ${getExpiryClass(client.expiryType)}">${client.expiryTime}</span>
                                        </td>
                                        <td class="traffic-cell">
                                            <div class="traffic-combined-cell">
                                                <span class="up">↑${client.up}</span>
                                                <span class="down">↓${client.down}</span>
                                            </div>
                                        </td>
                                        <td class="volume-cell">
                                            <div class="volume-info">
                                                <span class="remaining">${client.remaining_formatted}</span>
                                                <span class="total">/ ${client.totalGB_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}', '${client.sub_url || ''}', '${client.json_url || ''}', '${client.dash_sub_url || ''}')" title="QR Code">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="14" width="7" height="7"></rect>
                                                        <rect x="3" y="14" width="7" height="7"></rect>
                                                    </svg>
                                                </button>
                                                <button class="action-btn renew" onclick="openRenewModal(${client.server_id}, '${client.inbound_id}', '${client.email}')" title="Renew">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${client.server_id}, '${client.inbound_id}', '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="openResetModal(${client.server_id}, '${client.inbound_id}', '${client.email}', ${client.totalGB || 0})" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                                ${IS_SUPERADMIN ? `<button class="action-btn" onclick="openAssignModal(${client.server_id}, '${client.email}', '${client.inbound_id}')" title="Assign Owner">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                        <circle cx="10" cy="7" r="4"></circle>
                                                        <path d="M22 11h-2.5a2.5 2.5 0 0 0 0 5H22"></path>
                                                    </svg>
                                                </button>
                                                <button class="action-btn" onclick="openEditClientModal(${client.server_id}, '${client.inbound_id}', '${client.email}')" title="Edit Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                    </svg>
                                                </button>` : ''}
                                                <button class="action-btn danger" onclick="openDeleteClientModal(${client.server_id}, '${client.inbound_id}', '${client.email}', '${client.id}', ${client.enable}, '${client.expiryTime}', '${client.up}', '${client.down}', '${client.totalGB_formatted}', '${client.remaining_formatted}')" title="Delete Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `).join('');
    }

    function toggleClients(btn) {
        const clientsList = btn.nextElementSibling;
        const isHidden = clientsList.classList.contains('hidden');
        clientsList.classList.toggle('hidden');
        
        const count = clientsList.querySelectorAll('tbody tr').length;
        btn.innerHTML = isHidden 
            ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg> Hide Clients (${count})`
            : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg> Show Clients (${count})`;
    }

    function bytesToGB(bytes) {
        if (!bytes || bytes <= 0) return 0;
        return Math.max(1, Math.round(bytes / (1024 * 1024 * 1024)));
    }

    function formatVolumeLabel(bytes) {
        if (!bytes || bytes <= 0) return 'Unlimited / Not Set';
        const gb = bytes / (1024 * 1024 * 1024);
        return `${Number.isInteger(gb) ? gb : gb.toFixed(1)} GB`;
    }

    async function showQrCode(encodedLink, email, subUrl, jsonUrl, dashSubUrl) {
        const link = decodeURIComponent(encodedLink);
        document.getElementById('qr-email').textContent = email;
        document.getElementById('title-config').textContent = email;
        
        document.getElementById('input-sub').value = subUrl || '';
        document.getElementById('input-json').value = jsonUrl || '';
        document.getElementById('input-config').value = link || '';
        document.getElementById('input-dash').value = dashSubUrl || '';
        
        try {
            // Generate Config QR
            if (link) {
                const configResp = await fetch(`/api/client/qrcode?link=${encodedLink}`);
                const configData = await configResp.json();
                if (configData.success) {
                    document.getElementById('img-config').src = configData.qrcode;
                    document.getElementById('box-config').style.display = 'flex';
                }
            }
            
            // Generate Subscription QR
            if (subUrl && subUrl !== 'undefined' && subUrl !== 'null') {
                const subResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(subUrl)}`);
                const subData = await subResp.json();
                if (subData.success) {
                    document.getElementById('img-sub').src = subData.qrcode;
                    document.getElementById('box-sub').style.display = 'flex';
                }
            } else {
                document.getElementById('box-sub').style.display = 'none';
            }
            
            // Generate JSON QR
            if (jsonUrl && jsonUrl !== 'undefined' && jsonUrl !== 'null') {
                const jsonResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(jsonUrl)}`);
                const jsonData = await jsonResp.json();
                if (jsonData.success) {
                    document.getElementById('img-json').src = jsonData.qrcode;
                    document.getElementById('box-json').style.display = 'flex';
                }
            } else {
                document.getElementById('box-json').style.display = 'none';
            }

            // Generate Dash Sub QR
            if (dashSubUrl && dashSubUrl !== 'undefined' && dashSubUrl !== 'null' && dashSubUrl !== '') {
                const dashResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(dashSubUrl)}`);
                const dashData = await dashResp.json();
                if (dashData.success) {
                    document.getElementById('img-dash').src = dashData.qrcode;
                    document.getElementById('box-dash').style.display = 'flex';
                }
            } else {
                document.getElementById('box-dash').style.display = 'none';
            }
            
            document.getElementById('qr-modal').classList.remove('hidden');
        } catch (error) {
            showToast('Error generating QR Codes: ' + error.message, 'error');
        }
    }
    
    function copyText(elementId, imgId, title) {
        const input = document.getElementById(elementId);
        if (!input.value) return;
        
        navigator.clipboard.writeText(input.value).then(() => {
            showToast('Link copied!');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
        
        // Show expanded QR on mobile only
        if (window.innerWidth <= 768 && imgId) {
            expandQrCode(imgId, title);
        }
    }
    
    function expandQrCode(imgId, title) {
        const img = document.getElementById(imgId);
        if (!img || !img.src) return;
        
        document.getElementById('expanded-qr-title').textContent = title;
        document.getElementById('expanded-qr-img').src = img.src;
        document.getElementById('expanded-qr-modal').classList.remove('hidden');
    }
    
    function closeExpandedQr() {
        document.getElementById('expanded-qr-modal').classList.add('hidden');
    }

    function closeQrModal() {
        document.getElementById('qr-modal').classList.add('hidden');
    }

    async function copyLink() {
        if (!currentLink) {
            showToast('Link not found', 'error');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(currentLink);
            showToast('Link copied');
        } catch (error) {
            showToast('Copy failed', 'error');
        }
    }

    async function toggleClient(serverId, inboundId, email, enable) {
        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, enable: enable })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(enable ? 'Client enabled' : 'Client disabled');
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function openResetModal(serverId, inboundId, email, totalBytes = 0) {
        document.getElementById('reset-server-id').value = serverId;
        document.getElementById('reset-inbound-id').value = inboundId;
        document.getElementById('reset-email').value = email;
        document.getElementById('reset-client-email').textContent = email;
        document.getElementById('reset-current-volume').textContent = formatVolumeLabel(totalBytes);
        const defaultGb = bytesToGB(totalBytes) || 50;
        const volInput = document.getElementById('reset-volume');
        volInput.value = defaultGb;
        updateResetCost();
        document.getElementById('reset-modal').classList.remove('hidden');
    }

    function closeResetModal() {
        document.getElementById('reset-modal').classList.add('hidden');
    }

    function updateResetCost() {
        const volInput = document.getElementById('reset-volume');
        if (!volInput) return;
        let volume = parseInt(volInput.value) || 0;
        if (volume < 0) volume = 0;
        volInput.value = volume;
        const cost = volume * BASE_COST_GB;
        const costLabel = document.getElementById('reset-cost');
        if (costLabel) costLabel.textContent = Number(cost).toLocaleString();
    }

    async function submitResetTraffic() {
        const serverId = document.getElementById('reset-server-id').value;
        const inboundId = document.getElementById('reset-inbound-id').value;
        const email = document.getElementById('reset-email').value;
        const volume = parseInt(document.getElementById('reset-volume').value) || 0;

        if (USER_ROLE === 'reseller' && BASE_COST_GB > 0 && volume <= 0) {
            showToast('Please enter billable volume (GB)', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/reset`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, volume_gb: volume })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Traffic reset');
                closeResetModal();
                if (typeof data.remaining_credit !== 'undefined') {
                    updateWalletDisplay(data.remaining_credit);
                }
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function openRenewModal(serverId, inboundId, email) {
        document.getElementById('renew-server-id').value = serverId;
        document.getElementById('renew-inbound-id').value = inboundId;
        document.getElementById('renew-email').value = email;
        document.getElementById('renew-client-email').textContent = email;
        document.getElementById('renew-start-after-first-use').checked = false;
        document.getElementById('renew-reset-traffic').checked = false;
        document.getElementById('renew-custom-days').value = 30;
        document.getElementById('renew-custom-volume').value = 10;
        selectedRenewPackageId = null;
        loadRenewPackages();
        calculateRenewCustomPrice();
        document.getElementById('renew-modal').classList.remove('hidden');
    }

    function closeRenewModal() {
        document.getElementById('renew-modal').classList.add('hidden');
    }

    async function submitRenewal() {
        const serverId = document.getElementById('renew-server-id').value;
        const inboundId = document.getElementById('renew-inbound-id').value;
        const email = document.getElementById('renew-email').value;
        const startAfterFirstUse = document.getElementById('renew-start-after-first-use').checked;
        const resetTraffic = document.getElementById('renew-reset-traffic').checked;

        const usePackage = Boolean(selectedRenewPackageId);
        const payload = {
            mode: usePackage ? 'package' : 'custom',
            start_after_first_use: startAfterFirstUse,
            reset_traffic: resetTraffic
        };

        if (usePackage) {
            payload.package_id = selectedRenewPackageId;
        } else {
            const customDays = parseInt(document.getElementById('renew-custom-days').value) || 0;
            const customVolume = parseInt(document.getElementById('renew-custom-volume').value) || 0;
            if (customDays <= 0) {
                showToast('Days must be greater than 0', 'error');
                return;
            }
            payload.days = customDays;
            payload.volume = customVolume;
        }

        const btn = document.querySelector('#renew-modal .btn-primary');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Processing...';

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/renew`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Client renewed');
                closeRenewModal();
                if (typeof data.remaining_credit !== 'undefined') {
                    updateWalletDisplay(data.remaining_credit);
                }
                refreshData();
            } else {
                showToast(data.error || 'Error renewing', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    let allServers = [];

    function openAddClientModal() {
        document.getElementById('add-client-server-select').innerHTML = '<option value="">-- Select Server --</option>';
        document.getElementById('add-client-inbound-select').innerHTML = '<option value="">-- Select Inbound --</option>';
        
        if (allServers && allServers.length > 0) {
            allServers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;
                option.textContent = server.name;
                document.getElementById('add-client-server-select').appendChild(option);
            });
        }
        
        document.getElementById('add-client-email').value = '';
        document.getElementById('custom-days').value = 30;
        document.getElementById('custom-volume').value = 10;
        document.getElementById('add-client-start-after-first-use').checked = false;
        selectedPackageId = null;
        loadPackages();
        calculateCustomPrice();
        updateAddPriceDisplay();
        document.getElementById('add-client-modal').classList.remove('hidden');
    }

    async function loadPackages() {
        const container = document.getElementById('packages-list');
        if (!container) return;
        container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 10px;">Loading packages...</div>';
        try {
            const res = await fetch('/api/packages');
            const pkgs = await res.json();
            
            if (!Array.isArray(pkgs) || pkgs.length === 0) {
                container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 10px;">No packages defined</div>';
                selectedPackageId = null;
                updateAddPriceDisplay();
                return;
            }

            container.innerHTML = pkgs.map(p => `
                <div class="pkg-card" data-package-id="${p.id}" data-package-price="${p.price}" onclick="selectPackage(this, ${p.id}, ${p.price})" 
                     style="border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 60px;">
                    <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; line-height: 1.2;">${p.name}</div>
                    <div style="color: #4ade80; font-weight: bold; font-size: 0.8rem;">${p.price.toLocaleString()} T</div>
                </div>
            `).join('');

            if (selectedPackageId) {
                const active = container.querySelector(`[data-package-id="${selectedPackageId}"]`);
                if (active) {
                    active.style.borderColor = 'var(--primary)';
                    active.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
                }
            }
            updateAddPriceDisplay();
        } catch (e) { 
            container.innerHTML = '<div style="grid-column: span 2; color: #ef4444; text-align: center;">Error loading packages</div>';
            selectedPackageId = null;
            updateAddPriceDisplay();
        }
    }

    function selectPackage(el, id, price) {
        const alreadySelected = selectedPackageId === id;
        document.querySelectorAll('#packages-list .pkg-card').forEach(d => {
            d.style.borderColor = 'var(--border-color)';
            d.style.backgroundColor = 'var(--bg-dark)';
        });

        if (alreadySelected) {
            selectedPackageId = null;
            updateAddPriceDisplay();
            return;
        }

        selectedPackageId = id;
        el.style.borderColor = 'var(--primary)';
        el.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
        updateAddPriceDisplay(price);
    }

    function updateRenewPriceDisplay(amount) {
        const target = document.getElementById('renew-payable-display');
        if (!target) return;
        const normalized = Number(amount) || 0;
        target.textContent = normalized.toLocaleString();
    }

    async function loadRenewPackages() {
        const container = document.getElementById('renew-packages-list');
        if (!container) return;
        container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 10px;">Loading packages...</div>';
        try {
            const res = await fetch('/api/packages');
            const pkgs = await res.json();
            if (!Array.isArray(pkgs) || pkgs.length === 0) {
                container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 15px; color: var(--text-secondary);">No packages defined.</div>';
                selectedRenewPackageId = null;
                refreshRenewPriceDisplay();
                return;
            }

            container.innerHTML = pkgs.map(p => `
                <div class="pkg-card" data-package-id="${p.id}" data-package-price="${p.price}" onclick="selectRenewPackage(this, ${p.id}, ${p.price})"
                     style="border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 60px;">
                    <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; line-height: 1.2;">${p.name}</div>
                    <div style="color: #4ade80; font-weight: bold; font-size: 0.8rem;">${p.price.toLocaleString()} T</div>
                </div>
            `).join('');

            if (selectedRenewPackageId) {
                const active = container.querySelector(`[data-package-id="${selectedRenewPackageId}"]`);
                if (active) {
                    active.style.borderColor = 'var(--primary)';
                    active.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
                }
            }
            refreshRenewPriceDisplay();
        } catch (e) {
            container.innerHTML = '<div style="grid-column: span 2; color: #ef4444; text-align: center;">Error loading packages</div>';
            selectedRenewPackageId = null;
            refreshRenewPriceDisplay();
        }
    }

    function selectRenewPackage(el, id, price) {
        const alreadySelected = selectedRenewPackageId === id;
        document.querySelectorAll('#renew-packages-list .pkg-card').forEach(card => {
            card.style.borderColor = 'var(--border-color)';
            card.style.backgroundColor = 'var(--bg-dark)';
        });

        if (alreadySelected) {
            selectedRenewPackageId = null;
            refreshRenewPriceDisplay();
            return;
        }

        selectedRenewPackageId = id;
        el.style.borderColor = 'var(--primary)';
        el.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
        refreshRenewPriceDisplay(price);
    }

    function computeRenewCustomPrice() {
        let days = parseInt(document.getElementById('renew-custom-days').value) || 0;
        let vol = parseInt(document.getElementById('renew-custom-volume').value) || 0;
        if (days < 0) days = 0;
        if (vol < 0) vol = 0;
        // BASE_COST_DAY and BASE_COST_GB are now user-specific (calculated in backend)
        return (days * BASE_COST_DAY) + (vol * BASE_COST_GB);
    }

    function calculateRenewCustomPrice() {
        const total = computeRenewCustomPrice();
        const costDisplay = document.getElementById('renew-price-display');
        if (costDisplay) costDisplay.innerText = total.toLocaleString();
        refreshRenewPriceDisplay(total);
    }

    function refreshRenewPriceDisplay(prefetchedAmount) {
        if (selectedRenewPackageId) {
            const price = getPackagePrice('#renew-packages-list', selectedRenewPackageId);
            updateRenewPriceDisplay(price);
        } else if (typeof prefetchedAmount === 'number') {
            updateRenewPriceDisplay(prefetchedAmount);
        } else {
            updateRenewPriceDisplay(computeRenewCustomPrice());
        }
    }

    function computeAddCustomPrice() {
        let days = parseInt(document.getElementById('custom-days').value) || 0;
        let vol = parseInt(document.getElementById('custom-volume').value) || 0;
        if (days < 0) days = 0;
        if (vol < 0) vol = 0;
        // BASE_COST_DAY and BASE_COST_GB are now user-specific (calculated in backend)
        return (days * BASE_COST_DAY) + (vol * BASE_COST_GB);
    }

    function calculateCustomPrice() {
        const total = computeAddCustomPrice();
        const preview = document.getElementById('custom-price-display');
        if (preview) preview.innerText = total.toLocaleString();
        if (!selectedPackageId) {
            updateAddPriceDisplay(total);
        }
    }

    function getPackagePrice(containerSelector, packageId) {
        const el = document.querySelector(`${containerSelector} .pkg-card[data-package-id="${packageId}"]`);
        if (!el) return 0;
        const priceAttr = el.getAttribute('data-package-price');
        return Number(priceAttr || 0);
    }

    function updateAddPriceDisplay(prefetchedAmount) {
        const display = document.getElementById('add-price-display');
        if (!display) return;
        let total;
        if (selectedPackageId) {
            total = getPackagePrice('#packages-list', selectedPackageId);
        } else if (typeof prefetchedAmount === 'number') {
            total = prefetchedAmount;
        } else {
            total = computeAddCustomPrice();
        }
        display.textContent = (Number(total) || 0).toLocaleString();
    }

    function onServerSelected() {
        const serverId = document.getElementById('add-client-server-select').value;
        const inboundSelect = document.getElementById('add-client-inbound-select');
        inboundSelect.innerHTML = '<option value="">-- Select Inbound --</option>';
        
        if (!serverId) return;
        
        const serverInbounds = inboundsData.filter(i => i.server_id == serverId);
        if (serverInbounds.length > 0) {
            serverInbounds.forEach(inbound => {
                const option = document.createElement('option');
                option.value = JSON.stringify({
                    server_id: inbound.server_id,
                    inbound_id: inbound.id
                });
                const activeClients = inbound.clients.filter(c => c.enable).length;
                option.textContent = `${inbound.remark} - ${inbound.protocol} (${inbound.port}) [${activeClients}]`;
                inboundSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.textContent = 'No inbounds available';
            option.disabled = true;
            inboundSelect.appendChild(option);
        }
    }

    function closeAddClientModal() {
        document.getElementById('add-client-modal').classList.add('hidden');
    }

    async function submitAddClient() {
        const email = document.getElementById('add-client-email').value.trim();
        const inboundSelect = document.getElementById('add-client-inbound-select');
        const startAfterFirstUse = document.getElementById('add-client-start-after-first-use').checked;
        
        if (!inboundSelect.value) return showToast('Select an inbound', 'error');
        if (!email) return showToast('Enter username', 'error');

        const inboundData = JSON.parse(inboundSelect.value);
        
        const usePackage = Boolean(selectedPackageId);
        const payload = {
            email: email,
            mode: usePackage ? 'package' : 'custom',
            start_after_first_use: startAfterFirstUse
        };

        if (usePackage) {
            payload.package_id = selectedPackageId;
        } else {
            const customDays = parseInt(document.getElementById('custom-days').value) || 0;
            const customVolume = parseInt(document.getElementById('custom-volume').value) || 0;
            if (customDays <= 0) return showToast('Duration must be greater than 0', 'error');
            payload.days = customDays;
            payload.volume = customVolume;
        }

        const btn = document.querySelector('#add-client-modal .btn-primary');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Processing...';

        try {
            const response = await fetch(`/api/client/${inboundData.server_id}/${inboundData.inbound_id}/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Client created successfully');
                closeAddClientModal();
                refreshData();
                if (data.client) {
                    showNewClientModal(data.client);
                }
            } else {
                showToast(data.error || 'Error creating client', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    function closeNewClientModal() {
        document.getElementById('new-client-modal').classList.add('hidden');
    }

    function copyNewClientDetails() {
        const textarea = document.getElementById('new-client-details');
        textarea.select();
        document.execCommand('copy');
        showToast('Details copied to clipboard');
    }

    async function showNewClientModal(client) {
        const modal = document.getElementById('new-client-modal');
        const detailsText = document.getElementById('new-client-details');
        
        // Fetch active template
        let templateContent = '';
        try {
            const res = await fetch('/api/templates/active');
            const data = await res.json();
            if (data.success) {
                templateContent = data.content;
            }
        } catch (e) {
            console.error('Failed to load template', e);
        }

        // Fallback if fetch fails or returns empty
        if (!templateContent) {
            templateContent = `😍 سفارش جدید شما

اطلاعات سرویس
📡 پروتکل: {protocol}
🔮 نام سرویس: {service_name}
🔋حجم سرویس: {volume} گیگ
⏰ مدت سرویس: {days} روز⁮⁮ ⁮⁮

لینک های اتصال
 
🌐 subscription Direct:
{sub_link}

🌐 Account Dashboard : 
{dashboard_link}`;
        }

        // Replace variables
        const text = templateContent
            .replace(/{protocol}/g, client.protocol || 'vless')
            .replace(/{service_name}/g, client.email)
            .replace(/{volume}/g, client.volume)
            .replace(/{days}/g, client.days)
            .replace(/{sub_link}/g, client.sub_link || '')
            .replace(/{dashboard_link}/g, client.dashboard_link || '');

        detailsText.value = text;
        
        // Generate QRs
        try {
            if (client.sub_link) {
                const subResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(client.sub_link)}`);
                const subData = await subResp.json();
                if (subData.success) {
                    document.getElementById('new-client-img-sub').src = subData.qrcode;
                    document.getElementById('new-client-sub-link').value = client.sub_link;
                    document.getElementById('new-client-qr-sub').style.display = 'flex';
                }
            } else {
                document.getElementById('new-client-qr-sub').style.display = 'none';
            }
            
            if (client.dashboard_link) {
                const dashResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(client.dashboard_link)}`);
                const dashData = await dashResp.json();
                if (dashData.success) {
                    document.getElementById('new-client-img-dash').src = dashData.qrcode;
                    document.getElementById('new-client-dash-link').value = client.dashboard_link;
                    document.getElementById('new-client-qr-dash').style.display = 'flex';
                }
            } else {
                document.getElementById('new-client-qr-dash').style.display = 'none';
            }
        } catch (e) {
            console.error(e);
        }

        modal.classList.remove('hidden');
    }

    let selectedServerIds = new Set();
    let hideDisabledClients = false;

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            const servers = await response.json();
            allServers = servers;
            renderServerList(servers);
            populateServerFilter(servers);
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function populateServerFilter(servers) {
        const list = document.getElementById('server-filter-list');
        list.innerHTML = '';
        
        servers.forEach(server => {
            const div = document.createElement('div');
            div.className = 'filter-item';
            
            // Create label wrapper for custom checkbox style
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.style.width = '100%';
            label.style.margin = '0';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = selectedServerIds.has(server.id);
            checkbox.onchange = (e) => toggleServerSelection(server.id, e.target.checked);
            
            const checkmark = document.createElement('span');
            checkmark.className = 'checkmark';
            
            const span = document.createElement('span');
            span.textContent = server.name;
            span.style.marginLeft = '8px'; // Add some spacing after checkmark
            
            label.appendChild(checkbox);
            label.appendChild(checkmark);
            label.appendChild(span);
            
            div.appendChild(label);
            list.appendChild(div);
        });
    }

    function toggleServerSelection(id, checked) {
        if (checked) {
            selectedServerIds.add(id);
        } else {
            selectedServerIds.delete(id);
        }
        updateServerFilterCount();
        applyFilters();
    }

    function selectAllServers() {
        const checkboxes = document.querySelectorAll('#server-filter-list input');
        // Check if all are currently checked
        const allChecked = Array.from(checkboxes).every(c => c.checked);
        
        if (allChecked) {
            selectedServerIds.clear();
        } else {
            allServers.forEach(s => selectedServerIds.add(s.id));
        }
        
        // Re-render list to update checkboxes
        populateServerFilter(allServers);
        updateServerFilterCount();
        applyFilters();
    }

    function updateServerFilterCount() {
        const count = selectedServerIds.size;
        const badge = document.getElementById('server-filter-count');
        badge.textContent = count;
        if (count > 0) {
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    function toggleServerFilter() {
        const dropdown = document.getElementById('server-filter-dropdown');
        dropdown.classList.toggle('hidden');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('server-filter-dropdown');
        const btn = document.getElementById('server-filter-btn');
        if (dropdown && !dropdown.classList.contains('hidden') && !dropdown.contains(event.target) && !btn.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    function applyFilters() {
        hideDisabledClients = document.getElementById('hide-disabled-filter').checked;
        
        // If we have search results, filter them
        const searchResultsDiv = document.getElementById('search-results');
        if (searchResultsDiv.style.display !== 'none') {
            // Re-run search or filter existing results?
            // For now, let's just re-run search if there is a query
            const searchInput = document.getElementById('global-search-input');
            if (searchInput.value.trim().length > 0) {
                performGlobalSearch();
                return;
            }
        }

        // Otherwise filter the main list
        if (allInboundsData && allInboundsData.length > 0) {
             const filteredInbounds = filterInbounds(allInboundsData);
             updateInbounds(filteredInbounds);
        }
    }
    
    function filterInbounds(inbounds) {
        // Clone to avoid mutating original data structure if we modify clients array
        // But shallow clone of array is enough if we filter clients
        
        let filtered = inbounds;

        // 1. Filter by Server
        if (selectedServerIds.size > 0) {
            filtered = filtered.filter(i => selectedServerIds.has(i.server_id));
        }
        
        // 2. Filter by Hide Disabled
        if (hideDisabledClients) {
            // We need to return new inbound objects with filtered clients
            filtered = filtered.map(inbound => {
                const activeClients = inbound.clients.filter(c => c.enable);
                if (activeClients.length === 0) return null; // Filter out empty inbounds?
                
                return {
                    ...inbound,
                    clients: activeClients
                };
            }).filter(i => i !== null);
        }
        
        return filtered;
    }

    function renderServerList(servers) {
        const container = document.getElementById('server-list');
        
        if (servers.length === 0) {
            container.innerHTML = '<p class="no-servers">No servers added</p>';
            return;
        }
        
        container.innerHTML = servers.map(server => `
            <div class="server-item ${!server.enabled ? 'disabled' : ''}">
                <div class="server-info">
                    <h4>${server.name}</h4>
                    <p>${server.host}</p>
                </div>
                <div class="server-actions">
                    <button class="action-btn" onclick="editServer(${server.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn danger" onclick="deleteServer(${server.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function openServerModal() {
        document.getElementById('form-title').textContent = 'Add Server';
        document.getElementById('edit-server-id').value = '';
        document.getElementById('server-name').value = '';
        document.getElementById('server-host').value = '';
        document.getElementById('server-username').value = '';
        document.getElementById('server-password').value = '';
        document.getElementById('server-sub-path').value = '/sub/';
        document.getElementById('server-json-path').value = '/json/';
        document.getElementById('server-sub-port').value = '';
        document.getElementById('server-panel-type').value = 'auto';
        document.getElementById('server-modal').classList.remove('hidden');
        loadServers();
    }

    function closeServerModal() {
        document.getElementById('server-modal').classList.add('hidden');
    }

    function editServer(id) {
        const server = allServers.find(s => s.id === id);
        if (!server) return;
        
        document.getElementById('form-title').textContent = 'Edit Server';
        document.getElementById('edit-server-id').value = server.id;
        document.getElementById('server-name').value = server.name;
        document.getElementById('server-host').value = server.host;
        document.getElementById('server-username').value = server.username;
        document.getElementById('server-sub-path').value = server.sub_path || '/sub/';
        document.getElementById('server-json-path').value = server.json_path || '/json/';
        document.getElementById('server-sub-port').value = server.sub_port || '';
        document.getElementById('server-panel-type').value = server.panel_type;
        document.getElementById('server-modal').classList.remove('hidden');
    }

    async function testServerConnection() {
        const id = document.getElementById('edit-server-id').value;
        
        if (!id) {
            showToast('Save server first', 'error');
            return;
        }

        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value,
            sub_path: document.getElementById('server-sub-path').value,
            json_path: document.getElementById('server-json-path').value
        };

        if (!data.host || !data.username || !data.password) {
            showToast('Please fill all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/servers/${id}/test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(`Connection successful - Panel Type: ${result.panel_type === 'sanaei' ? '3X-UI' : result.panel_type === 'alireza' ? 'X-UI' : 'Unknown'}`);
            } else {
                showToast(result.error || 'Connection failed', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function saveServer() {
        const id = document.getElementById('edit-server-id').value;
        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value,
            sub_path: document.getElementById('server-sub-path').value,
            json_path: document.getElementById('server-json-path').value,
            sub_port: document.getElementById('server-sub-port').value
        };

        if (!data.name || !data.host || !data.username || !data.password) {
            showToast('All fields are required', 'error');
            return;
        }

        try {
            const url = id ? `/api/servers/${id}` : '/api/servers';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(id ? 'Server updated' : 'Server added');
                closeServerModal();
                loadServers();
                refreshData();
            } else {
                showToast(result.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function deleteServer(id) {
        if (!confirm('Are you sure you want to delete this server?')) return;
        
        try {
            const response = await fetch(`/api/servers/${id}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                showToast('Server deleted');
                loadServers();
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    let searchTimeout = null;

    async function performGlobalSearch() {
        const searchInput = document.getElementById('global-search-input');
        const clearBtn = document.getElementById('clear-search-btn');
        const query = searchInput.value.trim().toLowerCase();
        
        // Toggle clear button visibility
        if (searchInput.value.length > 0) {
            clearBtn.classList.remove('hidden');
        } else {
            clearBtn.classList.add('hidden');
        }
        
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        if (query.length === 0) {
            clearSearch(false); // Pass false to avoid refreshing data immediately if not needed
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/api/clients/search?email=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    displaySearchResults(data.results, query);
                } else {
                    displaySearchResults([], query);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }, 500); // 500ms debounce
    }

    function clearSearch(shouldRefresh = true) {
        const searchResultsDiv = document.getElementById('search-results');
        const wasShowingResults = searchResultsDiv.style.display !== 'none';

        document.getElementById('global-search-input').value = '';
        searchResultsDiv.style.display = 'none';
        document.getElementById('clear-search-btn').classList.add('hidden');
        
        if (shouldRefresh) {
            refreshData();
        } else if (wasShowingResults) {
            refreshData(true);
        }
    }

    function displaySearchResults(results, query) {
        const searchResultsDiv = document.getElementById('search-results');
        const searchResultsText = document.getElementById('search-results-text');
        const clearBtn = document.getElementById('clear-search-btn');
        
        // Ensure clear button is visible if we have results (or even no results but a query)
        clearBtn.classList.remove('hidden');
        
        // Apply filters to search results
        let filteredResults = results;
        
        // Filter by Server
        if (selectedServerIds.size > 0) {
            filteredResults = filteredResults.filter(r => selectedServerIds.has(r.server_id));
        }
        
        // Filter by Hide Disabled
        if (hideDisabledClients) {
            filteredResults = filteredResults.filter(r => r.client.enable);
        }
        
        if (filteredResults.length === 0) {
            searchResultsDiv.style.display = 'block';
            if (results.length > 0) {
                searchResultsText.textContent = `Found ${results.length} client(s), but all hidden by filters.`;
            } else {
                searchResultsText.textContent = `No clients found matching "${query}"`;
            }
            updateInboundsFiltered([]);
            return;
        }
        
        searchResultsDiv.style.display = 'block';
        searchResultsText.textContent = `Found ${filteredResults.length} client(s) matching "${query}"` + (results.length !== filteredResults.length ? ` (filtered from ${results.length})` : '');
        
        updateInboundsFiltered(filteredResults);
    }

    function updateInboundsFiltered(filteredResults) {
        if (filteredResults.length === 0) {
            const container = document.getElementById('inbounds-container');
            container.innerHTML = `<div class="empty-state"><h3>No results</h3></div>`;
            return;
        }
        
        const container = document.getElementById('inbounds-container');
        const inboundsToShow = [];
        
        filteredResults.forEach(result => {
            const existing = inboundsToShow.find(i => i.id === result.inbound_id && i.server_id === result.server_id);
            if (existing) {
                existing.clients.push(result.client);
            } else {
                inboundsToShow.push({
                    id: result.inbound_id,
                    server_id: result.server_id,
                    server_name: result.server_name,
                    remark: result.inbound.remark,
                    protocol: result.inbound.protocol,
                    port: result.inbound.port,
                    enable: result.inbound.enable,
                    network: 'tcp',
                    security: 'tls',
                    client_count: 1,
                    total_up: '0 B',
                    total_down: '0 B',
                    clients: [result.client]
                });
            }
        });
        
        const html = inboundsToShow.map(inbound => `
            <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                <div class="inbound-header">
                    <div class="inbound-title">
                        <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                        <h3>${inbound.remark}</h3>
                        <span class="port-badge">:${inbound.port}</span>
                        <span class="server-badge">${inbound.server_name}</span>
                    </div>
                </div>
                ${inbound.clients.length > 0 ? `
                <div class="clients-section">
                    <div class="clients-list">
                        <div class="clients-table-wrapper">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Traffic</th>
                                        <th>Volume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td class="email-cell">${client.email}</td>
                                        <td>
                                            ${client.enable 
                                                ? `<span class="client-status active">Enabled</span>` 
                                                : `<span class="client-status inactive">Disabled</span>`}
                                        </td>
                                        <td>
                                            <span class="expiry-badge ${getExpiryClass(client.expiryType)}">${client.expiryTime}</span>
                                        </td>
                                        <td class="traffic-cell">
                                            <div class="traffic-combined-cell">
                                                <span class="up">${client.up}</span>
                                                <span class="down">${client.down}</span>
                                            </div>
                                        </td>
                                        <td class="volume-cell">
                                            <div class="volume-info">
                                                <span class="remaining">${client.remaining_formatted}</span>
                                                <span class="total">/ ${client.totalGB_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}', '${client.sub_url || ''}', '${client.json_url || ''}', '${client.dash_sub_url || ''}')" title="QR Code">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="14" width="7" height="7"></rect>
                                                        <rect x="3" y="14" width="7" height="7"></rect>
                                                    </svg>
                                                </button>
                                                <button class="action-btn renew" onclick="openRenewModal(${inbound.server_id}, '${inbound.id}', '${client.email}')" title="Renew">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${inbound.server_id}, '${inbound.id}', '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="openResetModal(${inbound.server_id}, '${inbound.id}', '${client.email}', ${client.totalGB || 0})" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                                ${IS_SUPERADMIN ? `<button class="action-btn" onclick="openAssignModal(${inbound.server_id}, '${client.email}', '${inbound.id}')" title="Assign Owner">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="10" cy="7" r="4"></circle><path d="M22 11h-2.5a2.5 2.5 0 0 0 0 5H22"></path>
                                                    </svg>
                                                </button>
                                                <button class="action-btn" onclick="openEditClientModal(${inbound.server_id}, '${inbound.id}', '${client.email}')" title="Edit Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                    </svg>
                                                </button>` : ''}
                                                <button class="action-btn danger" onclick="openDeleteClientModal(${inbound.server_id}, '${inbound.id}', '${client.email}', '${client.id}', ${client.enable}, '${client.expiryTime}', '${client.up}', '${client.down}', '${client.totalGB_formatted}', '${client.remaining_formatted}')" title="Delete Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                        <path d="M19 6v14a2 2 0 0 1-2-2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `).join('');
        
        container.innerHTML = html;
    }

    function toggleResellerDropdown() {
        const dropdown = document.getElementById('assign-reseller-dropdown');
        dropdown.classList.toggle('hidden');
    }

    // Close reseller dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('assign-reseller-dropdown');
        const btn = document.getElementById('assign-reseller-btn');
        if (dropdown && !dropdown.classList.contains('hidden') && !dropdown.contains(event.target) && !btn.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    function selectReseller(id, name) {
        document.getElementById('assign-reseller-select').value = id;
        document.getElementById('assign-reseller-label').textContent = name;
        document.getElementById('assign-reseller-dropdown').classList.add('hidden');
    }

    async function loadResellersForModal() {
        try {
            const response = await fetch('/api/admins');
            const admins = await response.json();
            const resellers = admins.filter(a => a.role === 'reseller');
            const list = document.getElementById('assign-reseller-list');
            
            if (resellers.length === 0) {
                list.innerHTML = '<div style="padding: 10px; color: var(--text-secondary); text-align: center;">No resellers found</div>';
                return;
            }

            list.innerHTML = resellers.map(r => `
                <div class="filter-item" onclick="selectReseller(${r.id}, '${r.username}')">
                    <span style="flex: 1;">${r.username}</span>
                    <span style="font-size: 0.8rem; color: #4ade80;">${r.credit.toLocaleString()} T</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading resellers:', error);
            document.getElementById('assign-reseller-list').innerHTML = '<div style="padding: 10px; color: var(--danger); text-align: center;">Error loading resellers</div>';
        }
    }

    function openAssignModal(serverId, email, inboundId = 0) {
        document.getElementById('assign-server-id').value = serverId;
        document.getElementById('assign-client-email-hidden').value = email;
        document.getElementById('assign-client-email').textContent = email;
        
        // Reset selection
        document.getElementById('assign-reseller-select').value = '';
        document.getElementById('assign-reseller-label').textContent = 'Select Reseller';
        
        document.getElementById('assign-modal').classList.remove('hidden');
        loadResellersForModal();
    }

    function closeAssignModal() {
        document.getElementById('assign-modal').classList.add('hidden');
    }

    async function submitAssignment() {
        const serverId = document.getElementById('assign-server-id').value;
        const email = document.getElementById('assign-client-email-hidden').value;
        const resellerId = document.getElementById('assign-reseller-select').value;

        if (!resellerId) {
            showToast('Please select a reseller', 'error');
            return;
        }

        try {
            const response = await fetch('/api/assign-client', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    server_id: parseInt(serverId),
                    email: email,
                    reseller_id: parseInt(resellerId)
                })
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client assigned successfully');
                closeAssignModal();
                refreshData();
            } else {
                showToast(result.error || 'Error assigning client', 'error');
            }
        } catch (error) {
            showToast('Error assigning client', 'error');
        }
    }

    function openEditClientModal(serverId, inboundId, email) {
        document.getElementById('edit-client-server-id').value = serverId;
        document.getElementById('edit-client-inbound-id').value = inboundId;
        document.getElementById('edit-client-old-email').value = email;
        document.getElementById('edit-client-new-email').value = email;
        document.getElementById('edit-client-modal').classList.remove('hidden');
    }

    function closeEditClientModal() {
        document.getElementById('edit-client-modal').classList.add('hidden');
    }

    async function submitEditClient() {
        const serverId = document.getElementById('edit-client-server-id').value;
        const inboundId = document.getElementById('edit-client-inbound-id').value;
        const oldEmail = document.getElementById('edit-client-old-email').value;
        const newEmail = document.getElementById('edit-client-new-email').value.trim();

        if (!newEmail) {
            showToast('Email cannot be empty', 'error');
            return;
        }

        if (newEmail === oldEmail) {
            closeEditClientModal();
            return;
        }

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${encodeURIComponent(oldEmail)}/edit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_email: newEmail })
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client updated successfully');
                closeEditClientModal();
                refreshData();
            } else {
                showToast(result.error || 'Error updating client', 'error');
            }
        } catch (error) {
            showToast('Error updating client', 'error');
        }
    }

    function toggleOverview() {
        const stats = document.getElementById('overview-stats');
        const toggle = document.querySelector('.overview-toggle');
        stats.classList.toggle('show');
        toggle.classList.toggle('active');
    }

    function openDeleteClientModal(serverId, inboundId, email, uuid, enable, expiry, up, down, total, remaining) {
        document.getElementById('delete-client-server-id').value = serverId;
        document.getElementById('delete-client-inbound-id').value = inboundId;
        document.getElementById('delete-client-email-hidden').value = email;
        
        document.getElementById('delete-client-email').textContent = email;
        document.getElementById('delete-client-uuid').textContent = uuid;
        
        const statusEl = document.getElementById('delete-client-status');
        statusEl.innerHTML = enable 
            ? '<span class="client-status active">Enabled</span>' 
            : '<span class="client-status inactive">Disabled</span>';
            
        document.getElementById('delete-client-expiry').textContent = expiry;
        document.getElementById('delete-client-traffic').innerHTML = `<span class="up">↑${up}</span> <span class="down">↓${down}</span>`;
        document.getElementById('delete-client-volume').innerHTML = `<span class="remaining">${remaining}</span> <span class="total">/ ${total}</span>`;
        
        document.getElementById('delete-client-modal').classList.remove('hidden');
    }

    function closeDeleteClientModal() {
        document.getElementById('delete-client-modal').classList.add('hidden');
    }

    async function submitDeleteClient() {
        const serverId = document.getElementById('delete-client-server-id').value;
        const inboundId = document.getElementById('delete-client-inbound-id').value;
        const email = document.getElementById('delete-client-email-hidden').value;

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${encodeURIComponent(email)}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client deleted successfully');
                closeDeleteClientModal();
                refreshData();
            } else {
                showToast(result.error || 'Error deleting client', 'error');
            }
        } catch (error) {
            showToast('Error deleting client', 'error');
        }
    }
</script>
{% endblock %}
