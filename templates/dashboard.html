{% extends "base.html" %}

{% block title %}Dashboard - X-UI{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header_actions %}
<div class="header-controls">
    <label class="toggle-switch" title="Auto Refresh">
        <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
        <span class="slider"></span>
    </label>
    <select id="refresh-interval" class="interval-select" onchange="updateRefreshInterval()">
        <option value="10">10s</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
        <option value="120">2 min</option>
        <option value="300">5 min</option>
    </select>
    <button class="btn btn-primary" onclick="refreshData()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon purple">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Servers</span>
            <span class="stat-value" id="stat-servers">{{ server_count }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Inbounds</span>
            <span class="stat-value" id="stat-inbounds">0</span>
            <span class="stat-sub" id="stat-active">0 Active</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Clients</span>
            <span class="stat-value" id="stat-total-clients">0</span>
            <div class="client-breakdown">
                <span class="client-count active-count"><span id="stat-active-clients">0</span></span>
                <span class="client-count inactive-count"><span id="stat-inactive-clients">0</span></span>
            </div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Total Traffic</span>
            <span class="stat-value" id="stat-traffic">0 B</span>
            <span class="stat-sub"><span id="stat-upload">↑ 0 B</span> / <span id="stat-download">↓ 0 B</span></span>
        </div>
    </div>
</div>

<div class="inbounds-section">
    <div class="section-header">
        <h2>Inbounds</h2>
        <span class="badge" id="inbounds-count">0 total</span>
    </div>
    <div class="inbounds-list" id="inbounds-container">
        <div class="empty-state" id="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
            </svg>
            <h3>No servers added</h3>
            <p>Add your X-UI server to see statistics.</p>
            <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="server-modal-title">Servers</h2>
            <button class="modal-close" onclick="closeServerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="server-form">
                <h3 id="form-title">Add Server</h3>
                <input type="hidden" id="edit-server-id">
                <div class="form-group">
                    <label>Server Name</label>
                    <input type="text" id="server-name" placeholder="Server 1">
                </div>
                <div class="form-group">
                    <label>Panel URL</label>
                    <input type="text" id="server-host" placeholder="http://1.2.3.4:54321">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="server-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="server-password" placeholder="password">
                </div>
                <div class="form-group">
                    <label>Panel Type</label>
                    <select id="server-panel-type" class="form-select">
                        <option value="auto">Auto Detect</option>
                        <option value="sanaei">3X-UI (Sanaei)</option>
                        <option value="alireza">X-UI (Alireza)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="testServerConnection()">Test Connection</button>
                    <button class="btn btn-primary" onclick="saveServer()">Save</button>
                </div>
            </div>
            
            <div class="server-list-section">
                <h3>Servers</h3>
                <div class="server-list" id="server-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="qr-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>QR Code</h2>
            <button class="modal-close" onclick="closeQrModal()">&times;</button>
        </div>
        <div class="modal-body qr-body">
            <img id="qr-image" src="" alt="QR Code">
            <p id="qr-email" class="qr-email"></p>
            <div class="qr-actions">
                <button class="btn btn-secondary" onclick="copyLink()">Copy Link</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="renew-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Renew Client</h2>
            <button class="modal-close" onclick="closeRenewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="renew-server-id">
            <input type="hidden" id="renew-inbound-id">
            <input type="hidden" id="renew-email">
            
            <p class="renew-info">Renew Client: <strong id="renew-client-email"></strong></p>
            
            <div class="form-group">
                <label>Days</label>
                <input type="number" id="renew-days" value="30" min="1" max="365" class="form-input">
            </div>
            
            <div class="form-group">
                <label>Volume (GB) (0 = Unlimited)</label>
                <input type="number" id="renew-volume" value="0" min="0" max="10000" class="form-input">
            </div>
            
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="renew-start-after-first-use">
                    <span>Start after first use</span>
                </label>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeRenewModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitRenewal()">Renew</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let autoRefreshInterval = null;
    let currentLink = '';
    let inboundsData = [];

    document.addEventListener('DOMContentLoaded', function() {
        refreshData();
        loadServers();
    });

    function toggleAutoRefresh() {
        const toggle = document.getElementById('auto-refresh-toggle');
        
        if (toggle.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    }

    function updateRefreshInterval() {
        if (document.getElementById('auto-refresh-toggle').checked) {
            startAutoRefresh();
        }
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        const interval = parseInt(document.getElementById('refresh-interval').value) * 1000;
        autoRefreshInterval = setInterval(() => refreshData(), interval);
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    async function refreshData() {
        showLoading();
        
        try {
            const response = await fetch('/api/refresh');
            const data = await response.json();
            
            if (data.success) {
                updateStats(data.stats, data.server_count);
                updateInbounds(data.inbounds);
                inboundsData = data.inbounds;
                
                const failedServers = data.servers?.filter(s => !s.success) || [];
                if (failedServers.length > 0) {
                    const errors = failedServers.map(s => `${s.server_name}: ${s.error}`).join(', ');
                    showToast('Server errors: ' + errors, 'error');
                }
            } else {
                showToast('Error loading data', 'error');
            }
        } catch (error) {
            console.error('Refresh error:', error);
            showToast('Error updating: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function updateStats(stats, serverCount) {
        document.getElementById('stat-servers').textContent = serverCount || 0;
        document.getElementById('stat-inbounds').textContent = stats?.total_inbounds || 0;
        document.getElementById('stat-active').textContent = `${stats?.active_inbounds || 0} Active`;
        document.getElementById('stat-total-clients').textContent = stats?.total_clients || 0;
        document.getElementById('stat-active-clients').textContent = stats?.active_clients || 0;
        document.getElementById('stat-inactive-clients').textContent = stats?.inactive_clients || 0;
        document.getElementById('stat-traffic').textContent = stats?.total_traffic || '0 B';
        document.getElementById('stat-upload').textContent = `↑ ${stats?.total_upload || '0 B'}`;
        document.getElementById('stat-download').textContent = `↓ ${stats?.total_download || '0 B'}`;
    }

    function getExpiryClass(type) {
        switch(type) {
            case 'expired': return 'expiry-expired';
            case 'today': return 'expiry-today';
            case 'soon': return 'expiry-soon';
            case 'start_after_use': return 'expiry-start-after';
            default: return '';
        }
    }

    function updateInbounds(inbounds) {
        const container = document.getElementById('inbounds-container');
        document.getElementById('inbounds-count').textContent = `${inbounds.length} total`;
        
        if (inbounds.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                    </svg>
                    <h3>No servers added</h3>
                    <p>Add your X-UI server to see statistics.</p>
                    <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
                </div>`;
            return;
        }
        
        container.innerHTML = inbounds.map(inbound => `
            <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                <div class="inbound-header">
                    <div class="inbound-title">
                        <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                        <h3>${inbound.remark}</h3>
                        <span class="port-badge">:${inbound.port}</span>
                        <span class="server-badge">${inbound.server_name}</span>
                    </div>
                    <div class="inbound-status">
                        ${inbound.enable 
                            ? `<span class="status-pill active">Active</span>` 
                            : `<span class="status-pill inactive">Inactive</span>`}
                    </div>
                </div>
                
                <div class="inbound-meta-compact">
                    <span class="meta-tag"><span class="label">Network:</span> <span class="value">${inbound.network}</span></span>
                    <span class="meta-tag"><span class="label">Security:</span> <span class="value">${inbound.security}</span></span>
                    <span class="meta-tag"><span class="label">Clients:</span> <span class="value">${inbound.client_count}</span></span>
                    <span class="meta-tag traffic"><span class="label">Traffic:</span> <span class="up">↑${inbound.total_up}</span> <span class="down">↓${inbound.total_down}</span></span>
                </div>

                ${inbound.clients.length > 0 ? `
                <div class="clients-section">
                    <button class="toggle-clients" onclick="toggleClients(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        Show Clients (${inbound.clients.length})
                    </button>
                    <div class="clients-list hidden">
                        <div class="clients-table-wrapper">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Traffic</th>
                                        <th>Volume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td class="email-cell">${client.email}</td>
                                        <td>
                                            ${client.enable 
                                                ? `<span class="client-status active">Enabled</span>` 
                                                : `<span class="client-status inactive">Disabled</span>`}
                                        </td>
                                        <td>
                                            <span class="expiry-badge ${getExpiryClass(client.expiryType)}">${client.expiryTime}</span>
                                        </td>
                                        <td class="traffic-cell">
                                            <div class="traffic-combined-cell">
                                                <span class="up">↑${client.up}</span>
                                                <span class="down">↓${client.down}</span>
                                            </div>
                                        </td>
                                        <td class="volume-cell">
                                            <div class="volume-info">
                                                <span class="remaining">${client.remaining_formatted}</span>
                                                <span class="total">/ ${client.totalGB_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}')" title="QR Code">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="14" width="7" height="7"></rect>
                                                        <rect x="3" y="14" width="7" height="7"></rect>
                                                    </svg>
                                                </button>
                                                <button class="action-btn" onclick="copyClientLink('${encodeURIComponent(client.link || '')}')" title="Copy Link">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                    </svg>
                                                </button>
                                                <button class="action-btn renew" onclick="openRenewModal(${client.server_id}, ${client.inbound_id}, '${client.email}')" title="Renew">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${client.server_id}, ${client.inbound_id}, '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="resetClientTraffic(${client.server_id}, ${client.inbound_id}, '${client.email}')" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `).join('');
    }

    function toggleClients(btn) {
        const clientsList = btn.nextElementSibling;
        const isHidden = clientsList.classList.contains('hidden');
        clientsList.classList.toggle('hidden');
        
        const count = clientsList.querySelectorAll('tbody tr').length;
        btn.innerHTML = isHidden 
            ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg> Hide Clients (${count})`
            : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg> Show Clients (${count})`;
    }

    async function showQrCode(encodedLink, email) {
        const link = decodeURIComponent(encodedLink);
        if (!link) {
            showToast('Link not found', 'error');
            return;
        }
        
        currentLink = link;
        document.getElementById('qr-email').textContent = email;
        
        try {
            const response = await fetch(`/api/client/qrcode?link=${encodedLink}`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('qr-image').src = data.qr_code;
                document.getElementById('qr-modal').classList.remove('hidden');
            } else {
                showToast('Error generating QR Code', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function closeQrModal() {
        document.getElementById('qr-modal').classList.add('hidden');
    }

    async function copyLink() {
        if (!currentLink) {
            showToast('Link not found', 'error');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(currentLink);
            showToast('Link copied');
        } catch (error) {
            showToast('Copy failed', 'error');
        }
    }

    async function copyClientLink(encodedLink) {
        const link = decodeURIComponent(encodedLink);
        if (!link) {
            showToast('Link not found', 'error');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(link);
            showToast('Link copied');
        } catch (error) {
            showToast('Copy failed', 'error');
        }
    }

    async function toggleClient(serverId, inboundId, email, enable) {
        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable: enable })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(enable ? 'Client enabled' : 'Client disabled');
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function resetClientTraffic(serverId, inboundId, email) {
        if (!confirm('Are you sure you want to reset traffic?')) return;
        
        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/reset`, {
                method: 'POST'
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Traffic reset');
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function openRenewModal(serverId, inboundId, email) {
        document.getElementById('renew-server-id').value = serverId;
        document.getElementById('renew-inbound-id').value = inboundId;
        document.getElementById('renew-email').value = email;
        document.getElementById('renew-client-email').textContent = email;
        document.getElementById('renew-days').value = 30;
        document.getElementById('renew-volume').value = 0;
        document.getElementById('renew-start-after-first-use').checked = false;
        document.getElementById('renew-modal').classList.remove('hidden');
    }

    function closeRenewModal() {
        document.getElementById('renew-modal').classList.add('hidden');
    }

    async function submitRenewal() {
        const serverId = document.getElementById('renew-server-id').value;
        const inboundId = document.getElementById('renew-inbound-id').value;
        const email = document.getElementById('renew-email').value;
        const days = parseInt(document.getElementById('renew-days').value);
        const volume = parseInt(document.getElementById('renew-volume').value);
        const startAfterFirstUse = document.getElementById('renew-start-after-first-use').checked;

        if (!days || (volume === '' && volume !== 0)) {
            showToast('Please fill all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/renew`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    days: days, 
                    volume: volume,
                    start_after_first_use: startAfterFirstUse
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Client renewed');
                closeRenewModal();
                refreshData();
            } else {
                showToast(data.error || 'Error renewing', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            const servers = await response.json();
            renderServerList(servers);
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function renderServerList(servers) {
        const container = document.getElementById('server-list');
        
        if (servers.length === 0) {
            container.innerHTML = '<p class="no-servers">No servers added</p>';
            return;
        }
        
        container.innerHTML = servers.map(server => `
            <div class="server-item ${!server.enabled ? 'disabled' : ''}">
                <div class="server-info">
                    <h4>${server.name}</h4>
                    <p>${server.host}</p>
                </div>
                <div class="server-actions">
                    <button class="action-btn" onclick="editServer(${server.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn danger" onclick="deleteServer(${server.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function openServerModal() {
        document.getElementById('form-title').textContent = 'Add Server';
        document.getElementById('edit-server-id').value = '';
        document.getElementById('server-name').value = '';
        document.getElementById('server-host').value = '';
        document.getElementById('server-username').value = '';
        document.getElementById('server-password').value = '';
        document.getElementById('server-panel-type').value = 'auto';
        document.getElementById('server-modal').classList.remove('hidden');
        loadServers();
    }

    function closeServerModal() {
        document.getElementById('server-modal').classList.add('hidden');
    }

    function editServer(id) {
        // Fetch and populate form
        const serverId = document.getElementById('edit-server-id').value = id;
    }

    async function testServerConnection() {
        const id = document.getElementById('edit-server-id').value;
        
        if (!id) {
            showToast('Save server first', 'error');
            return;
        }

        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value
        };

        if (!data.host || !data.username || !data.password) {
            showToast('Please fill all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/servers/${id}/test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(`Connection successful - Panel Type: ${result.panel_type === 'sanaei' ? '3X-UI' : result.panel_type === 'alireza' ? 'X-UI' : 'Unknown'}`);
            } else {
                showToast(result.error || 'Connection failed', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function saveServer() {
        const id = document.getElementById('edit-server-id').value;
        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value
        };

        if (!data.name || !data.host || !data.username || !data.password) {
            showToast('All fields are required', 'error');
            return;
        }

        try {
            const url = id ? `/api/servers/${id}` : '/api/servers';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(id ? 'Server updated' : 'Server added');
                closeServerModal();
                loadServers();
                refreshData();
            } else {
                showToast(result.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function deleteServer(id) {
        if (!confirm('Are you sure you want to delete this server?')) return;
        
        try {
            const response = await fetch(`/api/servers/${id}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                showToast('Server deleted');
                loadServers();
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
