<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-UI Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    <h1>X-UI Dashboard</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="openServerModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                            <line x1="6" y1="6" x2="6.01" y2="6"></line>
                            <line x1="6" y1="18" x2="6.01" y2="18"></line>
                        </svg>
                        Servers (<span id="server-count">{{ server_count }}</span>)
                    </button>
                    <button class="btn btn-refresh" onclick="refreshData()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="refresh-controls">
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
                    <span class="slider"></span>
                </label>
                <span class="toggle-label">Auto Refresh</span>
                <div class="timer-control" id="timer-control" style="display: none;">
                    <input type="number" id="refresh-interval" value="60" min="10" max="3600" class="timer-input">
                    <span class="timer-label">seconds</span>
                </div>
                <span class="refresh-status" id="refresh-status"></span>
            </div>
        </header>

        <div class="stats-grid" id="stats-container">
            <div class="stat-card">
                <div class="stat-icon purple">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                        <line x1="6" y1="6" x2="6.01" y2="6"></line>
                        <line x1="6" y1="18" x2="6.01" y2="18"></line>
                    </svg>
                </div>
                <div class="stat-info">
                    <span class="stat-label">Total Servers</span>
                    <span class="stat-value" id="stat-servers">{{ server_count }}</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                </div>
                <div class="stat-info">
                    <span class="stat-label">Total Inbounds</span>
                    <span class="stat-value" id="stat-inbounds">0</span>
                    <span class="stat-sub" id="stat-active">0 active</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="stat-info">
                    <span class="stat-label">Total Clients</span>
                    <span class="stat-value" id="stat-clients">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                </div>
                <div class="stat-info">
                    <span class="stat-label">Total Traffic</span>
                    <span class="stat-value" id="stat-traffic">0 B</span>
                    <span class="stat-sub"><span id="stat-upload">↑ 0 B</span> / <span id="stat-download">↓ 0 B</span></span>
                </div>
            </div>
        </div>

        <div class="inbounds-section">
            <div class="section-header">
                <h2>Inbounds</h2>
                <span class="badge" id="inbounds-count">0 total</span>
            </div>

            <div class="inbounds-list" id="inbounds-container">
                <div class="empty-state" id="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                        <line x1="6" y1="6" x2="6.01" y2="6"></line>
                        <line x1="6" y1="18" x2="6.01" y2="18"></line>
                    </svg>
                    <h3>No Servers Added</h3>
                    <p>Add your X-UI servers to view inbounds and client statistics.</p>
                    <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>X-UI Dashboard Monitor - Multi Server</p>
            <p class="footer-sub">Last updated: <span id="last-update">Never</span></p>
        </footer>
    </div>

    <div class="modal-overlay hidden" id="server-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Server Management</h2>
                <button class="modal-close" onclick="closeServerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="server-form">
                    <h3 id="form-title">Add New Server</h3>
                    <input type="hidden" id="edit-server-id">
                    <div class="form-group">
                        <label>Server Name</label>
                        <input type="text" id="server-name" placeholder="My Server">
                    </div>
                    <div class="form-group">
                        <label>Host URL</label>
                        <input type="text" id="server-host" placeholder="http://1.2.3.4:54321">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="server-username" placeholder="admin">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="server-password" placeholder="password">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="testServerConnection()">Test Connection</button>
                        <button class="btn btn-primary" onclick="saveServer()">Save Server</button>
                    </div>
                </div>
                
                <div class="server-list-section">
                    <h3>Saved Servers</h3>
                    <div class="server-list" id="server-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="qr-modal">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h2>QR Code</h2>
                <button class="modal-close" onclick="closeQrModal()">&times;</button>
            </div>
            <div class="modal-body qr-body">
                <img id="qr-image" src="" alt="QR Code">
                <p id="qr-email" class="qr-email"></p>
                <div class="qr-actions">
                    <button class="btn btn-secondary" onclick="copyLink()">Copy Link</button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay hidden" id="loading">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <div class="toast hidden" id="toast"></div>

    <script>
        let autoRefreshInterval = null;
        let currentLink = '';
        let inboundsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            loadServers();
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('auto-refresh-toggle');
            const timerControl = document.getElementById('timer-control');
            const status = document.getElementById('refresh-status');
            
            if (toggle.checked) {
                timerControl.style.display = 'flex';
                startAutoRefresh();
            } else {
                timerControl.style.display = 'none';
                stopAutoRefresh();
                status.textContent = '';
            }
        }

        function startAutoRefresh() {
            stopAutoRefresh();
            const interval = parseInt(document.getElementById('refresh-interval').value) * 1000;
            const status = document.getElementById('refresh-status');
            
            autoRefreshInterval = setInterval(() => {
                refreshData();
            }, interval);
            
            status.textContent = `Refreshing every ${interval/1000}s`;
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        document.getElementById('refresh-interval').addEventListener('change', function() {
            if (document.getElementById('auto-refresh-toggle').checked) {
                startAutoRefresh();
            }
        });

        async function refreshData() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/refresh');
                const data = await response.json();
                
                if (data.success) {
                    updateStats(data.stats, data.server_count);
                    updateInbounds(data.inbounds);
                    inboundsData = data.inbounds;
                    document.getElementById('last-update').textContent = new Date().toLocaleString('fa-IR');
                }
            } catch (error) {
                showToast('Failed to refresh data: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function updateStats(stats, serverCount) {
            document.getElementById('stat-servers').textContent = serverCount || 0;
            document.getElementById('stat-inbounds').textContent = stats?.total_inbounds || 0;
            document.getElementById('stat-active').textContent = `${stats?.active_inbounds || 0} active`;
            document.getElementById('stat-clients').textContent = stats?.total_clients || 0;
            document.getElementById('stat-traffic').textContent = stats?.total_traffic || '0 B';
            document.getElementById('stat-upload').textContent = `↑ ${stats?.total_upload || '0 B'}`;
            document.getElementById('stat-download').textContent = `↓ ${stats?.total_download || '0 B'}`;
            document.getElementById('server-count').textContent = serverCount || 0;
        }

        function updateInbounds(inbounds) {
            const container = document.getElementById('inbounds-container');
            const emptyState = document.getElementById('empty-state');
            document.getElementById('inbounds-count').textContent = `${inbounds.length} total`;
            
            if (inbounds.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyState.cloneNode(true));
                return;
            }
            
            container.innerHTML = inbounds.map(inbound => `
                <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                    <div class="inbound-header">
                        <div class="inbound-title">
                            <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                            <h3>${inbound.remark}</h3>
                            <span class="port-badge">:${inbound.port}</span>
                            <span class="server-badge">${inbound.server_name}</span>
                        </div>
                        <div class="inbound-status">
                            ${inbound.enable 
                                ? '<span class="status-pill active">Active</span>' 
                                : '<span class="status-pill inactive">Disabled</span>'}
                        </div>
                    </div>
                    
                    <div class="inbound-meta">
                        <div class="meta-item">
                            <span class="meta-label">Network</span>
                            <span class="meta-value">${inbound.network}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Security</span>
                            <span class="meta-value">${inbound.security}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Clients</span>
                            <span class="meta-value">${inbound.client_count}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Expiry</span>
                            <span class="meta-value">${inbound.expiryTime}</span>
                        </div>
                    </div>
                    
                    <div class="traffic-stats">
                        <div class="traffic-item upload">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="17 11 12 6 7 11"></polyline>
                                <polyline points="12 6 12 18"></polyline>
                            </svg>
                            <span>${inbound.total_up}</span>
                        </div>
                        <div class="traffic-item download">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="7 13 12 18 17 13"></polyline>
                                <polyline points="12 6 12 18"></polyline>
                            </svg>
                            <span>${inbound.total_down}</span>
                        </div>
                        <div class="traffic-item total">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span>${inbound.total_traffic}</span>
                        </div>
                    </div>

                    ${inbound.clients.length > 0 ? `
                    <div class="clients-section">
                        <button class="toggle-clients" onclick="toggleClients(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            Show Clients (${inbound.clients.length})
                        </button>
                        <div class="clients-list hidden">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Upload</th>
                                        <th>Download</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td>${client.email}</td>
                                        <td>
                                            ${client.enable 
                                                ? '<span class="client-status active">Active</span>' 
                                                : '<span class="client-status inactive">Disabled</span>'}
                                        </td>
                                        <td>${client.expiryTime}</td>
                                        <td class="traffic-cell upload">${client.up}</td>
                                        <td class="traffic-cell download">${client.down}</td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}')" title="QR Code">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="14" width="7" height="7"></rect>
                                                        <rect x="3" y="14" width="7" height="7"></rect>
                                                    </svg>
                                                </button>
                                                <button class="action-btn" onclick="copyClientLink('${encodeURIComponent(client.link || '')}')" title="Copy Link">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${client.server_id}, ${client.inbound_id}, '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="resetClientTraffic(${client.server_id}, ${client.inbound_id}, '${client.email}')" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function toggleClients(btn) {
            const clientsList = btn.nextElementSibling;
            const isHidden = clientsList.classList.contains('hidden');
            
            clientsList.classList.toggle('hidden');
            const count = clientsList.querySelectorAll('tbody tr').length;
            btn.innerHTML = isHidden 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg> Hide Clients (${count})`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg> Show Clients (${count})`;
        }

        async function showQrCode(link, email) {
            if (!link) {
                showToast('No link available for this client', 'error');
                return;
            }
            
            currentLink = decodeURIComponent(link);
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/client/qrcode?link=${link}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('qr-image').src = data.qrcode;
                    document.getElementById('qr-email').textContent = email;
                    document.getElementById('qr-modal').classList.remove('hidden');
                } else {
                    showToast('Failed to generate QR code', 'error');
                }
            } catch (error) {
                showToast('Failed to generate QR code: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function closeQrModal() {
            document.getElementById('qr-modal').classList.add('hidden');
        }

        function copyLink() {
            if (currentLink) {
                navigator.clipboard.writeText(currentLink);
                showToast('Link copied to clipboard!');
            }
        }

        function copyClientLink(link) {
            if (!link) {
                showToast('No link available', 'error');
                return;
            }
            navigator.clipboard.writeText(decodeURIComponent(link));
            showToast('Link copied to clipboard!');
        }

        async function toggleClient(serverId, inboundId, email, enable) {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable })
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Client ${enable ? 'enabled' : 'disabled'} successfully`);
                    refreshData();
                } else {
                    showToast('Failed: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Failed: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function resetClientTraffic(serverId, inboundId, email) {
            if (!confirm(`Reset traffic for ${email}?`)) return;
            
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/reset`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Traffic reset successfully');
                    refreshData();
                } else {
                    showToast('Failed: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Failed: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function openServerModal() {
            document.getElementById('server-modal').classList.remove('hidden');
            loadServers();
            clearServerForm();
        }

        function closeServerModal() {
            document.getElementById('server-modal').classList.add('hidden');
        }

        function clearServerForm() {
            document.getElementById('form-title').textContent = 'Add New Server';
            document.getElementById('edit-server-id').value = '';
            document.getElementById('server-name').value = '';
            document.getElementById('server-host').value = '';
            document.getElementById('server-username').value = '';
            document.getElementById('server-password').value = '';
        }

        async function loadServers() {
            try {
                const response = await fetch('/api/servers');
                const servers = await response.json();
                
                const list = document.getElementById('server-list');
                
                if (servers.length === 0) {
                    list.innerHTML = '<p class="no-servers">No servers added yet</p>';
                    return;
                }
                
                list.innerHTML = servers.map(server => `
                    <div class="server-item ${!server.enabled ? 'disabled' : ''}">
                        <div class="server-info">
                            <strong>${server.name}</strong>
                            <span>${server.host}</span>
                        </div>
                        <div class="server-actions">
                            <button class="action-btn" onclick="editServer(${server.id})" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="action-btn danger" onclick="deleteServer(${server.id})" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showToast('Failed to load servers', 'error');
            }
        }

        async function saveServer() {
            const id = document.getElementById('edit-server-id').value;
            const data = {
                name: document.getElementById('server-name').value,
                host: document.getElementById('server-host').value,
                username: document.getElementById('server-username').value,
                password: document.getElementById('server-password').value,
                enabled: true
            };
            
            if (!data.name || !data.host || !data.username || !data.password) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const url = id ? `/api/servers/${id}` : '/api/servers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(id ? 'Server updated!' : 'Server added!');
                    clearServerForm();
                    loadServers();
                    refreshData();
                } else {
                    showToast('Failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Failed: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function editServer(id) {
            try {
                const response = await fetch('/api/servers');
                const servers = await response.json();
                const server = servers.find(s => s.id === id);
                
                if (server) {
                    document.getElementById('form-title').textContent = 'Edit Server';
                    document.getElementById('edit-server-id').value = id;
                    document.getElementById('server-name').value = server.name;
                    document.getElementById('server-host').value = server.host;
                    document.getElementById('server-username').value = server.username;
                    document.getElementById('server-password').value = '';
                }
            } catch (error) {
                showToast('Failed to load server', 'error');
            }
        }

        async function deleteServer(id) {
            if (!confirm('Are you sure you want to delete this server?')) return;
            
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/servers/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Server deleted!');
                    loadServers();
                    refreshData();
                } else {
                    showToast('Failed to delete server', 'error');
                }
            } catch (error) {
                showToast('Failed: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function testServerConnection() {
            const id = document.getElementById('edit-server-id').value;
            
            if (!id) {
                showToast('Please save the server first, then test', 'error');
                return;
            }
            
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/servers/${id}/test`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Connection successful!');
                } else {
                    showToast('Connection failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Test failed: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }

        document.getElementById('server-modal').addEventListener('click', function(e) {
            if (e.target === this) closeServerModal();
        });

        document.getElementById('qr-modal').addEventListener('click', function(e) {
            if (e.target === this) closeQrModal();
        });
    </script>
</body>
</html>
