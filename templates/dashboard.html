{% extends "base.html" %}

{% block title %}Dashboard - X-UI{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header_actions %}
<div class="header-controls">
    <label class="toggle-switch" title="Auto Refresh">
        <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
        <span class="slider"></span>
    </label>
    <select id="refresh-interval" class="interval-select" onchange="updateRefreshInterval()">
        <option value="10">10s</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
        <option value="120">2 min</option>
        <option value="300">5 min</option>
    </select>
    <button class="btn btn-primary" onclick="refreshData()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        <span class="btn-label">Refresh</span>
    </button>
    <button class="btn btn-success" onclick="openAddClientModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"></path>
        </svg>
        <span class="btn-label">Add Client</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="overview-wrapper">
    <div class="overview-toggle" onclick="toggleOverview()">
        <h3>Overview</h3>
        <svg id="overview-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </div>
    <div class="stats-grid" id="overview-stats">
        <div class="stat-card">
            <div class="stat-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                    <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Servers</span>
                <span class="stat-value" id="stat-servers">{{ server_count }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                    <line x1="8" y1="21" x2="16" y2="21"></line>
                    <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Inbounds</span>
                <span class="stat-value" id="stat-inbounds">0</span>
                <span class="stat-sub" id="stat-active">0 Active</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Clients</span>
                <div class="stat-value-row">
                    <span class="stat-value" id="stat-total-clients">0</span>
                    <span class="stat-online" title="Online clients">
                        <span class="online-dot"></span>
                        <span id="stat-online-clients">0</span>
                    </span>
                </div>
                <div class="client-breakdown">
                    <span class="client-count active-count"><span id="stat-active-clients">0</span></span>
                    <span class="client-count inactive-count"><span id="stat-inactive-clients">0</span></span>
                    <span class="client-count expiry-start-after" title="Not started"><span id="stat-not-started-clients">0</span></span>
                    <span class="client-count unlimited-expiry" title="Unlimited expiry"><span id="stat-unlimited-expiry-clients">0</span></span>
                    <span class="client-count unlimited-volume" title="Unlimited volume"><span id="stat-unlimited-volume-clients">0</span></span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-label">Total Traffic</span>
                <span class="stat-value" id="stat-traffic">0 B</span>
                <span class="stat-sub"><span id="stat-upload">↑ 0 B</span> / <span id="stat-download">↓ 0 B</span></span>
            </div>
        </div>
    </div>
</div>

<div class="inbounds-section">
    <div class="section-header">
        <h2>Inbounds</h2>
        <span class="badge" id="inbounds-count">0 total</span>
    </div>
    <div class="filter-bar">
        <div class="search-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            
            <div style="width:0;height:0;overflow:hidden;position:absolute;">
                <input type="text" name="fake_username_trap" tabindex="-1">
                <input type="password" name="fake_password_trap" tabindex="-1">
            </div>

            <input type="text" 
                   id="global-search-input" 
                   name="search_query_unique_id_123" 
                   autocomplete="off" 
                   readonly 
                   onfocus="this.removeAttribute('readonly');"
                   placeholder="Search clients..." 
                   class="search-input">

            <button class="search-clear hidden" onclick="clearSearch()" id="clear-search-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="filters-group">
            <!-- Server Filter -->
            <div class="filter-dropdown-wrapper">
                <button class="filter-btn" onclick="toggleServerFilter()" id="server-filter-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="filter-icon"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>
                    <span>Servers</span>
                    <span class="badge-count hidden" id="server-filter-count">0</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="server-filter-dropdown" class="filter-dropdown hidden">
                    <div class="filter-header">
                        <span>Select Servers</span>
                        <button class="text-btn" onclick="selectAllServers()">All</button>
                    </div>
                    <div id="server-filter-list" class="filter-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Expiry Filter -->
            <div class="filter-dropdown-wrapper">
                <button class="filter-btn" onclick="toggleExpiryFilter()" id="expiry-filter-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="filter-icon"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    <span id="expiry-filter-label">Expiry</span>
                    <span class="badge-count hidden" id="expiry-filter-count">0</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div id="expiry-filter-dropdown" class="filter-dropdown hidden">
                    <div class="filter-header">
                        <span>Expiry</span>
                        <button class="text-btn" onclick="toggleAllExpiryFilters()">All</button>
                    </div>
                    <div class="filter-list">
                        <div class="filter-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="expiry-filter-not-started" onchange="toggleExpirySelection('not_started', this.checked)">
                                <span class="checkmark"></span>
                                <span>Not started</span>
                            </label>
                        </div>
                        <div class="filter-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="expiry-filter-unlimited" onchange="toggleExpirySelection('unlimited', this.checked)">
                                <span class="checkmark"></span>
                                <span>Unlimited</span>
                            </label>
                        </div>
                        <div class="filter-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="expiry-filter-expired" onchange="toggleExpirySelection('expired', this.checked)">
                                <span class="checkmark"></span>
                                <span>Expired</span>
                            </label>
                        </div>
                        <div class="filter-item">
                            <label class="checkbox-label">
                                <input type="checkbox" id="expiry-filter-today" onchange="toggleExpirySelection('today', this.checked)">
                                <span class="checkmark"></span>
                                <span>Today</span>
                            </label>
                        </div>
                        <div class="filter-item">
                            <label class="checkbox-label" style="width: 100%;">
                                <input type="checkbox" id="expiry-filter-lt-days" onchange="toggleExpirySelection('lt_days', this.checked)">
                                <span class="checkmark"></span>
                                <span>Less than</span>
                                <input type="number" id="expiry-lt-days" class="form-input expiry-days-input" min="1" max="999" step="1" value="7" onchange="onExpiryDaysChanged()" onkeydown="onExpiryDaysKeyDown(event)" onclick="event.stopPropagation()">
                                <span>days</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hide Disabled Filter -->
            <label class="filter-toggle" title="Hide Disabled Clients">
                <input type="checkbox" id="hide-disabled-filter" onchange="applyDisabledVisibility()">
                <span class="toggle-track"></span>
                <span class="toggle-text">Hide Disabled</span>
            </label>

            <label class="filter-toggle" title="Show Disabled Clients Only">
                <input type="checkbox" id="disabled-only-filter" onchange="applyDisabledVisibility()">
                <span class="toggle-track"></span>
                <span class="toggle-text">Disabled only</span>
            </label>
        </div>
    </div>
    
    <div id="search-results" style="display: none; margin-bottom: 20px; padding: 12px 16px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px; font-size: 0.9rem; color: #e0e7ff; display: none; justify-content: space-between; align-items: center; gap: 10px;">
        <span id="search-results-text"></span>
        <button id="search-select-all-btn" class="btn btn-secondary" style="display:none; padding: 6px 10px;" onclick="selectAllSearchResults()">Select All</button>
    </div>
    <div id="bulk-actions-container" style="display:none; margin-bottom: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--card);">
        <strong>Bulk Actions</strong>
        <span id="bulk-selected-count" style="margin-left: 10px; font-size: 0.9em; color: var(--text-secondary);">0 selected</span>

        <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
            <select id="bulk-action-select" class="form-select" style="max-width: 200px;" onchange="onBulkActionChanged()">
                <option value="">Select Action</option>
                <option value="enable">Enable</option>
                <option value="disable">Disable</option>
                <option value="delete">Delete</option>
                <option value="add_days">Add Days</option>
                <option value="add_volume">Add Volume (GB)</option>
                {% if is_superadmin %}
                <option value="assign_owner">Assign Owner</option>
                <option value="unassign_owner">Unassign Owner</option>
                {% endif %}
            </select>

            <div id="bulk-delta-container" style="display:none;">
                <input id="bulk-days-delta" type="number" class="form-input" min="1" step="1" placeholder="Days" style="max-width: 110px; display:none;">
                <input id="bulk-volume-delta" type="number" class="form-input" min="1" step="1" placeholder="GB" style="max-width: 110px; display:none;">
            </div>

            <div id="bulk-conditions" style="display:flex; gap:10px; align-items:center;">
                <select id="bulk-cond-enable" class="form-select" style="max-width: 160px;" title="Target by enabled/disabled">
                    <option value="any" selected>Any Status</option>
                    <option value="enabled">Enabled only</option>
                    <option value="disabled">Disabled only</option>
                </select>
                <select id="bulk-cond-expiry" class="form-select" style="max-width: 190px;" title="Target by expiry type">
                    <option value="any" selected>Any Expiry</option>
                    <option value="unlimited">Unlimited</option>
                    <option value="start_after_use">Not started</option>
                    <option value="expired">Expired</option>
                    <option value="today">Today</option>
                    <option value="soon">Soon</option>
                    <option value="normal">Normal</option>
                </select>
            </div>

            {% if is_superadmin %}
            <div id="bulk-reseller-container" style="display:none;">
                <select id="bulk-reseller-select" class="form-select" style="max-width: 220px;">
                    <option value="">Select Reseller</option>
                </select>
            </div>
            {% endif %}

            <button class="btn btn-primary" onclick="executeBulkAction()">Apply</button>
            <button class="btn btn-secondary" onclick="clearBulkSelection()">Clear</button>
        </div>

        <div id="bulk-progress" style="display:none; margin-top: 10px;">
            <div style="height: 8px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 999px; overflow: hidden;">
                <div id="bulk-progress-bar" style="height: 8px; width: 0%; background: var(--primary);"></div>
            </div>
            <div id="bulk-progress-text" style="margin-top: 6px; font-size: 0.85rem; color: var(--text-secondary);">0/0</div>
        </div>
    </div>
    <div class="inbounds-list" id="inbounds-container">
        <div class="empty-state" id="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
            </svg>
            <h3>No servers added</h3>
            <p>Add your X-UI server to see statistics.</p>
            <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="server-modal-title">Servers</h2>
            <button class="modal-close" onclick="closeServerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="server-form">
                <h3 id="form-title">Add Server</h3>
                <input type="hidden" id="edit-server-id">
                <div class="form-group">
                    <label>Server Name</label>
                    <input type="text" id="server-name" placeholder="Server 1">
                </div>
                <div class="form-group">
                    <label>Panel URL</label>
                    <input type="text" id="server-host" placeholder="http://1.2.3.4:54321">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="server-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="server-password" placeholder="password">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 2;">
                        <label>Sub Path</label>
                        <input type="text" id="server-sub-path" placeholder="/sub/" value="/sub/">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Json Path</label>
                        <input type="text" id="server-json-path" placeholder="/json/" value="/json/">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Sub Port</label>
                        <input type="number" id="server-sub-port" placeholder="Default">
                    </div>
                </div>
                <div class="form-group">
                    <label>Panel Type</label>
                    <select id="server-panel-type" class="form-select">
                        <option value="auto">Auto Detect</option>
                        <option value="sanaei">3X-UI (Sanaei)</option>
                        <option value="alireza">X-UI (Alireza)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="testServerConnection()">Test Connection</button>
                    <button class="btn btn-primary" onclick="saveServer()">Save</button>
                </div>
            </div>
            
            <div class="server-list-section">
                <h3>Servers</h3>
                <div class="server-list" id="server-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="qr-modal">
    <div class="modal modal-xl">
        <div class="modal-header">
            <h2>QR Codes - <span id="qr-email" class="qr-email" style="word-break: break-all;"></span></h2>
            <button class="modal-close" onclick="closeQrModal()">&times;</button>
        </div>
        <div class="modal-body qr-body" style="padding: 15px;">
            <div class="qr-grid">
                
                <div class="qr-item ripple" id="box-sub" onclick="copyText('input-sub', 'img-sub', 'Subscription')">
                    <div class="qr-title">Subscription</div>
                    <img id="img-sub" src="" alt="Sub QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-sub">
                </div>

                <div class="qr-item ripple" id="box-json" onclick="copyText('input-json', 'img-json', 'Subscription JSON')">
                    <div class="qr-title">Subscription JSON</div>
                    <img id="img-json" src="" alt="Json QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-json">
                </div>

                <div class="qr-item ripple" id="box-config" onclick="copyText('input-config', 'img-config', 'Direct Link')">
                    <div class="qr-title" id="title-config">Direct Link</div>
                    <img id="img-config" src="" alt="Config QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-config">
                </div>

                <div class="qr-item ripple" id="box-dash" onclick="copyText('input-dash', 'img-dash', 'Dash Sub')">
                    <div class="qr-title">Dash Sub</div>
                    <img id="img-dash" src="" alt="Dash QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-dash">
                </div>
                
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="expanded-qr-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2 id="expanded-qr-title">QR Code</h2>
            <button class="modal-close" onclick="closeExpandedQr()">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center; padding: 20px;">
            <img id="expanded-qr-img" src="" alt="QR" style="max-width: 300px; width: 100%; height: auto; background: white; padding: 10px; border-radius: 8px;">
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="renew-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Renew Client</h2>
            <button class="modal-close" onclick="closeRenewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="renew-server-id">
            <input type="hidden" id="renew-inbound-id">
            <input type="hidden" id="renew-email">
            
            <p class="renew-info" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-secondary);">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <strong id="renew-client-email"></strong>
                <span id="renew-client-status" style="color: var(--text-secondary);"></span>
            </p>

            <div class="form-group">
                <label>Packages (Optional)</label>
                <div id="renew-packages-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading packages...</div>
                </div>
                <small style="color: var(--text-secondary); display: block; margin-top: 6px;">Click again to unselect a package. No selection = custom pricing.</small>
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Duration (Days) <small style="color: var(--text-secondary); font-weight: normal;">(0 = Unlimited ∞)</small></label>
                    <input type="number" id="renew-custom-days" class="form-input" value="30" min="0" max="365" oninput="calculateRenewCustomPrice()">
                </div>
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Volume (GB) <small style="color: var(--text-secondary); font-weight: normal;">(0 = Unlimited ∞)</small></label>
                    <input type="number" id="renew-custom-volume" class="form-input" value="10" min="0" max="10000" oninput="calculateRenewCustomPrice()">
                </div>
                <div style="flex: 1.5; background: rgba(255,255,255,0.05); padding: 0 12px; border-radius: 8px; height: 42px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color);">
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">Cost: <strong id="renew-price-display" style="color: #fbbf24; margin-left: 4px;">0</strong> <span style="font-size: 0.75rem;">T</span></span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1.5fr); gap: 10px; align-items: stretch; margin-bottom: 5px;">
                <label class="form-group form-toggle-item" style="cursor: pointer; margin: 0;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="renew-free-toggle" onchange="refreshRenewPriceDisplay()">
                        <span class="slider"></span>
                    </div>
                    <span>Free</span>
                </label>

                <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); padding: 8px 12px; border-radius: 8px; margin: 0; min-width: 0;">
                    <span style="font-size: 0.9rem; color: #4ade80;">Payable Amount</span>
                    <div style="color: #4ade80; display: inline-flex; align-items: baseline; gap: 8px; min-width: 0; flex-wrap: wrap; justify-content: flex-end;">
                        <strong id="renew-payable-display" style="font-size: 1.1rem;">0</strong>
                        <strong id="renew-payable-free" style="display:none; font-size: 1.1rem; color: #fbbf24;">0</strong>
                        <span class="wallet-currency" style="font-size: 0.8rem;">T</span>
                    </div>
                </div>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 15px; text-align: right; opacity: 0.8;">
                Packages override the custom price. Without a package the amount is based on days & volume.
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <label class="form-group form-toggle-item" style="cursor: pointer; margin: 0;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="renew-reset-traffic">
                        <span class="slider"></span>
                    </div>
                    <span>Reset Traffic</span>
                </label>
                
                <label class="form-group form-toggle-item" style="cursor: pointer; margin: 0;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="renew-start-after-first-use">
                        <span class="slider"></span>
                    </div>
                    <span>Start after first use</span>
                </label>
            </div>
            
            <!-- Payment Card Info -->
            <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; padding: 12px; margin-top: 15px;">
                <div style="font-size: 0.85rem; color: #a5b4fc; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    Payment Info (Optional)
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.75rem;">Sender Card</label>
                        <input type="text" id="renew-sender-card" class="form-input" placeholder="6037xxxx" style="font-size: 0.85rem;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.75rem;">Destination Card</label>
                        <select id="renew-dest-card" class="form-select" style="font-size: 0.85rem;">
                            <option value="">-- Select --</option>
                            {% for card in bank_cards %}
                            <option value="{{ card.id }}">{{ card.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-footer" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div style="font-size: 0.9rem; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; color: #4ade80;">
                        <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path>
                        <path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path>
                        <path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path>
                    </svg>
                    <span style="color: #4ade80;">{{ "{:,}".format(credit if credit else 0) }} T</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeRenewModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitRenewal()">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="renew-success-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Renewal Successful</h2>
            <button class="modal-close" onclick="closeRenewSuccessModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="renew-prev-state" style="margin-bottom: 15px; font-size: 0.85rem; color: var(--text-secondary); background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 6px; flex-wrap: wrap; direction: ltr; word-break: break-all;">
            </div>
            <div id="renew-success-text" style="white-space: pre-wrap; word-break: break-all; margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6; background: var(--bg-dark); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); direction: ltr; text-align: left;"></div>
            <button class="btn btn-primary w-full" onclick="copyRenewSuccessText()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy Text
            </button>
        </div>
    </div>
</div>

        <div class="modal-overlay hidden" id="reset-modal">
            <div class="modal modal-sm">
                <div class="modal-header">
                    <h2>Reset Traffic</h2>
                    <button class="modal-close" onclick="closeResetModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reset-server-id">
                    <input type="hidden" id="reset-inbound-id">
                    <input type="hidden" id="reset-email">

                    <p class="renew-info">User: <strong id="reset-client-email"></strong></p>
                    <p class="reset-summary">Current plan volume: <strong id="reset-current-volume"></strong></p>

                    <div class="form-group">
                        <label>Billable Volume (GB)</label>
                        <input type="number" id="reset-volume" class="form-input" min="1" max="10000" value="50" oninput="updateResetCost()">
                        <small style="color: var(--text-secondary);">Adjust to charge the correct amount for this reset.</small>
                    </div>

                    <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1.5fr); gap: 10px; align-items: stretch; margin-bottom: 15px;">
                        <label class="form-group form-toggle-item" style="cursor: pointer; margin: 0;">
                            <div class="toggle-switch">
                                <input type="checkbox" id="reset-free-toggle" onchange="updateResetCost()">
                                <span class="slider"></span>
                            </div>
                            <span>Free</span>
                        </label>

                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); padding: 8px 12px; border-radius: 8px; margin: 0; min-width: 0;">
                            <span style="font-size: 0.9rem; color: #4ade80;">Payable</span>
                            <div style="color: #4ade80; display: inline-flex; align-items: baseline; gap: 8px; min-width: 0; flex-wrap: wrap; justify-content: flex-end;">
                                <strong id="reset-cost" style="font-size: 1.1rem;">0</strong>
                                <span class="wallet-currency" style="font-size: 0.8rem;">T</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Card Info -->
                    <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; padding: 12px; margin-top: 10px;">
                        <div style="font-size: 0.85rem; color: #a5b4fc; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                            Payment Info (Optional)
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.75rem;">Sender Card</label>
                                <input type="text" id="reset-sender-card" class="form-input" placeholder="6037xxxx" style="font-size: 0.85rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.75rem;">Destination Card</label>
                                <select id="reset-dest-card" class="form-select" style="font-size: 0.85rem;">
                                    <option value="">-- Select --</option>
                                    {% for card in bank_cards %}
                                    <option value="{{ card.id }}">{{ card.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitResetTraffic()">Confirm Reset</button>
                    </div>
                </div>
            </div>
        </div>

<div class="modal-overlay hidden" id="add-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Purchase New Service</h2>
            <button class="modal-close" onclick="closeAddClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Server & Inbound</label>
                <div style="display: flex; gap: 10px;">
                    <select id="add-client-server-select" class="form-select" onchange="onServerSelected()" style="flex: 1;"></select>
                    <select id="add-client-inbound-select" class="form-select" {% if is_superadmin %}onchange="onInboundSelected()"{% endif %} style="flex: 1;"></select>
                </div>
            </div>

            <div class="form-group">
                {% if is_superadmin %}
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end;">
                        <div>
                            <label>Username / Email</label>
                            <input type="text" id="add-client-email" class="form-input" placeholder="user1">
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 8px; height: 42px; display: flex; align-items: center; justify-content: center; padding: 0 10px; overflow: hidden;">
                            <span style="font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="last-user-display">Last User: -</span>
                        </div>
                    </div>
                {% else %}
                    <label>Username / Email</label>
                    <input type="text" id="add-client-email" class="form-input" placeholder="user1">
                {% endif %}
            </div>

            <div class="form-group">
                <label>Packages (Optional)</label>
                <div id="packages-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading packages...</div>
                </div>
                <small style="color: var(--text-secondary); display: block; margin-top: 6px;">Click a package to use its pricing. Click again to remove selection.</small>
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Duration (Days) <small style="color: var(--text-secondary); font-weight: normal;">(0 = Unlimited ∞)</small></label>
                    <input type="number" id="custom-days" class="form-input" value="30" min="0" max="365" oninput="calculateCustomPrice()">
                </div>
                <div class="form-group" style="flex:1; margin-bottom: 0;">
                    <label>Volume (GB) <small style="color: var(--text-secondary); font-weight: normal;">(0 = Unlimited ∞)</small></label>
                    <input type="number" id="custom-volume" class="form-input" value="10" min="0" max="10000" oninput="calculateCustomPrice()">
                </div>
                <div style="flex: 1.5; background: rgba(255,255,255,0.05); padding: 0 12px; border-radius: 8px; height: 42px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color);">
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">Cost: <strong id="custom-price-display" style="color: #fbbf24; margin-left: 4px;">0</strong> <span style="font-size: 0.75rem;">T</span></span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1.5fr); gap: 10px; align-items: stretch; margin-bottom: 5px;">
                <label class="form-group form-toggle-item" style="cursor: pointer; margin: 0;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="add-client-free-toggle" onchange="updateAddPriceDisplay()">
                        <span class="slider"></span>
                    </div>
                    <span>Free</span>
                </label>

                <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); padding: 8px 12px; border-radius: 8px; margin: 0; min-width: 0;">
                    <span style="font-size: 0.9rem; color: #4ade80;">Payable Amount</span>
                    <div style="color: #4ade80; display: inline-flex; align-items: baseline; gap: 8px; min-width: 0; flex-wrap: wrap; justify-content: flex-end;">
                        <strong id="add-price-display" style="font-size: 1.1rem;">0</strong>
                        <strong id="add-price-free" style="display:none; font-size: 1.1rem; color: #fbbf24;">0</strong>
                        <span class="wallet-currency" style="font-size: 0.8rem;">T</span>
                    </div>
                </div>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 15px; text-align: right; opacity: 0.8;">
                Package price takes priority. Otherwise, days × cost/day + GB × cost/GB.
            </div>
            
            <label class="form-group form-toggle-item" style="cursor: pointer;">
                <div class="toggle-switch">
                    <input type="checkbox" id="add-client-start-after-first-use">
                    <span class="slider"></span>
                </div>
                <span>Start after first use</span>
            </label>
            
            <!-- Payment Card Info -->
            <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; padding: 12px; margin-top: 5px;">
                <div style="font-size: 0.85rem; color: #a5b4fc; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    Payment Info (Optional)
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.75rem;">Sender Card</label>
                        <input type="text" id="add-client-sender-card" class="form-input" placeholder="6037xxxx" style="font-size: 0.85rem;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.75rem;">Destination Card</label>
                        <select id="add-client-dest-card" class="form-select" style="font-size: 0.85rem;">
                            <option value="">-- Select --</option>
                            {% for card in bank_cards %}
                            <option value="{{ card.id }}">{{ card.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-footer" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div style="font-size: 0.9rem; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; color: #4ade80;">
                        <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path>
                        <path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path>
                        <path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path>
                    </svg>
                    <span style="color: #4ade80;">{{ "{:,}".format(credit if credit else 0) }} T</span>
                </div>
                <button class="btn btn-primary" onclick="submitAddClient()">
                    Pay & Create
                </button>
            </div>

        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="assign-modal">
    <div class="modal modal-sm" style="overflow: visible;">
        <div class="modal-header">
            <h2>Assign Owner</h2>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow: visible;">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Client: <strong id="assign-client-email" style="color: var(--text-primary);"></strong></p>
            <input type="hidden" id="assign-server-id">
            <input type="hidden" id="assign-inbound-id">
            <input type="hidden" id="assign-client-email-hidden">
            <input type="hidden" id="assign-client-uuid">
            
            <div class="form-group">
                <label>Select Reseller</label>
                <div class="filter-dropdown-wrapper" style="width: 100%;">
                    <button class="filter-btn" onclick="toggleResellerDropdown()" id="assign-reseller-btn" style="width: 100%; justify-content: space-between;">
                        <span id="assign-reseller-label">Select Reseller</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div id="assign-reseller-dropdown" class="filter-dropdown hidden" style="width: 100%; max-height: 200px; overflow-y: auto;">
                        <div id="assign-reseller-list" class="filter-list" style="max-height: none;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <input type="hidden" id="assign-reseller-select">
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAssignment()">Assign</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="edit-client-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Edit Client</h2>
            <button class="modal-close" onclick="closeEditClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-client-server-id">
            <input type="hidden" id="edit-client-inbound-id">
            <input type="hidden" id="edit-client-old-email">
            
            <div class="form-group">
                <label>Email</label>
                <input type="text" id="edit-client-new-email" class="form-input" placeholder="New Email">
            </div>

            {% if is_superadmin %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Total Volume (GB)</label>
                    <input type="number" id="edit-client-total-gb" class="form-input" step="0.1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Expiry Time</label>
                    <input type="text" id="edit-client-expiry" data-jdp class="form-input" placeholder="1403/09/15 14:30">
                </div>
            </div>
            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 10px; margin-bottom: 15px; font-size: 0.8rem; color: #fbbf24; line-height: 1.4;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                Changes here are not recorded in the Finance system. If you are adding volume or time, make sure to manually adjust or record the transaction in the Finance section.
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeEditClientModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitEditClient()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="new-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Client Created Successfully</h2>
            <button class="modal-close" onclick="closeNewClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Client Details</label>
                <textarea id="new-client-details" class="form-input" rows="12" readonly style="font-family: 'Vazirmatn', sans-serif; direction: rtl; white-space: pre-wrap; word-break: break-all; line-height: 1.7;"></textarea>
                <button class="btn btn-secondary btn-block" style="margin-top: 8px;" onclick="copyNewClientDetails()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    Copy Details
                </button>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">QR Codes</h3>
                <div class="qr-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="qr-item ripple" id="new-client-qr-sub" onclick="copyText('new-client-sub-link', 'new-client-img-sub', 'Subscription')">
                        <div class="qr-title">Subscription</div>
                        <img id="new-client-img-sub" src="" alt="Sub QR">
                        <div class="click-hint">Tap to Copy</div>
                        <input type="hidden" id="new-client-sub-link">
                    </div>
                    <div class="qr-item ripple" id="new-client-qr-dash" onclick="copyText('new-client-dash-link', 'new-client-img-dash', 'Dashboard')">
                        <div class="qr-title">Dashboard</div>
                        <img id="new-client-img-dash" src="" alt="Dash QR">
                        <div class="click-hint">Tap to Copy</div>
                        <input type="hidden" id="new-client-dash-link">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/persian-date@latest/dist/persian-date.min.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='jalalidatepicker.min.css') }}">
<script src="{{ url_for('static', filename='jalalidatepicker.min.js') }}"></script>

<style nonce="{{ csp_nonce }}">
    /* Jalali Datepicker Dark Theme Overrides */
    jdp-container {
        background-color: var(--bg-card) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: var(--shadow-lg) !important;
        font-family: 'Vazirmatn', sans-serif !important;
        z-index: 9999 !important;
    }

    jdp-container, jdp-container * {
        font-family: 'Vazirmatn', sans-serif !important;
    }

    jdp-container .jdp-day-name:last-child,
    jdp-container .jdp-day:nth-child(7n) {
        color: #f87171 !important;
    }

    jdp-container .jdp-header {
        background-color: var(--bg-dark) !important;
        border-bottom: 1px solid var(--border-color) !important;
    }

    jdp-container .jdp-header select,
    jdp-container select {
        background-color: var(--bg-card) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 4px !important;
        padding: 2px 4px !important;
        outline: none !important;
    }

    jdp-container .jdp-header .jdp-btn {
        background-color: var(--bg-card) !important;
        color: var(--text-secondary) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 4px !important;
        margin: 0 2px !important;
    }
    
    jdp-container .jdp-header .jdp-btn:hover {
        background-color: var(--primary) !important;
        color: white !important;
        border-color: var(--primary) !important;
    }

    jdp-container .jdp-days {
        color: var(--text-primary) !important;
    }

    jdp-container .jdp-day {
        color: var(--text-primary) !important;
    }

    jdp-container .jdp-day-name {
        color: #9ca3af !important; /* gray-400 */
    }

    jdp-container .jdp-day:hover {
        background-color: var(--bg-card-hover) !important;
        border-radius: 4px !important;
    }

    jdp-container .jdp-day.selected {
        background-color: var(--primary) !important;
        color: white !important;
        border-radius: 4px !important;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.4) !important;
    }
    
    jdp-container .jdp-day.today {
        border: 1px solid var(--primary) !important;
        border-radius: 4px !important;
    }

    #edit-client-expiry {
        font-family: 'Vazirmatn', sans-serif !important;
    }
</style>
<div class="modal-overlay hidden" id="delete-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Delete Client</h2>
            <button class="modal-close" onclick="closeDeleteClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="delete-client-server-id">
            <input type="hidden" id="delete-client-inbound-id">
            <input type="hidden" id="delete-client-email-hidden">
            
            <div class="alert alert-danger" style="margin-bottom: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 15px; border-radius: 8px;">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <strong>Warning: This action cannot be undone!</strong>
                </div>
                <p>You are about to delete the following client:</p>
            </div>

            <div class="client-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                <div style="grid-column: span 2;">
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Email / Subscription</label>
                    <div id="delete-client-email" style="font-weight: bold; font-size: 1.1rem; color: var(--text-primary);"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Status</label>
                    <div id="delete-client-status"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Expiry</label>
                    <div id="delete-client-expiry"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Traffic (Up/Down)</label>
                    <div id="delete-client-traffic"></div>
                </div>
                
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Volume (Used/Total)</label>
                    <div id="delete-client-volume"></div>
                </div>
                
                <div style="grid-column: span 2;">
                    <label style="color: var(--text-secondary); font-size: 0.85rem;">Client ID (UUID)</label>
                    <div id="delete-client-uuid" style="font-family: monospace; font-size: 0.9rem; word-break: break-all;"></div>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeDeleteClientModal()">Cancel</button>
                <button class="btn btn-danger" onclick="submitDeleteClient()">Delete Client</button>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
    let autoRefreshInterval = null;
    let currentLink = '';
    let inboundsData = [];
    let allInboundsData = [];
    let pendingServers = [];
    let serverStatuses = []; // /api/refresh -> servers (status list)
    let refreshController = null;
    const serverRefreshControllers = new Map(); // serverId -> AbortController
    let activeRefreshJobId = null;
    let refreshJobPollTimer = null;
    const refreshJobContext = new Map(); // jobId -> { serverId?: number|null }
    const postActionRefreshState = new Map(); // serverId -> { nextAllowedAt:number, timer:number|null }

    const selectedExpiryFilters = new Set(); // not_started | unlimited | expired | today | lt_days
    const expandedInboundKeys = new Set(); // `${server_id}:${inbound_id}` -> expanded client list
    let expiryLessThanDays = 7;
    let disabledOnlyClients = false;

    // Persist bulk selections across refresh/re-render
    const bulkSelectedClientKeys = new Set(); // key = `${server_id}:${inbound_id}:${emailLower}`

    const IS_SUPERADMIN = {{ 'true' if is_superadmin else 'false' }};
    const USER_ROLE = "{{ role }}";
        function escapeHtml(value) {
            const s = String(value ?? '');
            return s
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getOwnerText(client) {
            if (typeof USER_ROLE !== 'undefined' && USER_ROLE === 'reseller') {
                return 'You';
            }
            if (!client) return '';
            const ownerName = (client.owner_username || '').trim();
            return ownerName ? ownerName : 'System';
        }

        function renderOwnerCell(client) {
            return `<span style="font-size: 0.85rem; color: var(--text-secondary);">${escapeHtml(getOwnerText(client))}</span>`;
        }
    let selectedPackageId = null;
    let selectedRenewPackageId = null;
    let selectedRenewPackageDays = 0;
    let selectedRenewPackageVolume = 0;
    let selectedRenewPackageName = '';
    let currentClientExpiryText = '';
    let currentClientRemainingVolume = '';
    const BASE_COST_DAY = {{ base_cost_day|default(0) }};
    const BASE_COST_GB = {{ base_cost_gb|default(0) }};

    function showDashboardSkeleton(count = 3) {
        const container = document.getElementById('inbounds-container');
        if (!container) return;

        const n = Math.max(1, Math.min(8, parseInt(count) || 3));
        container.innerHTML = Array.from({ length: n }).map(() => `
            <div class="inbound-card dashboard-skeleton-card">
                <div class="inbound-header">
                    <div class="inbound-title" style="gap: 10px; align-items: center;">
                        <div class="skeleton skeleton-pill" style="width: 64px;"></div>
                        <div class="skeleton skeleton-line" style="width: 180px; height: 16px;"></div>
                        <div class="skeleton skeleton-pill" style="width: 56px;"></div>
                        <div class="skeleton skeleton-pill" style="width: 96px;"></div>
                    </div>
                    <div class="inbound-status">
                        <div class="skeleton skeleton-pill" style="width: 78px; height: 26px;"></div>
                    </div>
                </div>
                <div class="inbound-meta-compact" style="gap: 10px;">
                    <div class="skeleton skeleton-pill" style="width: 120px; height: 18px;"></div>
                    <div class="skeleton skeleton-pill" style="width: 110px; height: 18px;"></div>
                    <div class="skeleton skeleton-pill" style="width: 90px; height: 18px;"></div>
                    <div class="skeleton skeleton-pill" style="width: 160px; height: 18px;"></div>
                </div>
            </div>
        `).join('');
    }

    function shamsiToGregorian(shamsiStr) {
        if (!shamsiStr) return null;
        try {
            const parts = shamsiStr.split(/[\s\/:-]+/);
            if (parts.length < 3) return null;
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);
            const hour = parts.length > 3 ? parseInt(parts[3]) : 0;
            const minute = parts.length > 4 ? parseInt(parts[4]) : 0;
            
            if (typeof persianDate !== 'undefined') {
                const pDate = new persianDate([year, month, day, hour, minute]);
                return pDate.toDate().toISOString();
            }
            return null;
        } catch (e) {
            console.error('Date conversion error:', e);
            return null;
        }
    }

    function toEnglishDigits(str) {
        if (!str) return str;
        return str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
    }

    function initShamsiPicker() {
        if (typeof jalaliDatepicker !== 'undefined') {
            jalaliDatepicker.startWatch({
                time: true,
                hasSecond: false,
                zIndex: 99999
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        initShamsiPicker();
        // Prefer skeleton placeholders over a blocking spinner overlay.
        showDashboardSkeleton();
        updateExpiryFilterLabel();
        updateExpiryFilterCount();
        syncExpiryFilterCheckboxes();
        // Load servers first to know if we have any
        loadServers().then(() => {
            // Kick off a background refresh (non-blocking) and render cached data immediately.
            refreshData(true, { mode: 'full', poll: true }).finally(() => hideLoading());
        });
        document.getElementById('global-search-input').addEventListener('input', () => performGlobalSearch(false));
        if (IS_SUPERADMIN) {
            loadResellersForModal();
            loadResellersForBulk();
        }
        onBulkActionChanged();
    });

    function toggleAutoRefresh() {
        const toggle = document.getElementById('auto-refresh-toggle');
        
        if (toggle.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    }

    function updateRefreshInterval() {
        if (document.getElementById('auto-refresh-toggle').checked) {
            startAutoRefresh();
        }
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        const interval = parseInt(document.getElementById('refresh-interval').value) * 1000;
        // Auto refresh should be lightweight: fetch cached payload only.
        autoRefreshInterval = setInterval(() => refreshData(true, { mode: 'cache', poll: false }), interval);
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    function isSearchActive() {
        const searchInput = document.getElementById('global-search-input');
        return Boolean(searchInput && searchInput.value.trim().length > 0);
    }

    function queueSilentServerRefresh(serverId, cooldownMs = 1200) {
        const key = (serverId !== undefined && serverId !== null && serverId !== '') ? String(serverId) : '__all__';
        const now = Date.now();

        const existing = postActionRefreshState.get(key) || { nextAllowedAt: 0, timer: null };
        const run = () => {
            if (serverId !== undefined && serverId !== null && serverId !== '') {
                refreshServerData(serverId, { mode: 'full', force: true, poll: true, enqueue: true });
            } else {
                refreshData(true, { mode: 'full', force: true, poll: true, serverId: null });
            }
        };

        if (now >= existing.nextAllowedAt) {
            if (existing.timer) {
                clearTimeout(existing.timer);
                existing.timer = null;
            }
            existing.nextAllowedAt = now + cooldownMs;
            postActionRefreshState.set(key, existing);
            run();
            return;
        }

        const delay = Math.max(0, existing.nextAllowedAt - now);
        if (existing.timer) clearTimeout(existing.timer);
        existing.timer = setTimeout(() => {
            const cur = postActionRefreshState.get(key) || existing;
            cur.timer = null;
            cur.nextAllowedAt = Date.now() + cooldownMs;
            postActionRefreshState.set(key, cur);
            run();
        }, delay);
        postActionRefreshState.set(key, existing);
    }

    function makeBulkClientKey(serverId, inboundId, email) {
        const sid = parseInt(serverId);
        const iid = parseInt(inboundId);
        const em = String(email || '').trim().toLowerCase();
        return `${sid}:${iid}:${em}`;
    }

    function applyBulkSelectionToDOM() {
        const boxes = Array.from(document.querySelectorAll('.client-bulk-checkbox'));
        const byInbound = new Map();

        boxes.forEach(cb => {
            const key = makeBulkClientKey(cb.dataset.serverId, cb.dataset.inboundId, cb.dataset.email);
            cb.checked = bulkSelectedClientKeys.has(key);
            const inboundKey = cb.dataset.inboundKey;
            if (!byInbound.has(inboundKey)) byInbound.set(inboundKey, []);
            byInbound.get(inboundKey).push(cb);
        });

        // Update each inbound's select-all checkbox based on children
        document.querySelectorAll('.select-all-clients').forEach(sa => {
            const onChangeAttr = sa.getAttribute('onchange') || '';
            const match = onChangeAttr.match(/toggleSelectAllClients\('([^']+)'/);
            const inboundKey = match ? match[1] : null;
            if (!inboundKey || !byInbound.has(inboundKey)) {
                sa.checked = false;
                return;
            }
            const children = byInbound.get(inboundKey);
            sa.checked = children.length > 0 && children.every(cb => cb.checked);
        });
    }

    function mergeServerInboundsIntoCache(serverId, serverInbounds) {
        const sid = parseInt(serverId);
        if (!Number.isFinite(sid)) return;
        const newBlock = Array.isArray(serverInbounds) ? serverInbounds : [];

        const merge = (arr) => {
            const list = Array.isArray(arr) ? arr : [];
            const firstIdx = list.findIndex(x => parseInt(x?.server_id) === sid);
            const without = list.filter(x => parseInt(x?.server_id) !== sid);
            if (firstIdx < 0) return without.concat(newBlock);
            const insertAt = Math.min(Math.max(firstIdx, 0), without.length);
            return without.slice(0, insertAt).concat(newBlock, without.slice(insertAt));
        };

        allInboundsData = merge(allInboundsData);
    }

    function patchLocalClient(serverId, inboundId, email, patch) {
        const sid = parseInt(serverId);
        const iid = String(inboundId);
        const em = String(email || '').toLowerCase();
        if (!Number.isFinite(sid) || !iid || !em) return false;

        let changed = false;
        for (const inbound of (allInboundsData || [])) {
            if (parseInt(inbound?.server_id) !== sid) continue;
            if (String(inbound?.id) !== iid) continue;
            const clients = Array.isArray(inbound.clients) ? inbound.clients : [];
            const client = clients.find(c => String(c?.email || '').toLowerCase() === em);
            if (!client) continue;

            if (patch && Object.prototype.hasOwnProperty.call(patch, 'enable')) {
                client.enable = Boolean(patch.enable);
                changed = true;
            }
            if (patch && Object.prototype.hasOwnProperty.call(patch, 'up')) {
                const upVal = Number(patch.up) || 0;
                client.up = upVal;
                client.up_formatted = formatBytes(upVal);
                changed = true;
            }
            if (patch && Object.prototype.hasOwnProperty.call(patch, 'down')) {
                const downVal = Number(patch.down) || 0;
                client.down = downVal;
                client.down_formatted = formatBytes(downVal);
                changed = true;
            }
            // Support addDays: add days to current expiry (optimistic)
            if (patch && Object.prototype.hasOwnProperty.call(patch, 'addDays')) {
                const daysToAdd = parseInt(patch.addDays) || 0;
                if (daysToAdd > 0) {
                    let currentExp = parseInt(client.expiryTimestamp) || 0;
                    if (currentExp < 0) {
                        // Not started: add to pending
                        currentExp = currentExp - (daysToAdd * 86400000);
                    } else if (currentExp > 0) {
                        currentExp = currentExp + (daysToAdd * 86400000);
                    } else {
                        // Unlimited (0): set to now + days
                        currentExp = Date.now() + (daysToAdd * 86400000);
                    }
                    client.expiryTimestamp = currentExp;
                    client.expiryTime = _formatExpiryForDisplay(currentExp);
                    client.expiryType = _getExpiryType(currentExp);
                    changed = true;
                }
            }
            // Support addVolumeGB: add GB to current totalGB cap (optimistic)
            if (patch && Object.prototype.hasOwnProperty.call(patch, 'addVolumeGB')) {
                const gbToAdd = parseInt(patch.addVolumeGB) || 0;
                if (gbToAdd > 0) {
                    let currentTotalBytes = parseInt(client.totalGB) || 0;
                    if (currentTotalBytes > 0) {
                        currentTotalBytes = currentTotalBytes + (gbToAdd * 1024 * 1024 * 1024);
                        client.totalGB = currentTotalBytes;
                        client.totalGB_formatted = _formatGBForDisplay(currentTotalBytes);
                        // Recalculate remaining
                        const usedBytes = (parseInt(client.up) || 0) + (parseInt(client.down) || 0);
                        const remainingBytes = Math.max(0, currentTotalBytes - usedBytes);
                        client.remaining_formatted = _formatGBForDisplay(remainingBytes);
                        changed = true;
                    }
                    // If unlimited (0), stays unlimited
                }
            }
            break;
        }

        if (changed) {
            applyFilters();
            const searchInput = document.getElementById('global-search-input');
            if (searchInput && searchInput.value.trim().length > 0) {
                performGlobalSearch(true);
            }
        }
        return changed;
    }

    // Helper: format expiryTimestamp (ms) to display string
    function _formatExpiryForDisplay(ts) {
        if (ts === 0) return 'Unlimited';
        if (ts < 0) {
            const days = Math.abs(ts) / 86400000;
            return `Not started (${Math.round(days)} days)`;
        }
        const now = Date.now();
        if (ts < now) {
            const daysAgo = Math.floor((now - ts) / 86400000);
            return `Expired (${daysAgo}d ago)`;
        }
        const daysLeft = Math.ceil((ts - now) / 86400000);
        if (daysLeft === 0) return 'Today';
        return `${daysLeft} days left`;
    }

    // Helper: get expiry type from timestamp
    function _getExpiryType(ts) {
        if (ts === 0) return 'unlimited';
        if (ts < 0) return 'start_after_use';
        const now = Date.now();
        if (ts < now) return 'expired';
        const daysLeft = Math.ceil((ts - now) / 86400000);
        if (daysLeft === 0) return 'today';
        if (daysLeft < 7) return 'soon';
        return 'normal';
    }

    // Helper: format bytes to GB display
    function _formatGBForDisplay(bytes) {
        if (!bytes || bytes <= 0) return 'Unlimited';
        const gb = bytes / (1024 * 1024 * 1024);
        if (gb >= 1024) {
            return `${(gb / 1024).toFixed(2)} TB`;
        }
        return `${gb.toFixed(2)} GB`;
    }

    // Remove a client from local data (optimistic delete)
    function removeLocalClient(serverId, inboundId, email) {
        const sid = parseInt(serverId);
        const iid = String(inboundId);
        const em = String(email || '').toLowerCase();
        if (!Number.isFinite(sid) || !iid || !em) return false;

        let changed = false;
        for (const inbound of (allInboundsData || [])) {
            if (parseInt(inbound?.server_id) !== sid) continue;
            if (String(inbound?.id) !== iid) continue;
            if (!Array.isArray(inbound.clients)) continue;
            const idx = inbound.clients.findIndex(c => String(c?.email || '').toLowerCase() === em);
            if (idx >= 0) {
                inbound.clients.splice(idx, 1);
                inbound.client_count = inbound.clients.length;
                changed = true;
            }
            break;
        }

        if (changed) {
            applyFilters();
            const searchInput = document.getElementById('global-search-input');
            if (searchInput && searchInput.value.trim().length > 0) {
                performGlobalSearch(true);
            }
        }
        return changed;
    }

    async function refreshServerData(serverId, options = {}) {
        const sid = parseInt(serverId);
        if (!Number.isFinite(sid)) return;

        const force = Boolean(options && options.force);
        const poll = (options && options.poll !== undefined) ? Boolean(options.poll) : true;
        const mode = (options && options.mode) ? String(options.mode) : 'cache';
        const enqueue = (options && options.enqueue !== undefined) ? Boolean(options.enqueue) : (mode !== 'cache');

        // Abort previous server refresh for the same server
        const prev = serverRefreshControllers.get(String(sid));
        if (prev) {
            try { prev.abort(); } catch (e) {}
        }
        const controller = new AbortController();
        serverRefreshControllers.set(String(sid), controller);

        try {
            const params = new URLSearchParams();
            if (force) params.set('force', '1');
            params.set('mode', mode);
            if (enqueue) params.set('enqueue', '1');
            const qs = params.toString() ? `?${params.toString()}` : '';
            const resp = await fetch(`/api/server/${sid}/refresh${qs}`, { signal: controller.signal });
            const data = await resp.json();

            if (data && data.success) {
                mergeServerInboundsIntoCache(sid, data.inbounds || []);

                // Keep per-server status/errors in sync for empty/error rendering.
                if (data.server_status && typeof data.server_status === 'object') {
                    const st = data.server_status;
                    const stId = parseInt(st.server_id ?? data.server_id);
                    if (Number.isFinite(stId)) {
                        const list = Array.isArray(serverStatuses) ? serverStatuses : [];
                        const idx = list.findIndex(x => parseInt(x?.server_id) === stId);
                        if (idx >= 0) {
                            list[idx] = Object.assign({}, list[idx], st);
                            serverStatuses = list;
                        } else {
                            serverStatuses = list.concat([st]);
                        }
                    }
                }

                updateStats(data.stats || {}, data.server_count || (allServers ? allServers.length : 0));
                applyFilters();

                const searchInput = document.getElementById('global-search-input');
                if (searchInput && searchInput.value.trim().length > 0) {
                    performGlobalSearch(true);
                }

                const jobId = data.refresh_job && data.refresh_job.id;
                const jobState = data.refresh_job && data.refresh_job.state;
                if (jobId && poll) {
                    refreshJobContext.set(jobId, { serverId: sid });
                    startRefreshJobPolling(jobId, { showErrors: false, serverId: sid });
                }

                // If this is a foreground refresh, give feedback
                if (!options.isSilent) {
                    if (jobId && (jobState === 'queued' || jobState === 'running')) {
                        showToast('Refresh started');
                    }
                }
            }
        } catch (e) {
            if (e && e.name === 'AbortError') return;
        } finally {
            const cur = serverRefreshControllers.get(String(sid));
            if (cur === controller) serverRefreshControllers.delete(String(sid));
        }
    }

    function stopRefreshJobPolling() {
        activeRefreshJobId = null;
        if (refreshJobPollTimer) {
            clearTimeout(refreshJobPollTimer);
            refreshJobPollTimer = null;
        }
    }

    function startRefreshJobPolling(jobId, { showErrors = false, serverId = null } = {}) {
        if (!jobId) return;
        if (activeRefreshJobId === jobId) return;
        activeRefreshJobId = jobId;

        if (refreshJobPollTimer) {
            clearTimeout(refreshJobPollTimer);
            refreshJobPollTimer = null;
        }

        const pollOnce = async () => {
            if (!activeRefreshJobId) return;
            try {
                const resp = await fetch(`/api/refresh/job/${encodeURIComponent(activeRefreshJobId)}`);
                const payload = await resp.json();
                if (!payload || !payload.success || !payload.job) {
                    throw new Error(payload?.error || 'Failed to poll refresh job');
                }

                const state = payload.job.state;
                if (state === 'done') {
                    const doneId = activeRefreshJobId;
                    stopRefreshJobPolling();
                    // Pull latest cached snapshot after refresh completes.
                    const ctx = refreshJobContext.get(doneId) || {};
                    const sid = (serverId !== null && serverId !== undefined) ? serverId : (ctx.serverId ?? null);
                    if (sid !== null && sid !== undefined) {
                        await refreshServerData(sid, { mode: 'cache', enqueue: false, poll: false });
                    } else {
                        await refreshData(true, { mode: 'cache', poll: false });
                    }
                    refreshJobContext.delete(doneId);
                    return;
                }

                if (state === 'error') {
                    const err = payload.job.error || 'Refresh failed';
                    stopRefreshJobPolling();
                    if (showErrors) showToast(err, 'error');
                    refreshJobContext.delete(jobId);
                    return;
                }
            } catch (e) {
                // Keep polling; network hiccups shouldn't break the UI.
            }

            refreshJobPollTimer = setTimeout(pollOnce, 900);
        };

        pollOnce();
    }

    async function refreshData(isSilent = false, options = {}) {
        const refreshBtn = document.querySelector('.header-controls .btn-primary');

        const force = Boolean(options && options.force);
        const serverId = (options && (options.serverId !== undefined)) ? options.serverId : null;
        const poll = (options && options.poll !== undefined) ? Boolean(options.poll) : true;
        const mode = (options && options.mode) ? String(options.mode) : (isSilent ? 'cache' : 'full');
        const enqueue = (options && options.enqueue !== undefined) ? Boolean(options.enqueue) : (mode !== 'cache');
        
        // Cancel previous request if it exists
        if (refreshController) {
            refreshController.abort();
        }
        refreshController = new AbortController();
        const signal = refreshController.signal;

        if (!isSilent) {
            if (refreshBtn) {
                if (!refreshBtn.dataset.originalContent) {
                    refreshBtn.dataset.originalContent = refreshBtn.innerHTML;
                }
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; border-color: rgba(255,255,255,0.2); border-top-color: white;"></div> Refreshing';
            } else {
                showDashboardSkeleton();
            }
        }
        
        try {
            const params = new URLSearchParams();
            if (force) params.set('force', '1');
            if (mode) params.set('mode', mode);
            if (enqueue) params.set('enqueue', '1');
            if (serverId !== null && serverId !== '' && serverId !== undefined) params.set('server_id', String(serverId));
            const qs = params.toString() ? `?${params.toString()}` : '';
            const response = await fetch(`/api/refresh${qs}`, { signal });
            const data = await response.json();
            
            if (data.success) {
                allInboundsData = data.inbounds;
                inboundsData = data.inbounds;
                serverStatuses = data.servers || [];
                
                // Clear pending servers since we have full data
                pendingServers = [];

                updateStats(data.stats, data.servers ? data.servers.length : 0);
                applyFilters();

                const jobId = data.refresh_job && data.refresh_job.id;
                const jobState = data.refresh_job && data.refresh_job.state;
                if (jobId && poll) {
                    startRefreshJobPolling(jobId, { showErrors: !isSilent });
                }

                if (!isSilent) {
                    if (jobId && (jobState === 'queued' || jobState === 'running')) {
                        showToast('Refresh started');
                    } else {
                        showToast('Data updated successfully');
                    }
                }
                
                // If there is an active search, re-run it
                const searchInput = document.getElementById('global-search-input');
                if (searchInput && searchInput.value.trim().length > 0) {
                    // Re-run search immediately after refresh (no debounce)
                    performGlobalSearch(true);
                }
            } else {
                if (!isSilent) showToast(data.error || 'Error updating data', 'error');
                handleRefreshError();
            }
        } catch (error) {
            if (error.name === 'AbortError') return;
            console.error('Refresh error:', error);
            if (!isSilent) showToast('Error updating: ' + error.message, 'error');
            handleRefreshError();
        } finally {
            if (!isSilent) {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = refreshBtn.dataset.originalContent;
                } else {
                    hideLoading();
                }
            }
            hideLoading();
            refreshController = null;
        }
    }

    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    function handleRefreshError() {
        // If we have servers but failed to load data, show error state instead of "No servers added"
        if (allServers && allServers.length > 0) {
            const container = document.getElementById('inbounds-container');
            // Only replace if it's currently showing the empty state or nothing
            if (container.querySelector('.empty-state') || container.querySelector('.dashboard-skeleton-card') || container.innerHTML.trim() === '') {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <h3>Connection Error</h3>
                        <p>Failed to load data from servers. Please check your connection and try again.</p>
                        <button class="btn btn-primary" onclick="refreshData()">Try Again</button>
                    </div>`;
            }
        }
    }

    function updateStats(stats, serverCount) {
        document.getElementById('stat-servers').textContent = serverCount || 0;
        document.getElementById('stat-inbounds').textContent = stats?.total_inbounds || 0;
        document.getElementById('stat-active').textContent = `${stats?.active_inbounds || 0} Active`;
        document.getElementById('stat-total-clients').textContent = stats?.total_clients || 0;
        const onlineEl = document.getElementById('stat-online-clients');
        if (onlineEl) onlineEl.textContent = stats?.online_clients || 0;
        document.getElementById('stat-active-clients').textContent = stats?.active_clients || 0;
        document.getElementById('stat-inactive-clients').textContent = stats?.inactive_clients || 0;
        const notStartedEl = document.getElementById('stat-not-started-clients');
        if (notStartedEl) notStartedEl.textContent = stats?.not_started_clients || 0;
        const unExpEl = document.getElementById('stat-unlimited-expiry-clients');
        if (unExpEl) unExpEl.textContent = stats?.unlimited_expiry_clients || 0;
        const unVolEl = document.getElementById('stat-unlimited-volume-clients');
        if (unVolEl) unVolEl.textContent = stats?.unlimited_volume_clients || 0;
        document.getElementById('stat-traffic').textContent = stats?.total_traffic || '0 B';
        document.getElementById('stat-upload').textContent = `↑ ${stats?.total_upload || '0 B'}`;
        document.getElementById('stat-download').textContent = `↓ ${stats?.total_download || '0 B'}`;
    }

    function getExpiryClass(type) {
        switch(type) {
            case 'expired': return 'expiry-expired';
            case 'today': return 'expiry-today';
            case 'soon': return 'expiry-soon';
            case 'start_after_use': return 'expiry-start-after';
            case 'unlimited': return 'expiry-start-after';
            default: return '';
        }
    }

    function updateInbounds(inbounds) {
        const container = document.getElementById('inbounds-container');
        const countEl = document.getElementById('inbounds-count');
        if (countEl) countEl.textContent = `${inbounds.length} inbounds`;
        
        let html = '';

        if (inbounds.length === 0 && (!pendingServers || pendingServers.length === 0)) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                    </svg>
                    <h3>No servers added</h3>
                    <p>Add your X-UI server to see statistics.</p>
                    <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
                </div>`;
            return;
        }
        
        html += inbounds.map(inbound => {
            const inboundKey = `${inbound.server_id}:${inbound.id}`;
            const isExpanded = expandedInboundKeys.has(inboundKey);
            const toggleCount = inbound.clients.length;
            return `
            <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                <div class="inbound-header">
                    <div class="inbound-title">
                        <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                        <h3>${inbound.remark}</h3>
                        <span class="port-badge">:${inbound.port}</span>
                        <span class="server-badge">${inbound.server_name}</span>
                    </div>
                    <div class="inbound-status">
                        ${inbound.enable 
                            ? `<span class="status-pill active">Active</span>` 
                            : `<span class="status-pill inactive">Inactive</span>`}
                    </div>
                </div>
                
                <div class="inbound-meta-compact">
                    <span class="meta-tag"><span class="label">Network:</span> <span class="value">${inbound.network}</span></span>
                    <span class="meta-tag"><span class="label">Security:</span> <span class="value">${inbound.security}</span></span>
                    <span class="meta-tag"><span class="label">Clients:</span> <span class="value">${inbound.client_count}</span></span>
                    <span class="meta-tag traffic"><span class="label">Traffic:</span> <span class="up">↑${inbound.total_up}</span> <span class="down">↓${inbound.total_down}</span></span>
                </div>

                ${inbound.clients.length > 0 ? `
                <div class="clients-section">
                    <button class="toggle-clients" data-inbound-key="${inboundKey}" onclick="toggleClients(this, event)">
                        ${isExpanded
                            ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg> Hide Clients (${toggleCount})`
                            : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg> Show Clients (${toggleCount})`}
                    </button>
                    <div class="clients-list ${isExpanded ? '' : 'hidden'}">
                        <div class="clients-table-wrapper">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th style="width: 34px;">
                                            <label class="checkbox-label" style="padding-left: 0; width: 20px; height: 20px; margin: 0 auto;">
                                                <input type="checkbox" class="select-all-clients" onchange="toggleSelectAllClients('${inboundKey}', this.checked)">
                                                <span class="checkmark"></span>
                                            </label>
                                        </th>
                                        <th>Email</th>
                                        <th>Owner</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Traffic</th>
                                        <th>Volume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td class="select-cell">
                                            <label class="checkbox-label" style="padding-left: 0; width: 20px; height: 20px; margin: 0 auto;">
                                                <input type="checkbox" class="client-bulk-checkbox" data-inbound-key="${inboundKey}" data-server-id="${client.server_id}" data-inbound-id="${client.inbound_id}" data-email="${client.email}" data-client-uuid="${client.id || ''}" onchange="onBulkClientCheckboxChanged(this)">
                                                <span class="checkmark"></span>
                                            </label>
                                        </td>
                                        <td class="email-cell"><span class="email-with-online">${client.is_online ? '<span class="online-pulse" title="Online"></span>' : ''}<span class="email-text">${client.email}</span></span></td>
                                        <td class="owner-cell">${renderOwnerCell(client)}</td>
                                        <td>
                                            ${client.enable 
                                                ? `<span class="client-status active">Enabled</span>` 
                                                : `<span class="client-status inactive">Disabled</span>`}
                                        </td>
                                        <td>
                                            <span class="expiry-badge ${getExpiryClass(client.expiryType)}">
                                                <span class="expiry-time">${client.expiryTime}</span>
                                                ${client.expiryTimestamp ? `<span class=\"expiry-time\">${formatTehranTime(client.expiryTimestamp)}</span>` : ''}
                                            </span>
                                        </td>
                                        <td class="traffic-cell">
                                            <div class="traffic-combined-cell">
                                                <span class="up">↑ ${client.up_formatted}</span>
                                                <span class="down">↓ ${client.down_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="volume-cell">
                                            <div class="volume-info">
                                                <span class="remaining ${client.volume_status || ''}">${client.remaining_formatted}</span>
                                                <span class="total ${client.totalGB_formatted === 'Unlimited' ? 'expiry-start-after' : ''}">/ ${client.totalGB_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}', '${client.sub_url || ''}', '${client.json_url || ''}', '${client.dash_sub_url || ''}', ${client.server_id}, '${client.subId || client.id || ''}')" title="QR Code">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="14" width="7" height="7"></rect>
                                                        <rect x="3" y="14" width="7" height="7"></rect>
                                                    </svg>
                                                </button>
                                                <button class="action-btn renew" onclick="openRenewModal(${client.server_id}, '${client.inbound_id}', '${client.email}', '${client.volume_status || ''}', '${client.remaining_formatted || ''}', '${client.totalGB_formatted || ''}', '${client.expiryType || ''}', '${client.expiryTime || ''}', ${client.expiryTimestamp || 0})" title="Renew">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${client.server_id}, '${client.inbound_id}', '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="openResetModal(${client.server_id}, '${client.inbound_id}', '${client.email}', ${client.totalGB || 0})" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                                <button class="action-btn" onclick="openEditClientModal(${client.server_id}, '${client.inbound_id}', '${client.email}', ${client.totalGB || 0}, ${client.expiryTimestamp || 0})" title="Edit Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                    </svg>
                                                </button>
                                                ${IS_SUPERADMIN ? `<button class="action-btn" onclick="openAssignModal(${client.server_id}, '${client.email}', '${client.inbound_id}', '${client.id || ''}')" title="Assign Owner">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                        <circle cx="10" cy="7" r="4"></circle>
                                                        <path d="M22 11h-2.5a2.5 2.5 0 0 0 0 5H22"></path>
                                                    </svg>
                                                </button>` : ''}
                                                <button class="action-btn danger" onclick="openDeleteClientModal(${client.server_id}, '${client.inbound_id}', '${client.email}', '${client.id}', ${client.enable}, '${client.expiryTime}', ${client.expiryTimestamp || 0}, '${client.up}', '${client.down}', '${client.totalGB_formatted}', '${client.remaining_formatted}')" title="Delete Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        }).join('');

        // Add per-server empty/error cards for servers whose inbounds didn't load.
        try {
            const searchActive = (typeof isSearchActive === 'function') ? isSearchActive() : false;
            if (!searchActive) {
                const presentServerIds = new Set();
                for (const ib of (inbounds || [])) {
                    const sid = parseInt(ib?.server_id);
                    if (Number.isFinite(sid)) presentServerIds.add(sid);
                }

                const statuses = Array.isArray(serverStatuses) ? serverStatuses : [];
                const statusMap = new Map();
                statuses.forEach(st => {
                    const sid = parseInt(st?.server_id);
                    if (Number.isFinite(sid)) statusMap.set(sid, st);
                });

                const visibleSelected = (typeof selectedServerIds !== 'undefined' && selectedServerIds && selectedServerIds.size > 0)
                    ? new Set(Array.from(selectedServerIds).map(x => parseInt(x)).filter(Number.isFinite))
                    : null;

                const serversList = Array.isArray(allServers) ? allServers : [];
                const missingServers = serversList.filter(s => {
                    const sid = parseInt(s?.id);
                    if (!Number.isFinite(sid)) return false;
                    if (visibleSelected && !visibleSelected.has(sid)) return false;
                    return !presentServerIds.has(sid);
                });

                if (missingServers.length > 0) {
                    let errorServers = 0;
                    missingServers.forEach(s => {
                        const sid = parseInt(s?.id);
                        const st = statusMap.get(sid) || {};
                        const isErr = Boolean(st && (st.error || st.success === false || st.reachable === false || st.reachable_error));
                        if (isErr) errorServers += 1;
                    });

                    if (countEl) {
                        const extra = errorServers > 0
                            ? ` • ${errorServers} server error`
                            : ` • ${missingServers.length} server empty`;
                        countEl.textContent = `${inbounds.length} inbounds${extra}`;
                    }

                    html += missingServers.map(s => {
                        const sid = parseInt(s?.id);
                        const st = statusMap.get(sid) || {};
                        const ok = (st && (st.success === true || st.reachable === true)) && !st.error;
                        const isErr = !ok && Boolean(st && (st.error || st.success === false || st.reachable === false || st.reachable_error));
                        const title = isErr ? 'Inbounds not loaded' : 'No inbounds found';
                        const reason = isErr
                            ? (st.error || st.reachable_error || 'Failed to fetch inbounds from panel')
                            : 'This server returned zero inbounds.';
                        const pill = isErr
                            ? `<span class="status-pill inactive" style="background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.28); color: #fecaca;">Error</span>`
                            : `<span class="status-pill inactive">Empty</span>`;
                        const panelType = (s?.panel_type || st?.panel_type || '') ? escapeHtml(String(s?.panel_type || st?.panel_type)) : '';

                        return `
                        <div class="inbound-card" style="border-style: dashed; opacity: 0.95;">
                            <div class="inbound-header">
                                <div class="inbound-title">
                                    <span class="protocol-badge" style="background: rgba(148,163,184,0.14); color: rgba(226,232,240,0.9);">${isErr ? 'ERROR' : 'EMPTY'}</span>
                                    <h3>${escapeHtml(s?.name || ('Server #' + sid))}</h3>
                                    ${panelType ? `<span class="port-badge">${panelType}</span>` : ''}
                                    <span class="server-badge">#${sid}</span>
                                </div>
                                <div class="inbound-status">${pill}</div>
                            </div>
                            <div class="inbound-meta-compact" style="align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span class="meta-tag" style="min-width: 220px; max-width: 100%;">
                                    <span class="label">${escapeHtml(title)}:</span>
                                    <span class="value" style="opacity: 0.9;">${escapeHtml(String(reason))}</span>
                                </span>
                                <button class="btn btn-secondary" style="padding: 6px 10px;" onclick="refreshServerData(${sid}, { mode: 'full', force: true, poll: true, enqueue: true })">Retry</button>
                            </div>
                        </div>`;
                    }).join('');
                }
            }
        } catch (e) {
            // UI-only best-effort
        }

        // Add placeholders for pending servers
        if (typeof pendingServers !== 'undefined' && pendingServers.length > 0) {
             html += pendingServers.map(s => `
                <div class="inbound-card loading-placeholder" style="opacity: 0.7; border-style: dashed;">
                    <div class="inbound-header">
                        <div class="inbound-title">
                            <div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin-right: 10px;"></div>
                            <h3>Loading ${s.name}...</h3>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        container.innerHTML = html;
        applyBulkSelectionToDOM();
        updateBulkUI();
    }

    function toggleClients(btn, ev) {
        if (ev) {
            ev.preventDefault();
            ev.stopPropagation();
        }
        const clientsList = btn.nextElementSibling;
        const isHidden = clientsList.classList.contains('hidden');
        clientsList.classList.toggle('hidden');

        const inboundKey = btn && btn.dataset ? btn.dataset.inboundKey : null;
        if (inboundKey) {
            if (isHidden) {
                expandedInboundKeys.add(inboundKey);
            } else {
                expandedInboundKeys.delete(inboundKey);
            }
        }
        
        const count = clientsList.querySelectorAll('tbody tr').length;
        btn.innerHTML = isHidden 
            ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg> Hide Clients (${count})`
            : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg> Show Clients (${count})`;
    }

    function bytesToGB(bytes) {
        if (!bytes || bytes <= 0) return 0;
        return Math.max(1, Math.round(bytes / (1024 * 1024 * 1024)));
    }

    function formatVolumeLabel(bytes) {
        if (!bytes || bytes <= 0) return 'Unlimited / Not Set';
        const gb = bytes / (1024 * 1024 * 1024);
        return `${Number.isInteger(gb) ? gb : gb.toFixed(1)} GB`;
    }

    async function showQrCode(encodedLink, email, subUrl, jsonUrl, dashSubUrl, serverId, subId) {
        let link = decodeURIComponent(encodedLink);
        document.getElementById('qr-email').textContent = email;
        document.getElementById('title-config').textContent = email;
        
        document.getElementById('input-sub').value = subUrl || '';
        document.getElementById('input-json').value = jsonUrl || '';
        
        // Fix relative URL for dashSubUrl if needed
        let finalDashUrl = dashSubUrl || '';
        if (finalDashUrl && finalDashUrl.startsWith('/')) {
            finalDashUrl = window.location.origin + finalDashUrl;
        }
        document.getElementById('input-dash').value = finalDashUrl;
        
        try {
            // Fetch direct link from panel subscription if serverId and subId are provided
            if (serverId && subId) {
                try {
                    const directLinkResp = await fetch(`/api/client/direct-link/${serverId}/${encodeURIComponent(subId)}`);
                    const directLinkData = await directLinkResp.json();
                    if (directLinkData.success && directLinkData.direct_link) {
                        link = directLinkData.direct_link;
                    }
                } catch (e) {
                    console.warn('Failed to fetch direct link from panel:', e);
                }
            }
            
            document.getElementById('input-config').value = link || '';
            
            // Generate Config QR
            if (link) {
                const configResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(link)}`);
                const configData = await configResp.json();
                if (configData.success) {
                    document.getElementById('img-config').src = configData.qrcode;
                    document.getElementById('box-config').style.display = 'flex';
                }
            }
            
            // Generate Subscription QR
            if (subUrl && subUrl !== 'undefined' && subUrl !== 'null') {
                const subResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(subUrl)}`);
                const subData = await subResp.json();
                if (subData.success) {
                    document.getElementById('img-sub').src = subData.qrcode;
                    document.getElementById('box-sub').style.display = 'flex';
                }
            } else {
                document.getElementById('box-sub').style.display = 'none';
            }
            
            // Generate JSON QR
            if (jsonUrl && jsonUrl !== 'undefined' && jsonUrl !== 'null') {
                const jsonResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(jsonUrl)}`);
                const jsonData = await jsonResp.json();
                if (jsonData.success) {
                    document.getElementById('img-json').src = jsonData.qrcode;
                    document.getElementById('box-json').style.display = 'flex';
                }
            } else {
                document.getElementById('box-json').style.display = 'none';
            }

            // Generate Dash Sub QR
            if (finalDashUrl && finalDashUrl !== 'undefined' && finalDashUrl !== 'null' && finalDashUrl !== '') {
                const dashResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(finalDashUrl)}`);
                const dashData = await dashResp.json();
                if (dashData.success) {
                    document.getElementById('img-dash').src = dashData.qrcode;
                    document.getElementById('box-dash').style.display = 'flex';
                }
            } else {
                document.getElementById('box-dash').style.display = 'none';
            }
            
            document.getElementById('qr-modal').classList.remove('hidden');
        } catch (error) {
            showToast('Error generating QR Codes: ' + error.message, 'error');
        }
    }
    
    function copyText(elementId, imgId, title) {
        const input = document.getElementById(elementId);
        if (!input.value) return;
        
        navigator.clipboard.writeText(input.value).then(() => {
            showToast('Link copied!');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
        
        // Show expanded QR on mobile only
        if (window.innerWidth <= 768 && imgId) {
            expandQrCode(imgId, title);
        }
    }
    
    function expandQrCode(imgId, title) {
        const img = document.getElementById(imgId);
        if (!img || !img.src) return;
        
        document.getElementById('expanded-qr-title').textContent = title;
        document.getElementById('expanded-qr-img').src = img.src;
        document.getElementById('expanded-qr-modal').classList.remove('hidden');
    }
    
    function closeExpandedQr() {
        document.getElementById('expanded-qr-modal').classList.add('hidden');
    }

    function closeQrModal() {
        document.getElementById('qr-modal').classList.add('hidden');
    }

    async function copyLink() {
        if (!currentLink) {
            showToast('Link not found', 'error');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(currentLink);
            showToast('Link copied');
        } catch (error) {
            showToast('Copy failed', 'error');
        }
    }

    async function toggleClient(serverId, inboundId, email, enable) {
        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, enable: enable })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(enable ? 'Client enabled' : 'Client disabled');
                // Update UI instantly, then sync from server cache in background.
                patchLocalClient(serverId, inboundId, email, { enable: enable });
                queueSilentServerRefresh(serverId);
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function openResetModal(serverId, inboundId, email, totalBytes = 0) {
        document.getElementById('reset-server-id').value = serverId;
        document.getElementById('reset-inbound-id').value = inboundId;
        document.getElementById('reset-email').value = email;
        document.getElementById('reset-client-email').textContent = email;
        document.getElementById('reset-current-volume').textContent = formatVolumeLabel(totalBytes);
        const defaultGb = bytesToGB(totalBytes) || 50;
        const volInput = document.getElementById('reset-volume');
        volInput.value = defaultGb;
        
        const freeToggle = document.getElementById('reset-free-toggle');
        if (freeToggle) freeToggle.checked = false;

        updateResetCost();
        document.getElementById('reset-modal').classList.remove('hidden');
    }

    function closeResetModal() {
        document.getElementById('reset-modal').classList.add('hidden');
    }

    function updateResetCost() {
        const volInput = document.getElementById('reset-volume');
        if (!volInput) return;
        let volume = parseInt(volInput.value) || 0;
        if (volume < 0) volume = 0;
        volInput.value = volume;
        
        const isFree = document.getElementById('reset-free-toggle')?.checked || false;
        const cost = isFree ? 0 : (volume * BASE_COST_GB);
        
        const costLabel = document.getElementById('reset-cost');
        if (costLabel) costLabel.textContent = Number(cost).toLocaleString();
    }

    async function submitResetTraffic() {
        const serverId = document.getElementById('reset-server-id').value;
        const inboundId = document.getElementById('reset-inbound-id').value;
        const email = document.getElementById('reset-email').value;
        const volume = parseInt(document.getElementById('reset-volume').value) || 0;
        const isFree = document.getElementById('reset-free-toggle')?.checked || false;
        const senderCard = document.getElementById('reset-sender-card')?.value?.trim() || '';
        const destCardId = document.getElementById('reset-dest-card')?.value || '';

        if (!isFree && USER_ROLE === 'reseller' && BASE_COST_GB > 0 && volume <= 0) {
            showToast('Please enter billable volume (GB)', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/reset`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: email, 
                    volume_gb: volume,
                    is_free: isFree,
                    sender_card: senderCard,
                    card_id: destCardId ? parseInt(destCardId) : null
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Traffic reset');
                closeResetModal();
                if (typeof data.remaining_credit !== 'undefined') {
                    updateWalletDisplay(data.remaining_credit);
                }
                // Update UI instantly (best-effort), then sync from server cache in background.
                patchLocalClient(serverId, inboundId, email, { up: 0, down: 0 });
                queueSilentServerRefresh(serverId);
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function openRenewModal(serverId, inboundId, email, volumeStatus, remainingFormatted, totalFormatted, expiryType, expiryText, expiryTimestamp) {
        document.getElementById('renew-server-id').value = serverId;
        document.getElementById('renew-inbound-id').value = inboundId;
        document.getElementById('renew-email').value = email;
        document.getElementById('renew-client-email').textContent = email;
        
        currentClientExpiryText = expiryText || '';
        currentClientRemainingVolume = remainingFormatted || '';

        const statusEl = document.getElementById('renew-client-status');
        if (statusEl) {
            const volStatus = String(volumeStatus || '').toLowerCase();
            const expType = String(expiryType || '').toLowerCase();
            const expText = String(expiryText || '').trim();
            const remainingTextRaw = String(remainingFormatted || '').trim();
            const timeText = formatTehranTime(expiryTimestamp);

            const clear = () => {
                while (statusEl.firstChild) statusEl.removeChild(statusEl.firstChild);
            };
            const appendText = (t) => statusEl.appendChild(document.createTextNode(t));
            const makeSpan = (className, text) => {
                const s = document.createElement('span');
                if (className) s.className = className;
                if (text != null) s.textContent = String(text);
                return s;
            };

            const makeExpiryBadge = () => {
                const badge = document.createElement('span');
                badge.className = `expiry-badge ${getExpiryClass(expType)}`.trim();
                const line1 = makeSpan('expiry-time', expText || (expType ? expType.toUpperCase() : ''));
                badge.appendChild(line1);
                if (timeText) {
                    badge.appendChild(document.createTextNode(' '));
                    badge.appendChild(makeSpan('expiry-time', timeText));
                }
                return badge;
            };

            clear();

            // Priority: suspended -> low -> expired -> today -> normal
            if (volStatus === 'suspended') {
                appendText('— ');
                statusEl.appendChild(makeSpan('remaining suspended', 'Suspended'));
                appendText(' ');
                statusEl.appendChild(makeSpan('', '(volume finished)'));
            } else if (volStatus === 'low') {
                appendText('— ');
                // Backend already formats low like "0.24 GB Low"
                statusEl.appendChild(makeSpan('remaining low', remainingTextRaw || 'Low'));
            } else if (expType === 'expired') {
                appendText('— ');
                statusEl.appendChild(makeExpiryBadge());
            } else if (expType === 'today') {
                appendText('— ');
                statusEl.appendChild(makeExpiryBadge());
            } else {
                const hasAny = Boolean(expText) || Boolean(remainingTextRaw);
                if (!hasAny) {
                    statusEl.textContent = '';
                } else {
                    appendText('— ');
                    if (expText) {
                        statusEl.appendChild(makeExpiryBadge());
                    }
                    if (expText && remainingTextRaw) appendText(' • ');
                    if (remainingTextRaw) {
                        // Use existing "server-badge" style for neutral info
                        statusEl.appendChild(makeSpan('server-badge', `Remaining: ${remainingTextRaw}`));
                    }
                }
            }
        }
        document.getElementById('renew-start-after-first-use').checked = false;
        document.getElementById('renew-reset-traffic').checked = false;
        const renewFreeToggle = document.getElementById('renew-free-toggle');
        if (renewFreeToggle) renewFreeToggle.checked = false;
        document.getElementById('renew-custom-days').value = 30;
        document.getElementById('renew-custom-volume').value = 10;
        selectedRenewPackageId = null;
        selectedRenewPackageDays = 0;
        selectedRenewPackageVolume = 0;
        selectedRenewPackageName = '';
        loadRenewPackages();
        calculateRenewCustomPrice();
        document.getElementById('renew-modal').classList.remove('hidden');
    }

    function closeRenewModal() {
        document.getElementById('renew-modal').classList.add('hidden');
    }

    function closeRenewSuccessModal() {
        document.getElementById('renew-success-modal').classList.add('hidden');
    }

    function copyRenewSuccessText() {
        const text = document.getElementById('renew-success-text').innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard');
        });
    }

    async function submitRenewal() {
        const serverId = document.getElementById('renew-server-id').value;
        const inboundId = document.getElementById('renew-inbound-id').value;
        const email = document.getElementById('renew-email').value;
        const startAfterFirstUse = document.getElementById('renew-start-after-first-use').checked;
        const resetTraffic = document.getElementById('renew-reset-traffic').checked;
        const senderCard = document.getElementById('renew-sender-card')?.value?.trim() || '';
        const destCardId = document.getElementById('renew-dest-card')?.value || '';

        const usePackage = Boolean(selectedRenewPackageId);
        const payload = {
            mode: usePackage ? 'package' : 'custom',
            free: Boolean(document.getElementById('renew-free-toggle')?.checked),
            start_after_first_use: startAfterFirstUse,
            reset_traffic: resetTraffic,
            sender_card: senderCard,
            card_id: destCardId ? parseInt(destCardId) : null
        };

        if (usePackage) {
            payload.package_id = selectedRenewPackageId;
        } else {
            const customDays = parseInt(document.getElementById('renew-custom-days').value) || 0;
            const rawVol = (document.getElementById('renew-custom-volume').value || '').trim();
            const customVolume = rawVol === '' ? null : (parseInt(rawVol) || 0);
            // 0 days is valid and means unlimited.
            // For volume: empty means "no change"; 0 means "unlimited".
            payload.days = customDays;
            if (customVolume !== null) {
                payload.volume = customVolume;
            }
        }

        const btn = document.querySelector('#renew-modal .btn-primary');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Processing...';

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/renew`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            if (data.success) {
                closeRenewModal();
                
                let finalDays = 0;
                let finalVolume = null;
                if (usePackage) {
                    finalDays = selectedRenewPackageDays;
                    finalVolume = selectedRenewPackageVolume;
                } else {
                    finalDays = parseInt(document.getElementById('renew-custom-days').value) || 0;
                    const rawVol2 = (document.getElementById('renew-custom-volume').value || '').trim();
                    finalVolume = rawVol2 === '' ? null : (parseInt(rawVol2) || 0);
                }

                const prevHtml = `
                    <span style="color: #818cf8; font-weight: 600;">${email}</span>
                    <span style="color: var(--text-secondary);">—</span>
                    <span>${currentClientExpiryText || 'Unlimited'}</span>
                    <span style="color: var(--text-secondary);">•</span>
                    <span class="server-badge" style="background: rgba(99, 102, 241, 0.1); color: #a5b4fc; border: 1px solid rgba(99, 102, 241, 0.2); padding: 2px 8px; border-radius: 4px;">Remaining: ${currentClientRemainingVolume || 'Unlimited'}</span>
                `;
                document.getElementById('renew-prev-state').innerHTML = prevHtml;

                const fallbackVolLabel = (finalVolume === null) ? '—' : `${finalVolume}GB`;
                const fallbackText = `🔰${email}\n⌛${finalDays} Days 📊${fallbackVolLabel}\nتمدید شد`;
                const successText = (data && typeof data.copy_text === 'string' && data.copy_text.trim())
                    ? data.copy_text
                    : fallbackText;
                document.getElementById('renew-success-text').innerText = successText;
                document.getElementById('renew-success-modal').classList.remove('hidden');

                if (typeof data.remaining_credit !== 'undefined') {
                    updateWalletDisplay(data.remaining_credit);
                }
                queueSilentServerRefresh(serverId);
            } else {
                showToast(data.error || 'Error renewing', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    let allServers = [];

    function openAddClientModal() {
        document.getElementById('add-client-server-select').innerHTML = '<option value="">-- Select Server --</option>';
        document.getElementById('add-client-inbound-select').innerHTML = '<option value="">-- Select Inbound --</option>';

        const lastUserDisplay = document.getElementById('last-user-display');
        if (lastUserDisplay) {
            lastUserDisplay.innerText = 'Last User: -';
            lastUserDisplay.style.color = 'var(--text-secondary)';
            lastUserDisplay.title = '';
        }
        
        if (allServers && allServers.length > 0) {
            allServers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;
                option.textContent = server.name;
                document.getElementById('add-client-server-select').appendChild(option);
            });
        }
        
        document.getElementById('add-client-email').value = '';
        document.getElementById('custom-days').value = 30;
        document.getElementById('custom-volume').value = 10;
        document.getElementById('add-client-start-after-first-use').checked = false;
        const addFreeToggle = document.getElementById('add-client-free-toggle');
        if (addFreeToggle) addFreeToggle.checked = false;
        selectedPackageId = null;
        loadPackages();
        calculateCustomPrice();
        updateAddPriceDisplay();
        document.getElementById('add-client-modal').classList.remove('hidden');
    }

    async function loadPackages() {
        const container = document.getElementById('packages-list');
        if (!container) return;
        container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 10px;">Loading packages...</div>';
        try {
            const res = await fetch('/api/packages');
            const pkgs = await res.json();
            
            if (!Array.isArray(pkgs) || pkgs.length === 0) {
                container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 10px;">No packages defined</div>';
                selectedPackageId = null;
                updateAddPriceDisplay();
                return;
            }

            container.innerHTML = pkgs.map(p => `
                <div class="pkg-card" data-package-id="${p.id}" data-package-price="${p.price}" onclick="selectPackage(this, ${p.id}, ${p.price})" 
                     style="border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 60px;">
                    <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; line-height: 1.2; color: var(--text-secondary);">${p.name}</div>
                    <div style="color: #4ade80; font-weight: bold; font-size: 0.8rem;">${p.price.toLocaleString()} T</div>
                </div>
            `).join('');

            if (selectedPackageId) {
                const active = container.querySelector(`[data-package-id="${selectedPackageId}"]`);
                if (active) {
                    active.style.borderColor = 'var(--primary)';
                    active.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
                }
            }
            updateAddPriceDisplay();
        } catch (e) { 
            container.innerHTML = '<div style="grid-column: span 2; color: #ef4444; text-align: center;">Error loading packages</div>';
            selectedPackageId = null;
            updateAddPriceDisplay();
        }
    }

    function selectPackage(el, id, price) {
        const alreadySelected = selectedPackageId === id;
        document.querySelectorAll('#packages-list .pkg-card').forEach(d => {
            d.style.borderColor = 'var(--border-color)';
            d.style.backgroundColor = 'var(--bg-dark)';
        });

        if (alreadySelected) {
            selectedPackageId = null;
            updateAddPriceDisplay();
            return;
        }

        selectedPackageId = id;
        el.style.borderColor = 'var(--primary)';
        el.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
        updateAddPriceDisplay(price);
    }

    function updateRenewPriceDisplay(amount) {
        const target = document.getElementById('renew-payable-display');
        if (!target) return;
        const freeEl = document.getElementById('renew-payable-free');

        const normalized = Number(amount) || 0;
        target.textContent = normalized.toLocaleString();

        const isFree = Boolean(document.getElementById('renew-free-toggle')?.checked);
        if (isFree) {
            target.style.textDecoration = 'line-through';
            target.style.opacity = '0.65';
            if (freeEl) freeEl.style.display = '';
        } else {
            target.style.textDecoration = '';
            target.style.opacity = '';
            if (freeEl) freeEl.style.display = 'none';
        }
    }

    async function loadRenewPackages() {
        const container = document.getElementById('renew-packages-list');
        if (!container) return;
        container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 10px;">Loading packages...</div>';
        try {
            const res = await fetch('/api/packages');
            const pkgs = await res.json();
            if (!Array.isArray(pkgs) || pkgs.length === 0) {
                container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 15px; color: var(--text-secondary);">No packages defined.</div>';
                selectedRenewPackageId = null;
                refreshRenewPriceDisplay();
                return;
            }

            container.innerHTML = pkgs.map(p => `
                <div class="pkg-card" data-package-id="${p.id}" data-package-price="${p.price}" onclick="selectRenewPackage(this, ${p.id}, ${p.price}, ${p.days}, ${p.volume}, '${p.name}')"
                     style="border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 60px;">
                    <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; line-height: 1.2; color: var(--text-secondary);">${p.name}</div>
                    <div style="color: #4ade80; font-weight: bold; font-size: 0.8rem;">${p.price.toLocaleString()} T</div>
                </div>
            `).join('');

            if (selectedRenewPackageId) {
                const active = container.querySelector(`[data-package-id="${selectedRenewPackageId}"]`);
                if (active) {
                    active.style.borderColor = 'var(--primary)';
                    active.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
                }
            }
            refreshRenewPriceDisplay();
        } catch (e) {
            container.innerHTML = '<div style="grid-column: span 2; color: #ef4444; text-align: center;">Error loading packages</div>';
            selectedRenewPackageId = null;
            refreshRenewPriceDisplay();
        }
    }

    function selectRenewPackage(el, id, price, days, volume, name) {
        const alreadySelected = selectedRenewPackageId === id;
        document.querySelectorAll('#renew-packages-list .pkg-card').forEach(card => {
            card.style.borderColor = 'var(--border-color)';
            card.style.backgroundColor = 'var(--bg-dark)';
        });

        if (alreadySelected) {
            selectedRenewPackageId = null;
            selectedRenewPackageDays = 0;
            selectedRenewPackageVolume = 0;
            selectedRenewPackageName = '';
            refreshRenewPriceDisplay();
            return;
        }

        selectedRenewPackageId = id;
        selectedRenewPackageDays = days;
        selectedRenewPackageVolume = volume;
        selectedRenewPackageName = name;
        el.style.borderColor = 'var(--primary)';
        el.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
        refreshRenewPriceDisplay(price);
    }

    function computeRenewCustomPrice() {
        let days = parseInt(document.getElementById('renew-custom-days').value) || 0;
        let vol = parseInt(document.getElementById('renew-custom-volume').value) || 0;
        if (days < 0) days = 0;
        if (vol < 0) vol = 0;
        // 0 days or 0 volume means unlimited (no charge for unlimited)
        return (days * BASE_COST_DAY) + (vol * BASE_COST_GB);
    }

    function calculateRenewCustomPrice() {
        const total = computeRenewCustomPrice();
        const costDisplay = document.getElementById('renew-price-display');
        if (costDisplay) costDisplay.innerText = total.toLocaleString();
        refreshRenewPriceDisplay(total);
    }

    function refreshRenewPriceDisplay(prefetchedAmount) {
        if (selectedRenewPackageId) {
            const price = getPackagePrice('#renew-packages-list', selectedRenewPackageId);
            updateRenewPriceDisplay(price);
        } else if (typeof prefetchedAmount === 'number') {
            updateRenewPriceDisplay(prefetchedAmount);
        } else {
            updateRenewPriceDisplay(computeRenewCustomPrice());
        }
    }

    function computeAddCustomPrice() {
        let days = parseInt(document.getElementById('custom-days').value) || 0;
        let vol = parseInt(document.getElementById('custom-volume').value) || 0;
        if (days < 0) days = 0;
        if (vol < 0) vol = 0;
        // BASE_COST_DAY and BASE_COST_GB are now user-specific (calculated in backend)
        return (days * BASE_COST_DAY) + (vol * BASE_COST_GB);
    }

    function calculateCustomPrice() {
        const total = computeAddCustomPrice();
        const preview = document.getElementById('custom-price-display');
        if (preview) preview.innerText = total.toLocaleString();
        if (!selectedPackageId) {
            updateAddPriceDisplay(total);
        }
    }

    function getPackagePrice(containerSelector, packageId) {
        const el = document.querySelector(`${containerSelector} .pkg-card[data-package-id="${packageId}"]`);
        if (!el) return 0;
        const priceAttr = el.getAttribute('data-package-price');
        return Number(priceAttr || 0);
    }

    function updateAddPriceDisplay(prefetchedAmount) {
        const display = document.getElementById('add-price-display');
        if (!display) return;
        const freeEl = document.getElementById('add-price-free');
        let total;
        if (selectedPackageId) {
            total = getPackagePrice('#packages-list', selectedPackageId);
        } else if (typeof prefetchedAmount === 'number') {
            total = prefetchedAmount;
        } else {
            total = computeAddCustomPrice();
        }

        const normalized = Number(total) || 0;
        display.textContent = normalized.toLocaleString();

        const isFree = Boolean(document.getElementById('add-client-free-toggle')?.checked);
        if (isFree) {
            display.style.textDecoration = 'line-through';
            display.style.opacity = '0.65';
            if (freeEl) freeEl.style.display = '';
        } else {
            display.style.textDecoration = '';
            display.style.opacity = '';
            if (freeEl) freeEl.style.display = 'none';
        }
    }

    function onServerSelected() {
        const serverId = document.getElementById('add-client-server-select').value;
        const inboundSelect = document.getElementById('add-client-inbound-select');
        inboundSelect.innerHTML = '<option value="">-- Select Inbound --</option>';

        const lastUserDisplay = document.getElementById('last-user-display');
        if (lastUserDisplay) {
            lastUserDisplay.innerText = 'Last User: -';
            lastUserDisplay.style.color = 'var(--text-secondary)';
            lastUserDisplay.title = '';
        }
        
        if (!serverId) return;
        
        const serverInbounds = inboundsData.filter(i => i.server_id == serverId);
        if (serverInbounds.length > 0) {
            serverInbounds.forEach(inbound => {
                const option = document.createElement('option');
                option.value = JSON.stringify({
                    server_id: inbound.server_id,
                    inbound_id: inbound.id
                });
                const activeClients = inbound.clients.filter(c => c.enable).length;
                option.textContent = `${inbound.remark} - ${inbound.protocol} (${inbound.port}) [${activeClients}]`;
                inboundSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.textContent = 'No inbounds available';
            option.disabled = true;
            inboundSelect.appendChild(option);
        }
    }

    function onInboundSelected() {
        if (typeof IS_SUPERADMIN !== 'undefined' && !IS_SUPERADMIN) return;
        const select = document.getElementById('add-client-inbound-select');
        const display = document.getElementById('last-user-display');

        if (!display) return;

        if (!select.value) {
            display.innerText = 'Last User: -';
            display.style.color = 'var(--text-secondary)';
            display.title = '';
            return;
        }

        try {
            const data = JSON.parse(select.value);
            const inbound = inboundsData.find(i => i.id == data.inbound_id && i.server_id == data.server_id);
            if (inbound && inbound.clients && inbound.clients.length > 0) {
                const lastClient = inbound.clients[inbound.clients.length - 1];
                display.innerText = `Last User: ${lastClient.email}`;
                display.style.color = '#fbbf24';
                display.title = lastClient.email;
            } else {
                display.innerText = 'Last User: None';
                display.style.color = 'var(--text-secondary)';
                display.title = '';
            }
        } catch (e) {
            console.error(e);
            display.innerText = 'Last User: Error';
            display.style.color = 'var(--text-secondary)';
            display.title = '';
        }
    }

    function closeAddClientModal() {
        document.getElementById('add-client-modal').classList.add('hidden');
    }

    async function submitAddClient() {
        const email = document.getElementById('add-client-email').value.trim();
        const inboundSelect = document.getElementById('add-client-inbound-select');
        const startAfterFirstUse = document.getElementById('add-client-start-after-first-use').checked;
        const senderCard = document.getElementById('add-client-sender-card')?.value?.trim() || '';
        const destCardId = document.getElementById('add-client-dest-card')?.value || '';
        
        if (!inboundSelect.value) return showToast('Select an inbound', 'error');
        if (!email) return showToast('Enter username', 'error');

        const inboundData = JSON.parse(inboundSelect.value);
        
        const usePackage = Boolean(selectedPackageId);
        const payload = {
            email: email,
            mode: usePackage ? 'package' : 'custom',
            free: Boolean(document.getElementById('add-client-free-toggle')?.checked),
            start_after_first_use: startAfterFirstUse,
            sender_card: senderCard,
            card_id: destCardId ? parseInt(destCardId) : null
        };

        if (usePackage) {
            payload.package_id = selectedPackageId;
        } else {
            const customDays = parseInt(document.getElementById('custom-days').value) || 0;
            const customVolume = parseInt(document.getElementById('custom-volume').value) || 0;
            if (customDays <= 0) return showToast('Duration must be greater than 0', 'error');
            payload.days = customDays;
            payload.volume = customVolume;
        }

        const btn = document.querySelector('#add-client-modal .btn-primary');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Processing...';

        try {
            const response = await fetch(`/api/client/${inboundData.server_id}/${inboundData.inbound_id}/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Client created successfully');
                closeAddClientModal();
                // Always refresh only the affected server immediately
                refreshData(true, { force: true, wait: true, serverId: inboundData.server_id });
                if (data.client) {
                    showNewClientModal(data.client);
                }
            } else {
                showToast(data.error || 'Error creating client', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    function closeNewClientModal() {
        document.getElementById('new-client-modal').classList.add('hidden');
    }

    function copyNewClientDetails() {
        const textarea = document.getElementById('new-client-details');
        textarea.select();
        document.execCommand('copy');
        showToast('Details copied to clipboard');
    }

    async function showNewClientModal(client) {
        const modal = document.getElementById('new-client-modal');
        const detailsText = document.getElementById('new-client-details');
        
        // Fetch active template
        let templateContent = '';
        try {
            const res = await fetch('/api/templates/active?type=client_created');
            const data = await res.json();
            if (data.success) {
                templateContent = data.content;
            }
        } catch (e) {
            console.error('Failed to load template', e);
        }

        // Fallback if fetch fails or returns empty
        if (!templateContent) {
            templateContent = `😍 سفارش جدید شما

اطلاعات سرویس
📡 پروتکل: {protocol}
🔮 نام سرویس: {service_name}
🔋حجم سرویس: {volume} گیگ
⏰ مدت سرویس: {days} روز⁮⁮ ⁮⁮

لینک های اتصال
 
🌐 subscription Direct:
{sub_link}

🌐 Account Dashboard : 
{dashboard_link}`;
        }

        // Replace variables
        const text = templateContent
            .replace(/{protocol}/g, client.protocol || 'vless')
            .replace(/{service_name}/g, client.email)
            .replace(/{volume}/g, client.volume)
            .replace(/{days}/g, client.days)
            .replace(/{sub_link}/g, client.sub_link || '')
            .replace(/{dashboard_link}/g, client.dashboard_link || '');

        detailsText.value = text;
        
        // Generate QRs
        try {
            if (client.sub_link) {
                const subResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(client.sub_link)}`);
                const subData = await subResp.json();
                if (subData.success) {
                    document.getElementById('new-client-img-sub').src = subData.qrcode;
                    document.getElementById('new-client-sub-link').value = client.sub_link;
                    document.getElementById('new-client-qr-sub').style.display = 'flex';
                }
            } else {
                document.getElementById('new-client-qr-sub').style.display = 'none';
            }
            
            if (client.dashboard_link) {
                const dashResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(client.dashboard_link)}`);
                const dashData = await dashResp.json();
                if (dashData.success) {
                    document.getElementById('new-client-img-dash').src = dashData.qrcode;
                    document.getElementById('new-client-dash-link').value = client.dashboard_link;
                    document.getElementById('new-client-qr-dash').style.display = 'flex';
                }
            } else {
                document.getElementById('new-client-qr-dash').style.display = 'none';
            }
        } catch (e) {
            console.error(e);
        }

        modal.classList.remove('hidden');
    }

    let selectedServerIds = new Set();
    let hideDisabledClients = false;

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            const servers = await response.json();
            allServers = servers;
            renderServerList(servers);
            populateServerFilter(servers);
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function populateServerFilter(servers) {
        const list = document.getElementById('server-filter-list');
        list.innerHTML = '';
        
        servers.forEach(server => {
            const div = document.createElement('div');
            div.className = 'filter-item';
            
            // Create label wrapper for custom checkbox style
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.style.width = '100%';
            label.style.margin = '0';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = selectedServerIds.has(server.id);
            checkbox.onchange = (e) => toggleServerSelection(server.id, e.target.checked);
            
            const checkmark = document.createElement('span');
            checkmark.className = 'checkmark';
            
            const span = document.createElement('span');
            span.textContent = server.name;
            span.style.marginLeft = '8px'; // Add some spacing after checkmark
            
            label.appendChild(checkbox);
            label.appendChild(checkmark);
            label.appendChild(span);
            
            div.appendChild(label);
            list.appendChild(div);
        });
    }

    function toggleServerSelection(id, checked) {
        if (checked) {
            selectedServerIds.add(id);
        } else {
            selectedServerIds.delete(id);
        }
        updateServerFilterCount();
        applyFilters();
    }

    function selectAllServers() {
        const checkboxes = document.querySelectorAll('#server-filter-list input');
        // Check if all are currently checked
        const allChecked = Array.from(checkboxes).every(c => c.checked);
        
        if (allChecked) {
            selectedServerIds.clear();
        } else {
            allServers.forEach(s => selectedServerIds.add(s.id));
        }
        
        // Re-render list to update checkboxes
        populateServerFilter(allServers);
        updateServerFilterCount();
        applyFilters();
    }

    function updateServerFilterCount() {
        const count = selectedServerIds.size;
        const badge = document.getElementById('server-filter-count');
        badge.textContent = count;
        if (count > 0) {
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    function toggleServerFilter() {
        const dropdown = document.getElementById('server-filter-dropdown');
        dropdown.classList.toggle('hidden');
    }

    function toggleExpiryFilter() {
        const dropdown = document.getElementById('expiry-filter-dropdown');
        dropdown.classList.toggle('hidden');
    }

    function updateExpiryFilterLabel() {
        const labelEl = document.getElementById('expiry-filter-label');
        if (!labelEl) return;

        const count = selectedExpiryFilters.size;
        if (count === 0) {
            labelEl.textContent = 'Expiry';
            return;
        }

        if (count > 1) {
            labelEl.textContent = 'Expiry';
            return;
        }

        const only = Array.from(selectedExpiryFilters)[0];
        switch (only) {
            case 'not_started':
                labelEl.textContent = 'Not started';
                break;
            case 'unlimited':
                labelEl.textContent = 'Unlimited';
                break;
            case 'expired':
                labelEl.textContent = 'Expired';
                break;
            case 'today':
                labelEl.textContent = 'Today';
                break;
            case 'lt_days':
                labelEl.textContent = `< ${expiryLessThanDays} days`;
                break;
            default:
                labelEl.textContent = 'Expiry';
        }
    }

    function updateExpiryFilterCount() {
        const badge = document.getElementById('expiry-filter-count');
        if (!badge) return;
        const count = selectedExpiryFilters.size;
        badge.textContent = count;
        if (count > 0) badge.classList.remove('hidden');
        else badge.classList.add('hidden');
    }

    function toggleAllExpiryFilters() {
        const allKeys = ['not_started', 'unlimited', 'expired', 'today', 'lt_days'];
        const allSelected = allKeys.every(k => selectedExpiryFilters.has(k));

        if (allSelected) {
            selectedExpiryFilters.clear();
        } else {
            allKeys.forEach(k => selectedExpiryFilters.add(k));
            const daysInput = document.getElementById('expiry-lt-days');
            const parsed = parseInt(daysInput?.value || '', 10);
            expiryLessThanDays = Number.isFinite(parsed) && parsed > 0 ? parsed : 7;
        }

        updateExpiryFilterLabel();
        updateExpiryFilterCount();
        syncExpiryFilterCheckboxes();
        applyFilters();
    }

    function syncExpiryFilterCheckboxes() {
        const map = {
            not_started: 'expiry-filter-not-started',
            unlimited: 'expiry-filter-unlimited',
            expired: 'expiry-filter-expired',
            today: 'expiry-filter-today',
            lt_days: 'expiry-filter-lt-days'
        };

        Object.entries(map).forEach(([key, id]) => {
            const el = document.getElementById(id);
            if (el) el.checked = selectedExpiryFilters.has(key);
        });

        const daysInput = document.getElementById('expiry-lt-days');
        if (daysInput) daysInput.value = String(expiryLessThanDays);
    }

    function toggleExpirySelection(type, checked) {
        const key = String(type || '').toLowerCase();
        if (!key) return;

        if (checked) selectedExpiryFilters.add(key);
        else selectedExpiryFilters.delete(key);

        if (key === 'lt_days' && checked) {
            const daysInput = document.getElementById('expiry-lt-days');
            const parsed = parseInt(daysInput?.value || '', 10);
            expiryLessThanDays = Number.isFinite(parsed) && parsed > 0 ? parsed : 7;
        }

        updateExpiryFilterLabel();
        updateExpiryFilterCount();
        applyFilters();
    }

    function clearExpiryFilter() {
        selectedExpiryFilters.clear();
        updateExpiryFilterLabel();
        updateExpiryFilterCount();
        syncExpiryFilterCheckboxes();
        applyFilters();
    }

    function onExpiryDaysChanged() {
        const daysInput = document.getElementById('expiry-lt-days');
        const parsed = parseInt(daysInput?.value || '', 10);
        expiryLessThanDays = Number.isFinite(parsed) && parsed > 0 ? parsed : 7;
        updateExpiryFilterLabel();
        if (selectedExpiryFilters.has('lt_days')) applyFilters();
    }

    function onExpiryDaysKeyDown(event) {
        if (!event) return;
        if (event.key === 'Enter') {
            event.preventDefault();
            onExpiryDaysChanged();
        }
    }

    function matchesExpiryFilter(client) {
        if (!client) return false;
        if (!selectedExpiryFilters || selectedExpiryFilters.size === 0) return true;

        const type = String(client.expiryType || '').toLowerCase();
        const expiryTs = Number(client.expiryTimestamp || 0);
        const now = Date.now();

        // OR across selected options
        if (selectedExpiryFilters.has('not_started') && type === 'start_after_use') return true;
        if (selectedExpiryFilters.has('unlimited') && type === 'unlimited') return true;
        if (selectedExpiryFilters.has('expired') && (type === 'expired' || (expiryTs > 0 && expiryTs < now))) return true;
        if (selectedExpiryFilters.has('today') && type === 'today') return true;

        if (selectedExpiryFilters.has('lt_days')) {
            if (expiryTs > now && type !== 'expired' && type !== 'start_after_use' && type !== 'unlimited' && type !== 'today') {
                const daysLeft = Math.ceil((expiryTs - now) / 86400000);
                if (daysLeft > 0 && daysLeft < expiryLessThanDays) return true;
            }
        }

        return false;
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('server-filter-dropdown');
        const btn = document.getElementById('server-filter-btn');
        if (dropdown && !dropdown.classList.contains('hidden') && !dropdown.contains(event.target) && !btn.contains(event.target)) {
            dropdown.classList.add('hidden');
        }

        const expDropdown = document.getElementById('expiry-filter-dropdown');
        const expBtn = document.getElementById('expiry-filter-btn');
        if (expDropdown && !expDropdown.classList.contains('hidden') && !expDropdown.contains(event.target) && !expBtn.contains(event.target)) {
            expDropdown.classList.add('hidden');
        }
    });

    function applyDisabledVisibility() {
        const container = document.getElementById('inbounds-container');

        const disabledOnlyEl = document.getElementById('disabled-only-filter');
        disabledOnlyClients = Boolean(disabledOnlyEl && disabledOnlyEl.checked);

        const hideDisabledEl = document.getElementById('hide-disabled-filter');
        hideDisabledClients = Boolean(hideDisabledEl && hideDisabledEl.checked);

        // Mutually exclusive: "Disabled only" overrides "Hide Disabled"
        if (disabledOnlyClients && hideDisabledClients) {
            hideDisabledClients = false;
            if (hideDisabledEl) hideDisabledEl.checked = false;
        }

        if (container) {
            container.classList.toggle('filter-hide-disabled', hideDisabledClients);
            container.classList.toggle('filter-disabled-only', disabledOnlyClients);
        }
    }

    function applyFilters() {
        // Keep container CSS state in sync even when other filters re-run
        applyDisabledVisibility();
        
        // If we have search results, filter them
        const searchResultsDiv = document.getElementById('search-results');
        if (searchResultsDiv.style.display !== 'none') {
            // Re-run search or filter existing results?
            // For now, let's just re-run search if there is a query
            const searchInput = document.getElementById('global-search-input');
            if (searchInput.value.trim().length > 0) {
                performGlobalSearch(true);
                return;
            }
        }

        // Otherwise filter the main list
        let filteredInbounds = [];
        if (allInboundsData && allInboundsData.length > 0) {
             filteredInbounds = filterInbounds(allInboundsData);
        }
        updateInbounds(filteredInbounds);
    }
    
    function filterInbounds(inbounds) {
        // Clone to avoid mutating original data structure if we modify clients array
        // But shallow clone of array is enough if we filter clients
        
        let filtered = inbounds;

        // 1. Filter by Server
        if (selectedServerIds.size > 0) {
            filtered = filtered.filter(i => selectedServerIds.has(i.server_id));
        }
        
        // 2. Filter clients (Expiry)
        if (selectedExpiryFilters && selectedExpiryFilters.size > 0) {
            filtered = filtered.map(inbound => {
                let clients = inbound.clients;

                if (selectedExpiryFilters && selectedExpiryFilters.size > 0) {
                    clients = clients.filter(matchesExpiryFilter);
                }

                if (clients.length === 0) return null;

                return {
                    ...inbound,
                    clients,
                    client_count: clients.length
                };
            }).filter(i => i !== null);
        }
        
        return filtered;
    }

    function renderServerList(servers) {
        const container = document.getElementById('server-list');
        
        if (servers.length === 0) {
            container.innerHTML = '<p class="no-servers">No servers added</p>';
            return;
        }
        
        container.innerHTML = servers.map(server => `
            <div class="server-item ${!server.enabled ? 'disabled' : ''}">
                <div class="server-info">
                    <h4>${server.name}</h4>
                    <p>${server.host}</p>
                </div>
                <div class="server-actions">
                    <button class="action-btn" onclick="editServer(${server.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn danger" onclick="deleteServer(${server.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function openServerModal() {
        document.getElementById('form-title').textContent = 'Add Server';
        document.getElementById('edit-server-id').value = '';
        document.getElementById('server-name').value = '';
        document.getElementById('server-host').value = '';
        document.getElementById('server-username').value = '';
        document.getElementById('server-password').value = '';
        document.getElementById('server-sub-path').value = '/sub/';
        document.getElementById('server-json-path').value = '/json/';
        document.getElementById('server-sub-port').value = '';
        document.getElementById('server-panel-type').value = 'auto';
        document.getElementById('server-modal').classList.remove('hidden');
        loadServers();
    }

    function closeServerModal() {
        document.getElementById('server-modal').classList.add('hidden');
    }

    function editServer(id) {
        const server = allServers.find(s => s.id === id);
        if (!server) return;
        
        document.getElementById('form-title').textContent = 'Edit Server';
        document.getElementById('edit-server-id').value = server.id;
        document.getElementById('server-name').value = server.name;
        document.getElementById('server-host').value = server.host;
        document.getElementById('server-username').value = server.username;
        document.getElementById('server-sub-path').value = server.sub_path || '/sub/';
        document.getElementById('server-json-path').value = server.json_path || '/json/';
        document.getElementById('server-sub-port').value = server.sub_port || '';
        document.getElementById('server-panel-type').value = server.panel_type;
        document.getElementById('server-modal').classList.remove('hidden');
    }

    async function testServerConnection() {
        const id = document.getElementById('edit-server-id').value;
        
        if (!id) {
            showToast('Save server first', 'error');
            return;
        }

        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value,
            sub_path: document.getElementById('server-sub-path').value,
            json_path: document.getElementById('server-json-path').value
        };

        if (!data.host || !data.username || !data.password) {
            showToast('Please fill all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/servers/${id}/test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(`Connection successful - Panel Type: ${result.panel_type === 'sanaei' ? '3X-UI' : result.panel_type === 'alireza' ? 'X-UI' : 'Unknown'}`);
            } else {
                showToast(result.error || 'Connection failed', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function saveServer() {
        const id = document.getElementById('edit-server-id').value;
        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value,
            sub_path: document.getElementById('server-sub-path').value,
            json_path: document.getElementById('server-json-path').value,
            sub_port: document.getElementById('server-sub-port').value
        };

        if (!data.name || !data.host || !data.username || !data.password) {
            showToast('All fields are required', 'error');
            return;
        }

        try {
            const url = id ? `/api/servers/${id}` : '/api/servers';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(id ? 'Server updated' : 'Server added');
                closeServerModal();
                loadServers();
                refreshData();
            } else {
                showToast(result.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function deleteServer(id) {
        if (!confirm('Are you sure you want to delete this server?')) return;
        
        try {
            const response = await fetch(`/api/servers/${id}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                showToast('Server deleted');
                loadServers();
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    let searchTimeout = null;

    async function performGlobalSearch(immediate = false) {
        const searchInput = document.getElementById('global-search-input');
        const clearBtn = document.getElementById('clear-search-btn');
        const query = searchInput.value.trim().toLowerCase();
        
        // Toggle clear button visibility
        if (searchInput.value.length > 0) {
            clearBtn.classList.remove('hidden');
        } else {
            clearBtn.classList.add('hidden');
        }
        
        if (searchTimeout) clearTimeout(searchTimeout);

        if (query.length === 0) {
            clearSearch(false); // Pass false to avoid refreshing data immediately if not needed
            return;
        }
        
        const runSearch = async () => {
            try {
                const response = await fetch(`/api/clients/search?email=${encodeURIComponent(query)}`);
                const data = await response.json();
                if (data.success && data.results.length > 0) {
                    displaySearchResults(data.results, query);
                } else {
                    displaySearchResults([], query);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        };

        if (immediate) {
            await runSearch();
            return;
        }

        searchTimeout = setTimeout(runSearch, 500); // 500ms debounce
    }

    function clearSearch(shouldRefresh = true) {
        const searchResultsDiv = document.getElementById('search-results');
        const wasShowingResults = searchResultsDiv.style.display !== 'none';

        document.getElementById('global-search-input').value = '';
        searchResultsDiv.style.display = 'none';
        document.getElementById('clear-search-btn').classList.add('hidden');
        
        if (shouldRefresh) {
            refreshData();
        } else if (wasShowingResults) {
            refreshData(true);
        }
    }

    function displaySearchResults(results, query) {
        const searchResultsDiv = document.getElementById('search-results');
        const searchResultsText = document.getElementById('search-results-text');
        const clearBtn = document.getElementById('clear-search-btn');
        const selectAllBtn = document.getElementById('search-select-all-btn');
        
        // Ensure clear button is visible if we have results (or even no results but a query)
        clearBtn.classList.remove('hidden');
        
        // Apply filters to search results
        let filteredResults = results;
        
        // Filter by Server
        if (selectedServerIds.size > 0) {
            filteredResults = filteredResults.filter(r => selectedServerIds.has(r.server_id));
        }
        
        // Filter by Expiry
        if (selectedExpiryFilters && selectedExpiryFilters.size > 0) {
            filteredResults = filteredResults.filter(r => matchesExpiryFilter(r.client));
        }
        
        if (filteredResults.length === 0) {
            searchResultsDiv.style.display = 'flex';
            if (selectAllBtn) selectAllBtn.style.display = 'none';
            if (results.length > 0) {
                searchResultsText.textContent = `Found ${results.length} client(s), but all hidden by filters.`;
            } else {
                searchResultsText.textContent = `No clients found matching "${query}"`;
            }
            updateInboundsFiltered([]);
            return;
        }
        
        searchResultsDiv.style.display = 'flex';
        searchResultsText.textContent = `Found ${filteredResults.length} client(s) matching "${query}"` + (results.length !== filteredResults.length ? ` (filtered from ${results.length})` : '');
        if (selectAllBtn) selectAllBtn.style.display = 'inline-flex';
        
        updateInboundsFiltered(filteredResults);
        // Apply CSS-only disabled visibility to rendered rows
        applyDisabledVisibility();
    }

    function selectAllSearchResults() {
        // In search mode, the inbounds list is rebuilt with only filtered results,
        // so selecting all currently-rendered checkboxes corresponds to "select all search results".
        const boxes = Array.from(document.querySelectorAll('.client-bulk-checkbox'));
        boxes.forEach(cb => {
            cb.checked = true;
            const key = makeBulkClientKey(cb.dataset.serverId, cb.dataset.inboundId, cb.dataset.email);
            bulkSelectedClientKeys.add(key);
        });
        applyBulkSelectionToDOM();
        updateBulkUI();
    }

    function updateInboundsFiltered(filteredResults) {
        if (filteredResults.length === 0) {
            const container = document.getElementById('inbounds-container');
            container.innerHTML = `<div class="empty-state"><h3>No results</h3></div>`;
            return;
        }
        
        const container = document.getElementById('inbounds-container');
        const inboundsToShow = [];
        
        filteredResults.forEach(result => {
            const existing = inboundsToShow.find(i => i.id === result.inbound_id && i.server_id === result.server_id);
            if (existing) {
                existing.clients.push(result.client);
            } else {
                inboundsToShow.push({
                    id: result.inbound_id,
                    server_id: result.server_id,
                    server_name: result.server_name,
                    remark: result.inbound.remark,
                    protocol: result.inbound.protocol,
                    port: result.inbound.port,
                    enable: result.inbound.enable,
                    network: 'tcp',
                    security: 'tls',
                    client_count: 1,
                    total_up: '0 B',
                    total_down: '0 B',
                    clients: [result.client]
                });
            }
        });
        
        const html = inboundsToShow.map(inbound => `
            <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                <div class="inbound-header">
                    <div class="inbound-title">
                        <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                        <h3>${inbound.remark}</h3>
                        <span class="port-badge">:${inbound.port}</span>
                        <span class="server-badge">${inbound.server_name}</span>
                    </div>
                </div>
                ${inbound.clients.length > 0 ? `
                <div class="clients-section">
                    <div class="clients-list">
                        <div class="clients-table-wrapper">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th style="width: 34px;">
                                            <label class="checkbox-label" style="padding-left: 0; width: 20px; height: 20px; margin: 0 auto;">
                                                <input type="checkbox" class="select-all-clients" onchange="toggleSelectAllClients('${inbound.server_id}:${inbound.id}', this.checked)">
                                                <span class="checkmark"></span>
                                            </label>
                                        </th>
                                        <th>Email</th>
                                        <th>Owner</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Traffic</th>
                                        <th>Volume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td class="select-cell">
                                            <label class="checkbox-label" style="padding-left: 0; width: 20px; height: 20px; margin: 0 auto;">
                                                <input type="checkbox" class="client-bulk-checkbox" data-inbound-key="${inbound.server_id}:${inbound.id}" data-server-id="${inbound.server_id}" data-inbound-id="${inbound.id}" data-email="${client.email}" data-client-uuid="${client.id || ''}" onchange="onBulkClientCheckboxChanged(this)">
                                                <span class="checkmark"></span>
                                            </label>
                                        </td>
                                        <td class="email-cell"><span class="email-with-online">${client.is_online ? '<span class="online-pulse" title="Online"></span>' : ''}<span class="email-text">${client.email}</span></span></td>
                                        <td class="owner-cell">${renderOwnerCell(client)}</td>
                                        <td>
                                            ${client.enable 
                                                ? `<span class="client-status active">Enabled</span>` 
                                                : `<span class="client-status inactive">Disabled</span>`}
                                        </td>
                                        <td>
                                            <span class="expiry-badge ${getExpiryClass(client.expiryType)}">
                                                <span class="expiry-time">${client.expiryTime}</span>
                                                ${client.expiryTimestamp ? `<span class="expiry-time">${formatTehranTime(client.expiryTimestamp)}</span>` : ''}
                                            </span>
                                        </td>
                                        <td class="traffic-cell">
                                            <div class="traffic-combined-cell">
                                                <span class="up">↑ ${client.up_formatted}</span>
                                                <span class="down">↓ ${client.down_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="volume-cell">
                                            <div class="volume-info">
                                                <span class="remaining ${client.volume_status || ''}">${client.remaining_formatted}</span>
                                                <span class="total ${client.totalGB_formatted === 'Unlimited' ? 'expiry-start-after' : ''}">/ ${client.totalGB_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}', '${client.sub_url || ''}', '${client.json_url || ''}', '${client.dash_sub_url || ''}', ${inbound.server_id}, '${client.subId || client.id || ''}')" title="QR Code">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="14" width="7" height="7"></rect>
                                                        <rect x="3" y="14" width="7" height="7"></rect>
                                                    </svg>
                                                </button>
                                                <button class="action-btn renew" onclick="openRenewModal(${inbound.server_id}, '${inbound.id}', '${client.email}', '${client.volume_status || ''}', '${client.remaining_formatted || ''}', '${client.totalGB_formatted || ''}', '${client.expiryType || ''}', '${client.expiryTime || ''}', ${client.expiryTimestamp || 0})" title="Renew">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${inbound.server_id}, '${inbound.id}', '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="openResetModal(${inbound.server_id}, '${inbound.id}', '${client.email}', ${client.totalGB || 0})" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                                <button class="action-btn" onclick="openEditClientModal(${inbound.server_id}, '${inbound.id}', '${client.email}', ${client.totalGB || 0}, ${client.expiryTimestamp || 0})" title="Edit Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                    </svg>
                                                </button>
                                                ${IS_SUPERADMIN ? `<button class="action-btn" onclick="openAssignModal(${inbound.server_id}, '${client.email}', '${inbound.id}', '${client.id || ''}')" title="Assign Owner">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="10" cy="7" r="4"></circle><path d="M22 11h-2.5a2.5 2.5 0 0 0 0 5H22"></path>
                                                    </svg>
                                                </button>` : ''}
                                                <button class="action-btn danger" onclick="openDeleteClientModal(${inbound.server_id}, '${inbound.id}', '${client.email}', '${client.id}', ${client.enable}, '${client.expiryTime}', ${client.expiryTimestamp || 0}, '${client.up}', '${client.down}', '${client.totalGB_formatted}', '${client.remaining_formatted}')" title="Delete Client">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                        <path d="M19 6v14a2 2 0 0 1-2-2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `).join('');
        
        container.innerHTML = html;

        applyBulkSelectionToDOM();
        updateBulkUI();
    }

    function getSelectedClientsForBulk() {
        // Prefer persisted selection; intersect with currently-present boxes.
        const boxes = Array.from(document.querySelectorAll('.client-bulk-checkbox'));
        const selected = [];
        boxes.forEach(cb => {
            const key = makeBulkClientKey(cb.dataset.serverId, cb.dataset.inboundId, cb.dataset.email);
            if (!bulkSelectedClientKeys.has(key)) return;
            selected.push({
                server_id: parseInt(cb.dataset.serverId),
                inbound_id: parseInt(cb.dataset.inboundId),
                email: cb.dataset.email,
                client_uuid: cb.dataset.clientUuid || ''
            });
        });
        return selected.filter(x => x.server_id && (x.inbound_id || x.inbound_id === 0) && x.email);
    }

    function updateBulkUI() {
        const container = document.getElementById('bulk-actions-container');
        const countEl = document.getElementById('bulk-selected-count');
        if (!container || !countEl) return;
        const selected = getSelectedClientsForBulk();
        countEl.textContent = `${selected.length} selected`;
        container.style.display = selected.length > 0 ? 'block' : 'none';
    }

    function onBulkClientCheckboxChanged(el) {
        if (!el) return;
        const key = makeBulkClientKey(el.dataset.serverId, el.dataset.inboundId, el.dataset.email);
        if (el.checked) bulkSelectedClientKeys.add(key);
        else bulkSelectedClientKeys.delete(key);
        applyBulkSelectionToDOM();
        updateBulkUI();
    }

    function toggleSelectAllClients(inboundKey, checked) {
        const boxes = document.querySelectorAll('.client-bulk-checkbox');
        boxes.forEach(cb => {
            if (cb.dataset.inboundKey !== inboundKey) return;
            cb.checked = checked;
            const key = makeBulkClientKey(cb.dataset.serverId, cb.dataset.inboundId, cb.dataset.email);
            if (checked) bulkSelectedClientKeys.add(key);
            else bulkSelectedClientKeys.delete(key);
        });
        applyBulkSelectionToDOM();
        updateBulkUI();
    }

    function clearBulkSelection() {
        document.querySelectorAll('.client-bulk-checkbox').forEach(cb => cb.checked = false);
        document.querySelectorAll('.select-all-clients').forEach(cb => cb.checked = false);
        bulkSelectedClientKeys.clear();
        updateBulkUI();
    }

    // Optimistic update: patch local data immediately after bulk assign/unassign
    function applyOwnerUpdateToLocal(clients, newOwnerId, newOwnerName) {
        if (!Array.isArray(allInboundsData)) return;
        
        // Build a lookup set for quick matching
        const clientSet = new Set();
        clients.forEach(c => {
            const key = `${c.server_id}:${c.inbound_id}:${(c.email || '').toLowerCase()}`;
            clientSet.add(key);
        });
        
        // Patch each matching client in the local cache
        for (const inbound of allInboundsData) {
            const sid = inbound.server_id;
            const iid = inbound.id;
            const inboundClients = inbound.clients || [];
            
            for (const client of inboundClients) {
                const em = (client.email || '').toLowerCase();
                const key = `${sid}:${iid}:${em}`;
                
                if (clientSet.has(key)) {
                    if (newOwnerName) {
                        client.owner_reseller_id = newOwnerId;
                        client.owner_username = newOwnerName;
                    } else {
                        delete client.owner_reseller_id;
                        delete client.owner_username;
                    }
                }
            }
        }
        
        // Re-render the UI with updated data
        applyFilters();
        
        // If search is active, re-run search to update displayed results
        const searchInput = document.getElementById('global-search-input');
        if (searchInput && searchInput.value.trim().length > 0) {
            performGlobalSearch(true);
        }
    }

    function setBulkProgress(visible, processed = 0, total = 0) {
        const wrap = document.getElementById('bulk-progress');
        const bar = document.getElementById('bulk-progress-bar');
        const text = document.getElementById('bulk-progress-text');
        if (!wrap || !bar || !text) return;
        wrap.style.display = visible ? 'block' : 'none';
        const safeTotal = Math.max(0, parseInt(total || 0));
        const safeProcessed = Math.max(0, Math.min(parseInt(processed || 0), safeTotal || 0));
        const pct = safeTotal > 0 ? Math.round((safeProcessed / safeTotal) * 100) : 0;
        bar.style.width = `${pct}%`;
        text.textContent = `${safeProcessed}/${safeTotal}`;
    }

    function onBulkActionChanged() {
        const action = document.getElementById('bulk-action-select')?.value;
        const resellerContainer = document.getElementById('bulk-reseller-container');
        if (resellerContainer) {
            resellerContainer.style.display = (typeof IS_SUPERADMIN !== 'undefined' && IS_SUPERADMIN && action === 'assign_owner') ? 'block' : 'none';
        }

        const deltaContainer = document.getElementById('bulk-delta-container');
        const daysInput = document.getElementById('bulk-days-delta');
        const volInput = document.getElementById('bulk-volume-delta');
        if (deltaContainer && daysInput && volInput) {
            const isDays = action === 'add_days';
            const isVol = action === 'add_volume';
            deltaContainer.style.display = (isDays || isVol) ? 'block' : 'none';
            daysInput.style.display = isDays ? 'block' : 'none';
            volInput.style.display = isVol ? 'block' : 'none';
        }
    }

    async function loadResellersForBulk() {
        const select = document.getElementById('bulk-reseller-select');
        if (!select) return;
        try {
            const response = await fetch('/api/admins');
            const admins = await response.json();
            const resellers = admins.filter(a => a.role === 'reseller');

            const options = [
                '<option value="">Select Reseller</option>',
                '<option value="0">System</option>'
            ].concat(
                resellers.map(r => `<option value="${r.id}">${r.username}</option>`)
            );
            select.innerHTML = options.join('');
        } catch (error) {
            console.error('Error loading resellers for bulk:', error);
            select.innerHTML = '<option value="">Error loading resellers</option>';
        }
    }

    async function executeBulkAction() {
        let action = document.getElementById('bulk-action-select')?.value;
        if (!action) {
            showToast('Please select an action', 'error');
            return;
        }

        const clients = getSelectedClientsForBulk();
        if (!clients.length) {
            showToast('Please select at least one client', 'error');
            return;
        }

        const data = {};
        const conditions = {
            enable_state: document.getElementById('bulk-cond-enable')?.value || 'any',
            expiry_type: document.getElementById('bulk-cond-expiry')?.value || 'any'
        };

        if (action === 'add_days') {
            const raw = document.getElementById('bulk-days-delta')?.value;
            const v = parseInt(raw);
            if (!Number.isFinite(v) || v <= 0) {
                showToast('Please enter days (> 0)', 'error');
                return;
            }
            data.days_delta = v;
        }

        if (action === 'add_volume') {
            const raw = document.getElementById('bulk-volume-delta')?.value;
            const v = parseInt(raw);
            if (!Number.isFinite(v) || v <= 0) {
                showToast('Please enter volume GB (> 0)', 'error');
                return;
            }
            data.volume_gb_delta = v;
        }

        if (action === 'assign_owner') {
            const resellerId = document.getElementById('bulk-reseller-select')?.value;
            if (resellerId === null || resellerId === undefined || String(resellerId).trim() === '') {
                showToast('Please select a reseller', 'error');
                return;
            }
            const resellerIdInt = parseInt(resellerId);
            if (resellerIdInt === 0) {
                // Treat "System" as an explicit unassign (no owner)
                action = 'unassign_owner';
            } else {
                data.reseller_id = resellerIdInt;
            }
        }

        try {
            setBulkProgress(true, 0, clients.length);

            const response = await fetch('/api/client/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, clients, data, conditions })
            });

            const result = await response.json();
            if (!response.ok || !result.success) {
                setBulkProgress(false);
                showToast(result.error || 'Bulk action failed', 'error');
                return;
            }

            const jobId = result.job_id;
            if (!jobId) {
                setBulkProgress(false);
                showToast('Bulk action failed (missing job id)', 'error');
                return;
            }

            const pollStart = Date.now();
            const pollMaxMs = 10 * 60 * 1000;
            const poll = async () => {
                try {
                    if ((Date.now() - pollStart) > pollMaxMs) {
                        setBulkProgress(false);
                        showToast('Bulk action is taking too long. Please refresh.', 'error');
                        return;
                    }

                    const stResp = await fetch(`/api/client/bulk/job/${jobId}`);
                    const st = await stResp.json();
                    if (!stResp.ok || !st.success) {
                        setBulkProgress(false);
                        showToast(st.error || 'Bulk progress error', 'error');
                        return;
                    }

                    const job = st.job || {};
                    const progress = job.progress || {};
                    const total = progress.total || clients.length;
                    const processed = progress.processed || 0;
                    setBulkProgress(true, processed, total);

                    if (job.state === 'done') {
                        setBulkProgress(false);
                        const successCount = progress.success || 0;
                        const failedCount = progress.failed || 0;
                        const skippedCount = progress.skipped || 0;
                        showToast(`Bulk action done. Success: ${successCount}, Failed: ${failedCount}, Skipped: ${skippedCount}`);
                        
                        // Optimistic UI update for assign/unassign - update local data instantly
                        if (action === 'assign_owner' || action === 'unassign_owner') {
                            const newOwnerName = action === 'unassign_owner' ? null : 
                                (document.getElementById('bulk-reseller-select')?.selectedOptions[0]?.text || null);
                            const newOwnerId = action === 'unassign_owner' ? null : (data.reseller_id || null);
                            applyOwnerUpdateToLocal(clients, newOwnerId, newOwnerName);
                        }

                        // Optimistic UI update for enable/disable
                        if (action === 'enable' || action === 'disable') {
                            const newEnable = action === 'enable';
                            clients.forEach(c => {
                                patchLocalClient(c.server_id, c.inbound_id, c.email, { enable: newEnable });
                            });
                        }

                        // Optimistic UI update for add_days
                        if (action === 'add_days' && data.days_delta) {
                            const daysDelta = parseInt(data.days_delta) || 0;
                            if (daysDelta > 0) {
                                clients.forEach(c => {
                                    patchLocalClient(c.server_id, c.inbound_id, c.email, { addDays: daysDelta });
                                });
                            }
                        }

                        // Optimistic UI update for add_volume
                        if (action === 'add_volume' && data.volume_gb_delta) {
                            const volDelta = parseInt(data.volume_gb_delta) || 0;
                            if (volDelta > 0) {
                                clients.forEach(c => {
                                    patchLocalClient(c.server_id, c.inbound_id, c.email, { addVolumeGB: volDelta });
                                });
                            }
                        }

                        // Optimistic UI update for delete - remove from local data instantly
                        if (action === 'delete') {
                            clients.forEach(c => {
                                removeLocalClient(c.server_id, c.inbound_id, c.email);
                            });
                        }
                        
                        // Clear selection and re-render
                        clearBulkSelection();
                        // Background sync (silent) - UI already updated optimistically
                        setTimeout(() => refreshData(true), 500);
                        return;
                    }
                    if (job.state === 'error') {
                        setBulkProgress(false);
                        showToast(job.error || 'Bulk action failed', 'error');
                        return;
                    }

                    setTimeout(poll, 600);
                } catch (e) {
                    console.error('Bulk poll error:', e);
                    setBulkProgress(false);
                    showToast('Bulk action failed', 'error');
                }
            };

            poll();
        } catch (error) {
            console.error('Bulk action error:', error);
            setBulkProgress(false);
            showToast('Bulk action failed', 'error');
        }
    }

    function toggleResellerDropdown() {
        const dropdown = document.getElementById('assign-reseller-dropdown');
        dropdown.classList.toggle('hidden');
    }

    // Close reseller dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('assign-reseller-dropdown');
        const btn = document.getElementById('assign-reseller-btn');
        if (dropdown && !dropdown.classList.contains('hidden') && !dropdown.contains(event.target) && !btn.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    function selectReseller(id, name) {
        document.getElementById('assign-reseller-select').value = id;
        document.getElementById('assign-reseller-label').textContent = name;
        document.getElementById('assign-reseller-dropdown').classList.add('hidden');
    }

    async function loadResellersForModal() {
        try {
            const response = await fetch('/api/admins');
            const admins = await response.json();
            const resellers = admins.filter(a => a.role === 'reseller');
            const list = document.getElementById('assign-reseller-list');
            
            const systemItem = `
                <div class="filter-item" onclick="selectReseller(0, 'System')">
                    <span style="flex: 1;">System</span>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Unassign</span>
                </div>
            `;

            const resellerItems = resellers.map(r => `
                <div class="filter-item" onclick="selectReseller(${r.id}, '${r.username}')">
                    <span style="flex: 1;">${r.username}</span>
                    <span style="font-size: 0.8rem; color: #4ade80;">${r.credit.toLocaleString()} T</span>
                </div>
            `).join('');

            list.innerHTML = systemItem + resellerItems;
        } catch (error) {
            console.error('Error loading resellers:', error);
            document.getElementById('assign-reseller-list').innerHTML = '<div style="padding: 10px; color: var(--danger); text-align: center;">Error loading resellers</div>';
        }
    }

    function openAssignModal(serverId, email, inboundId = 0, clientUuid = '') {
        document.getElementById('assign-server-id').value = serverId;
        document.getElementById('assign-inbound-id').value = inboundId;
        document.getElementById('assign-client-email-hidden').value = email;
        document.getElementById('assign-client-email').textContent = email;
        document.getElementById('assign-client-uuid').value = clientUuid || '';
        
        // Reset selection
        document.getElementById('assign-reseller-select').value = '';
        document.getElementById('assign-reseller-label').textContent = 'Select Reseller';
        
        document.getElementById('assign-modal').classList.remove('hidden');
        loadResellersForModal();
    }

    function closeAssignModal() {
        document.getElementById('assign-modal').classList.add('hidden');
    }

    async function submitAssignment() {
        const serverId = document.getElementById('assign-server-id').value;
        const inboundId = document.getElementById('assign-inbound-id').value;
        const email = document.getElementById('assign-client-email-hidden').value;
        const clientUuid = document.getElementById('assign-client-uuid').value;
        const resellerId = document.getElementById('assign-reseller-select').value;

        if (resellerId === null || resellerId === undefined || String(resellerId).trim() === '') {
            showToast('Please select an owner', 'error');
            return;
        }

        try {
            const response = await fetch('/api/assign-client', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    server_id: parseInt(serverId),
                    email: email,
                    reseller_id: parseInt(resellerId),
                    inbound_id: (inboundId === null || inboundId === undefined || String(inboundId).trim() === '') ? null : parseInt(inboundId),
                    client_uuid: (clientUuid === null || clientUuid === undefined || String(clientUuid).trim() === '') ? null : String(clientUuid)
                })
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client assigned successfully');
                closeAssignModal();
                refreshData();
            } else {
                showToast(result.error || 'Error assigning client', 'error');
            }
        } catch (error) {
            showToast('Error assigning client', 'error');
        }
    }

    function openEditClientModal(serverId, inboundId, email, totalGB = 0, expiryTime = 0) {
        document.getElementById('edit-client-server-id').value = serverId;
        document.getElementById('edit-client-inbound-id').value = inboundId;
        document.getElementById('edit-client-old-email').value = email;
        document.getElementById('edit-client-new-email').value = email;
        
        const totalGbInput = document.getElementById('edit-client-total-gb');
        if (totalGbInput) {
            totalGbInput.value = (totalGB / (1024 * 1024 * 1024)).toFixed(2);
        }
        
        const expiryInput = document.getElementById('edit-client-expiry');
        if (expiryInput) {
            let ts = Number(expiryTime) || 0;
            if (ts > 0) {
                // If timestamp is in seconds (10 digits), convert to ms
                if (ts < 10000000000) ts *= 1000;
                
                try {
                    if (typeof persianDate !== 'undefined') {
                        const pDate = new persianDate(ts);
                        expiryInput.value = toEnglishDigits(pDate.format('YYYY/MM/DD HH:mm'));
                    } else {
                        const date = new Date(ts);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        expiryInput.value = `${year}/${month}/${day} ${hours}:${minutes}`;
                    }
                } catch (e) {
                    console.error('Error formatting date:', e);
                    expiryInput.value = '';
                }
            } else {
                expiryInput.value = '';
            }
        }

        document.getElementById('edit-client-modal').classList.remove('hidden');
    }

    function closeEditClientModal() {
        document.getElementById('edit-client-modal').classList.add('hidden');
    }

    async function submitEditClient() {
        const serverId = document.getElementById('edit-client-server-id').value;
        const inboundId = document.getElementById('edit-client-inbound-id').value;
        const oldEmail = document.getElementById('edit-client-old-email').value;
        const newEmail = document.getElementById('edit-client-new-email').value.trim();

        if (!newEmail) {
            showToast('Email cannot be empty', 'error');
            return;
        }

        const payload = { new_email: newEmail };
        
        const totalGbInput = document.getElementById('edit-client-total-gb');
        if (totalGbInput) {
            payload.totalGB = parseFloat(totalGbInput.value) || 0;
        }
        
        const expiryInput = document.getElementById('edit-client-expiry');
        if (expiryInput && expiryInput.value) {
            const gregorian = shamsiToGregorian(expiryInput.value);
            if (gregorian) {
                payload.expiryTime = new Date(gregorian).getTime();
            } else {
                payload.expiryTime = new Date(expiryInput.value).getTime();
            }
        } else if (expiryInput) {
            payload.expiryTime = 0;
        }

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${encodeURIComponent(oldEmail)}/edit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client updated successfully');
                closeEditClientModal();
                queueSilentServerRefresh(serverId);
            } else {
                showToast(result.error || 'Error updating client', 'error');
            }
        } catch (error) {
            showToast('Error updating client', 'error');
        }
    }

    function toggleOverview() {
        const stats = document.getElementById('overview-stats');
        const toggle = document.querySelector('.overview-toggle');
        stats.classList.toggle('show');
        toggle.classList.toggle('active');
    }

    function formatTehranTime(ts) {
        if (!ts || ts <= 0) return '';
        const d = new Date(Number(ts));
        if (Number.isNaN(d.getTime())) return '';
        return d.toLocaleTimeString('en-GB', { timeZone: 'Asia/Tehran', hour12: false });
    }

    function openDeleteClientModal(serverId, inboundId, email, uuid, enable, expiry, expiryTs, up, down, total, remaining) {
        document.getElementById('delete-client-server-id').value = serverId;
        document.getElementById('delete-client-inbound-id').value = inboundId;
        document.getElementById('delete-client-email-hidden').value = email;
        
        document.getElementById('delete-client-email').textContent = email;
        document.getElementById('delete-client-uuid').textContent = uuid;
        
        const statusEl = document.getElementById('delete-client-status');
        statusEl.innerHTML = enable 
            ? '<span class="client-status active">Enabled</span>' 
            : '<span class="client-status inactive">Disabled</span>';

        const expiryTimeText = formatTehranTime(expiryTs);
        document.getElementById('delete-client-expiry').innerHTML = expiryTimeText
            ? `${expiry}<div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px;">${expiryTimeText} (Asia/Tehran)</div>`
            : expiry;
        document.getElementById('delete-client-traffic').innerHTML = `<span class="up">↑${up}</span> <span class="down">↓${down}</span>`;
        document.getElementById('delete-client-volume').innerHTML = `<span class="remaining">${remaining}</span> <span class="total">/ ${total}</span>`;
        
        document.getElementById('delete-client-modal').classList.remove('hidden');
    }

    function closeDeleteClientModal() {
        document.getElementById('delete-client-modal').classList.add('hidden');
    }

    async function submitDeleteClient() {
        const serverId = document.getElementById('delete-client-server-id').value;
        const inboundId = document.getElementById('delete-client-inbound-id').value;
        const email = document.getElementById('delete-client-email-hidden').value;

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${encodeURIComponent(email)}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client deleted successfully');
                closeDeleteClientModal();
                queueSilentServerRefresh(serverId);
            } else {
                showToast(result.error || 'Error deleting client', 'error');
            }
        } catch (error) {
            showToast('Error deleting client', 'error');
        }
    }
</script>
{% endblock %}
