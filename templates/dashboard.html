{% extends "base.html" %}

{% block title %}Dashboard - X-UI{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header_actions %}
<div class="header-controls">
    {% if role == 'reseller' %}
    <div class="credit-badge" style="background: rgba(34, 197, 94, 0.2); color: #4ade80; padding: 8px 15px; border-radius: 12px; font-weight: bold; border: 1px solid rgba(34, 197, 94, 0.3);">
        üí∞ Credit: {{ credit }}
    </div>
    {% endif %}

    <label class="toggle-switch" title="Auto Refresh">
        <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
        <span class="slider"></span>
    </label>
    <select id="refresh-interval" class="interval-select" onchange="updateRefreshInterval()">
        <option value="10">10s</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
        <option value="120">2 min</option>
        <option value="300">5 min</option>
    </select>
    <button class="btn btn-primary" onclick="refreshData()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Refresh
    </button>
    <button class="btn btn-success" onclick="openAddClientModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"></path>
        </svg>
        Add Client
    </button>
</div>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon purple">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Servers</span>
            <span class="stat-value" id="stat-servers">{{ server_count }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Inbounds</span>
            <span class="stat-value" id="stat-inbounds">0</span>
            <span class="stat-sub" id="stat-active">0 Active</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Clients</span>
            <span class="stat-value" id="stat-total-clients">0</span>
            <div class="client-breakdown">
                <span class="client-count active-count"><span id="stat-active-clients">0</span></span>
                <span class="client-count inactive-count"><span id="stat-inactive-clients">0</span></span>
            </div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
        </div>
        <div class="stat-info">
            <span class="stat-label">Total Traffic</span>
            <span class="stat-value" id="stat-traffic">0 B</span>
            <span class="stat-sub"><span id="stat-upload">‚Üë 0 B</span> / <span id="stat-download">‚Üì 0 B</span></span>
        </div>
    </div>
</div>

<div class="inbounds-section">
    <div class="section-header">
        <h2>Inbounds</h2>
        <span class="badge" id="inbounds-count">0 total</span>
    </div>
    <div style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="global-search-input" placeholder="Search clients by email across all servers..." class="form-input" style="flex: 1; padding: 10px 12px;">
            <button class="btn btn-secondary" onclick="clearSearch()" id="clear-search-btn" style="display: none;">Clear</button>
        </div>
        <div id="search-results" style="display: none; margin-top: 10px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; font-size: 14px;">
            <span id="search-results-text"></span>
        </div>
    </div>
    <div class="inbounds-list" id="inbounds-container">
        <div class="empty-state" id="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
            </svg>
            <h3>No servers added</h3>
            <p>Add your X-UI server to see statistics.</p>
            <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="server-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="server-modal-title">Servers</h2>
            <button class="modal-close" onclick="closeServerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="server-form">
                <h3 id="form-title">Add Server</h3>
                <input type="hidden" id="edit-server-id">
                <div class="form-group">
                    <label>Server Name</label>
                    <input type="text" id="server-name" placeholder="Server 1">
                </div>
                <div class="form-group">
                    <label>Panel URL</label>
                    <input type="text" id="server-host" placeholder="http://1.2.3.4:54321">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="server-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="server-password" placeholder="password">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 2;">
                        <label>Sub Path</label>
                        <input type="text" id="server-sub-path" placeholder="/sub/" value="/sub/">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Json Path</label>
                        <input type="text" id="server-json-path" placeholder="/json/" value="/json/">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Sub Port</label>
                        <input type="number" id="server-sub-port" placeholder="Default">
                    </div>
                </div>
                <div class="form-group">
                    <label>Panel Type</label>
                    <select id="server-panel-type" class="form-select">
                        <option value="auto">Auto Detect</option>
                        <option value="sanaei">3X-UI (Sanaei)</option>
                        <option value="alireza">X-UI (Alireza)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="testServerConnection()">Test Connection</button>
                    <button class="btn btn-primary" onclick="saveServer()">Save</button>
                </div>
            </div>
            
            <div class="server-list-section">
                <h3>Servers</h3>
                <div class="server-list" id="server-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="qr-modal">
    <div class="modal modal-xl">
        <div class="modal-header">
            <h2>QR Codes - <span id="qr-email" class="qr-email"></span></h2>
            <button class="modal-close" onclick="closeQrModal()">&times;</button>
        </div>
        <div class="modal-body qr-body" style="padding: 15px;">
            <div class="qr-grid">
                
                <div class="qr-item ripple" id="box-sub" onclick="copyText('input-sub', 'img-sub', 'Subscription')">
                    <div class="qr-title">Subscription</div>
                    <img id="img-sub" src="" alt="Sub QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-sub">
                </div>

                <div class="qr-item ripple" id="box-json" onclick="copyText('input-json', 'img-json', 'Subscription JSON')">
                    <div class="qr-title">Subscription JSON</div>
                    <img id="img-json" src="" alt="Json QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-json">
                </div>

                <div class="qr-item ripple" id="box-config" onclick="copyText('input-config', 'img-config', 'Direct Link')">
                    <div class="qr-title" id="title-config">Direct Link</div>
                    <img id="img-config" src="" alt="Config QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-config">
                </div>

                <div class="qr-item ripple" id="box-dash" onclick="copyText('input-dash', 'img-dash', 'Dash Sub')">
                    <div class="qr-title">Dash Sub</div>
                    <img id="img-dash" src="" alt="Dash QR">
                    <div class="click-hint">Tap to Copy</div>
                    <input type="hidden" id="input-dash">
                </div>
                
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="expanded-qr-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2 id="expanded-qr-title">QR Code</h2>
            <button class="modal-close" onclick="closeExpandedQr()">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center; padding: 20px;">
            <img id="expanded-qr-img" src="" alt="QR" style="max-width: 300px; width: 100%; height: auto; background: white; padding: 10px; border-radius: 8px;">
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="renew-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Renew Client</h2>
            <button class="modal-close" onclick="closeRenewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="renew-server-id">
            <input type="hidden" id="renew-inbound-id">
            <input type="hidden" id="renew-email">
            
            <p class="renew-info">Renew Client: <strong id="renew-client-email"></strong></p>
            
            <div class="form-group">
                <label>Days</label>
                <input type="number" id="renew-days" value="30" min="1" max="365" class="form-input">
            </div>
            
            <div class="form-group">
                <label>Volume (GB) (0 = Unlimited)</label>
                <input type="number" id="renew-volume" value="0" min="0" max="10000" class="form-input">
            </div>
            
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="renew-start-after-first-use">
                    <span>Start after first use</span>
                </label>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeRenewModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitRenewal()">Renew</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="add-client-modal">
    <div class="modal modal-md">
        <div class="modal-header">
            <h2>Purchase New Service</h2>
            <button class="modal-close" onclick="closeAddClientModal()">&times;</button>
        </div>
        <div class="modal-body">
            
            <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                <button class="tab-btn active" onclick="switchAddMode('package')" id="btn-mode-package" style="padding: 10px; border-bottom: 2px solid var(--primary); color: white; background: none; cursor: pointer;">üì¶ Buy Package</button>
                <button class="tab-btn" onclick="switchAddMode('custom')" id="btn-mode-custom" style="padding: 10px; color: var(--text-secondary); background: none; border-bottom: 2px solid transparent; cursor: pointer;">‚öôÔ∏è Custom Plan</button>
            </div>

            <div class="form-group">
                <label>Username / Email</label>
                <input type="text" id="add-client-email" class="form-input" placeholder="user1">
            </div>
            
            <div class="form-group">
                <label>Server & Inbound</label>
                <select id="add-client-server-select" class="form-select" onchange="onServerSelected()" style="margin-bottom: 5px;"></select>
                <select id="add-client-inbound-select" class="form-select"></select>
            </div>

            <div id="section-package">
                <div class="form-group">
                    <label>Select Package</label>
                    <div id="packages-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 200px; overflow-y: auto;">
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading packages...</div>
                    </div>
                </div>
            </div>

            <div id="section-custom" class="hidden">
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex:1">
                        <label>Duration (Days)</label>
                        <input type="number" id="custom-days" class="form-input" value="30" oninput="calculateCustomPrice()">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Volume (GB)</label>
                        <input type="number" id="custom-volume" class="form-input" value="10" oninput="calculateCustomPrice()">
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                    Calculated Cost: <strong id="custom-price-display" style="color: #fbbf24;">0</strong> Toman
                </div>
            </div>
            
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="add-client-start-after-first-use">
                    <span>Start after first use</span>
                </label>
            </div>

            <div class="form-footer" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div style="font-size: 0.9rem;">
                    Wallet: <span style="color: #4ade80;">{{ credit if credit else 0 }} T</span>
                </div>
                <button class="btn btn-primary" onclick="submitAddClient()">
                    Pay & Create
                </button>
            </div>

        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="assign-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Assign to Reseller</h2>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Client: <strong id="assign-client-email" style="color: var(--text-primary);"></strong></p>
            <input type="hidden" id="assign-server-id">
            <input type="hidden" id="assign-client-email-hidden">
            
            <div class="form-group">
                <label>Select Reseller</label>
                <select id="assign-reseller-select" class="form-select">
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAssignment()">Assign</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let autoRefreshInterval = null;
    let currentLink = '';
    let inboundsData = [];
    let allInboundsData = [];

    const IS_SUPERADMIN = {{ 'true' if is_superadmin else 'false' }};
    const USER_ROLE = "{{ role }}";
    let currentMode = 'package';
    let selectedPackageId = null;
    const BASE_COST_DAY = {{ base_cost_day|default(0) }};
    const BASE_COST_GB = {{ base_cost_gb|default(0) }};

    document.addEventListener('DOMContentLoaded', function() {
        showLoading();
        refreshData(true).then(() => hideLoading());
        loadServers();
        document.getElementById('global-search-input').addEventListener('input', performGlobalSearch);
        if (IS_SUPERADMIN) loadResellersForModal();
    });

    function toggleAutoRefresh() {
        const toggle = document.getElementById('auto-refresh-toggle');
        
        if (toggle.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    }

    function updateRefreshInterval() {
        if (document.getElementById('auto-refresh-toggle').checked) {
            startAutoRefresh();
        }
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        const interval = parseInt(document.getElementById('refresh-interval').value) * 1000;
        autoRefreshInterval = setInterval(() => refreshData(true), interval);
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    async function refreshData(isSilent = false) {
        const refreshBtn = document.querySelector('.header-controls .btn-primary');
        
        if (!isSilent) {
            if (refreshBtn) {
                if (!refreshBtn.dataset.originalContent) {
                    refreshBtn.dataset.originalContent = refreshBtn.innerHTML;
                }
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; border-color: rgba(255,255,255,0.2); border-top-color: white;"></div> Refreshing';
            } else {
                showLoading();
            }
        }
        
        try {
            const response = await fetch('/api/refresh');
            const data = await response.json();
            
            if (data.success) {
                updateStats(data.stats, data.server_count);
                updateInbounds(data.inbounds);
                inboundsData = data.inbounds;
                
                const failedServers = data.servers?.filter(s => !s.success) || [];
                if (failedServers.length > 0) {
                    const errors = failedServers.map(s => `${s.server_name}: ${s.error}`).join(', ');
                    showToast('Server errors: ' + errors, 'error');
                }
                if (!isSilent) showToast('Data updated successfully');
            } else {
                if (!isSilent) showToast('Error loading data', 'error');
            }
        } catch (error) {
            console.error('Refresh error:', error);
            if (!isSilent) showToast('Error updating: ' + error.message, 'error');
        } finally {
            if (!isSilent) {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = refreshBtn.dataset.originalContent;
                } else {
                    hideLoading();
                }
            }
            hideLoading();
        }
    }

    function updateStats(stats, serverCount) {
        document.getElementById('stat-servers').textContent = serverCount || 0;
        document.getElementById('stat-inbounds').textContent = stats?.total_inbounds || 0;
        document.getElementById('stat-active').textContent = `${stats?.active_inbounds || 0} Active`;
        document.getElementById('stat-total-clients').textContent = stats?.total_clients || 0;
        document.getElementById('stat-active-clients').textContent = stats?.active_clients || 0;
        document.getElementById('stat-inactive-clients').textContent = stats?.inactive_clients || 0;
        document.getElementById('stat-traffic').textContent = stats?.total_traffic || '0 B';
        document.getElementById('stat-upload').textContent = `‚Üë ${stats?.total_upload || '0 B'}`;
        document.getElementById('stat-download').textContent = `‚Üì ${stats?.total_download || '0 B'}`;
    }

    function getExpiryClass(type) {
        switch(type) {
            case 'expired': return 'expiry-expired';
            case 'today': return 'expiry-today';
            case 'soon': return 'expiry-soon';
            case 'start_after_use': return 'expiry-start-after';
            default: return '';
        }
    }

    function updateInbounds(inbounds) {
        const container = document.getElementById('inbounds-container');
        document.getElementById('inbounds-count').textContent = `${inbounds.length} total`;
        
        if (inbounds.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                    </svg>
                    <h3>No servers added</h3>
                    <p>Add your X-UI server to see statistics.</p>
                    <button class="btn btn-primary" onclick="openServerModal()">Add Server</button>
                </div>`;
            return;
        }
        
        container.innerHTML = inbounds.map(inbound => `
            <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                <div class="inbound-header">
                    <div class="inbound-title">
                        <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                        <h3>${inbound.remark}</h3>
                        <span class="port-badge">:${inbound.port}</span>
                        <span class="server-badge">${inbound.server_name}</span>
                    </div>
                    <div class="inbound-status">
                        ${inbound.enable 
                            ? `<span class="status-pill active">Active</span>` 
                            : `<span class="status-pill inactive">Inactive</span>`}
                    </div>
                </div>
                
                <div class="inbound-meta-compact">
                    <span class="meta-tag"><span class="label">Network:</span> <span class="value">${inbound.network}</span></span>
                    <span class="meta-tag"><span class="label">Security:</span> <span class="value">${inbound.security}</span></span>
                    <span class="meta-tag"><span class="label">Clients:</span> <span class="value">${inbound.client_count}</span></span>
                    <span class="meta-tag traffic"><span class="label">Traffic:</span> <span class="up">‚Üë${inbound.total_up}</span> <span class="down">‚Üì${inbound.total_down}</span></span>
                </div>

                ${inbound.clients.length > 0 ? `
                <div class="clients-section">
                    <button class="toggle-clients" onclick="toggleClients(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        Show Clients (${inbound.clients.length})
                    </button>
                    <div class="clients-list hidden">
                        <div class="clients-table-wrapper">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Traffic</th>
                                        <th>Volume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td class="email-cell">${client.email}</td>
                                        <td>
                                            ${client.enable 
                                                ? `<span class="client-status active">Enabled</span>` 
                                                : `<span class="client-status inactive">Disabled</span>`}
                                        </td>
                                        <td>
                                            <span class="expiry-badge ${getExpiryClass(client.expiryType)}">${client.expiryTime}</span>
                                        </td>
                                        <td class="traffic-cell">
                                            <div class="traffic-combined-cell">
                                                <span class="up">‚Üë${client.up}</span>
                                                <span class="down">‚Üì${client.down}</span>
                                            </div>
                                        </td>
                                        <td class="volume-cell">
                                            <div class="volume-info">
                                                <span class="remaining">${client.remaining_formatted}</span>
                                                <span class="total">/ ${client.totalGB_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn" onclick="showQrCode('${encodeURIComponent(client.link || '')}', '${client.email}', '${client.sub_url || ''}', '${client.json_url || ''}', '${client.dash_sub_url || ''}')" title="QR Code">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="3" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="3" width="7" height="7"></rect>
                                                        <rect x="14" y="14" width="7" height="7"></rect>
                                                        <rect x="3" y="14" width="7" height="7"></rect>
                                                    </svg>
                                                </button>
                                                <button class="action-btn" onclick="copyClientLink('${encodeURIComponent(client.link || '')}')" title="Copy Link">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                    </svg>
                                                </button>
                                                <button class="action-btn renew" onclick="openRenewModal(${client.server_id}, ${client.inbound_id}, '${client.email}')" title="Renew">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${client.server_id}, ${client.inbound_id}, '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="resetClientTraffic(${client.server_id}, ${client.inbound_id}, '${client.email}')" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `).join('');
    }

    function toggleClients(btn) {
        const clientsList = btn.nextElementSibling;
        const isHidden = clientsList.classList.contains('hidden');
        clientsList.classList.toggle('hidden');
        
        const count = clientsList.querySelectorAll('tbody tr').length;
        btn.innerHTML = isHidden 
            ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg> Hide Clients (${count})`
            : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg> Show Clients (${count})`;
    }

    async function showQrCode(encodedLink, email, subUrl, jsonUrl, dashSubUrl) {
        const link = decodeURIComponent(encodedLink);
        document.getElementById('qr-email').textContent = email;
        document.getElementById('title-config').textContent = email;
        
        document.getElementById('input-sub').value = subUrl || '';
        document.getElementById('input-json').value = jsonUrl || '';
        document.getElementById('input-config').value = link || '';
        document.getElementById('input-dash').value = dashSubUrl || '';
        
        try {
            // Generate Config QR
            if (link) {
                const configResp = await fetch(`/api/client/qrcode?link=${encodedLink}`);
                const configData = await configResp.json();
                if (configData.success) {
                    document.getElementById('img-config').src = configData.qrcode;
                    document.getElementById('box-config').style.display = 'flex';
                }
            }
            
            // Generate Subscription QR
            if (subUrl && subUrl !== 'undefined' && subUrl !== 'null') {
                const subResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(subUrl)}`);
                const subData = await subResp.json();
                if (subData.success) {
                    document.getElementById('img-sub').src = subData.qrcode;
                    document.getElementById('box-sub').style.display = 'flex';
                }
            } else {
                document.getElementById('box-sub').style.display = 'none';
            }
            
            // Generate JSON QR
            if (jsonUrl && jsonUrl !== 'undefined' && jsonUrl !== 'null') {
                const jsonResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(jsonUrl)}`);
                const jsonData = await jsonResp.json();
                if (jsonData.success) {
                    document.getElementById('img-json').src = jsonData.qrcode;
                    document.getElementById('box-json').style.display = 'flex';
                }
            } else {
                document.getElementById('box-json').style.display = 'none';
            }

            // Generate Dash Sub QR
            if (dashSubUrl && dashSubUrl !== 'undefined' && dashSubUrl !== 'null' && dashSubUrl !== '') {
                const dashResp = await fetch(`/api/client/qrcode?link=${encodeURIComponent(dashSubUrl)}`);
                const dashData = await dashResp.json();
                if (dashData.success) {
                    document.getElementById('img-dash').src = dashData.qrcode;
                    document.getElementById('box-dash').style.display = 'flex';
                }
            } else {
                document.getElementById('box-dash').style.display = 'none';
            }
            
            document.getElementById('qr-modal').classList.remove('hidden');
        } catch (error) {
            showToast('Error generating QR Codes: ' + error.message, 'error');
        }
    }
    
    function copyText(elementId, imgId, title) {
        const input = document.getElementById(elementId);
        if (!input.value) return;
        
        navigator.clipboard.writeText(input.value).then(() => {
            showToast('Link copied!');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
        
        // Show expanded QR on mobile only
        if (window.innerWidth <= 768 && imgId) {
            expandQrCode(imgId, title);
        }
    }
    
    function expandQrCode(imgId, title) {
        const img = document.getElementById(imgId);
        if (!img || !img.src) return;
        
        document.getElementById('expanded-qr-title').textContent = title;
        document.getElementById('expanded-qr-img').src = img.src;
        document.getElementById('expanded-qr-modal').classList.remove('hidden');
    }
    
    function closeExpandedQr() {
        document.getElementById('expanded-qr-modal').classList.add('hidden');
    }

    function closeQrModal() {
        document.getElementById('qr-modal').classList.add('hidden');
    }

    async function copyLink() {
        if (!currentLink) {
            showToast('Link not found', 'error');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(currentLink);
            showToast('Link copied');
        } catch (error) {
            showToast('Copy failed', 'error');
        }
    }

    async function copyClientLink(encodedLink) {
        const link = decodeURIComponent(encodedLink);
        if (!link) {
            showToast('Link not found', 'error');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(link);
            showToast('Link copied');
        } catch (error) {
            showToast('Copy failed', 'error');
        }
    }

    async function toggleClient(serverId, inboundId, email, enable) {
        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable: enable })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(enable ? 'Client enabled' : 'Client disabled');
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function resetClientTraffic(serverId, inboundId, email) {
        if (!confirm('Are you sure you want to reset traffic?')) return;
        
        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/reset`, {
                method: 'POST'
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Traffic reset');
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function openRenewModal(serverId, inboundId, email) {
        document.getElementById('renew-server-id').value = serverId;
        document.getElementById('renew-inbound-id').value = inboundId;
        document.getElementById('renew-email').value = email;
        document.getElementById('renew-client-email').textContent = email;
        document.getElementById('renew-days').value = 30;
        document.getElementById('renew-volume').value = 0;
        document.getElementById('renew-start-after-first-use').checked = false;
        document.getElementById('renew-modal').classList.remove('hidden');
    }

    function closeRenewModal() {
        document.getElementById('renew-modal').classList.add('hidden');
    }

    async function submitRenewal() {
        const serverId = document.getElementById('renew-server-id').value;
        const inboundId = document.getElementById('renew-inbound-id').value;
        const email = document.getElementById('renew-email').value;
        const days = parseInt(document.getElementById('renew-days').value);
        const volume = parseInt(document.getElementById('renew-volume').value);
        const startAfterFirstUse = document.getElementById('renew-start-after-first-use').checked;

        if (!days || (volume === '' && volume !== 0)) {
            showToast('Please fill all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/client/${serverId}/${inboundId}/${email}/renew`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    days: days, 
                    volume: volume,
                    start_after_first_use: startAfterFirstUse
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Client renewed');
                closeRenewModal();
                refreshData();
            } else {
                showToast(data.error || 'Error renewing', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    let allServers = [];

    function openAddClientModal() {
        document.getElementById('add-client-server-select').innerHTML = '<option value="">-- Select Server --</option>';
        document.getElementById('add-client-inbound-select').innerHTML = '<option value="">-- Select Inbound --</option>';
        
        if (allServers && allServers.length > 0) {
            allServers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;
                option.textContent = server.name;
                document.getElementById('add-client-server-select').appendChild(option);
            });
        }
        
        document.getElementById('add-client-email').value = '';
        document.getElementById('custom-days').value = 30;
        document.getElementById('custom-volume').value = 10;
        document.getElementById('add-client-start-after-first-use').checked = false;
        currentMode = 'package';
        switchAddMode('package');
        document.getElementById('add-client-modal').classList.remove('hidden');
    }

    function switchAddMode(mode) {
        currentMode = mode;
        document.getElementById('section-package').classList.toggle('hidden', mode !== 'package');
        document.getElementById('section-custom').classList.toggle('hidden', mode !== 'custom');
        
        // Update Tab Styles
        document.getElementById('btn-mode-package').style.borderBottom = mode === 'package' ? '2px solid var(--primary)' : '2px solid transparent';
        document.getElementById('btn-mode-package').style.color = mode === 'package' ? 'white' : 'var(--text-secondary)';
        
        document.getElementById('btn-mode-custom').style.borderBottom = mode === 'custom' ? '2px solid var(--primary)' : '2px solid transparent';
        document.getElementById('btn-mode-custom').style.color = mode === 'custom' ? 'white' : 'var(--text-secondary)';
        
        if (mode === 'package') loadPackages();
        if (mode === 'custom') calculateCustomPrice();
    }

    async function loadPackages() {
        const container = document.getElementById('packages-list');
        try {
            const res = await fetch('/api/packages');
            const pkgs = await res.json();
            
            if (pkgs.length === 0) {
                container.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 10px;">No packages defined</div>';
                return;
            }

            container.innerHTML = pkgs.map(p => `
                <div class="pkg-card" onclick="selectPackage(this, ${p.id})" 
                     style="border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; background: var(--bg-dark);">
                    <div style="font-weight: bold; font-size: 0.9rem;">${p.name}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin: 5px 0;">${p.days} Days / ${p.volume} GB</div>
                    <div style="color: #4ade80; font-weight: bold; font-size: 0.85rem;">${p.price.toLocaleString()} T</div>
                </div>
            `).join('');
        } catch (e) { 
            container.innerHTML = '<div style="grid-column: span 2; color: #ef4444; text-align: center;">Error loading packages</div>'; 
        }
    }

    function selectPackage(el, id) {
        document.querySelectorAll('.pkg-card').forEach(d => {
            d.style.borderColor = 'var(--border-color)';
            d.style.backgroundColor = 'var(--bg-dark)';
        });
        el.style.borderColor = 'var(--primary)';
        el.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
        selectedPackageId = id;
    }

    function calculateCustomPrice() {
        const days = parseInt(document.getElementById('custom-days').value) || 0;
        const vol = parseInt(document.getElementById('custom-volume').value) || 0;
        const total = (days * BASE_COST_DAY) + (vol * BASE_COST_GB);
        document.getElementById('custom-price-display').innerText = total.toLocaleString();
    }

    function onServerSelected() {
        const serverId = document.getElementById('add-client-server-select').value;
        const inboundSelect = document.getElementById('add-client-inbound-select');
        inboundSelect.innerHTML = '<option value="">-- Select Inbound --</option>';
        
        if (!serverId) return;
        
        const serverInbounds = inboundsData.filter(i => i.server_id == serverId);
        if (serverInbounds.length > 0) {
            serverInbounds.forEach(inbound => {
                const option = document.createElement('option');
                option.value = JSON.stringify({
                    server_id: inbound.server_id,
                    inbound_id: inbound.id
                });
                const activeClients = inbound.clients.filter(c => c.enable).length;
                option.textContent = `${inbound.remark} - ${inbound.protocol} (${inbound.port}) [${activeClients}]`;
                inboundSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.textContent = 'No inbounds available';
            option.disabled = true;
            inboundSelect.appendChild(option);
        }
    }

    function closeAddClientModal() {
        document.getElementById('add-client-modal').classList.add('hidden');
    }

    async function submitAddClient() {
        const email = document.getElementById('add-client-email').value.trim();
        const inboundSelect = document.getElementById('add-client-inbound-select');
        const startAfterFirstUse = document.getElementById('add-client-start-after-first-use').checked;
        
        if (!inboundSelect.value) return showToast('Select an inbound', 'error');
        if (!email) return showToast('Enter username', 'error');

        const inboundData = JSON.parse(inboundSelect.value);
        
        const payload = {
            email: email,
            mode: currentMode,
            start_after_first_use: startAfterFirstUse
        };

        if (currentMode === 'package') {
            if (!selectedPackageId) return showToast('Please select a package', 'error');
            payload.package_id = selectedPackageId;
        } else {
            payload.days = document.getElementById('custom-days').value;
            payload.volume = document.getElementById('custom-volume').value;
        }

        const btn = document.querySelector('#add-client-modal .btn-primary');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Processing...';

        try {
            const response = await fetch(`/api/client/${inboundData.server_id}/${inboundData.inbound_id}/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Client created successfully');
                closeAddClientModal();
                refreshData();
            } else {
                showToast(data.error || 'Error creating client', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            const servers = await response.json();
            allServers = servers;
            renderServerList(servers);
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    function renderServerList(servers) {
        const container = document.getElementById('server-list');
        
        if (servers.length === 0) {
            container.innerHTML = '<p class="no-servers">No servers added</p>';
            return;
        }
        
        container.innerHTML = servers.map(server => `
            <div class="server-item ${!server.enabled ? 'disabled' : ''}">
                <div class="server-info">
                    <h4>${server.name}</h4>
                    <p>${server.host}</p>
                </div>
                <div class="server-actions">
                    <button class="action-btn" onclick="editServer(${server.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="action-btn danger" onclick="deleteServer(${server.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function openServerModal() {
        document.getElementById('form-title').textContent = 'Add Server';
        document.getElementById('edit-server-id').value = '';
        document.getElementById('server-name').value = '';
        document.getElementById('server-host').value = '';
        document.getElementById('server-username').value = '';
        document.getElementById('server-password').value = '';
        document.getElementById('server-sub-path').value = '/sub/';
        document.getElementById('server-json-path').value = '/json/';
        document.getElementById('server-sub-port').value = '';
        document.getElementById('server-panel-type').value = 'auto';
        document.getElementById('server-modal').classList.remove('hidden');
        loadServers();
    }

    function closeServerModal() {
        document.getElementById('server-modal').classList.add('hidden');
    }

    function editServer(id) {
        const server = allServers.find(s => s.id === id);
        if (!server) return;
        
        document.getElementById('form-title').textContent = 'Edit Server';
        document.getElementById('edit-server-id').value = server.id;
        document.getElementById('server-name').value = server.name;
        document.getElementById('server-host').value = server.host;
        document.getElementById('server-username').value = server.username;
        document.getElementById('server-sub-path').value = server.sub_path || '/sub/';
        document.getElementById('server-json-path').value = server.json_path || '/json/';
        document.getElementById('server-sub-port').value = server.sub_port || '';
        document.getElementById('server-panel-type').value = server.panel_type;
        document.getElementById('server-modal').classList.remove('hidden');
    }

    async function testServerConnection() {
        const id = document.getElementById('edit-server-id').value;
        
        if (!id) {
            showToast('Save server first', 'error');
            return;
        }

        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value,
            sub_path: document.getElementById('server-sub-path').value,
            json_path: document.getElementById('server-json-path').value
        };

        if (!data.host || !data.username || !data.password) {
            showToast('Please fill all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/servers/${id}/test`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(`Connection successful - Panel Type: ${result.panel_type === 'sanaei' ? '3X-UI' : result.panel_type === 'alireza' ? 'X-UI' : 'Unknown'}`);
            } else {
                showToast(result.error || 'Connection failed', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function saveServer() {
        const id = document.getElementById('edit-server-id').value;
        const data = {
            name: document.getElementById('server-name').value,
            host: document.getElementById('server-host').value,
            username: document.getElementById('server-username').value,
            password: document.getElementById('server-password').value,
            panel_type: document.getElementById('server-panel-type').value,
            sub_path: document.getElementById('server-sub-path').value,
            json_path: document.getElementById('server-json-path').value,
            sub_port: document.getElementById('server-sub-port').value
        };

        if (!data.name || !data.host || !data.username || !data.password) {
            showToast('All fields are required', 'error');
            return;
        }

        try {
            const url = id ? `/api/servers/${id}` : '/api/servers';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(id ? 'Server updated' : 'Server added');
                closeServerModal();
                loadServers();
                refreshData();
            } else {
                showToast(result.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function deleteServer(id) {
        if (!confirm('Are you sure you want to delete this server?')) return;
        
        try {
            const response = await fetch(`/api/servers/${id}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                showToast('Server deleted');
                loadServers();
                refreshData();
            } else {
                showToast(data.error || 'Error', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function performGlobalSearch() {
        const searchInput = document.getElementById('global-search-input');
        const query = searchInput.value.trim().toLowerCase();
        
        if (query.length === 0) {
            clearSearch();
            return;
        }
        
        try {
            const response = await fetch(`/api/clients/search?email=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.success && data.results.length > 0) {
                displaySearchResults(data.results, query);
            } else {
                displaySearchResults([], query);
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    }

    function displaySearchResults(results, query) {
        const searchResultsDiv = document.getElementById('search-results');
        const searchResultsText = document.getElementById('search-results-text');
        const clearBtn = document.getElementById('clear-search-btn');
        
        if (results.length === 0) {
            searchResultsDiv.style.display = 'block';
            searchResultsText.textContent = `No clients found matching "${query}"`;
            clearBtn.style.display = 'inline-block';
            updateInboundsFiltered([]);
            return;
        }
        
        searchResultsDiv.style.display = 'block';
        searchResultsText.textContent = `Found ${results.length} client(s) matching "${query}"`;
        clearBtn.style.display = 'inline-block';
        
        updateInboundsFiltered(results);
    }

    function updateInboundsFiltered(filteredResults) {
        if (filteredResults.length === 0) {
            const container = document.getElementById('inbounds-container');
            container.innerHTML = `<div class="empty-state"><h3>No results</h3></div>`;
            return;
        }
        
        const container = document.getElementById('inbounds-container');
        const inboundsToShow = [];
        
        filteredResults.forEach(result => {
            const existing = inboundsToShow.find(i => i.id === result.inbound_id && i.server_id === result.server_id);
            if (existing) {
                existing.clients.push(result.client);
            } else {
                inboundsToShow.push({
                    id: result.inbound_id,
                    server_id: result.server_id,
                    server_name: result.server_name,
                    remark: result.inbound.remark,
                    protocol: result.inbound.protocol,
                    port: result.inbound.port,
                    enable: result.inbound.enable,
                    network: 'tcp',
                    security: 'tls',
                    client_count: 1,
                    total_up: '0 B',
                    total_down: '0 B',
                    clients: [result.client]
                });
            }
        });
        
        const html = inboundsToShow.map(inbound => `
            <div class="inbound-card ${!inbound.enable ? 'disabled' : ''}">
                <div class="inbound-header">
                    <div class="inbound-title">
                        <span class="protocol-badge ${inbound.protocol.toLowerCase()}">${inbound.protocol}</span>
                        <h3>${inbound.remark}</h3>
                        <span class="port-badge">:${inbound.port}</span>
                        <span class="server-badge">${inbound.server_name}</span>
                    </div>
                </div>
                ${inbound.clients.length > 0 ? `
                <div class="clients-section">
                    <div class="clients-list">
                        <div class="clients-table-wrapper">
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Traffic</th>
                                        <th>Volume</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inbound.clients.map(client => `
                                    <tr class="${!client.enable ? 'disabled-row' : ''}">
                                        <td class="email-cell">${client.email}</td>
                                        <td>
                                            ${client.enable 
                                                ? `<span class="client-status active">Enabled</span>` 
                                                : `<span class="client-status inactive">Disabled</span>`}
                                        </td>
                                        <td>
                                            <span class="expiry-badge ${getExpiryClass(client.expiryType)}">${client.expiryTime}</span>
                                        </td>
                                        <td class="traffic-cell">
                                            <div class="traffic-combined-cell">
                                                <span class="up">${client.upload}</span>
                                                <span class="down">${client.download}</span>
                                            </div>
                                        </td>
                                        <td class="volume-cell">
                                            <div class="volume-info">
                                                <span class="remaining">${client.remaining_formatted}</span>
                                                <span class="total">/ ${client.totalGB_formatted}</span>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-buttons">
                                                <button class="action-btn renew" onclick="openRenewModal(${inbound.server_id}, '${inbound.id}', '${client.email}')" title="Renew">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </button>
                                                <button class="action-btn ${client.enable ? 'danger' : 'success'}" onclick="toggleClient(${inbound.server_id}, '${inbound.id}', '${client.email}', ${!client.enable})" title="${client.enable ? 'Disable' : 'Enable'}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        ${client.enable 
                                                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>'
                                                            : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'}
                                                    </svg>
                                                </button>
                                                <button class="action-btn warning" onclick="resetClientTraffic(${inbound.server_id}, '${inbound.id}', '${client.email}')" title="Reset Traffic">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="1 4 1 10 7 10"></polyline>
                                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                                    </svg>
                                                </button>
                                                ${IS_SUPERADMIN ? `<button class="action-btn" onclick="openAssignModal(${inbound.server_id}, '${client.email}', '${inbound.id}')" title="Assign Owner">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="10" cy="7" r="4"></circle><path d="M22 11h-2.5a2.5 2.5 0 0 0 0 5H22"></path>
                                                    </svg>
                                                </button>` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `).join('');
        
        container.innerHTML = html;
    }

    function clearSearch() {
        document.getElementById('global-search-input').value = '';
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('clear-search-btn').style.display = 'none';
        refreshData();
    }

    async function loadResellersForModal() {
        try {
            const response = await fetch('/api/admins');
            const admins = await response.json();
            const resellers = admins.filter(a => a.role === 'reseller');
            const select = document.getElementById('assign-reseller-select');
            select.innerHTML = '<option value="">Select Reseller</option>' + 
                resellers.map(r => `<option value="${r.id}">${r.username} (Credit: ${r.credit})</option>`).join('');
        } catch (error) {
            console.error('Error loading resellers:', error);
        }
    }

    function openAssignModal(serverId, email, inboundId = 0) {
        document.getElementById('assign-server-id').value = serverId;
        document.getElementById('assign-client-email-hidden').value = email;
        document.getElementById('assign-client-email').textContent = email;
        document.getElementById('assign-modal').classList.remove('hidden');
    }

    function closeAssignModal() {
        document.getElementById('assign-modal').classList.add('hidden');
    }

    async function submitAssignment() {
        const serverId = document.getElementById('assign-server-id').value;
        const email = document.getElementById('assign-client-email-hidden').value;
        const resellerId = document.getElementById('assign-reseller-select').value;

        if (!resellerId) {
            showToast('Please select a reseller', 'error');
            return;
        }

        try {
            const response = await fetch('/api/assign-client', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    server_id: parseInt(serverId),
                    email: email,
                    reseller_id: parseInt(resellerId)
                })
            });

            const result = await response.json();
            if (result.success) {
                showToast('Client assigned successfully');
                closeAssignModal();
                refreshData();
            } else {
                showToast(result.error || 'Error assigning client', 'error');
            }
        } catch (error) {
            showToast('Error assigning client', 'error');
        }
    }
</script>
{% endblock %}
