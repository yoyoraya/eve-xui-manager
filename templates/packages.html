{% extends "base.html" %}

{% block title %}Packages & Pricing{% endblock %}
{% block page_title %}ŸÖÿØ€åÿ±€åÿ™ ÿ®ÿ≥ÿ™Ÿá‚ÄåŸáÿß Ÿà ÿ™ÿπÿ±ŸÅŸá‚ÄåŸáÿß{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
    
    <div class="server-card">
        <div class="server-header">
            <div class="server-title">
                <h3>‚öôÔ∏è Base Tariffs (Custom Plans)</h3>
            </div>
        </div>
        <div style="padding: 20px;">
            <div class="form-group">
                <label>Price per GB (Toman)</label>
                <input type="number" id="conf-cost-gb" class="form-input" value="{{ base_cost_gb }}">
            </div>
            <div class="form-group">
                <label>Price per Day (Toman)</label>
                <input type="number" id="conf-cost-day" class="form-input" value="{{ base_cost_day }}">
            </div>
            <button class="btn btn-primary" onclick="saveConfig()" style="width: 100%; margin-top: 10px;">Save Tariffs</button>
        </div>
    </div>

    <div class="server-card">
        <div class="server-header">
            <div class="server-title">
                <h3>üì¶ Ready Packages</h3>
            </div>
            <div class="server-actions">
                <button class="btn btn-success btn-sm" onclick="document.getElementById('pkg-modal').classList.remove('hidden')">+ Add Package</button>
            </div>
        </div>
        <div style="padding: 20px;">
            <div id="packages-list" class="servers-grid" style="grid-template-columns: 1fr; gap: 10px;">
                </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="pkg-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2>Add New Package</h2>
            <button class="modal-close" onclick="document.getElementById('pkg-modal').classList.add('hidden')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group"><label>Package Name</label><input type="text" id="pkg-name" class="form-input" placeholder="e.g., 1 Month 30GB"></div>
            <div class="form-group"><label>Duration (Days)</label><input type="number" id="pkg-days" class="form-input" placeholder="30"></div>
            <div class="form-group"><label>Volume (GB)</label><input type="number" id="pkg-vol" class="form-input" placeholder="30"></div>
            <div class="form-group"><label>Price (Toman)</label><input type="number" id="pkg-price" class="form-input" placeholder="100000"></div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="document.getElementById('pkg-modal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary" onclick="createPackage()">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadPackages);

    async function loadPackages() {
        try {
            const res = await fetch('/api/packages');
            const data = await res.json();
            const container = document.getElementById('packages-list');
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No packages defined.</p>';
                return;
            }

            container.innerHTML = data.map(p => `
                <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color);">
                    <div>
                        <strong style="font-size: 1.1rem; color: var(--text-primary);">${p.name}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                            ‚è≥ ${p.days} Days | üíæ ${p.volume} GB
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #4ade80; font-weight: bold;">${p.price.toLocaleString()} T</div>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    async function createPackage() {
        const data = {
            name: document.getElementById('pkg-name').value,
            days: document.getElementById('pkg-days').value,
            volume: document.getElementById('pkg-vol').value,
            price: document.getElementById('pkg-price').value
        };
        
        try {
            const res = await fetch('/admin/packages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                showToast('Package created successfully');
                document.getElementById('pkg-modal').classList.add('hidden');
                loadPackages();
            } else {
                showToast('Error creating package', 'error');
            }
        } catch (e) { showToast('Connection error', 'error'); }
    }

    async function saveConfig() {
        const data = {
            cost_per_gb: document.getElementById('conf-cost-gb').value,
            cost_per_day: document.getElementById('conf-cost-day').value
        };
        try {
            await fetch('/admin/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            showToast('Configuration saved');
        } catch (e) { showToast('Error saving config', 'error'); }
    }
</script>
{% endblock %}
