{% extends "base.html" %}

{% block title %}Packages & Pricing{% endblock %}
{% block page_title %}Package & Tariff Management{% endblock %}

{% block content %}
<div class="packages-layout">
    
    <div class="server-card">
        <div class="server-header">
            <div class="server-title">
                <h3>‚öôÔ∏è Base Tariffs (Custom Plans)</h3>
            </div>
        </div>
        <div style="padding: 20px;">
            <div class="form-group">
                <label>Price per GB (Toman)</label>
                <input type="text" id="conf-cost-gb" class="form-input" value="{{ '{:,}'.format(base_cost_gb) }}" oninput="formatNumberInput(this)">
            </div>
            <div class="form-group">
                <label>Price per Day (Toman)</label>
                <input type="text" id="conf-cost-day" class="form-input" value="{{ '{:,}'.format(base_cost_day) }}" oninput="formatNumberInput(this)">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-block" onclick="saveConfig()">Save Tariffs</button>
            </div>
        </div>
    </div>

    <div class="server-card">
        <div class="server-header">
            <div class="server-title">
                <h3>üì¶ Ready Packages</h3>
            </div>
            <div class="server-actions">
                <button class="btn btn-success btn-full-mobile" type="button" onclick="openPackageModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>Add Package</span>
                </button>
            </div>
        </div>
        <div style="padding: 20px;">
            <div id="packages-list" class="servers-grid" style="grid-template-columns: 1fr; gap: 10px;">
                </div>
        </div>
    </div>
</div>

<style>
    .packages-layout {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
    }

    @media (max-width: 768px) {
        .packages-layout {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="modal-overlay hidden" id="pkg-modal">
    <div class="modal modal-sm">
        <div class="modal-header">
            <h2 id="pkg-modal-title">Add New Package</h2>
            <button class="modal-close" type="button" onclick="closePackageModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group"><label>Package Name</label><input type="text" id="pkg-name" class="form-input" placeholder="e.g., 1 Month 30GB"></div>
            <div class="form-group"><label>Duration (Days)</label><input type="number" id="pkg-days" class="form-input" placeholder="30"></div>
            <div class="form-group"><label>Volume (GB)</label><input type="number" id="pkg-vol" class="form-input" placeholder="30"></div>
            <div class="form-group"><label>Price (Toman)</label><input type="text" id="pkg-price" class="form-input" placeholder="100,000" oninput="formatNumberInput(this)"></div>
            <div class="form-actions">
                <button class="btn btn-secondary" type="button" onclick="closePackageModal()">Cancel</button>
                <button class="btn btn-primary" id="pkg-submit-btn" type="button" onclick="submitPackage()">Create Package</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
    let packageCache = [];
    let editingPackageId = null;

    document.addEventListener('DOMContentLoaded', loadPackages);

    async function loadPackages() {
        try {
            const res = await fetch('/api/packages');
            const data = await res.json();
            const container = document.getElementById('packages-list');
            packageCache = data;
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No packages defined.</p>';
                return;
            }

            container.innerHTML = data.map(p => `
                <div class="package-card">
                    <div class="package-info">
                        <strong>${p.name}</strong>
                        <span>‚è≥ ${p.days} Days | üíæ ${p.volume} GB</span>
                    </div>
                    <div class="package-meta">
                        <div class="package-price">${Number(p.price).toLocaleString()} T</div>
                        <div class="package-actions">
                            <button class="action-icon" type="button" title="Edit package" onclick="startEditPackage(${p.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20h9" />
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z" />
                                </svg>
                            </button>
                            <button class="action-icon danger" type="button" title="Delete package" onclick="deletePackage(${p.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6" />
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    function openPackageModal(pkg = null) {
        editingPackageId = pkg ? pkg.id : null;
        document.getElementById('pkg-modal-title').textContent = editingPackageId ? 'Edit Package' : 'Add New Package';
        document.getElementById('pkg-submit-btn').textContent = editingPackageId ? 'Update Package' : 'Create Package';
        document.getElementById('pkg-name').value = pkg ? pkg.name : '';
        document.getElementById('pkg-days').value = pkg ? pkg.days : '';
        document.getElementById('pkg-vol').value = pkg ? pkg.volume : '';
        document.getElementById('pkg-price').value = pkg ? Number(pkg.price).toLocaleString() : '';
        document.getElementById('pkg-modal').classList.remove('hidden');
    }

    function closePackageModal() {
        editingPackageId = null;
        document.getElementById('pkg-modal-title').textContent = 'Add New Package';
        document.getElementById('pkg-submit-btn').textContent = 'Create Package';
        document.getElementById('pkg-name').value = '';
        document.getElementById('pkg-days').value = '';
        document.getElementById('pkg-vol').value = '';
        document.getElementById('pkg-price').value = '';
        document.getElementById('pkg-modal').classList.add('hidden');
    }

    function startEditPackage(id) {
        const pkg = packageCache.find(item => item.id === id);
        if (!pkg) return;
        openPackageModal(pkg);
    }

    async function submitPackage() {
        const data = {
            name: document.getElementById('pkg-name').value,
            days: document.getElementById('pkg-days').value,
            volume: document.getElementById('pkg-vol').value,
            price: unformatNumber(document.getElementById('pkg-price').value)
        };
        
        if (!data.name || !data.days || !data.volume || !data.price) {
            showToast('Please fill out all package fields', 'error');
            return;
        }
        
        try {
            const url = editingPackageId ? `/admin/packages/${editingPackageId}` : '/admin/packages';
            const method = editingPackageId ? 'PUT' : 'POST';
            const res = await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                showToast(editingPackageId ? 'Package updated' : 'Package created successfully');
                closePackageModal();
                loadPackages();
            } else {
                showToast('Error saving package', 'error');
            }
        } catch (e) { showToast('Connection error', 'error'); }
    }

    async function deletePackage(id) {
        const pkg = packageCache.find(item => item.id === id);
        if (!pkg) return;
        const confirmed = confirm(`Delete package "${pkg.name}"?`);
        if (!confirmed) return;
        try {
            const res = await fetch(`/admin/packages/${id}`, { method: 'DELETE' });
            if (res.ok) {
                showToast('Package deleted');
                loadPackages();
            } else {
                showToast('Error deleting package', 'error');
            }
        } catch (e) { showToast('Connection error', 'error'); }
    }

    async function saveConfig() {
        const data = {
            cost_per_gb: unformatNumber(document.getElementById('conf-cost-gb').value),
            cost_per_day: unformatNumber(document.getElementById('conf-cost-day').value)
        };
        try {
            await fetch('/admin/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            showToast('Configuration saved');
        } catch (e) { showToast('Error saving config', 'error'); }
    }
</script>
{% endblock %}
