{% extends "base.html" %}
{% block title %}Sub Manager{% endblock %}
{% block page_title %}Subscription Page Manager{% endblock %}

{% block header_actions %}
{% endblock %}

{% block content %}
<div class="settings-layout">
    <div class="settings-sidebar">
        <button class="settings-tab active" onclick="switchTab('apps')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>
            Applications
        </button>
        <button class="settings-tab" onclick="switchTab('faq')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            FAQ
        </button>
        <button class="settings-tab" onclick="switchTab('contact')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            Contact Info
        </button>
    </div>

    <div class="settings-content">
        <div id="tab-apps" class="tab-pane active">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Applications</h2>
                        <p class="text-secondary">Manage client applications shown on the subscription page.</p>
                    </div>
                    <button class="btn btn-success" onclick="openAddModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add New App
                    </button>
                </div>
                <div id="apps-container" class="servers-grid"></div>
            </div>
        </div>

        <div id="tab-faq" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>FAQ Management</h2>
                        <p class="text-secondary">Manage frequently asked questions.</p>
                    </div>
                    <button class="btn btn-success" onclick="openAddFAQModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add New FAQ
                    </button>
                </div>
                <div id="faqs-container" class="servers-grid"></div>
            </div>
        </div>

        <div id="tab-contact" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Support Contact Information</h2>
                        <p class="text-secondary">Set the support contact details for the subscription page.</p>
                    </div>
                </div>
                <div style="padding: 0;">
                    <div class="form-group">
                        <label>Telegram Support ID (without @)</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">@</span>
                            <input type="text" id="support-telegram" class="form-input" style="padding-left: 30px;" value="{{ support_telegram }}" placeholder="username">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp Support Number</label>
                        <input type="text" id="support-whatsapp" class="form-input" value="{{ support_whatsapp }}" placeholder="e.g., 989123456789">
                        <small style="color: var(--text-secondary);">Enter number with country code (e.g., 98...)</small>
                    </div>

                    <div class="form-group">
                        <label>Telegram Channel Link</label>
                        <input type="text" id="channel-telegram" class="form-input" value="{{ channel_telegram }}" placeholder="https://t.me/yourchannel">
                        <small style="color: var(--text-secondary);">You can also enter just the channel id (without @).</small>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp Channel Link</label>
                        <input type="text" id="channel-whatsapp" class="form-input" value="{{ channel_whatsapp }}" placeholder="https://whatsapp.com/channel/...">
                        <small style="color: var(--text-secondary);">Paste the full WhatsApp Channel link.</small>
                    </div>
                    <div class="form-actions" style="display: flex; justify-content: flex-end;">
                        <button class="btn btn-primary" onclick="saveContactInfo()">Save Contact Info</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .settings-layout { display: grid; grid-template-columns: 250px 1fr; gap: 24px; align-items: start; }
    @media (max-width: 768px) { .settings-layout { grid-template-columns: 1fr; } }
    .settings-sidebar { background: var(--bg-card); border-radius: 12px; padding: 12px; border: 1px solid var(--border-color); }
    .settings-tab { display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; background: transparent; border: none; color: var(--text-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; font-size: 0.9rem; margin-bottom: 8px; }
    .settings-tab:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .settings-tab.active { background: rgba(99, 102, 241, 0.15); color: var(--primary); font-weight: 500; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .panel-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
    .header-content h2 { margin: 0 0 4px 0; font-size: 1.5rem; }
    .header-content p { margin: 0; font-size: 0.9rem; color: var(--text-secondary); }
    .panel-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; }
    
    /* Vazirmatn font for forms */
    .form-input, .form-select, label, .modal-body {
        font-family: 'Vazirmatn', sans-serif !important;
    }
    
    /* Spinner animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Custom File Upload Style - Redesigned */
    .file-upload-wrapper {
        position: relative;
        display: flex;
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        background-color: var(--bg-dark);
        transition: all 0.2s;
        height: 46px;
    }
    .file-upload-wrapper:hover {
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary);
    }
    .file-upload-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 0 20px;
        background-color: var(--bg-card-hover);
        color: var(--text-primary);
        font-size: 0.9rem;
        font-weight: 500;
        border-right: 1px solid var(--border-color);
        white-space: nowrap;
        transition: background-color 0.2s;
        flex-shrink: 0;
        min-width: 130px;
    }
    .file-upload-btn.loading {
        background-color: rgba(99, 102, 241, 0.15);
        color: var(--primary);
        pointer-events: none;
    }
    .file-upload-btn .btn-text,
    .file-upload-btn .btn-loading {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .file-upload-btn .btn-loading.hidden,
    .file-upload-btn.loading .btn-text {
        display: none;
    }
    .file-upload-btn.loading .btn-loading {
        display: flex;
    }
    .file-upload-wrapper.uploading {
        pointer-events: none;
        opacity: 0.8;
    }
    .file-upload-wrapper:hover .file-upload-btn {
        background-color: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }
    .file-upload-text {
        flex-grow: 1;
        display: flex;
        align-items: center;
        padding: 0 16px;
        color: var(--text-secondary);
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }
    .file-upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 10;
    }
    .upload-spinner-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        backdrop-filter: blur(2px);
        gap: 10px;
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    .upload-spinner-overlay svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
    }
</style>

<div class="modal-overlay hidden" id="edit-app-modal">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 id="modal-title">Edit App</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-app-id">
            
            <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                <div class="form-group" style="flex: 0 0 150px;">
                    <label style="color: var(--primary); font-weight: bold; margin-bottom: 5px; display: block;">OS Type</label>
                    <select id="edit-os-type" class="form-input">
                        <option value="android">Android</option>
                        <option value="ios">iOS</option>
                        <option value="windows">Windows</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label style="color: var(--primary); font-weight: bold; margin-bottom: 5px; display: block;">App Name</label>
                    <input type="text" id="edit-app-name" class="form-input" placeholder="Display Name">
                </div>

                <label class="form-group form-toggle-item" style="margin-bottom: 0; padding-bottom: 12px; cursor: pointer;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="edit-enabled">
                        <span class="slider"></span>
                    </div>
                    <span>Show in Sub Page</span>
                </label>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <h4 style="color: #4ade80; margin-bottom: 10px;">Persian Content</h4>
                    <div class="form-group">
                        <label>Title (FA)</label>
                        <input type="text" id="edit-title-fa" class="form-input" dir="rtl">
                    </div>
                    <div class="form-group">
                        <label>Description (FA)</label>
                        <textarea id="edit-desc-fa" class="form-input" rows="4" dir="rtl" style="width:100%; background:var(--bg-dark); color:white; border:1px solid var(--border-color); border-radius:8px; padding:10px;"></textarea>
                    </div>
                </div>
                <div style="flex: 1;">
                    <h4 style="color: #60a5fa; margin-bottom: 10px;">English Content</h4>
                    <div class="form-group">
                        <label>Title (EN)</label>
                        <input type="text" id="edit-title-en" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Description (EN)</label>
                        <textarea id="edit-desc-en" class="form-input" rows="4" style="width:100%; background:var(--bg-dark); color:white; border:1px solid var(--border-color); border-radius:8px; padding:10px;"></textarea>
                    </div>
                </div>
            </div>

            <h4 style="color: #fbbf24; margin-bottom: 10px;">Links</h4>
            <div class="form-group">
                <label>Direct Download Link</label>
                <input type="text" id="edit-download" class="form-input">
            </div>
            <div class="form-group">
                <label>Store Link (Google Play / App Store)</label>
                <input type="text" id="edit-store" class="form-input">
            </div>
            <div class="form-group">
                <label>Video Tutorial Link</label>
                <input type="text" id="edit-video" class="form-input">
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveApp()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* Quill Editor Dark Mode Styles */
    #editor-container {
        font-family: 'Vazirmatn', sans-serif !important;
    }
    #editor-container .ql-editor {
        font-family: 'Vazirmatn', sans-serif !important;
        font-size: 1rem;
        color: var(--text-primary);
        min-height: 150px;
    }
    .ql-toolbar.ql-snow {
        background: var(--bg-card-hover);
        border: 1px solid var(--border-color);
        border-radius: 8px 8px 0 0;
    }
    .ql-container.ql-snow {
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        background: var(--bg-dark);
    }
    /* Light colored icons */
    .ql-toolbar.ql-snow .ql-stroke {
        stroke: #cbd5e1 !important;
    }
    .ql-toolbar.ql-snow .ql-fill {
        fill: #cbd5e1 !important;
    }
    .ql-toolbar.ql-snow .ql-picker-label {
        color: #cbd5e1 !important;
    }
    .ql-toolbar.ql-snow .ql-picker-options {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
    }
    .ql-toolbar.ql-snow button:hover .ql-stroke,
    .ql-toolbar.ql-snow button.ql-active .ql-stroke {
        stroke: var(--primary) !important;
    }
    .ql-toolbar.ql-snow button:hover .ql-fill,
    .ql-toolbar.ql-snow button.ql-active .ql-fill {
        fill: var(--primary) !important;
    }
    /* RTL/LTR custom buttons */
    .ql-rtl, .ql-ltr {
        width: 28px !important;
        font-size: 12px !important;
        color: #cbd5e1 !important;
        font-weight: 600;
    }
    .ql-rtl:hover, .ql-ltr:hover {
        color: var(--primary) !important;
    }
</style>

<div class="modal-overlay hidden" id="edit-faq-modal">
    <div class="modal modal-lg" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="faq-modal-title">Edit FAQ</h2>
            <button class="modal-close" onclick="closeFAQModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-faq-id">
            
            <div class="form-group">
                <label>Platform</label>
                <select id="edit-faq-platform" class="form-select" style="width: 100%; padding: 10px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                    <option value="android">Android</option>
                    <option value="ios">iOS</option>
                    <option value="windows">Windows</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="edit-faq-title" class="form-input" placeholder="FAQ Title">
            </div>

            <div class="form-group">
                <label>Content</label>
                <div id="editor-container" style="height: 200px; background: var(--bg-dark); color: white;"></div>
            </div>

            <div class="form-group">
                <label>Image</label>
                <input type="text" id="edit-faq-image" class="form-input" placeholder="Image URL" style="margin-bottom: 10px;">
                
                <div class="file-upload-wrapper" id="faq-upload-container">
                    <div class="file-upload-btn" id="faq-upload-btn">
                        <span class="btn-text">Choose File</span>
                        <span class="btn-loading hidden">
                            <svg class="animate-spin" width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Uploading...
                        </span>
                    </div>
                    <div class="file-upload-text" id="faq-file-name">No file chosen</div>
                    <input type="file" id="faq-image-upload" class="file-upload-input" accept="image/*" onchange="uploadFAQImage(this)">
                </div>
                <p style="margin-top: 6px; font-size: 0.75rem; color: var(--text-secondary);">SVG, PNG, JPG or GIF (MAX. 800x400px).</p>
            </div>

            <div class="form-group">
                <label>Video URL</label>
                <input type="text" id="edit-faq-video" class="form-input" placeholder="Video URL (optional)">
            </div>

            <label class="form-group form-toggle-item" style="margin-bottom: 20px; cursor: pointer;">
                <div class="toggle-switch">
                    <input type="checkbox" id="edit-faq-enabled">
                    <span class="slider"></span>
                </div>
                <span>Visible</span>
            </label>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeFAQModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveFAQ()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
{% endblock %}

{% block scripts %}
<script>
    let apps = [];
    document.addEventListener('DOMContentLoaded', loadApps);

    async function loadApps() {
        try {
            const response = await fetch('/api/sub-apps');
            apps = await response.json();
            renderApps();
        } catch (error) {
            showToast('Error loading apps', 'error');
        }
    }

    function renderApps() {
        const container = document.getElementById('apps-container');
        
        if (apps.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No apps defined</p></div>';
            return;
        }

        container.innerHTML = apps.map(app => `
            <div class="server-card ${!app.is_enabled ? 'disabled' : ''}">
                <div class="server-header">
                    <div class="server-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                            <line x1="6" y1="6" x2="6.01" y2="6"></line>
                            <line x1="6" y1="18" x2="6.01" y2="18"></line>
                        </svg>
                    </div>
                    
                    <div class="server-title">
                        <h3>${app.name}</h3>
                        <p class="server-url" style="direction: rtl; text-align: right; margin-top: 2px;">
                            ${app.title_fa || 'بدون عنوان'}
                        </p>
                    </div>
                </div>

                <div class="server-badges">
                    <span class="badge ${app.is_enabled ? 'active' : 'inactive'}">
                        ${app.is_enabled ? 'Visible' : 'Hidden'}
                    </span>
                </div>

                <div class="server-actions">
                    <button class="action-btn" onclick="openEditModal(${app.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>

                    <button class="action-btn danger" onclick="deleteApp(${app.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function closeEditModal() {
        document.getElementById('edit-app-modal').classList.add('hidden');
    }

    function openAddModal() {
        document.getElementById('edit-app-id').value = '';
        document.getElementById('modal-title').textContent = 'Add New App';
        
        document.getElementById('edit-os-type').value = 'android';
        document.getElementById('edit-app-name').value = '';
        document.getElementById('edit-enabled').checked = true;
        document.getElementById('edit-title-fa').value = '';
        document.getElementById('edit-desc-fa').value = '';
        document.getElementById('edit-title-en').value = '';
        document.getElementById('edit-desc-en').value = '';
        document.getElementById('edit-download').value = '';
        document.getElementById('edit-store').value = '';
        document.getElementById('edit-video').value = '';
        
        document.getElementById('edit-app-modal').classList.remove('hidden');
    }

    function openEditModal(id) {
        const app = apps.find(a => a.id === id);
        document.getElementById('edit-app-id').value = app.id;
        document.getElementById('modal-title').textContent = 'Edit App';
        
        document.getElementById('edit-os-type').value = app.os_type || 'android';
        document.getElementById('edit-app-name').value = app.name;
        document.getElementById('edit-enabled').checked = app.is_enabled;
        document.getElementById('edit-title-fa').value = app.title_fa || '';
        document.getElementById('edit-desc-fa').value = app.description_fa || '';
        document.getElementById('edit-title-en').value = app.title_en || '';
        document.getElementById('edit-desc-en').value = app.description_en || '';
        document.getElementById('edit-download').value = app.download_link || '';
        document.getElementById('edit-store').value = app.store_link || '';
        document.getElementById('edit-video').value = app.tutorial_link || '';
        
        document.getElementById('edit-app-modal').classList.remove('hidden');
    }

    async function saveApp() {
        const id = document.getElementById('edit-app-id').value;
        const data = {
            os_type: document.getElementById('edit-os-type').value,
            name: document.getElementById('edit-app-name').value,
            is_enabled: document.getElementById('edit-enabled').checked,
            title_fa: document.getElementById('edit-title-fa').value,
            description_fa: document.getElementById('edit-desc-fa').value,
            title_en: document.getElementById('edit-title-en').value,
            description_en: document.getElementById('edit-desc-en').value,
            download_link: document.getElementById('edit-download').value,
            store_link: document.getElementById('edit-store').value,
            tutorial_link: document.getElementById('edit-video').value
        };

        if (!data.name.trim()) {
            showToast('App Name is required', 'error');
            return;
        }

        try {
            let url, method;
            
            if (id) {
                url = `/api/sub-apps/${id}`;
                method = 'PUT';
            } else {
                url = '/api/sub-apps';
                method = 'POST';
            }

            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(id ? 'App updated successfully' : 'App added successfully');
                closeEditModal();
                loadApps();
            } else {
                showToast('Error: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    async function deleteApp(id) {
        if (!confirm('Are you sure you want to delete this app?')) return;
        
        try {
            const response = await fetch(`/api/sub-apps/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('App deleted');
                loadApps();
            } else {
                showToast('Error deleting app', 'error');
            }
        } catch (error) {
            showToast('Error deleting app', 'error');
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab-${tabName}`).classList.add('active');
        // event.currentTarget might be null if called programmatically, but here it's onclick
        // However, to be safe and simple, we can find the button by onclick attribute or index
        // But the existing code uses event.currentTarget. Let's keep it but handle the case where we might want to call it differently later.
        // Actually, the existing code relies on 'event' being available from the onclick.
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }

        if (tabName === 'faq') {
            loadFAQs();
        }
    }

    // FAQ Logic
    let faqs = [];
    let quill;

    document.addEventListener('DOMContentLoaded', () => {
        // Register RTL/LTR format
        const DirectionAttribute = Quill.import('attributors/style/direction');
        Quill.register(DirectionAttribute, true);
        
        quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['rtl', 'ltr'],
                        ['clean']
                    ],
                    handlers: {
                        'rtl': function() {
                            const range = this.quill.getSelection();
                            if (range) {
                                this.quill.format('direction', 'rtl');
                                this.quill.format('align', 'right');
                            } else {
                                // Apply to entire editor
                                this.quill.root.style.direction = 'rtl';
                                this.quill.root.style.textAlign = 'right';
                            }
                        },
                        'ltr': function() {
                            const range = this.quill.getSelection();
                            if (range) {
                                this.quill.format('direction', 'ltr');
                                this.quill.format('align', 'left');
                            } else {
                                // Apply to entire editor
                                this.quill.root.style.direction = 'ltr';
                                this.quill.root.style.textAlign = 'left';
                            }
                        }
                    }
                }
            }
        });
        
        // Add RTL/LTR button labels to toolbar
        const toolbar = document.querySelector('.ql-toolbar');
        if (toolbar) {
            const rtlBtn = toolbar.querySelector('.ql-rtl');
            const ltrBtn = toolbar.querySelector('.ql-ltr');
            if (rtlBtn) rtlBtn.innerHTML = 'RTL';
            if (ltrBtn) ltrBtn.innerHTML = 'LTR';
        }
        
        // Set default direction to RTL for Persian
        quill.root.style.direction = 'rtl';
        quill.root.style.textAlign = 'right';
    });

    async function loadFAQs() {
        try {
            const response = await fetch('/api/faqs');
            faqs = await response.json();
            renderFAQs();
        } catch (error) {
            showToast('Error loading FAQs', 'error');
        }
    }

    function renderFAQs() {
        const container = document.getElementById('faqs-container');
        
        if (faqs.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No FAQs defined</p></div>';
            return;
        }

        container.innerHTML = faqs.map(faq => `
            <div class="server-card ${!faq.is_enabled ? 'disabled' : ''}">
                <div class="server-header">
                    <div class="server-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    
                    <div class="server-title">
                        <h3>${faq.title}</h3>
                    </div>
                </div>

                <div class="server-badges">
                    <span class="badge ${faq.is_enabled ? 'active' : 'inactive'}">
                        ${faq.is_enabled ? 'Visible' : 'Hidden'}
                    </span>
                </div>

                <div class="server-actions">
                    <button class="action-btn" onclick="openEditFAQModal(${faq.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>

                    <button class="action-btn danger" onclick="deleteFAQ(${faq.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function closeFAQModal() {
        document.getElementById('edit-faq-modal').classList.add('hidden');
    }

    function openAddFAQModal() {
        document.getElementById('edit-faq-id').value = '';
        document.getElementById('faq-modal-title').textContent = 'Add New FAQ';
        
        document.getElementById('edit-faq-platform').value = 'android';
        document.getElementById('edit-faq-title').value = '';
        quill.root.innerHTML = '';
        document.getElementById('edit-faq-image').value = '';
        document.getElementById('edit-faq-video').value = '';
        document.getElementById('edit-faq-enabled').checked = true;
        
        // Reset file upload
        document.getElementById('faq-image-upload').value = '';
        document.getElementById('faq-file-name').textContent = 'No file chosen';
        
        document.getElementById('edit-faq-modal').classList.remove('hidden');
    }

    function openEditFAQModal(id) {
        const faq = faqs.find(f => f.id === id);
        document.getElementById('edit-faq-id').value = faq.id;
        document.getElementById('faq-modal-title').textContent = 'Edit FAQ';
        
        document.getElementById('edit-faq-platform').value = faq.platform || 'android';
        document.getElementById('edit-faq-title').value = faq.title;
        quill.root.innerHTML = faq.content || '';
        document.getElementById('edit-faq-image').value = faq.image_url || '';
        document.getElementById('edit-faq-video').value = faq.video_url || '';
        document.getElementById('edit-faq-enabled').checked = faq.is_enabled;
        
        // Reset file upload
        document.getElementById('faq-image-upload').value = '';
        document.getElementById('faq-file-name').textContent = 'No file chosen';
        
        document.getElementById('edit-faq-modal').classList.remove('hidden');
    }

    async function saveFAQ() {
        const id = document.getElementById('edit-faq-id').value;
        const data = {
            platform: document.getElementById('edit-faq-platform').value,
            title: document.getElementById('edit-faq-title').value,
            content: quill.root.innerHTML,
            image_url: document.getElementById('edit-faq-image').value,
            video_url: document.getElementById('edit-faq-video').value,
            is_enabled: document.getElementById('edit-faq-enabled').checked
        };

        if (!data.title.trim()) {
            showToast('Title is required', 'error');
            return;
        }

        try {
            let url, method;
            if (id) {
                url = `/api/faqs/${id}`;
                method = 'PUT';
            } else {
                url = '/api/faqs';
                method = 'POST';
            }

            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(id ? 'FAQ updated successfully' : 'FAQ added successfully');
                closeFAQModal();
                loadFAQs();
            } else {
                showToast('Error: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    async function deleteFAQ(id) {
        if (!confirm('Are you sure you want to delete this FAQ?')) return;
        
        try {
            const response = await fetch(`/api/faqs/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('FAQ deleted');
                loadFAQs();
            } else {
                showToast('Error deleting FAQ', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    async function uploadFAQImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            document.getElementById('faq-file-name').textContent = file.name;
            
            // Show loading state on button
            const wrapper = document.getElementById('faq-upload-container');
            const btn = document.getElementById('faq-upload-btn');
            wrapper.classList.add('uploading');
            btn.classList.add('loading');
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.url) {
                    document.getElementById('edit-faq-image').value = result.url;
                    showToast('Image uploaded successfully');
                } else {
                    showToast('Upload failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Upload error', 'error');
            } finally {
                wrapper.classList.remove('uploading');
                btn.classList.remove('loading');
            }
        }
    }

    async function saveContactInfo() {
        const telegram = document.getElementById('support-telegram').value;
        const whatsapp = document.getElementById('support-whatsapp').value;
        const channelTelegram = document.getElementById('channel-telegram').value;
        const channelWhatsapp = document.getElementById('channel-whatsapp').value;

        try {
            const response = await fetch('/api/system-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    'support_telegram': telegram,
                    'support_whatsapp': whatsapp,
                    'channel_telegram': channelTelegram,
                    'channel_whatsapp': channelWhatsapp
                })
            });
            
            const result = await response.json();
            if (result.success) {
                showToast('Contact info saved successfully');
            } else {
                showToast('Error saving contact info', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }
</script>
{% endblock %}
