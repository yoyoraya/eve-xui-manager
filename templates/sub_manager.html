{% extends "base.html" %}
{% block title %}Sub Manager{% endblock %}
{% block page_title %}Subscription Page Manager{% endblock %}

{% block header_actions %}
{% endblock %}

{% block content %}
<div class="settings-layout">
    <div class="settings-sidebar">
        <button class="settings-tab active" onclick="switchTab('apps')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>
            Applications
        </button>
        <button class="settings-tab" onclick="switchTab('faq')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            FAQ
        </button>
        <button class="settings-tab" onclick="switchTab('contact')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            Contact Info
        </button>

        <button class="settings-tab" onclick="switchTab('announcements')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v11a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V4z"/><path d="M8 22h8"/><path d="M12 15v-3"/><path d="M12 6h.01"/></svg>
            Announcement
        </button>
    </div>

    <div class="settings-content">
        <div id="tab-apps" class="tab-pane active">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Applications</h2>
                        <p class="text-secondary">Manage client applications shown on the subscription page.</p>
                    </div>
                    <button class="btn btn-success" onclick="openAddModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add New App
                    </button>
                </div>
                <div id="apps-container" class="servers-grid"></div>
            </div>
        </div>

        <div id="tab-faq" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>FAQ Management</h2>
                        <p class="text-secondary">Manage frequently asked questions.</p>
                    </div>
                    <button class="btn btn-success" onclick="openAddFAQModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add New FAQ
                    </button>
                </div>
                <div id="faqs-container" class="servers-grid"></div>
            </div>
        </div>

        <div id="tab-contact" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Support Contact Information</h2>
                        <p class="text-secondary">Set the support contact details for the subscription page.</p>
                    </div>
                </div>
                <div style="padding: 0;">
                    <div class="form-group">
                        <label>Telegram Support ID (without @)</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">@</span>
                            <input type="text" id="support-telegram" class="form-input" style="padding-left: 30px;" value="{{ support_telegram }}" placeholder="username">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp Support Number</label>
                        <input type="text" id="support-whatsapp" class="form-input" value="{{ support_whatsapp }}" placeholder="e.g., 989123456789">
                        <small style="color: var(--text-secondary);">Enter number with country code (e.g., 98...)</small>
                    </div>

                    <div class="form-group">
                        <label>Telegram Channel Link</label>
                        <input type="text" id="channel-telegram" class="form-input" value="{{ channel_telegram }}" placeholder="https://t.me/yourchannel">
                        <small style="color: var(--text-secondary);">You can also enter just the channel id (without @).</small>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp Channel Link</label>
                        <input type="text" id="channel-whatsapp" class="form-input" value="{{ channel_whatsapp }}" placeholder="https://whatsapp.com/channel/...">
                        <small style="color: var(--text-secondary);">Paste the full WhatsApp Channel link.</small>
                    </div>
                    <div class="form-actions" style="display: flex; justify-content: flex-end;">
                        <button class="btn btn-primary" onclick="saveContactInfo()">Save Contact Info</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-announcements" class="tab-pane">
            <div class="panel-card">
                <div class="panel-card-header">
                    <div class="header-content">
                        <h2>Announcements</h2>
                        <p class="text-secondary">Create server-scoped announcements shown on the subscription page.</p>
                    </div>
                    <button class="btn btn-success" onclick="openAddAnnouncementModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Announcement
                    </button>
                </div>
                <div id="announcements-container" class="servers-grid"></div>
            </div>
        </div>
    </div>
</div>

<style nonce="{{ csp_nonce }}">
    .settings-layout { display: grid; grid-template-columns: 250px 1fr; gap: 24px; align-items: start; }
    @media (max-width: 768px) { .settings-layout { grid-template-columns: 1fr; } }
    .settings-sidebar { background: var(--bg-card); border-radius: 12px; padding: 12px; border: 1px solid var(--border-color); }
    .settings-tab { display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; background: transparent; border: none; color: var(--text-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; font-size: 0.9rem; margin-bottom: 8px; }
    .settings-tab:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .settings-tab.active { background: rgba(99, 102, 241, 0.15); color: var(--primary); font-weight: 500; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .panel-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
    .header-content h2 { margin: 0 0 4px 0; font-size: 1.5rem; }
    .header-content p { margin: 0; font-size: 0.9rem; color: var(--text-secondary); }
    .panel-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; }
    
    /* Vazirmatn font for forms */
    .form-input, .form-select, label, .modal-body {
        font-family: 'Vazirmatn', sans-serif !important;
    }

    /* Announcement Target Selector (reuse reseller access selector CSS) */
    .server-selection-wrapper {
        width: 100%;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        gap: 10px;
        font-size: 0.95rem;
        color: var(--text-primary);
        position: relative;
        padding-left: 0;
        user-select: none;
        margin: 0 !important;
        margin-bottom: 5px !important;
        min-height: 32px;
        line-height: 1.5;
    }

    .checkbox-label input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkmark {
        position: relative;
        display: inline-block;
        vertical-align: middle;
        height: 20px;
        width: 20px;
        background-color: var(--bg-dark);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        transition: all 0.2s ease;
        margin-right: 12px;
    }

    .checkbox-label:hover input ~ .checkmark {
        border-color: var(--primary);
    }

    .checkbox-label input:checked ~ .checkmark {
        background-color: var(--primary);
        border-color: var(--primary);
    }

    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }

    .checkbox-label input:checked ~ .checkmark:after {
        display: block;
    }

    .checkbox-label .checkmark:after {
        left: 7px;
        top: 3px;
        width: 4px;
        height: 9px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .checkbox-label input:indeterminate ~ .checkmark {
        background-color: var(--primary);
        border-color: var(--primary);
    }

    .checkbox-label input:indeterminate ~ .checkmark:after {
        display: block;
        left: 5px;
        top: 8px;
        width: 8px;
        height: 2px;
        border: none;
        background-color: white;
        transform: none;
    }

    .select-all-container {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        padding-left: 26px;
        border-bottom: 1px solid var(--border-color);
        background: rgba(255, 255, 255, 0.02);
    }

    .select-all-container .checkbox-label {
        margin-right: 12px;
        margin-left: -4px;
        padding-left: 0;
    }

    .server-list-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-left: 0;
        gap: 12px;
    }

    .meta-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
    }

    .count-pill {
        background: #312e81;
        color: #a5b4fc;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .server-accordion {
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-card);
    }

    .server-accordion:last-child {
        border-bottom: none;
    }

    .server-accordion-header {
        padding: 16px;
        padding-left: 30px;
        display: flex;
        align-items: center;
        gap: 0;
        cursor: pointer;
        transition: background 0.2s;
    }

    .server-accordion-header .checkbox-label {
        min-width: fit-content;
        margin-right: 12px;
        margin-left: -4px;
        padding-left: 0;
    }

    .server-accordion-header:hover {
        background-color: rgba(255, 255, 255, 0.03);
    }

    .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-grow: 1;
        margin-left: 6px;
        gap: 12px;
    }

    .server-info-block {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .server-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .server-host {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 0;
        font-family: monospace;
    }

    .chevron {
        color: var(--text-secondary);
        transition: transform 0.3s ease;
        font-size: 1.2rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 12px;
    }

    .server-accordion.open .chevron {
        transform: rotate(180deg);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background-color: var(--success);
        border-radius: 50%;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    .status-dot.disabled {
        background-color: var(--text-secondary);
        box-shadow: none;
    }

    .inbound-list {
        display: none;
        background-color: rgba(0, 0, 0, 0.3);
        padding: 8px 16px 16px 16px;
        border-top: 1px solid var(--border-color);
    }

    .server-accordion.open .inbound-list {
        display: block;
    }

    .inbound-list-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.02);
    }

    .inbound-header-text {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        gap: 12px;
    }

    .inbound-item {
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .inbound-item:hover {
        border-color: rgba(99, 102, 241, 0.35);
        background: rgba(99, 102, 241, 0.06);
    }

    .inbound-details {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .inbound-name {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .protocol-badge {
        font-size: 0.75rem;
        background: rgba(99, 102, 241, 0.18);
        color: #c7d2fe;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(99, 102, 241, 0.25);
        font-weight: 700;
    }

    .port-number {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-family: monospace;
    }

    .inbound-empty {
        padding: 12px 16px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    /* Spinner animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Custom File Upload Style - Redesigned */
    .file-upload-wrapper {
        position: relative;
        display: flex;
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        background-color: var(--bg-dark);
        transition: all 0.2s;
        height: 46px;
    }
    .file-upload-wrapper:hover {
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary);
    }
    .file-upload-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 0 20px;
        background-color: var(--bg-card-hover);
        color: var(--text-primary);
        font-size: 0.9rem;
        font-weight: 500;
        border-right: 1px solid var(--border-color);
        white-space: nowrap;
        transition: background-color 0.2s;
        flex-shrink: 0;
        min-width: 130px;
    }
    .file-upload-btn.loading {
        background-color: rgba(99, 102, 241, 0.15);
        color: var(--primary);
        pointer-events: none;
    }
    .file-upload-btn .btn-text,
    .file-upload-btn .btn-loading {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .file-upload-btn .btn-loading.hidden,
    .file-upload-btn.loading .btn-text {
        display: none;
    }
    .file-upload-btn.loading .btn-loading {
        display: flex;
    }
    .file-upload-wrapper.uploading {
        pointer-events: none;
        opacity: 0.8;
    }
    .file-upload-wrapper:hover .file-upload-btn {
        background-color: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }
    .file-upload-text {
        flex-grow: 1;
        display: flex;
        align-items: center;
        padding: 0 16px;
        color: var(--text-secondary);
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }
    .file-upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 10;
    }
    .upload-spinner-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        backdrop-filter: blur(2px);
        gap: 10px;
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    .upload-spinner-overlay svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
    }
</style>

<div class="modal-overlay hidden" id="edit-app-modal">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 id="modal-title">Edit App</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-app-id">
            
            <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                <div class="form-group" style="flex: 0 0 150px;">
                    <label style="color: var(--primary); font-weight: bold; margin-bottom: 5px; display: block;">OS Type</label>
                    <select id="edit-os-type" class="form-input">
                        <option value="android">Android</option>
                        <option value="ios">iOS</option>
                        <option value="windows">Windows</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label style="color: var(--primary); font-weight: bold; margin-bottom: 5px; display: block;">App Name</label>
                    <input type="text" id="edit-app-name" class="form-input" placeholder="Display Name">
                </div>

                <label class="form-group form-toggle-item" style="margin-bottom: 0; padding-bottom: 12px; cursor: pointer;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="edit-enabled">
                        <span class="slider"></span>
                    </div>
                    <span>Show in Sub Page</span>
                </label>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <h4 style="color: #4ade80; margin-bottom: 10px;">Persian Content</h4>
                    <div class="form-group">
                        <label>Title (FA)</label>
                        <input type="text" id="edit-title-fa" class="form-input" dir="rtl">
                    </div>
                    <div class="form-group">
                        <label>Description (FA)</label>
                        <textarea id="edit-desc-fa" class="form-input" rows="4" dir="rtl" style="width:100%; background:var(--bg-dark); color:white; border:1px solid var(--border-color); border-radius:8px; padding:10px;"></textarea>
                    </div>
                </div>
                <div style="flex: 1;">
                    <h4 style="color: #60a5fa; margin-bottom: 10px;">English Content</h4>
                    <div class="form-group">
                        <label>Title (EN)</label>
                        <input type="text" id="edit-title-en" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Description (EN)</label>
                        <textarea id="edit-desc-en" class="form-input" rows="4" style="width:100%; background:var(--bg-dark); color:white; border:1px solid var(--border-color); border-radius:8px; padding:10px;"></textarea>
                    </div>
                </div>
            </div>

            <h4 style="color: #fbbf24; margin-bottom: 10px;">Links</h4>
            <div class="form-group">
                <label>Direct Download Link</label>
                <input type="text" id="edit-download" class="form-input">
            </div>
            <div class="form-group">
                <label>Store Link (Google Play / App Store)</label>
                <input type="text" id="edit-store" class="form-input">
            </div>
            <div class="form-group">
                <label>Video Tutorial Link</label>
                <input type="text" id="edit-video" class="form-input">
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveApp()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style nonce="{{ csp_nonce }}">
    /* Quill Editor Dark Mode Styles */
    #editor-container {
        font-family: 'Vazirmatn', sans-serif !important;
    }
    #editor-container .ql-editor {
        font-family: 'Vazirmatn', sans-serif !important;
        font-size: 1rem;
        color: var(--text-primary);
        min-height: 150px;
    }
    .ql-toolbar.ql-snow {
        background: var(--bg-card-hover);
        border: 1px solid var(--border-color);
        border-radius: 8px 8px 0 0;
    }
    .ql-container.ql-snow {
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        background: var(--bg-dark);
    }
    /* Light colored icons */
    .ql-toolbar.ql-snow .ql-stroke {
        stroke: #cbd5e1 !important;
    }
    .ql-toolbar.ql-snow .ql-fill {
        fill: #cbd5e1 !important;
    }
    .ql-toolbar.ql-snow .ql-picker-label {
        color: #cbd5e1 !important;
    }
    .ql-toolbar.ql-snow .ql-picker-options {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
    }
    .ql-toolbar.ql-snow button:hover .ql-stroke,
    .ql-toolbar.ql-snow button.ql-active .ql-stroke {
        stroke: var(--primary) !important;
    }
    .ql-toolbar.ql-snow button:hover .ql-fill,
    .ql-toolbar.ql-snow button.ql-active .ql-fill {
        fill: var(--primary) !important;
    }
    /* RTL/LTR custom buttons */
    .ql-rtl, .ql-ltr {
        width: 28px !important;
        font-size: 12px !important;
        color: #cbd5e1 !important;
        font-weight: 600;
    }
    .ql-rtl:hover, .ql-ltr:hover {
        color: var(--primary) !important;
    }
</style>

<div class="modal-overlay hidden" id="edit-faq-modal">
    <div class="modal modal-lg" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="faq-modal-title">Edit FAQ</h2>
            <button class="modal-close" onclick="closeFAQModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-faq-id">
            
            <div class="form-group">
                <label>Platform</label>
                <select id="edit-faq-platform" class="form-select" style="width: 100%; padding: 10px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                    <option value="android">Android</option>
                    <option value="ios">iOS</option>
                    <option value="windows">Windows</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="edit-faq-title" class="form-input" placeholder="FAQ Title">
            </div>

            <div class="form-group">
                <label>Content</label>
                <div id="editor-container" style="height: 200px; background: var(--bg-dark); color: white;"></div>
            </div>

            <div class="form-group">
                <label>Image</label>
                <input type="text" id="edit-faq-image" class="form-input" placeholder="Image URL" style="margin-bottom: 10px;">
                
                <div class="file-upload-wrapper" id="faq-upload-container">
                    <div class="file-upload-btn" id="faq-upload-btn">
                        <span class="btn-text">Choose File</span>
                        <span class="btn-loading hidden">
                            <svg class="animate-spin" width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Uploading...
                        </span>
                    </div>
                    <div class="file-upload-text" id="faq-file-name">No file chosen</div>
                    <input type="file" id="faq-image-upload" class="file-upload-input" accept="image/*" onchange="uploadFAQImage(this)">
                </div>
                <p style="margin-top: 6px; font-size: 0.75rem; color: var(--text-secondary);">SVG, PNG, JPG or GIF (MAX. 800x400px).</p>
            </div>

            <div class="form-group">
                <label>Video URL</label>
                <input type="text" id="edit-faq-video" class="form-input" placeholder="Video URL (optional)">
            </div>

            <label class="form-group form-toggle-item" style="margin-bottom: 20px; cursor: pointer;">
                <div class="toggle-switch">
                    <input type="checkbox" id="edit-faq-enabled">
                    <span class="slider"></span>
                </div>
                <span>Visible</span>
            </label>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeFAQModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveFAQ()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="announcement-modal">
    <div class="modal" style="max-width: 720px;">
        <div class="modal-header">
            <h2 id="announcement-modal-title">Add Announcement</h2>
            <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="announcement-id">

            <div class="form-group">
                <label>Message</label>
                <textarea id="announcement-message" class="form-input" rows="4" placeholder="Write announcement text..."></textarea>
            </div>

            <div style="display:flex; gap: 12px;">
                <div class="form-group" style="flex:1;">
                    <label>Start</label>
                    <input type="text" id="announcement-start" data-jdp class="form-input" placeholder="1404/10/10 14:30">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>End</label>
                    <input type="text" id="announcement-end" data-jdp class="form-input" placeholder="1404/10/10 18:30">
                </div>
            </div>

            <div class="form-group">
                <label>Targets (Servers + Inbounds)</label>
                <input type="hidden" id="announcement-targets" value="*">

                <div class="server-selection-wrapper" style="margin-top: 8px;">
                    <div class="select-all-container">
                        <label class="checkbox-label" style="margin-bottom: 0 !important;" onclick="event.stopPropagation()">
                            <input type="checkbox" id="announcement-targets-all" onchange="ann_toggleAllServers(this)">
                            <span class="checkmark"></span>
                        </label>
                        <div class="server-list-meta">
                            <span class="meta-title">Select Servers</span>
                            <span class="count-pill" id="announcement-global-counter">0 / 0</span>
                        </div>
                    </div>

                    <div id="announcement-server-list"></div>
                </div>

                <small style="color: var(--text-secondary);">Target rules match reseller access selector: per-server inbounds or "Select All".</small>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeAnnouncementModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAnnouncement()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/persian-date@latest/dist/persian-date.min.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='jalalidatepicker.min.css') }}">
<script src="{{ url_for('static', filename='jalalidatepicker.min.js') }}"></script>

<script nonce="{{ csp_nonce }}">
    let apps = [];
    document.addEventListener('DOMContentLoaded', loadApps);

    async function loadApps() {
        try {
            const response = await fetch('/api/sub-apps');
            apps = await response.json();
            renderApps();
        } catch (error) {
            showToast('Error loading apps', 'error');
        }
    }

    function renderApps() {
        const container = document.getElementById('apps-container');
        
        if (apps.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No apps defined</p></div>';
            return;
        }

        container.innerHTML = apps.map(app => `
            <div class="server-card ${!app.is_enabled ? 'disabled' : ''}">
                <div class="server-header">
                    <div class="server-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                            <line x1="6" y1="6" x2="6.01" y2="6"></line>
                            <line x1="6" y1="18" x2="6.01" y2="18"></line>
                        </svg>
                    </div>
                    
                    <div class="server-title">
                        <h3>${app.name}</h3>
                        <p class="server-url" style="direction: rtl; text-align: right; margin-top: 2px;">
                            ${app.title_fa || 'بدون عنوان'}
                        </p>
                    </div>
                </div>

                <div class="server-badges">
                    <span class="badge ${app.is_enabled ? 'active' : 'inactive'}">
                        ${app.is_enabled ? 'Visible' : 'Hidden'}
                    </span>
                </div>

                <div class="server-actions">
                    <button class="action-btn" onclick="openEditModal(${app.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>

                    <button class="action-btn danger" onclick="deleteApp(${app.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function closeEditModal() {
        document.getElementById('edit-app-modal').classList.add('hidden');
    }

    function openAddModal() {
        document.getElementById('edit-app-id').value = '';
        document.getElementById('modal-title').textContent = 'Add New App';
        
        document.getElementById('edit-os-type').value = 'android';
        document.getElementById('edit-app-name').value = '';
        document.getElementById('edit-enabled').checked = true;
        document.getElementById('edit-title-fa').value = '';
        document.getElementById('edit-desc-fa').value = '';
        document.getElementById('edit-title-en').value = '';
        document.getElementById('edit-desc-en').value = '';
        document.getElementById('edit-download').value = '';
        document.getElementById('edit-store').value = '';
        document.getElementById('edit-video').value = '';
        
        document.getElementById('edit-app-modal').classList.remove('hidden');
    }

    function openEditModal(id) {
        const app = apps.find(a => a.id === id);
        document.getElementById('edit-app-id').value = app.id;
        document.getElementById('modal-title').textContent = 'Edit App';
        
        document.getElementById('edit-os-type').value = app.os_type || 'android';
        document.getElementById('edit-app-name').value = app.name;
        document.getElementById('edit-enabled').checked = app.is_enabled;
        document.getElementById('edit-title-fa').value = app.title_fa || '';
        document.getElementById('edit-desc-fa').value = app.description_fa || '';
        document.getElementById('edit-title-en').value = app.title_en || '';
        document.getElementById('edit-desc-en').value = app.description_en || '';
        document.getElementById('edit-download').value = app.download_link || '';
        document.getElementById('edit-store').value = app.store_link || '';
        document.getElementById('edit-video').value = app.tutorial_link || '';
        
        document.getElementById('edit-app-modal').classList.remove('hidden');
    }

    async function saveApp() {
        const id = document.getElementById('edit-app-id').value;
        const data = {
            os_type: document.getElementById('edit-os-type').value,
            name: document.getElementById('edit-app-name').value,
            is_enabled: document.getElementById('edit-enabled').checked,
            title_fa: document.getElementById('edit-title-fa').value,
            description_fa: document.getElementById('edit-desc-fa').value,
            title_en: document.getElementById('edit-title-en').value,
            description_en: document.getElementById('edit-desc-en').value,
            download_link: document.getElementById('edit-download').value,
            store_link: document.getElementById('edit-store').value,
            tutorial_link: document.getElementById('edit-video').value
        };

        if (!data.name.trim()) {
            showToast('App Name is required', 'error');
            return;
        }

        try {
            let url, method;
            
            if (id) {
                url = `/api/sub-apps/${id}`;
                method = 'PUT';
            } else {
                url = '/api/sub-apps';
                method = 'POST';
            }

            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(id ? 'App updated successfully' : 'App added successfully');
                closeEditModal();
                loadApps();
            } else {
                showToast('Error: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    async function deleteApp(id) {
        if (!confirm('Are you sure you want to delete this app?')) return;
        
        try {
            const response = await fetch(`/api/sub-apps/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('App deleted');
                loadApps();
            } else {
                showToast('Error deleting app', 'error');
            }
        } catch (error) {
            showToast('Error deleting app', 'error');
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab-${tabName}`).classList.add('active');
        // event.currentTarget might be null if called programmatically, but here it's onclick
        // However, to be safe and simple, we can find the button by onclick attribute or index
        // But the existing code uses event.currentTarget. Let's keep it but handle the case where we might want to call it differently later.
        // Actually, the existing code relies on 'event' being available from the onclick.
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }

        if (tabName === 'faq') {
            loadFAQs();
        }

        if (tabName === 'announcements') {
            loadAnnouncements();
        }
    }

    // Announcements Logic
    let announcements = [];

    // Announcement Targets (reseller-style selector)
    let annAllServers = [];
    let annServerInbounds = {};
    let annServersLoaded = false;
    let annInboundsLoaded = false;

    function escapeHtml(s) {
        return String(s || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function isAnnouncementActive(a) {
        try {
            if (typeof a.is_active === 'boolean') return a.is_active;
            const now = Date.now();
            const start = new Date(a.start_at).getTime();
            const end = new Date(a.end_at).getTime();
            if (Number.isNaN(start) || Number.isNaN(end)) return false;
            return start <= now && now <= end;
        } catch {
            return false;
        }
    }

    async function loadAnnouncements() {
        try {
            const response = await fetch('/api/announcements');
            announcements = await response.json();
            renderAnnouncements();
        } catch (error) {
            showToast('Error loading announcements', 'error');
        }
    }

    function renderAnnouncements() {
        const container = document.getElementById('announcements-container');
        if (!container) return;

        if (!announcements || announcements.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No announcements defined</p></div>';
            return;
        }

        container.innerHTML = announcements.map(a => {
            const isActive = isAnnouncementActive(a);
            const serversLabel = a.all_servers ? 'All servers' : ((a.server_names && a.server_names.length) ? a.server_names.join(', ') : 'No servers selected');
            const createdBy = a.created_by || 'unknown';
            const createdAt = a.created_at_jalali || (a.created_at ? new Date(a.created_at).toLocaleString('fa-IR') : '');
            const windowLabel = (a.start_at_jalali && a.end_at_jalali)
                ? `${a.start_at_jalali} → ${a.end_at_jalali}`
                : ((a.start_at && a.end_at) ? `${new Date(a.start_at).toLocaleString('fa-IR')} → ${new Date(a.end_at).toLocaleString('fa-IR')}` : '');

            return `
                <div class="server-card">
                    <div class="server-header">
                        <div class="server-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v11a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V4z"/><path d="M8 22h8"/><path d="M12 15v-3"/><path d="M12 6h.01"/></svg>
                        </div>
                        <div class="server-title">
                            <h3>Announcement</h3>
                            <p class="server-url" style="direction: rtl; text-align: right; margin-top: 2px;">${escapeHtml(a.message).slice(0, 120)}${(a.message || '').length > 120 ? '…' : ''}</p>
                        </div>
                    </div>

                    <div class="server-badges" style="flex-wrap: wrap;">
                        <span class="badge ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span>
                        <span class="badge" style="background: rgba(99, 102, 241, 0.12); color: var(--primary); border: 1px solid rgba(99, 102, 241, 0.2);">${escapeHtml(serversLabel)}</span>
                    </div>

                    <div style="margin-top: 10px; color: var(--text-secondary); font-size: 0.8rem;">
                        <div>${escapeHtml(windowLabel)}</div>
                        <div style="margin-top: 4px;">Created: ${escapeHtml(createdAt)} • By: ${escapeHtml(createdBy)}</div>
                    </div>

                    <div class="server-actions">
                        <button class="action-btn" onclick="openEditAnnouncementModal(${a.id})" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-btn danger" onclick="deleteAnnouncement(${a.id})" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function initAnnouncementShamsiPicker() {
        if (typeof jalaliDatepicker !== 'undefined') {
            jalaliDatepicker.startWatch({
                time: true,
                hasSecond: false
            });
        }
    }

    async function ann_loadServers() {
        try {
            const response = await fetch('/api/servers');
            annAllServers = await response.json();
            annServersLoaded = true;
            ann_renderServerList();
        } catch (error) {
            console.error('Error loading servers:', error);
        }
    }

    async function ann_loadInbounds() {
        try {
            const response = await fetch('/api/refresh?mode=cache&enqueue=0');
            const data = await response.json();
            if (data && data.inbounds) {
                annServerInbounds = data.inbounds.reduce((acc, inbound) => {
                    const sid = inbound.server_id;
                    if (!acc[sid]) acc[sid] = [];
                    acc[sid].push(inbound);
                    return acc;
                }, {});
                annInboundsLoaded = true;
                ann_renderServerList();
            }
        } catch (error) {
            console.error('Error loading inbounds:', error);
        }
    }

    function ann_renderServerList() {
        const list = document.getElementById('announcement-server-list');
        if (!list) return;
        if (!annServersLoaded) {
            list.innerHTML = '<div class="inbound-empty">Loading servers...</div>';
            return;
        }

        list.innerHTML = (annAllServers || []).map((s, idx) => {
            const statusClass = s.enabled ? '' : 'disabled';
            const inbounds = annServerInbounds[s.id] || [];

            const inboundItems = inbounds.length > 0 ? inbounds.map(inb => {
                return `
                    <label class="inbound-item checkbox-label">
                        <input type="checkbox" class="ann-inbound-checkbox" data-server="${s.id}" value="${inb.id}" onchange="ann_updateCounts(${s.id})">
                        <span class="checkmark"></span>
                        <div class="inbound-details">
                            <span class="inbound-name">${escapeHtml(inb.remark || 'Inbound')}</span>
                            <span class="protocol-badge">${escapeHtml(inb.protocol || '')}</span>
                            <span class="port-number">:${escapeHtml(inb.port || '')}</span>
                        </div>
                    </label>
                `;
            }).join('') : '<div class="inbound-empty">No inbounds found</div>';

            return `
                <div class="server-accordion ${idx === 0 ? 'open' : ''}" data-server-id="${s.id}">
                    <div class="server-accordion-header" onclick="ann_toggleServerAccordion(event, ${s.id})">
                        <label class="checkbox-label" onclick="event.stopPropagation()">
                            <input type="checkbox" class="ann-server-checkbox" value="${s.id}" data-server="${s.id}" onchange="ann_toggleServerInbounds(${s.id}, this)">
                            <span class="checkmark"></span>
                        </label>

                        <div class="header-content">
                            <div class="server-info-block">
                                <span class="server-name">${escapeHtml(s.name || '')}</span>
                                <span class="server-host">${escapeHtml(s.host || '')}</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <span class="status-dot ${statusClass}" title="${s.enabled ? 'Online' : 'Disabled'}"></span>
                                <span class="chevron">▾</span>
                            </div>
                        </div>
                    </div>

                    <div class="inbound-list" id="ann-inbound-list-${s.id}">
                        <div class="inbound-list-header">
                            <label class="checkbox-label">
                                <input type="checkbox" class="ann-inbound-select-all" data-server="${s.id}" onchange="ann_toggleAllInboundsInServer(${s.id}, this)">
                                <span class="checkmark"></span>
                            </label>
                            <div class="inbound-header-text">
                                <span>Select All Inbounds</span>
                                <span class="count-pill inbound-counter" id="ann-inbound-count-${s.id}">0 / 0</span>
                            </div>
                        </div>
                        ${inboundItems}
                    </div>
                </div>
            `;
        }).join('');

        ann_syncSelectionsToUi();
        (annAllServers || []).forEach(s => ann_updateCounts(s.id));
    }

    function ann_normalizeAllowedInput(raw) {
        if (!raw) return [];
        if (raw === '*') return '*';
        if (typeof raw === 'string') {
            const trimmed = raw.trim();
            if (trimmed === '*') return '*';
            try {
                const parsed = JSON.parse(trimmed);
                return ann_normalizeAllowedInput(parsed);
            } catch (e) {
                const ids = trimmed.split(',').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
                return ids.map(id => ({ server_id: id, inbounds: '*' }));
            }
        }

        const entries = Array.isArray(raw) ? raw : [raw];
        const merged = new Map();

        entries.forEach(item => {
            let serverId;
            let inboundRules = '*';

            if (typeof item === 'number' || (typeof item === 'string' && item.trim() !== '*')) {
                serverId = parseInt(item);
                inboundRules = '*';
            } else if (item && typeof item === 'object') {
                serverId = parseInt(item.server_id || item.server || item.id);
                const inb = item.inbounds;
                if (Array.isArray(inb)) {
                    inboundRules = inb.map(v => parseInt(v)).filter(v => !isNaN(v));
                } else if (inb === '*' || (typeof inb === 'string' && inb.trim() === '*') || typeof inb === 'undefined') {
                    inboundRules = '*';
                } else {
                    const num = parseInt(inb);
                    inboundRules = isNaN(num) ? [] : [num];
                }
            }

            if (!serverId || isNaN(serverId)) return;

            if (!merged.has(serverId)) {
                merged.set(serverId, inboundRules === '*' ? '*' : new Set(inboundRules));
            } else {
                const existing = merged.get(serverId);
                if (existing === '*' || inboundRules === '*') {
                    merged.set(serverId, '*');
                } else {
                    inboundRules.forEach(v => merged.get(serverId).add(v));
                }
            }
        });

        return Array.from(merged.entries()).map(([sid, inb]) => ({
            server_id: sid,
            inbounds: inb === '*' ? '*' : Array.from(inb)
        }));
    }

    function ann_stringifyAllowedForInput(value) {
        if (value === '*') return '*';
        try {
            return JSON.stringify(value || []);
        } catch (e) {
            return '[]';
        }
    }

    function ann_resetSelections(selectAll = false) {
        const all = document.getElementById('announcement-targets-all');
        if (all) {
            all.checked = selectAll;
            all.indeterminate = false;
        }
        document.querySelectorAll('.ann-server-checkbox').forEach(cb => {
            cb.checked = selectAll;
            cb.indeterminate = false;
        });
        document.querySelectorAll('.ann-inbound-checkbox').forEach(cb => {
            cb.checked = selectAll;
        });
        document.querySelectorAll('.ann-inbound-select-all').forEach(cb => {
            cb.checked = selectAll;
            cb.indeterminate = false;
        });
        (annAllServers || []).forEach(s => ann_updateCounts(s.id));
        ann_updateGlobalSelectionState();
    }

    function ann_applyAllowedServers(rawAllowed) {
        const allowed = ann_normalizeAllowedInput(rawAllowed);
        ann_resetSelections(false);

        if (allowed === '*') {
            ann_resetSelections(true);
            return;
        }

        (allowed || []).forEach(rule => {
            const serverId = rule.server_id;
            const inbounds = rule.inbounds;
            const container = document.querySelector(`.server-accordion[data-server-id="${serverId}"]`);
            if (!container) return;

            const inboundCheckboxes = container.querySelectorAll('.ann-inbound-checkbox');
            if (inbounds === '*' || (Array.isArray(inbounds) && inbounds.length === 0)) {
                inboundCheckboxes.forEach(cb => cb.checked = true);
            } else {
                const inboundSet = new Set((inbounds || []).map(v => parseInt(v)).filter(v => !isNaN(v)));
                inboundCheckboxes.forEach(cb => {
                    const inbId = parseInt(cb.value);
                    if (!isNaN(inbId) && inboundSet.has(inbId)) {
                        cb.checked = true;
                    }
                });
            }
            ann_updateCounts(serverId);
        });

        (annAllServers || []).forEach(s => ann_updateCounts(s.id));
        ann_updateGlobalSelectionState();
    }

    function ann_syncSelectionsToUi() {
        const raw = (document.getElementById('announcement-targets')?.value || '').trim();
        const normalized = ann_normalizeAllowedInput(raw);
        ann_applyAllowedServers(normalized);
    }

    function ann_toggleServerAccordion(event, serverId) {
        const accordion = document.querySelector(`.server-accordion[data-server-id="${serverId}"]`);
        if (!accordion) return;
        accordion.classList.toggle('open');
    }

    function ann_toggleAllInboundsInServer(serverId, sourceCheckbox) {
        const container = document.querySelector(`.server-accordion[data-server-id="${serverId}"]`);
        if (!container) return;
        const checkboxes = container.querySelectorAll('.ann-inbound-checkbox');
        checkboxes.forEach(cb => cb.checked = sourceCheckbox.checked);
        ann_updateCounts(serverId);
    }

    function ann_toggleServerInbounds(serverId, sourceCheckbox) {
        const container = document.querySelector(`.server-accordion[data-server-id="${serverId}"]`);
        if (!container) return;
        const selectAllInbound = container.querySelector('.ann-inbound-select-all');
        if (selectAllInbound) selectAllInbound.checked = sourceCheckbox.checked;
        ann_toggleAllInboundsInServer(serverId, sourceCheckbox);
    }

    function ann_updateCounts(serverId) {
        const container = document.querySelector(`.server-accordion[data-server-id="${serverId}"]`);
        if (!container) return;

        const checkboxes = container.querySelectorAll('.ann-inbound-checkbox');
        const checked = container.querySelectorAll('.ann-inbound-checkbox:checked');

        const counterEl = container.querySelector('.inbound-counter');
        if (counterEl) counterEl.innerText = `${checked.length} / ${checkboxes.length}`;

        const selectAllInbound = container.querySelector('.ann-inbound-select-all');
        const serverMainCheckbox = container.querySelector('.ann-server-checkbox');

        if (checked.length === 0) {
            if (selectAllInbound) {
                selectAllInbound.checked = false;
                selectAllInbound.indeterminate = false;
            }
            if (serverMainCheckbox) {
                serverMainCheckbox.checked = false;
                serverMainCheckbox.indeterminate = false;
            }
        } else if (checked.length === checkboxes.length && checkboxes.length > 0) {
            if (selectAllInbound) {
                selectAllInbound.checked = true;
                selectAllInbound.indeterminate = false;
            }
            if (serverMainCheckbox) {
                serverMainCheckbox.checked = true;
                serverMainCheckbox.indeterminate = false;
            }
        } else {
            if (selectAllInbound) {
                selectAllInbound.checked = false;
                selectAllInbound.indeterminate = true;
            }
            if (serverMainCheckbox) {
                serverMainCheckbox.checked = false;
                serverMainCheckbox.indeterminate = true;
            }
        }

        ann_updateGlobalSelectionState();
    }

    function ann_toggleAllServers(sourceCheckbox) {
        const allServerChecks = document.querySelectorAll('.ann-server-checkbox');
        allServerChecks.forEach(cb => {
            cb.checked = sourceCheckbox.checked;
            const serverId = cb.dataset.server;
            ann_toggleServerInbounds(serverId, cb);
        });
    }

    function ann_updateGlobalSelectionState() {
        const serverCheckboxes = document.querySelectorAll('.ann-server-checkbox');
        const checkedServers = Array.from(serverCheckboxes).filter(cb => cb.checked);
        const indeterminateServers = Array.from(serverCheckboxes).filter(cb => cb.indeterminate);

        const allCheckbox = document.getElementById('announcement-targets-all');
        const globalCounter = document.getElementById('announcement-global-counter');

        if (globalCounter) {
            globalCounter.innerText = `${checkedServers.length} / ${serverCheckboxes.length}`;
        }

        const payload = [];
        serverCheckboxes.forEach(cb => {
            const serverId = parseInt(cb.dataset.server);
            const container = document.querySelector(`.server-accordion[data-server-id="${serverId}"]`);
            if (!container) return;
            const inboundCheckboxes = container.querySelectorAll('.ann-inbound-checkbox');
            const checkedInbounds = container.querySelectorAll('.ann-inbound-checkbox:checked');
            if (checkedInbounds.length === 0) return;

            if (inboundCheckboxes.length > 0 && checkedInbounds.length === inboundCheckboxes.length) {
                payload.push({ server_id: serverId, inbounds: '*' });
            } else {
                const ids = Array.from(checkedInbounds)
                    .map(inb => parseInt(inb.value))
                    .filter(v => !isNaN(v));
                if (ids.length > 0) {
                    payload.push({ server_id: serverId, inbounds: Array.from(new Set(ids)) });
                }
            }
        });

        const allFullySelected = payload.length === serverCheckboxes.length && payload.length > 0 && payload.every(p => p.inbounds === '*');

        if (checkedServers.length === serverCheckboxes.length && serverCheckboxes.length > 0 && indeterminateServers.length === 0) {
            allCheckbox.checked = true;
            allCheckbox.indeterminate = false;
        } else {
            allCheckbox.checked = false;
            allCheckbox.indeterminate = (checkedServers.length > 0 || indeterminateServers.length > 0);
        }

        const hidden = document.getElementById('announcement-targets');
        if (hidden) {
            hidden.value = allFullySelected ? '*' : ann_stringifyAllowedForInput(payload);
        }
    }

    function closeAnnouncementModal() {
        document.getElementById('announcement-modal').classList.add('hidden');
    }

    async function openAddAnnouncementModal() {
        document.getElementById('announcement-id').value = '';
        document.getElementById('announcement-modal-title').textContent = 'Add Announcement';
        document.getElementById('announcement-message').value = '';

        // Default: all targets
        const hidden = document.getElementById('announcement-targets');
        if (hidden) hidden.value = '*';

        // Ensure selector is loaded
        await ann_loadServers();
        await ann_loadInbounds();
        ann_applyAllowedServers('*');
        initAnnouncementShamsiPicker();

        document.getElementById('announcement-modal').classList.remove('hidden');
    }

    async function openEditAnnouncementModal(id) {
        const a = (announcements || []).find(x => x.id === id);
        if (!a) return;

        document.getElementById('announcement-id').value = String(a.id);
        document.getElementById('announcement-modal-title').textContent = 'Edit Announcement';
        document.getElementById('announcement-message').value = a.message || '';

        document.getElementById('announcement-start').value = a.start_at_jalali || '';
        document.getElementById('announcement-end').value = a.end_at_jalali || '';

        const hidden = document.getElementById('announcement-targets');
        if (hidden) hidden.value = (a.targets || (a.all_servers ? '*' : '[]'));

        await ann_loadServers();
        await ann_loadInbounds();
        ann_syncSelectionsToUi();
        initAnnouncementShamsiPicker();

        document.getElementById('announcement-modal').classList.remove('hidden');
    }

    async function saveAnnouncement() {
        const id = (document.getElementById('announcement-id').value || '').trim();
        const message = (document.getElementById('announcement-message').value || '').trim();
        const startAtJalali = (document.getElementById('announcement-start').value || '').trim();
        const endAtJalali = (document.getElementById('announcement-end').value || '').trim();
        const targets = (document.getElementById('announcement-targets').value || '').trim() || '*';

        if (!message) {
            showToast('Message is required', 'error');
            return;
        }
        if (!startAtJalali || !endAtJalali) {
            showToast('Start/End are required', 'error');
            return;
        }

        const body = {
            message,
            start_at_jalali: startAtJalali,
            end_at_jalali: endAtJalali,
            targets
        };

        try {
            const url = id ? `/api/announcements/${id}` : '/api/announcements';
            const method = id ? 'PUT' : 'POST';
            const resp = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            const result = await resp.json();
            if (result.success) {
                showToast(id ? 'Announcement updated' : 'Announcement created');
                closeAnnouncementModal();
                loadAnnouncements();
            } else {
                showToast('Error: ' + (result.error || 'Unknown'), 'error');
            }
        } catch (e) {
            showToast('Connection error', 'error');
        }
    }

    async function deleteAnnouncement(id) {
        if (!confirm('Are you sure you want to delete this announcement?')) return;
        try {
            const resp = await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
            const result = await resp.json();
            if (result.success) {
                showToast('Announcement deleted');
                loadAnnouncements();
            } else {
                showToast('Error: ' + (result.error || 'Unknown'), 'error');
            }
        } catch (e) {
            showToast('Error deleting announcement', 'error');
        }
    }

    // FAQ Logic
    let faqs = [];
    let quill;

    document.addEventListener('DOMContentLoaded', () => {
        // Register RTL/LTR format
        const DirectionAttribute = Quill.import('attributors/style/direction');
        Quill.register(DirectionAttribute, true);
        
        quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['rtl', 'ltr'],
                        ['clean']
                    ],
                    handlers: {
                        'rtl': function() {
                            const range = this.quill.getSelection();
                            if (range) {
                                this.quill.format('direction', 'rtl');
                                this.quill.format('align', 'right');
                            } else {
                                // Apply to entire editor
                                this.quill.root.style.direction = 'rtl';
                                this.quill.root.style.textAlign = 'right';
                            }
                        },
                        'ltr': function() {
                            const range = this.quill.getSelection();
                            if (range) {
                                this.quill.format('direction', 'ltr');
                                this.quill.format('align', 'left');
                            } else {
                                // Apply to entire editor
                                this.quill.root.style.direction = 'ltr';
                                this.quill.root.style.textAlign = 'left';
                            }
                        }
                    }
                }
            }
        });
        
        // Add RTL/LTR button labels to toolbar
        const toolbar = document.querySelector('.ql-toolbar');
        if (toolbar) {
            const rtlBtn = toolbar.querySelector('.ql-rtl');
            const ltrBtn = toolbar.querySelector('.ql-ltr');
            if (rtlBtn) rtlBtn.innerHTML = 'RTL';
            if (ltrBtn) ltrBtn.innerHTML = 'LTR';
        }
        
        // Set default direction to RTL for Persian
        quill.root.style.direction = 'rtl';
        quill.root.style.textAlign = 'right';
    });

    async function loadFAQs() {
        try {
            const response = await fetch('/api/faqs');
            faqs = await response.json();
            renderFAQs();
        } catch (error) {
            showToast('Error loading FAQs', 'error');
        }
    }

    function renderFAQs() {
        const container = document.getElementById('faqs-container');
        
        if (faqs.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No FAQs defined</p></div>';
            return;
        }

        container.innerHTML = faqs.map(faq => `
            <div class="server-card ${!faq.is_enabled ? 'disabled' : ''}">
                <div class="server-header">
                    <div class="server-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    
                    <div class="server-title">
                        <h3>${faq.title}</h3>
                    </div>
                </div>

                <div class="server-badges">
                    <span class="badge ${faq.is_enabled ? 'active' : 'inactive'}">
                        ${faq.is_enabled ? 'Visible' : 'Hidden'}
                    </span>
                </div>

                <div class="server-actions">
                    <button class="action-btn" onclick="openEditFAQModal(${faq.id})" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>

                    <button class="action-btn danger" onclick="deleteFAQ(${faq.id})" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function closeFAQModal() {
        document.getElementById('edit-faq-modal').classList.add('hidden');
    }

    function openAddFAQModal() {
        document.getElementById('edit-faq-id').value = '';
        document.getElementById('faq-modal-title').textContent = 'Add New FAQ';
        
        document.getElementById('edit-faq-platform').value = 'android';
        document.getElementById('edit-faq-title').value = '';
        quill.root.innerHTML = '';
        document.getElementById('edit-faq-image').value = '';
        document.getElementById('edit-faq-video').value = '';
        document.getElementById('edit-faq-enabled').checked = true;
        
        // Reset file upload
        document.getElementById('faq-image-upload').value = '';
        document.getElementById('faq-file-name').textContent = 'No file chosen';
        
        document.getElementById('edit-faq-modal').classList.remove('hidden');
    }

    function openEditFAQModal(id) {
        const faq = faqs.find(f => f.id === id);
        document.getElementById('edit-faq-id').value = faq.id;
        document.getElementById('faq-modal-title').textContent = 'Edit FAQ';
        
        document.getElementById('edit-faq-platform').value = faq.platform || 'android';
        document.getElementById('edit-faq-title').value = faq.title;
        quill.root.innerHTML = faq.content || '';
        document.getElementById('edit-faq-image').value = faq.image_url || '';
        document.getElementById('edit-faq-video').value = faq.video_url || '';
        document.getElementById('edit-faq-enabled').checked = faq.is_enabled;
        
        // Reset file upload
        document.getElementById('faq-image-upload').value = '';
        document.getElementById('faq-file-name').textContent = 'No file chosen';
        
        document.getElementById('edit-faq-modal').classList.remove('hidden');
    }

    async function saveFAQ() {
        const id = document.getElementById('edit-faq-id').value;
        const data = {
            platform: document.getElementById('edit-faq-platform').value,
            title: document.getElementById('edit-faq-title').value,
            content: quill.root.innerHTML,
            image_url: document.getElementById('edit-faq-image').value,
            video_url: document.getElementById('edit-faq-video').value,
            is_enabled: document.getElementById('edit-faq-enabled').checked
        };

        if (!data.title.trim()) {
            showToast('Title is required', 'error');
            return;
        }

        try {
            let url, method;
            if (id) {
                url = `/api/faqs/${id}`;
                method = 'PUT';
            } else {
                url = '/api/faqs';
                method = 'POST';
            }

            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(id ? 'FAQ updated successfully' : 'FAQ added successfully');
                closeFAQModal();
                loadFAQs();
            } else {
                showToast('Error: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    async function deleteFAQ(id) {
        if (!confirm('Are you sure you want to delete this FAQ?')) return;
        
        try {
            const response = await fetch(`/api/faqs/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('FAQ deleted');
                loadFAQs();
            } else {
                showToast('Error deleting FAQ', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    async function uploadFAQImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            document.getElementById('faq-file-name').textContent = file.name;
            
            // Show loading state on button
            const wrapper = document.getElementById('faq-upload-container');
            const btn = document.getElementById('faq-upload-btn');
            wrapper.classList.add('uploading');
            btn.classList.add('loading');
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.url) {
                    document.getElementById('edit-faq-image').value = result.url;
                    showToast('Image uploaded successfully');
                } else {
                    showToast('Upload failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Upload error', 'error');
            } finally {
                wrapper.classList.remove('uploading');
                btn.classList.remove('loading');
            }
        }
    }

    async function saveContactInfo() {
        const telegram = document.getElementById('support-telegram').value;
        const whatsapp = document.getElementById('support-whatsapp').value;
        const channelTelegram = document.getElementById('channel-telegram').value;
        const channelWhatsapp = document.getElementById('channel-whatsapp').value;

        try {
            const response = await fetch('/api/system-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    'support_telegram': telegram,
                    'support_whatsapp': whatsapp,
                    'channel_telegram': channelTelegram,
                    'channel_whatsapp': channelWhatsapp
                })
            });
            
            const result = await response.json();
            if (result.success) {
                showToast('Contact info saved successfully');
            } else {
                showToast('Error saving contact info', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }
</script>
{% endblock %}
